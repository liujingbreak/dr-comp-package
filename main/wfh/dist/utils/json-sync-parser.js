"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.isToken = exports.isArrayAst = exports.isObjectAst = void 0;
const LLn_parser_1 = require("../LLn-parser");
const lexer = function (strLookAhead, emitter) {
    let char = strLookAhead.la();
    if (char == null) {
        emitter.end();
        return;
    }
    if (/[{}\[\],:]/.test(char)) {
        strLookAhead.startChunk(char);
        strLookAhead.advance();
        emitter.emit();
    }
    else if (/\s/.test(char)) {
        do {
            strLookAhead.advance();
            char = strLookAhead.la();
        } while (char && /\s/.test(char));
    }
    else if (/["']/.test(char)) {
        strLookAhead.startChunk('stringLiteral');
        const openChar = strLookAhead.advance();
        while (true) {
            const la = strLookAhead.la();
            if (la == null) {
                return strLookAhead.throwError();
            }
            if (la === '\\') {
                strLookAhead.advance(2);
            }
            else if (la === openChar) {
                strLookAhead.advance();
                emitter.emit();
                return;
            }
            else {
                strLookAhead.advance();
            }
        }
    }
    else {
        strLookAhead.startChunk('other');
        let next;
        do {
            strLookAhead.advance();
            next = strLookAhead.la();
        } while (next != null && !/[{}\[\],:\s'"]/.test(next));
        emitter.emit();
    }
    char = strLookAhead.la();
};
var AstType;
(function (AstType) {
    AstType[AstType["object"] = 0] = "object";
    AstType[AstType["array"] = 1] = "array";
    AstType[AstType["property"] = 2] = "property";
    AstType[AstType["value"] = 3] = "value";
})(AstType || (AstType = {}));
function isObjectAst(ast) {
    return ast.type === AstType.object;
}
exports.isObjectAst = isObjectAst;
function isArrayAst(ast) {
    return ast.type === AstType.array;
}
exports.isArrayAst = isArrayAst;
function isToken(ast) {
    return ast.text != null;
}
exports.isToken = isToken;
const grammar = function (tokenLa) {
    return doObject(tokenLa);
};
function doObject(lexer) {
    const ast = {
        type: AstType.object,
        properties: []
    };
    const lp = lexer.advance();
    ast.start = lp.pos;
    let next = lexer.la();
    while (next != null && next.type !== '}') {
        const propToken = lexer.advance();
        const colon = lexer.advance();
        if (colon.type !== ':') {
            throw new Error(`Expect ':' but recieve '${colon.text}' at ${colon.line}:${colon.col}`);
        }
        ast.properties.push({ name: propToken, value: doValue(lexer) });
        next = lexer.la();
        if (next && next.type === ',')
            lexer.advance();
        next = lexer.la();
    }
    const rp = lexer.advance(); // }
    ast.end = rp.end;
    return ast;
}
function doArray(lexer) {
    const ast = {
        type: AstType.array,
        items: []
    };
    const lp = lexer.advance();
    ast.start = lp.pos;
    let next = lexer.la();
    while (next != null && next.type !== ']') {
        if (next.type !== ',') {
            ast.items.push(doValue(lexer));
        }
        else {
            lexer.advance();
        }
        next = lexer.la();
    }
    if (next && next.type === ']') {
        ast.end = lexer.advance().end; // ]
    }
    else if (next == null)
        throw new Error('Unexpect EOF after ' + lexer.lastConsumed.text);
    else
        throw new Error(`Unexpect ${next.text} at ${next.line}:${next.col}`);
    return ast;
}
function doValue(lexer) {
    const next = lexer.la();
    if (next === null) {
        throw new Error('Unexpect EOF');
    }
    if (next.type === '{') {
        return doObject(lexer);
    }
    else if (next.type === '[') {
        return doArray(lexer);
    }
    else if (next.type === 'stringLiteral' || next.type === 'other') {
        return lexer.advance();
    }
    else {
        throw new Error(`Unexpect '${next.text}' at ${next.line}:${next.col}`);
    }
}
function parse(content) {
    const jsonParser = LLn_parser_1.parser('JSON', lexer, grammar);
    jsonParser.write(content);
    jsonParser.end();
    return jsonParser.getResult();
}
exports.default = parse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbi1zeW5jLXBhcnNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3RzL3V0aWxzL2pzb24tc3luYy1wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOENBQThEO0FBSTlELE1BQU0sS0FBSyxHQUFpQyxVQUMxQyxZQUFZLEVBQUUsT0FBTztJQUNyQixJQUFJLElBQUksR0FBRyxZQUFZLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDN0IsSUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO1FBQ2hCLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNkLE9BQU87S0FDUjtJQUNELElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUMzQixZQUFZLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlCLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN2QixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7S0FDaEI7U0FBTSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDMUIsR0FBRztZQUNELFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUN2QixJQUFJLEdBQUcsWUFBWSxDQUFDLEVBQUUsRUFBRSxDQUFDO1NBQzFCLFFBQVEsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7S0FDbkM7U0FBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDNUIsWUFBWSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUN6QyxNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDeEMsT0FBTyxJQUFJLEVBQUU7WUFDWCxNQUFNLEVBQUUsR0FBRyxZQUFZLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDN0IsSUFBSSxFQUFFLElBQUksSUFBSSxFQUFFO2dCQUNkLE9BQU8sWUFBWSxD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QUMsR0FBRyxFQUFFLENBQUM7SUFDakIsT0FBTyxVQUFVLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDaEMsQ0FBQztBQU5ELHdCQU1DIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBDaHVuaywgR3JhbW1hciwgTGV4ZXIsIHBhcnNlciB9IGZyb20gJy4uL0xMbi1wYXJzZXInO1xuXG5leHBvcnQgdHlwZSBUb2tlbiA9IENodW5rPHN0cmluZywgc3RyaW5nPiAmIHsvKiogc3RyaW5nIGxpdGVyYWwgY29udGFpbnMgXCJcIiBvciAnJyAqL3RleHQ6IHN0cmluZ307XG5cbmNvbnN0IGxleGVyOiBMZXhlcjxzdHJpbmcsIHN0cmluZywgVG9rZW4+ID0gZnVuY3Rpb24oXG4gIHN0ckxvb2tBaGVhZCwgZW1pdHRlcikge1xuICBsZXQgY2hhciA9IHN0ckxvb2tBaGVhZC5sYSgpO1xuICBpZiAoY2hhciA9PSBudWxsKSB7XG4gICAgZW1pdHRlci5lbmQoKTtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKC9be31cXFtcXF0sOl0vLnRlc3QoY2hhcikpIHtcbiAgICBzdHJMb29rQWhlYWQuc3RhcnRDaHVuayhjaGFyKTtcbiAgICBzdHJMb29rQWhlYWQuYWR2YW5jZSgpO1xuICAgIGVtaXR0ZXIuZW1pdCgpO1xuICB9IGVsc2UgaWYgKC9cXHMvLnRlc3QoY2hhcikpIHtcbiAgICBkbyB7XG4gICAgICBzdHJMb29rQWhlYWQuYWR2YW5jZSgpO1xuICAgICAgY2hhciA9IHN0ckxvb2tBaGVhZC5sYSgpO1xuICAgIH0gd2hpbGUgKGNoYXIgJiYgL1xccy8udGVzdChjaGFyKSk7XG4gIH0gZWxzZSBpZiAoL1tcIiddLy50ZXN0KGNoYXIpKSB7XG4gICAgc3RyTG9va0FoZWFkLnN0YXJ0Q2h1bmsoJ3N0cmluZ0xpdGVyYWwnKTtcbiAgICBjb25zdCBvcGVuQ2hhciA9IHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIGNvbnN0IGxhID0gc3RyTG9va0FoZWFkLmxhKCk7XG4gICAgICBpZiAobGEgPT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gc3RyTG9va0FoZWFkLnRocm93RXJyb3IoKTtcbiAgICAgIH1cbiAgICAgIGlmIChsYSA9PT0gJ1xcXFwnKSB7XG4gICAgICAgIHN0ckxvb2tBaGVhZC5hZHZhbmNlKDIpO1xuICAgICAgfSBlbHNlIGlmIChsYSA9PT0gb3BlbkNoYXIpIHtcbiAgICAgICAgc3RyTG9va0FoZWFkLmFkdmFuY2UoKTtcbiAgICAgICAgZW1pdHRlci5lbWl0KCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHN0ckxvb2tBaGVhZC5zdGFydENodW5rKCdvdGhlcicpO1xuICAgIGxldCBuZXh0OiBzdHJpbmcgfCBudWxsO1xuICAgIGRvIHtcbiAgICAgIHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgICBuZXh0ID0gc3RyTG9va0FoZWFkLmxhKCk7XG4gICAgfSB3aGlsZSAobmV4dCAhPSBudWxsICYmICEvW3t9XFxbXFxdLDpcXHMnXCJdLy50ZXN0KG5leHQpKTtcbiAgICBlbWl0dGVyLmVtaXQoKTtcbiAgfVxuICBjaGFyID0gc3RyTG9va0FoZWFkLmxhKCk7XG59O1xuXG5lbnVtIEFzdFR5cGUge1xuICBvYmplY3QgPSAwLFxuICBhcnJheSxcbiAgcHJvcGVydHksXG4gIHZhbHVlXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXN0IHtcbiAgdHlwZTogQXN0VHlwZTtcbiAgc3RhcnQ6IG51bWJlcjtcbiAgZW5kOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT2JqZWN0QXN0IGV4dGVuZHMgQXN0IHtcbiAgcHJvcGVydGllczoge25hbWU6IFRva2VuOyB2YWx1ZTogQXN0fFRva2VufVtdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFycmF5QXN0IGV4dGVuZHMgQXN0IHtcbiAgaXRlbXM6IEFycmF5PEFzdCB8IFRva2VuPjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzT2JqZWN0QXN0KGFzdDogQXN0IHwgVG9rZW4pOiBhc3QgaXMgT2JqZWN0QXN0IHtcbiAgcmV0dXJuIGFzdC50eXBlID09PSBBc3RUeXBlLm9iamVjdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzQXJyYXlBc3QoYXN0OiBBc3QgfCBUb2tlbik6IGFzdCBpcyBBcnJheUFzdCB7XG4gIHJldHVybiBhc3QudHlwZSA9PT0gQXN0VHlwZS5hcnJheTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzVG9rZW4oYXN0OiBBc3QgfCBUb2tlbik6IGFzdCBpcyBUb2tlbiB7XG4gIHJldHVybiAoYXN0IGFzIFRva2VuKS50ZXh0ICE9IG51bGw7XG59XG5cbmNvbnN0IGdyYW1tYXI6IEdyYW1tYXI8VG9rZW4sIE9iamVjdEFzdD4gPSBmdW5jdGlvbih0b2tlbkxhKSB7XG4gIHJldHVybiBkb09iamVjdCh0b2tlbkxhKTtcbn07XG5cbmZ1bmN0aW9uIGRvT2JqZWN0KGxleGVyOiBQYXJhbWV0ZXJzPEdyYW1tYXI8VG9rZW4sIE9iamVjdEFzdD4+WzBdKTogT2JqZWN0QXN0IHtcbiAgY29uc3QgYXN0OiBQYXJ0aWFsPE9iamVjdEFzdD4gPSB7XG4gICAgdHlwZTogQXN0VHlwZS5vYmplY3QsXG4gICAgcHJvcGVydGllczogW11cbiAgfTtcbiAgY29uc3QgbHAgPSBsZXhlci5hZHZhbmNlKCk7XG4gIGFzdC5zdGFydCA9IGxwLnBvcztcbiAgbGV0IG5leHQgPSBsZXhlci5sYSgpO1xuICB3aGlsZSAobmV4dCAhPSBudWxsICYmIG5leHQudHlwZSAhPT0gJ30nKSB7XG4gICAgY29uc3QgcHJvcFRva2VuID0gbGV4ZXIuYWR2YW5jZSgpO1xuICAgIGNvbnN0IGNvbG9uID0gbGV4ZXIuYWR2YW5jZSgpO1xuICAgIGlmIChjb2xvbi50eXBlICE9PSAnOicpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ICc6JyBidXQgcmVjaWV2ZSAnJHtjb2xvbi50ZXh0fScgYXQgJHtjb2xvbi5saW5lfToke2NvbG9uLmNvbH1gKTtcbiAgICB9XG5cbiAgICBhc3QucHJvcGVydGllcyEucHVzaCh7bmFtZTogcHJvcFRva2VuLCB2YWx1ZTogZG9WYWx1ZShsZXhlcil9KTtcbiAgICBuZXh0ID0gbGV4ZXIubGEoKTtcbiAgICBpZiAobmV4dCAmJiBuZXh0LnR5cGUgPT09ICcsJylcbiAgICAgIGxleGVyLmFkdmFuY2UoKTtcbiAgICBuZXh0ID0gbGV4ZXIubGEoKTtcbiAgfVxuICBjb25zdCBycCA9IGxleGVyLmFkdmFuY2UoKTsgLy8gfVxuICBhc3QuZW5kID0gcnAuZW5kO1xuICByZXR1cm4gYXN0IGFzIE9iamVjdEFzdDtcbn1cblxuZnVuY3Rpb24gZG9BcnJheShsZXhlcjogUGFyYW1ldGVyczxHcmFtbWFyPFRva2VuLCBPYmplY3RBc3Q+PlswXSk6IEFycmF5QXN0IHtcbiAgY29uc3QgYXN0OiBQYXJ0aWFsPEFycmF5QXN0PiA9IHtcbiAgICB0eXBlOiBBc3RUeXBlLmFycmF5LFxuICAgIGl0ZW1zOiBbXVxuICB9O1xuICBjb25zdCBscCA9IGxleGVyLmFkdmFuY2UoKTtcbiAgYXN0LnN0YXJ0ID0gbHAucG9zO1xuICBsZXQgbmV4dCA9IGxleGVyLmxhKCk7XG4gIHdoaWxlIChuZXh0ICE9IG51bGwgJiYgbmV4dC50eXBlICE9PSAnXScpIHtcblxuICAgIGlmIChuZXh0LnR5cGUgIT09ICcsJykge1xuICAgICAgYXN0Lml0ZW1zIS5wdXNoKGRvVmFsdWUobGV4ZXIpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV4ZXIuYWR2YW5jZSgpO1xuICAgIH1cbiAgICBuZXh0ID0gbGV4ZXIubGEoKTtcbiAgfVxuICBpZiAobmV4dCAmJiBuZXh0LnR5cGUgPT09ICddJykge1xuICAgIGFzdC5lbmQgPSBsZXhlci5hZHZhbmNlKCkuZW5kOyAvLyBdXG5cbiAgfSBlbHNlIGlmIChuZXh0ID09IG51bGwpXG4gICAgdGhyb3cgbmV3IEVycm9yKCdVbmV4cGVjdCBFT0YgYWZ0ZXIgJyArIGxleGVyLmxhc3RDb25zdW1lZC50ZXh0KTtcbiAgZWxzZVxuICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3QgJHtuZXh0LnRleHR9IGF0ICR7bmV4dC5saW5lfToke25leHQuY29sfWApO1xuICByZXR1cm4gYXN0IGFzIEFycmF5QXN0O1xufVxuXG5mdW5jdGlvbiBkb1ZhbHVlKGxleGVyOiBQYXJhbWV0ZXJzPEdyYW1tYXI8VG9rZW4sIE9iamVjdEFzdD4+WzBdKSB7XG4gIGNvbnN0IG5leHQgPSBsZXhlci5sYSgpO1xuICBpZiAobmV4dCA9PT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3QgRU9GJyk7XG4gIH1cbiAgaWYgKG5leHQudHlwZSA9PT0gJ3snKSB7XG4gICAgcmV0dXJuIGRvT2JqZWN0KGxleGVyKTtcbiAgfSBlbHNlIGlmIChuZXh0LnR5cGUgPT09ICdbJykge1xuICAgIHJldHVybiBkb0FycmF5KGxleGVyKTtcbiAgfSBlbHNlIGlmIChuZXh0LnR5cGUgPT09ICdzdHJpbmdMaXRlcmFsJyB8fCBuZXh0LnR5cGUgPT09ICdvdGhlcicpIHtcbiAgICByZXR1cm4gbGV4ZXIuYWR2YW5jZSgpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3QgJyR7bmV4dC50ZXh0fScgYXQgJHtuZXh0LmxpbmV9OiR7bmV4dC5jb2x9YCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gcGFyc2UoY29udGVudDogc3RyaW5nKSB7XG4gIGNvbnN0IGpzb25QYXJzZXIgPSBwYXJzZXI8c3RyaW5nLCBzdHJpbmcsIFRva2VuLCBPYmplY3RBc3Q+KFxuICAgICdKU09OJywgbGV4ZXIsIGdyYW1tYXIpO1xuICBqc29uUGFyc2VyLndyaXRlKGNvbnRlbnQpO1xuICBqc29uUGFyc2VyLmVuZCgpO1xuICByZXR1cm4ganNvblBhcnNlci5nZXRSZXN1bHQoKTtcbn1cbiJdfQ==