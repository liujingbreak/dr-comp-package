"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const async_LLn_parser_1 = require("dr-comp-package/wfh/dist/async-LLn-parser");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
var RCF822TokenType;
(function (RCF822TokenType) {
    RCF822TokenType[RCF822TokenType["CRLF"] = 0] = "CRLF";
    RCF822TokenType[RCF822TokenType[":"] = 1] = ":";
    RCF822TokenType[RCF822TokenType[";"] = 2] = ";";
    RCF822TokenType[RCF822TokenType["quoteStr"] = 3] = "quoteStr";
    RCF822TokenType[RCF822TokenType["CONTENT"] = 4] = "CONTENT";
})(RCF822TokenType = exports.RCF822TokenType || (exports.RCF822TokenType = {}));
const CR = '\r'.charCodeAt(0);
const LF = '\n'.charCodeAt(0);
const BACK_SLASH = '\\'.charCodeAt(0);
const QUOTE_MARK1 = '"'.charCodeAt(0);
const QUOTE_MARK2 = '\''.charCodeAt(0);
const COLON_MARK = ':'.charCodeAt(0);
const SEMI_COL = ';'.charCodeAt(0);
const parseLex = (la) => tslib_1.__awaiter(this, void 0, void 0, function* () {
    let chrCode = yield la.la();
    while (chrCode != null) {
        const chr = String.fromCharCode(chrCode);
        if (yield la.isNext(CR, LF)) {
            if (!/[\t ]/.test(String.fromCharCode((yield la.la(3))))) {
                la.startToken(RCF822TokenType.CRLF);
                yield la.advance(2);
                la.emitToken();
            }
            else {
                yield la.advance(2);
                yield skipWhiteSpace(la);
            }
        }
        else if ((yield la.la()) === LF) {
            if (!/[\t ]/.test(String.fromCharCode((yield la.la(2))))) {
                la.startToken(RCF822TokenType.CRLF);
                yield la.advance();
                la.emitToken();
            }
            else {
                yield la.advance();
                yield skipWhiteSpace(la);
            }
        }
        else if (chr === ':' || chr === ';') {
            la.startToken(RCF822TokenType[chr]);
            yield la.advance();
            la.emitToken();
            yield skipWhiteSpace(la);
        }
        else if (/\s/.test(chr)) {
            yield skipWhiteSpace(la);
        }
        else if (chr === '"' || chr === '\'') {
            yield quoteStr(la);
        }
        else {
            la.startToken(RCF822TokenType.CONTENT);
            // console.log(tk);
            yield la.advance();
            let code = yield la.la();
            let emit = false;
            while (code != null) {
                switch (code) {
                    case CR:
                    case LF:
                    case COLON_MARK:
                    case SEMI_COL:
                    case CR:
                    case QUOTE_MARK1:
                    case QUOTE_MARK2:
                        emit = true;
                        la.emitToken();
                        break;
                    default:
                        yield la.advance();
                        code = yield la.la();
                }
                if (emit)
                    break;
            }
        }
        chrCode = yield la.la();
    }
});
function quoteStr(la) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        la.startToken(RCF822TokenType.quoteStr);
        const openChar = yield la.advance();
        while (true) {
            const next = yield la.la();
            if (next == null) {
                return la.throwError();
            }
            if (next === BACK_SLASH) {
                yield la.advance(2);
            }
            else if (next === openChar) {
                yield la.advance();
                la.emitToken();
                break;
            }
            else {
                yield la.advance();
            }
        }
    });
}
function skipWhiteSpace(la) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        do {
            const code = yield la.la();
            if (code == null)
                return;
            if (/\s/.test(String.fromCharCode(code))) {
                yield la.advance();
            }
            else {
                break;
            }
        } while (true);
    });
}
const parseGrammar = (la) => tslib_1.__awaiter(this, void 0, void 0, function* () {
    yield parseHeaders(la);
    while ((yield la.la()) != null) {
        // await la.advance();
        // tslint:disable-next-line: no-console
        console.log((yield la.advance()).text);
    }
});
function parseHeaders(la) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const name = yield la.la();
    });
}
function parse(readable) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const input = new rxjs_1.Subject();
        const done = input.pipe(operators_1.observeOn(rxjs_1.queueScheduler), async_LLn_parser_1.mapChunks('RCF822-lexer', parseLex), operators_1.map(chunk => {
            chunk.text = Buffer.from(Uint8Array.from(chunk.values)).toString();
            // if (chunk.type === RCF822TokenType.CONTENT)
            // (chunk as Token<RCF822TokenType>).text = chunk.values!.join();
            delete chunk.values;
            return [chunk];
        }), async_LLn_parser_1.mapChunksObs('RCF822-parser', la => rxjs_1.from(parseGrammar(la))), operators_1.share()).toPromise();
        if (readable instanceof Buffer) {
            input.next(readable);
            input.complete();
        }
        else {
            // TODO:
        }
        yield done;
    });
}
exports.parse = parse;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AZHItY29yZS9hc3NldHMtcHJvY2Vzc2VyL3RzL21haWwvcmZjODIyLXBhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxnRkFDa0c7QUFFbEcsK0JBQW1EO0FBQ25ELDhDQUFxRDtBQUVyRCxJQUFZLGVBTVg7QUFORCxXQUFZLGVBQWU7SUFDekIscURBQUksQ0FBQTtJQUNKLCtDQUFHLENBQUE7SUFDSCwrQ0FBRyxDQUFBO0lBQ0gsNkRBQVEsQ0FBQTtJQUNSLDJEQUFPLENBQUE7QUFDVCxDQUFDLEVBTlcsZUFBZSxHQUFmLHVCQUFlLEtBQWYsdUJBQWUsUUFNMUI7QUFFRCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzlCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDOUIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0QyxNQUFNLFdBQVcsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3RDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdkMsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNyQyxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRW5DLE1BQU0sUUFBUSxHQUFzQyxDQUFPLEVBQUUsRUFBRSxFQUFFO0lBQy9ELElBQUksT0FBTyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQzVCLE9BQU8sT0FBTyxJQUFJLElBQUksRUFBRTtRQUN0QixNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3pDLElBQUksTUFB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UUFBUSxZQUFZLE1BQU0sRUFBRTtZQUM5QixLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3JCLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztTQUNsQjthQUFNO1lBQ0wsUUFBUTtTQUNUO1FBQ0QsTUFBTSxJQUFJLENBQUM7SUFDYixDQUFDO0NBQUE7QUF4QkQsc0JBd0JDIiwiZmlsZSI6Im5vZGVfbW9kdWxlcy9AZHItY29yZS9hc3NldHMtcHJvY2Vzc2VyL2Rpc3QvbWFpbC9yZmM4MjItcGFyc2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBQYXJzZUdyYW1tYXIsIFBhcnNlTGV4LCBUb2tlbixcbiAgbWFwQ2h1bmtzLCBtYXBDaHVua3NPYnMsIExvb2tBaGVhZE9ic2VydmFibGUgfSBmcm9tICdkci1jb21wLXBhY2thZ2Uvd2ZoL2Rpc3QvYXN5bmMtTExuLXBhcnNlcic7XG5pbXBvcnQge1JlYWRhYmxlfSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHtTdWJqZWN0LCBxdWV1ZVNjaGVkdWxlciwgZnJvbX0gZnJvbSAncnhqcyc7XG5pbXBvcnQge29ic2VydmVPbiwgbWFwLCBzaGFyZX0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5leHBvcnQgZW51bSBSQ0Y4MjJUb2tlblR5cGUge1xuICBDUkxGLFxuICAnOicsXG4gICc7JyxcbiAgcXVvdGVTdHIsXG4gIENPTlRFTlRcbn1cblxuY29uc3QgQ1IgPSAnXFxyJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgTEYgPSAnXFxuJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgQkFDS19TTEFTSCA9ICdcXFxcJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgUVVPVEVfTUFSSzEgPSAnXCInLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBRVU9URV9NQVJLMiA9ICdcXCcnLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBDT0xPTl9NQVJLID0gJzonLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBTRU1JX0NPTCA9ICc7Jy5jaGFyQ29kZUF0KDApO1xuXG5jb25zdCBwYXJzZUxleDogUGFyc2VMZXg8bnVtYmVyLCBSQ0Y4MjJUb2tlblR5cGU+ID0gYXN5bmMgKGxhKSA9PiB7XG4gIGxldCBjaHJDb2RlID0gYXdhaXQgbGEubGEoKTtcbiAgd2hpbGUgKGNockNvZGUgIT0gbnVsbCkge1xuICAgIGNvbnN0IGNociA9IFN0cmluZy5mcm9tQ2hhckNvZGUoY2hyQ29kZSk7XG4gICAgaWYgKGF3YWl0IGxhLmlzTmV4dChDUiwgTEYpKSB7XG4gICAgICBpZiAoIS9bXFx0IF0vLnRlc3QoU3RyaW5nLmZyb21DaGFyQ29kZSgoYXdhaXQgbGEubGEoMykpISkpKSB7XG4gICAgICAgIGxhLnN0YXJ0VG9rZW4oUkNGODIyVG9rZW5UeXBlLkNSTEYpO1xuICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKDIpO1xuICAgICAgICBsYS5lbWl0VG9rZW4oKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoMik7XG4gICAgICAgIGF3YWl0IHNraXBXaGl0ZVNwYWNlKGxhKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKChhd2FpdCBsYS5sYSgpKSA9PT0gTEYpIHtcbiAgICAgIGlmICghL1tcXHQgXS8udGVzdChTdHJpbmcuZnJvbUNoYXJDb2RlKChhd2FpdCBsYS5sYSgyKSkhKSkpIHtcbiAgICAgICAgbGEuc3RhcnRUb2tlbihSQ0Y4MjJUb2tlblR5cGUuQ1JMRik7XG4gICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoKTtcbiAgICAgICAgbGEuZW1pdFRva2VuKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gICAgICAgIGF3YWl0IHNraXBXaGl0ZVNwYWNlKGxhKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGNociA9PT0gJzonIHx8IGNociA9PT0gJzsnKSB7XG4gICAgICBsYS5zdGFydFRva2VuKFJDRjgyMlRva2VuVHlwZVtjaHJdKTtcbiAgICAgIGF3YWl0IGxhLmFkdmFuY2UoKTtcbiAgICAgIGxhLmVtaXRUb2tlbigpO1xuICAgICAgYXdhaXQgc2tpcFdoaXRlU3BhY2UobGEpO1xuICAgIH0gZWxzZSBpZiAoL1xccy8udGVzdChjaHIpKSB7XG4gICAgICBhd2FpdCBza2lwV2hpdGVTcGFjZShsYSk7XG4gICAgfSBlbHNlIGlmIChjaHIgPT09ICdcIicgfHwgY2hyID09PSAnXFwnJykge1xuICAgICAgYXdhaXQgcXVvdGVTdHIobGEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsYS5zdGFydFRva2VuKFJDRjgyMlRva2VuVHlwZS5DT05URU5UKTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKHRrKTtcbiAgICAgIGF3YWl0IGxhLmFkdmFuY2UoKTtcbiAgICAgIGxldCBjb2RlID0gYXdhaXQgbGEubGEoKTtcbiAgICAgIGxldCBlbWl0ID0gZmFsc2U7XG4gICAgICB3aGlsZSAoY29kZSAhPSBudWxsKSB7XG4gICAgICAgIHN3aXRjaCAoY29kZSkge1xuICAgICAgICAgIGNhc2UgQ1I6XG4gICAgICAgICAgY2FzZSBMRjpcbiAgICAgICAgICBjYXNlIENPTE9OX01BUks6XG4gICAgICAgICAgY2FzZSBTRU1JX0NPTDpcbiAgICAgICAgICBjYXNlIENSOlxuICAgICAgICAgIGNhc2UgUVVPVEVfTUFSSzE6XG4gICAgICAgICAgY2FzZSBRVU9URV9NQVJLMjpcbiAgICAgICAgICAgIGVtaXQgPSB0cnVlO1xuICAgICAgICAgICAgbGEuZW1pdFRva2VuKCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgICAgICAgICAgY29kZSA9IGF3YWl0IGxhLmxhKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGVtaXQpIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICBjaHJDb2RlID0gYXdhaXQgbGEubGEoKTtcbiAgfVxufTtcblxuYXN5bmMgZnVuY3Rpb24gcXVvdGVTdHIobGE6IExvb2tBaGVhZE9ic2VydmFibGU8bnVtYmVyLCBSQ0Y4MjJUb2tlblR5cGU+KSB7XG4gIGxhLnN0YXJ0VG9rZW4oUkNGODIyVG9rZW5UeXBlLnF1b3RlU3RyKTtcbiAgY29uc3Qgb3BlbkNoYXIgPSBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gIHdoaWxlICh0cnVlKSB7XG4gICAgY29uc3QgbmV4dCA9IGF3YWl0IGxhLmxhKCk7XG4gICAgaWYgKG5leHQgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGxhLnRocm93RXJyb3IoKTtcbiAgICB9XG4gICAgaWYgKG5leHQgPT09IEJBQ0tfU0xBU0gpIHtcbiAgICAgIGF3YWl0IGxhLmFkdmFuY2UoMik7XG4gICAgfSBlbHNlIGlmIChuZXh0ID09PSBvcGVuQ2hhcikge1xuICAgICAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgICAgbGEuZW1pdFRva2VuKCk7XG4gICAgICBicmVhaztcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgIH1cbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBza2lwV2hpdGVTcGFjZShsYTogTG9va0FoZWFkT2JzZXJ2YWJsZTxudW1iZXIsIFJDRjgyMlRva2VuVHlwZT4pIHtcbiAgZG8ge1xuICAgIGNvbnN0IGNvZGUgPSBhd2FpdCBsYS5sYSgpO1xuICAgIGlmIChjb2RlID09IG51bGwpIHJldHVybjtcbiAgICBpZiAoL1xccy8udGVzdChTdHJpbmcuZnJvbUNoYXJDb2RlKGNvZGUpKSkge1xuICAgICAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH0gd2hpbGUgKHRydWUpO1xufVxuXG5jb25zdCBwYXJzZUdyYW1tYXI6IFBhcnNlR3JhbW1hcjx2b2lkLCBSQ0Y4MjJUb2tlblR5cGU+ID0gYXN5bmMgKGxhKSA9PiB7XG4gIGF3YWl0IHBhcnNlSGVhZGVycyhsYSk7XG4gIHdoaWxlICgoYXdhaXQgbGEubGEoKSkgIT0gbnVsbCkge1xuICAgIC8vIGF3YWl0IGxhLmFkdmFuY2UoKTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWNvbnNvbGVcbiAgICBjb25zb2xlLmxvZygoYXdhaXQgbGEuYWR2YW5jZSgpKS50ZXh0KTtcbiAgfVxufTtcblxuYXN5bmMgZnVuY3Rpb24gcGFyc2VIZWFkZXJzKGxhOiBQYXJhbWV0ZXJzPHR5cGVvZiBwYXJzZUdyYW1tYXI+WzBdKSB7XG4gIGNvbnN0IG5hbWUgPSBhd2FpdCBsYS5sYSgpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcGFyc2UocmVhZGFibGU6IFJlYWRhYmxlIHwgQnVmZmVyKSB7XG4gIGNvbnN0IGlucHV0ID0gbmV3IFN1YmplY3Q8VWludDhBcnJheT4oKTtcbiAgY29uc3QgZG9uZSA9IGlucHV0LnBpcGUoXG4gICAgb2JzZXJ2ZU9uKHF1ZXVlU2NoZWR1bGVyKSxcbiAgICBtYXBDaHVua3MoJ1JDRjgyMi1sZXhlcicsIHBhcnNlTGV4KSxcbiAgICBtYXAoY2h1bmsgPT4ge1xuICAgICAgKGNodW5rIGFzIFRva2VuPFJDRjgyMlRva2VuVHlwZT4pLnRleHQgPSBCdWZmZXIuZnJvbShVaW50OEFycmF5LmZyb20oY2h1bmsudmFsdWVzISkpLnRvU3RyaW5nKCk7XG4gICAgICAvLyBpZiAoY2h1bmsudHlwZSA9PT0gUkNGODIyVG9rZW5UeXBlLkNPTlRFTlQpXG4gICAgICAvLyAoY2h1bmsgYXMgVG9rZW48UkNGODIyVG9rZW5UeXBlPikudGV4dCA9IGNodW5rLnZhbHVlcyEuam9pbigpO1xuICAgICAgZGVsZXRlIGNodW5rLnZhbHVlcztcbiAgICAgIHJldHVybiBbY2h1bmsgYXMgVG9rZW48UkNGODIyVG9rZW5UeXBlPl07XG4gICAgfSksXG4gICAgbWFwQ2h1bmtzT2JzKCdSQ0Y4MjItcGFyc2VyJywgbGEgPT4gZnJvbShwYXJzZUdyYW1tYXIobGEpKSksXG4gICAgc2hhcmUoKVxuICApLnRvUHJvbWlzZSgpO1xuXG5cbiAgaWYgKHJlYWRhYmxlIGluc3RhbmNlb2YgQnVmZmVyKSB7XG4gICAgaW5wdXQubmV4dChyZWFkYWJsZSk7XG4gICAgaW5wdXQuY29tcGxldGUoKTtcbiAgfSBlbHNlIHtcbiAgICAvLyBUT0RPOlxuICB9XG4gIGF3YWl0IGRvbmU7XG59XG4iXX0=
