"use strict";
const tslib_1 = require("tslib");
const ng_html_parser_1 = require("../utils/ng-html-parser");
const patch_text_1 = tslib_1.__importStar(require("../utils/patch-text"));
const __api_1 = tslib_1.__importDefault(require("__api"));
const log = require('log4js').getLogger('ng-html-loader');
const _ = tslib_1.__importStar(require("lodash"));
const vm = require("vm");
const chalk = require('chalk');
function loader(content, map) {
    var callback = this.async();
    if (!callback) {
        this.emitError('loader does not support sync mode');
        throw new Error('loader does not support sync mode');
    }
    load(content, this)
        .then(result => this.callback(null, result, map))
        .catch(err => {
        this.callback(err);
        this.emitError(err);
        log.error(err);
    });
}
(function (loader) {
    loader.compileHtml = load;
})(loader || (loader = {}));
const toCheckNames = ['href', 'src', 'ng-src', 'ng-href', 'srcset', 'routerLink'];
function load(content, loader) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const ast = new ng_html_parser_1.TemplateParser(content).parse();
        const proms = [];
        const replacements = [];
        for (const el of ast) {
            for (const name of toCheckNames) {
                if (_.has(el.attrs, name)) {
                    if (el.attrs[name].isNg || el.attrs[name].value == null)
                        continue;
                    proms.push(doAttrAssetsUrl(name, el.attrs[name].value, el, replacements, loader));
                }
            }
        }
        yield Promise.all(proms);
        const updated = patch_text_1.default(content, replacements);
        return updated;
    });
}
function doAttrAssetsUrl(attrName, valueToken, el, replacements, loader) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        if (!valueToken)
            return;
        if (attrName === 'srcset') {
            // img srcset
            const value = yield doSrcSet(valueToken.text, loader);
            replacements.push(new patch_text_1.Replacement(valueToken.start, valueToken.end, value));
        }
        else if (attrName === 'src') {
            // img src
            const url = yield doLoadAssets(valueToken.text, loader);
            replacements.push(new patch_text_1.Replacement(valueToken.start, valueToken.end, url));
        }
        else { // href, ng-src, routerLink
            const url = yield resolveUrl(valueToken.text, loader);
            replacements.push(new patch_text_1.Replacement(valueToken.start, valueToken.end, url));
        }
    });
}
function doSrcSet(value, loader) {
    var prom = value.split(/\s*,\s*/).map(urlSet => {
        urlSet = _.trim(urlSet);
        const factors = urlSet.split(/\s+/);
        const image = factors[0];
        return doLoadAssets(image, loader)
            .then(url => {
            return url + ' ' + factors[1];
        });
    });
    return Promise.all(prom)
        .then(urlSets => urlSets.join(', '));
}
function resolveUrl(href, loader) {
    if (href === '')
        return Promise.resolve(href);
    var res = __api_1.default.normalizeAssetsUrl(href, loader.resourcePath);
    if (_.isObject(res)) {
        const resolved = res.isPage ?
            __api_1.default.entryPageUrl(res.packageName, res.path, res.locale) :
            __api_1.default.assetsUrl(res.packageName, res.path);
        log.info(`resolve URL/routePath ${chalk.yellow(href)} to ${chalk.cyan(resolved)},\n` +
            chalk.grey(loader.resourcePath));
        return Promise.resolve(resolved);
    }
    return Promise.resolve(href);
}
function doLoadAssets(src, loader) {
    if (src.startsWith('assets://') || src.startsWith('page://')) {
        const res = __api_1.default.normalizeAssetsUrl(src, loader.resourcePath);
        if (_.isObject(res)) {
            return Promise.resolve(res.isPage ?
                __api_1.default.entryPageUrl(res.packageName, res.path, res.locale) :
                __api_1.default.assetsUrl(res.packageName, res.path));
        }
    }
    if (/^(?:https?:|\/\/|data:)/.test(src))
        return Promise.resolve(src);
    if (src.charAt(0) === '/')
        return Promise.resolve(src);
    if (src.charAt(0) === '~') {
        src = src.substring(1);
    }
    else if (src.startsWith('npm://')) {
        src = src.substring('npm://'.length);
    }
    else if (src.charAt(0) !== '.' && src.trim().length > 0 && src.indexOf('{') < 0)
        src = './' + src;
    // console.log(api.packageName, loader.resourcePath, src);
    return new Promise((resolve, reject) => {
        // Unlike extract-loader, we does not support embedded require statement in source code 
        loader.loadModule(src, (err, source, sourceMap, module) => {
            if (err)
                return reject(err);
            var sandbox = {
                __webpack_public_path__: _.get(loader, '_compiler.options.output.publicPath', __api_1.default.config().publicPath),
                module: {
                    exports: {}
                }
            };
            vm.runInNewContext(source, vm.createContext(sandbox));
            resolve(sandbox.module.exports);
        });
    });
}
module.exports = loader;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AZHItY29yZS9uZy1hcHAtYnVpbGRlci90cy9sb2FkZXJzL25nLWh0bWwtbG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNERBQWtGO0FBRWxGLDBFQUFrRTtBQUNsRSwwREFBd0I7QUFFeEIsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQzFELGtEQUE0QjtBQUM1Qix5QkFBMEI7QUFDMUIsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBRS9CLFNBQVMsTUFBTSxDQUFDLE9BQWUsRUFBRSxHQUFrQjtJQUNsRCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDNUIsSUFBSSxDQUFDLFFBQVEsRUFBRTtRQUNkLElBQUksQ0FBQyxTQUFTLENBQUMsbUNBQW1DLENBQUMsQ0FBQztRQUNwRCxNQUFNLElBQUksS0FBSyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7S0FDckQ7SUFDRCxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQztTQUNsQixJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDaEQsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1FBQ1osSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNuQixJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3BCLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEIsQ0FBQyxDQUFDLENBQUM7QUFDSixDQUFDO0FBRUQsV0FBVSxNQUFNO0lBQ0Ysa0JBQVcsR0FBRyxJQUFJLENBQUM7QUFDakMsQ0FBQyxFQUZTLE1BQU0sS0FBTixNQUFNLFFBRWY7QUFJRCxNQUFNLFlB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ci1jb3JlL25nLWFwcC1idWlsZGVyL2Rpc3QvbG9hZGVycy9uZy1odG1sLWxvYWRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7VGVtcGxhdGVQYXJzZXIsIEF0dHJpYnV0ZVZhbHVlQXN0LCBUYWdBc3R9IGZyb20gJy4uL3V0aWxzL25nLWh0bWwtcGFyc2VyJztcbmltcG9ydCB7UmF3U291cmNlTWFwfSBmcm9tICdzb3VyY2UtbWFwJztcbmltcG9ydCBwYXRjaFRleHQsIHtSZXBsYWNlbWVudCBhcyBSZXB9IGZyb20gJy4uL3V0aWxzL3BhdGNoLXRleHQnO1xuaW1wb3J0IGFwaSBmcm9tICdfX2FwaSc7XG5pbXBvcnQge2xvYWRlciBhcyB3YkxvYWRlcn0gZnJvbSAnd2VicGFjayc7XG5jb25zdCBsb2cgPSByZXF1aXJlKCdsb2c0anMnKS5nZXRMb2dnZXIoJ25nLWh0bWwtbG9hZGVyJyk7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgdm0gPSByZXF1aXJlKCd2bScpO1xuY29uc3QgY2hhbGsgPSByZXF1aXJlKCdjaGFsaycpO1xuXG5mdW5jdGlvbiBsb2FkZXIoY29udGVudDogc3RyaW5nLCBtYXA/OiBSYXdTb3VyY2VNYXApIHtcblx0dmFyIGNhbGxiYWNrID0gdGhpcy5hc3luYygpO1xuXHRpZiAoIWNhbGxiYWNrKSB7XG5cdFx0dGhpcy5lbWl0RXJyb3IoJ2xvYWRlciBkb2VzIG5vdCBzdXBwb3J0IHN5bmMgbW9kZScpO1xuXHRcdHRocm93IG5ldyBFcnJvcignbG9hZGVyIGRvZXMgbm90IHN1cHBvcnQgc3luYyBtb2RlJyk7XG5cdH1cblx0bG9hZChjb250ZW50LCB0aGlzKVxuXHQudGhlbihyZXN1bHQgPT4gdGhpcy5jYWxsYmFjayhudWxsLCByZXN1bHQsIG1hcCkpXG5cdC5jYXRjaChlcnIgPT4ge1xuXHRcdHRoaXMuY2FsbGJhY2soZXJyKTtcblx0XHR0aGlzLmVtaXRFcnJvcihlcnIpO1xuXHRcdGxvZy5lcnJvcihlcnIpO1xuXHR9KTtcbn1cblxubmFtZXNwYWNlIGxvYWRlciB7XG5cdGV4cG9ydCBjb25zdCBjb21waWxlSHRtbCA9IGxvYWQ7XG59XG5cbmV4cG9ydCA9IGxvYWRlcjtcblxuY29uc3QgdG9DaGVja05hbWVzID0gWydocmVmJywgJ3NyYycsICduZy1zcmMnLCAnbmctaHJlZicsICdzcmNzZXQnLCAncm91dGVyTGluayddO1xuXG5hc3luYyBmdW5jdGlvbiBsb2FkKGNvbnRlbnQ6IHN0cmluZywgbG9hZGVyOiB3YkxvYWRlci5Mb2FkZXJDb250ZXh0KSB7XG5cdGNvbnN0IGFzdCA9IG5ldyBUZW1wbGF0ZVBhcnNlcihjb250ZW50KS5wYXJzZSgpO1xuXHRjb25zdCBwcm9tczogQXJyYXk8UHJvbWlzZUxpa2U8YW55Pj4gPSBbXTtcblx0Y29uc3QgcmVwbGFjZW1lbnRzOiBSZXBbXSA9IFtdO1xuXHRmb3IgKGNvbnN0IGVsIG9mIGFzdCkge1xuXHRcdGZvciAoY29uc3QgbmFtZSBvZiB0b0NoZWNrTmFtZXMpIHtcblx0XHRcdGlmIChfLmhhcyhlbC5hdHRycywgbmFtZSkpIHtcblx0XHRcdFx0aWYgKGVsLmF0dHJzW25hbWVdLmlzTmcgfHwgZWwuYXR0cnNbbmFtZV0udmFsdWUgPT0gbnVsbClcblx0XHRcdFx0XHRjb250aW51ZTtcblx0XHRcdFx0cHJvbXMucHVzaChkb0F0dHJBc3NldHNVcmwobmFtZSwgZWwuYXR0cnNbbmFtZV0udmFsdWUsIGVsLCByZXBsYWNlbWVudHMsIGxvYWRlcikpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXHRhd2FpdCBQcm9taXNlLmFsbChwcm9tcyk7XG5cdGNvbnN0IHVwZGF0ZWQgPSBwYXRjaFRleHQoY29udGVudCwgcmVwbGFjZW1lbnRzKTtcblx0cmV0dXJuIHVwZGF0ZWQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRvQXR0ckFzc2V0c1VybChhdHRyTmFtZTogc3RyaW5nLCB2YWx1ZVRva2VuOiBBdHRyaWJ1dGVWYWx1ZUFzdCxcblx0ZWw6IFRhZ0FzdCwgcmVwbGFjZW1lbnRzOiBSZXBbXSwgbG9hZGVyOiB3YkxvYWRlci5Mb2FkZXJDb250ZXh0KTogUHJvbWlzZTxhbnk+IHtcblx0aWYgKCF2YWx1ZVRva2VuKVxuXHRcdHJldHVybjtcblx0aWYgKGF0dHJOYW1lID09PSAnc3Jjc2V0Jykge1xuXHRcdC8vIGltZyBzcmNzZXRcblx0XHRjb25zdCB2YWx1ZSA9IGF3YWl0IGRvU3JjU2V0KHZhbHVlVG9rZW4udGV4dCwgbG9hZGVyKTtcblx0XHRyZXBsYWNlbWVudHMucHVzaChuZXcgUmVwKHZhbHVlVG9rZW4uc3RhcnQsIHZhbHVlVG9rZW4uZW5kLCB2YWx1ZSkpO1xuXHR9IGVsc2UgaWYgKGF0dHJOYW1lID09PSAnc3JjJykge1xuXHRcdC8vIGltZyBzcmNcblx0XHRjb25zdCB1cmwgPSBhd2FpdCBkb0xvYWRBc3NldHModmFsdWVUb2tlbi50ZXh0LCBsb2FkZXIpO1xuXHRcdHJlcGxhY2VtZW50cy5wdXNoKG5ldyBSZXAodmFsdWVUb2tlbi5zdGFydCwgdmFsdWVUb2tlbi5lbmQsIHVybCkpO1xuXHR9IGVsc2UgeyAvLyBocmVmLCBuZy1zcmMsIHJvdXRlckxpbmtcblx0XHRjb25zdCB1cmwgPSBhd2FpdCByZXNvbHZlVXJsKHZhbHVlVG9rZW4udGV4dCwgbG9hZGVyKTtcblx0XHRyZXBsYWNlbWVudHMucHVzaChuZXcgUmVwKHZhbHVlVG9rZW4uc3RhcnQsIHZhbHVlVG9rZW4uZW5kLCB1cmwpKTtcblx0fVxufVxuXG5mdW5jdGlvbiBkb1NyY1NldCh2YWx1ZTogc3RyaW5nLCBsb2FkZXI6IHdiTG9hZGVyLkxvYWRlckNvbnRleHQpIHtcblx0dmFyIHByb20gPSB2YWx1ZS5zcGxpdCgvXFxzKixcXHMqLykubWFwKHVybFNldCA9PiB7XG5cdFx0dXJsU2V0ID0gXy50cmltKHVybFNldCk7XG5cdFx0Y29uc3QgZmFjdG9ycyA9IHVybFNldC5zcGxpdCgvXFxzKy8pO1xuXHRcdGNvbnN0IGltYWdlID0gZmFjdG9yc1swXTtcblx0XHRyZXR1cm4gZG9Mb2FkQXNzZXRzKGltYWdlLCBsb2FkZXIpXG5cdFx0LnRoZW4odXJsID0+IHtcblx0XHRcdHJldHVybiB1cmwgKyAnICcgKyBmYWN0b3JzWzFdO1xuXHRcdH0pO1xuXHR9KTtcblx0cmV0dXJuIFByb21pc2UuYWxsKHByb20pXG5cdC50aGVuKHVybFNldHMgPT4gdXJsU2V0cy5qb2luKCcsICcpKTtcbn1cblxuZnVuY3Rpb24gcmVzb2x2ZVVybChocmVmOiBzdHJpbmcsIGxvYWRlcjogd2JMb2FkZXIuTG9hZGVyQ29udGV4dCkge1xuXHRpZiAoaHJlZiA9PT0gJycpXG5cdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShocmVmKTtcblx0dmFyIHJlcyA9IGFwaS5ub3JtYWxpemVBc3NldHNVcmwoaHJlZiwgbG9hZGVyLnJlc291cmNlUGF0aCk7XG5cdGlmIChfLmlzT2JqZWN0KHJlcykpIHtcblx0XHRjb25zdCByZXNvbHZlZCA9IHJlcy5pc1BhZ2UgP1xuXHRcdFx0YXBpLmVudHJ5UGFnZVVybChyZXMucGFja2FnZU5hbWUsIHJlcy5wYXRoLCByZXMubG9jYWxlKSA6XG5cdFx0XHRhcGkuYXNzZXRzVXJsKHJlcy5wYWNrYWdlTmFtZSwgcmVzLnBhdGgpO1xuXHRcdGxvZy5pbmZvKGByZXNvbHZlIFVSTC9yb3V0ZVBhdGggJHtjaGFsay55ZWxsb3coaHJlZil9IHRvICR7Y2hhbGsuY3lhbihyZXNvbHZlZCl9LFxcbmAgK1xuXHRcdFx0Y2hhbGsuZ3JleShsb2FkZXIucmVzb3VyY2VQYXRoKSk7XG5cdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXNvbHZlZCk7XG5cdH1cblx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShocmVmKTtcbn1cblxuZnVuY3Rpb24gZG9Mb2FkQXNzZXRzKHNyYzogc3RyaW5nLCBsb2FkZXI6IHdiTG9hZGVyLkxvYWRlckNvbnRleHQpIHtcblx0aWYgKHNyYy5zdGFydHNXaXRoKCdhc3NldHM6Ly8nKSB8fCBzcmMuc3RhcnRzV2l0aCgncGFnZTovLycpKSB7XG5cdFx0Y29uc3QgcmVzID0gYXBpLm5vcm1hbGl6ZUFzc2V0c1VybChzcmMsIGxvYWRlci5yZXNvdXJjZVBhdGgpO1xuXHRcdGlmIChfLmlzT2JqZWN0KHJlcykpIHtcblx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzLmlzUGFnZSA/XG5cdFx0XHRcdGFwaS5lbnRyeVBhZ2VVcmwocmVzLnBhY2thZ2VOYW1lLCByZXMucGF0aCwgcmVzLmxvY2FsZSkgOlxuXHRcdFx0XHRhcGkuYXNzZXRzVXJsKHJlcy5wYWNrYWdlTmFtZSwgcmVzLnBhdGgpKTtcblx0XHR9XG5cdH1cblxuXHRpZiAoL14oPzpodHRwcz86fFxcL1xcL3xkYXRhOikvLnRlc3Qoc3JjKSlcblx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHNyYyk7XG5cdGlmIChzcmMuY2hhckF0KDApID09PSAnLycpXG5cdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShzcmMpO1xuXHRpZiAoc3JjLmNoYXJBdCgwKSA9PT0gJ34nKSB7XG5cdFx0c3JjID0gc3JjLnN1YnN0cmluZygxKTtcblx0fSBlbHNlIGlmIChzcmMuc3RhcnRzV2l0aCgnbnBtOi8vJykpIHtcblx0XHRzcmMgPSBzcmMuc3Vic3RyaW5nKCducG06Ly8nLmxlbmd0aCk7XG5cdH0gZWxzZSBpZiAoc3JjLmNoYXJBdCgwKSAhPT0gJy4nICYmIHNyYy50cmltKCkubGVuZ3RoID4gMCAmJiBzcmMuaW5kZXhPZigneycpIDwgMClcblx0XHRzcmMgPSAnLi8nICsgc3JjO1xuXG5cdC8vIGNvbnNvbGUubG9nKGFwaS5wYWNrYWdlTmFtZSwgbG9hZGVyLnJlc291cmNlUGF0aCwgc3JjKTtcblx0cmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdC8vIFVubGlrZSBleHRyYWN0LWxvYWRlciwgd2UgZG9lcyBub3Qgc3VwcG9ydCBlbWJlZGRlZCByZXF1aXJlIHN0YXRlbWVudCBpbiBzb3VyY2UgY29kZSBcblx0XHRsb2FkZXIubG9hZE1vZHVsZShzcmMsIChlcnI6IEVycm9yLCBzb3VyY2U6IGFueSwgc291cmNlTWFwOiBhbnksIG1vZHVsZTogYW55KSA9PiB7XG5cdFx0XHRpZiAoZXJyKVxuXHRcdFx0XHRyZXR1cm4gcmVqZWN0KGVycik7XG5cdFx0XHR2YXIgc2FuZGJveCA9IHtcblx0XHRcdFx0X193ZWJwYWNrX3B1YmxpY19wYXRoX186IF8uZ2V0KGxvYWRlciwgJ19jb21waWxlci5vcHRpb25zLm91dHB1dC5wdWJsaWNQYXRoJywgYXBpLmNvbmZpZygpLnB1YmxpY1BhdGgpLFxuXHRcdFx0XHRtb2R1bGU6IHtcblx0XHRcdFx0XHRleHBvcnRzOiB7fVxuXHRcdFx0XHR9XG5cdFx0XHR9O1xuXHRcdFx0dm0ucnVuSW5OZXdDb250ZXh0KHNvdXJjZSwgdm0uY3JlYXRlQ29udGV4dChzYW5kYm94KSk7XG5cdFx0XHRyZXNvbHZlKHNhbmRib3gubW9kdWxlLmV4cG9ydHMgYXMgc3RyaW5nKTtcblx0XHR9KTtcblx0fSk7XG59XG4iXX0=
