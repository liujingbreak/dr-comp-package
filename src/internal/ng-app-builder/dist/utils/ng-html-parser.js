"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/* tslint:disable max-classes-per-file max-line-length no-console jsdoc-format */
const base_LLn_parser_1 = require("dr-comp-package/wfh/dist/base-LLn-parser");
var HtmlTokenType;
(function (HtmlTokenType) {
    // comments,
    HtmlTokenType[HtmlTokenType["<"] = 0] = "<";
    HtmlTokenType[HtmlTokenType[">"] = 1] = ">";
    HtmlTokenType[HtmlTokenType["/>"] = 2] = "/>";
    HtmlTokenType[HtmlTokenType["("] = 3] = "(";
    HtmlTokenType[HtmlTokenType[")"] = 4] = ")";
    HtmlTokenType[HtmlTokenType["["] = 5] = "[";
    HtmlTokenType[HtmlTokenType["]"] = 6] = "]";
    HtmlTokenType[HtmlTokenType["</"] = 7] = "</";
    HtmlTokenType[HtmlTokenType["="] = 8] = "=";
    HtmlTokenType[HtmlTokenType["qm"] = 9] = "qm";
    HtmlTokenType[HtmlTokenType["identity"] = 10] = "identity";
    HtmlTokenType[HtmlTokenType["stringLiteral"] = 11] = "stringLiteral";
    HtmlTokenType[HtmlTokenType["any"] = 12] = "any";
    HtmlTokenType[HtmlTokenType["space"] = 13] = "space";
})(HtmlTokenType = exports.HtmlTokenType || (exports.HtmlTokenType = {}));
exports.TokenType = HtmlTokenType;
class TemplateLexer extends base_LLn_parser_1.BaseLexer {
    *[Symbol.iterator]() {
        while (true) {
            this.skip();
            let char = this.la();
            const start = this.position;
            if (char == null) {
                return;
            }
            switch (char) {
                case '>':
                case '(':
                case ')':
                case '[':
                case ']':
                case '=':
                    this.advance();
                    yield new base_LLn_parser_1.Token(HtmlTokenType[char], this, start);
                    continue;
                case '"':
                case '\'':
                    this.advance();
                    yield new base_LLn_parser_1.Token(HtmlTokenType.qm, this, start);
                    continue;
                default:
            }
            if (char === '<' && this.isIdStart(2)) {
                yield this.openTagStart();
            }
            else if (this.isNext('</')) {
                yield this.closeTagStart();
            }
            else if (this.isNext('/>')) {
                this.advance(2);
                yield new base_LLn_parser_1.Token(HtmlTokenType['/>'], this, start);
            }
            else if (this.isIdStart()) {
                do {
                    this.advance();
                    char = this.la();
                } while (this.isIdStart());
                yield new base_LLn_parser_1.Token(HtmlTokenType.identity, this, start);
                // } else if (char === '"') {
                // 	yield this.stringLit('"');
                // } else if (char === '\'') {
                // 	yield this.stringLit('\'');
                // } else if (char === '`') {
                // 	yield this.stringLit('`');
            }
            else if (this.isWhitespace()) {
                do {
                    this.advance();
                } while (this.isWhitespace());
                yield new base_LLn_parser_1.Token(HtmlTokenType.space, this, start);
                continue;
            }
            else {
                yield new base_LLn_parser_1.Token(HtmlTokenType.any, this, start);
                this.advance();
            }
        }
    }
    openTagStart() {
        const start = this.position;
        this.advance();
        do {
            this.advance();
        } while (this.isIdStart());
        return new base_LLn_parser_1.Token(HtmlTokenType['<'], this, start);
    }
    closeTagStart() {
        const start = this.position;
        this.advance(2);
        while (this.la() !== '>') {
            this.advance();
        }
        return new base_LLn_parser_1.Token(HtmlTokenType['</'], this, start);
    }
    isIdStart(laIdx = 1) {
        const char = this.la(laIdx);
        if (!char) {
            this.throwError('EOF');
            return;
        }
        return /[^<>()\[\]"'=`/]/.test(char) && /\S/.test(char);
    }
    isWhitespace() {
        const chr = this.la();
        return chr && /\s/.test(chr);
    }
    stringLit(quote) {
        this.advance();
        const start = this.position;
        const [line, col] = this.getLineColumn(start);
        while (this.la() !== quote) {
            if (this.la() == null) {
                console.log('endless string literal begin with line %s, col %s', line, col);
                this.throwError();
            }
            // console.log(':', this.la());
            if (this.la() === '\\') {
                this.advance();
            }
            this.advance();
        }
        const tk = new base_LLn_parser_1.Token(HtmlTokenType.stringLiteral, this, start);
        this.advance();
        return tk;
    }
    skip() {
        let chr = this.la();
        while (chr != null) {
            if (this.isComment()) {
                this.comment();
            }
            else if (this.isSwigComment()) {
                this.swigComment();
            }
            else {
                break;
            }
            chr = this.la();
        }
        return this.la();
    }
    isComment() {
        return this.isNext('<!--');
    }
    comment() {
        this.advance(4);
        while (!this.isNext('-->')) {
            if (this.la() == null)
                throw new Error('Comment is not closed, ' + this.getCurrentPosInfo());
            this.advance();
        }
        this.advance(3);
        return true;
    }
    isSwigComment() {
        return this.isNext('{#');
    }
    swigComment() {
        this.advance(2);
        while (!this.isNext('#}')) {
            this.advance();
        }
    }
}
exports.TemplateLexer = TemplateLexer;
class TemplateParser extends base_LLn_parser_1.BaseParser {
    constructor(input) {
        const lexer = new TemplateLexer(input);
        super(lexer);
        this.lexer = lexer;
        this.text = input;
    }
    getCurrentPosInfo() {
        const start = this.la() ? this.la().start : null;
        if (start) {
            const lineCol = this.lexer.getLineColumn(start);
            return `Line ${lineCol[0] + 1} column ${lineCol[1] + 1}`;
        }
        return '<end of file>';
    }
    skip() {
        while (this.la() != null && this.la().type === HtmlTokenType.space) {
            this.advance();
        }
    }
    parse() {
        const ast = [];
        while (this.la() != null) {
            if (this.la().type === HtmlTokenType['<']) {
                ast.push(this.tag());
            }
            else if (this.la().type === HtmlTokenType['</']) {
                this.advance();
            }
            else {
                this.advance();
            }
        }
        return ast;
    }
    tag() {
        const first = this.advance();
        const name = first.text.substring(1);
        const attrs = this.attributes();
        if (this.la() == null) {
            this.throwError('EOF');
        }
        const last = this.advance(); // >
        return { name, attrs, start: first.start, end: last.end };
    }
    attributes() {
        const attrs = {};
        while (this.la() && !this.isNextTypes(HtmlTokenType['>']) && !this.isNextTypes(HtmlTokenType['/>'])) {
            if (this.isNgAttrName()) {
                const key = this.ngAttrName();
                attrs[key] = { isNg: true, value: this.attrValue() };
            }
            else if (this.la().type === HtmlTokenType.identity) {
                const key = this.attrName();
                attrs[key] = { isNg: false, value: this.attrValue() };
            }
            else if (this.isNextTypes(HtmlTokenType.space)) {
                this.advance();
            }
            else {
                console.log('Previous tokens: ', this.lb().text);
                this.throwError(this.la().text);
            }
        }
        return attrs;
    }
    isNgAttrName() {
        if (this.la() == null)
            this.throwError('End of file');
        const type = this.la().type;
        return type === HtmlTokenType['['] || type === HtmlTokenType['('];
    }
    ngAttrName() {
        if (this.la() == null)
            this.throwError('End of file');
        const kind = this.la().type === HtmlTokenType['['] ? HtmlTokenType[']'] : HtmlTokenType[')'];
        let name;
        this.advance();
        if (this.isNgAttrName())
            name = this.ngAttrName();
        else
            name = this.attrName();
        if (this.la().type !== kind)
            this.throwError(this.la().text);
        this.advance();
        return name;
    }
    attrName() {
        return this.advance().text;
    }
    attrValue() {
        if (this.la() && this.la().type === HtmlTokenType['=']) {
            // let {text, start, end} = this.advance(2);
            // return {text, start, end};
            this.advance();
            let start = this.la() && this.la().start;
            if (this.isNextTypes(HtmlTokenType.qm)) {
                const endText = this.advance().text;
                start = this.la() && this.la().start;
                while (this.la() && !this.isNextTokenText(endText)) {
                    this.advance();
                }
                if (this.la() == null) {
                    this.throwError('end of file');
                }
                const end = this.lb().end;
                this.advance();
                // console.log('value:', this.text.slice(start, end));
                return {
                    text: this.text.slice(start, end),
                    start: start,
                    end
                };
            }
            while (this.la() && !this.isNextTypes(HtmlTokenType.space) &&
                !this.isNextTypes(HtmlTokenType['>'])) {
                this.advance();
            }
            if (this.la() == null) {
                this.throwError('end of file');
            }
            const end = this.lb().end;
            // console.log('value:', this.text.slice(start, end));
            return {
                text: this.text.slice(start, end),
                start: start,
                end
            };
        }
        else {
            return;
        }
    }
}
exports.TemplateParser = TemplateParser;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AZHItY29yZS9uZy1hcHAtYnVpbGRlci90cy91dGlscy9uZy1odG1sLXBhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlGQUFpRjtBQUNqRiw4RUFBc0Y7QUFFdEYsSUFBWSxhQWdCWDtBQWhCRCxXQUFZLGFBQWE7SUFDdkIsWUFBWTtJQUNaLDJDQUFHLENBQUE7SUFDSCwyQ0FBRyxDQUFBO0lBQ0gsNkNBQUksQ0FBQTtJQUNKLDJDQUFHLENBQUE7SUFDSCwyQ0FBRyxDQUFBO0lBQ0gsMkNBQUcsQ0FBQTtJQUNILDJDQUFHLENBQUE7SUFDSCw2Q0FBSSxDQUFBO0lBQ0osMkNBQUcsQ0FBQTtJQUNILDZDQUFFLENBQUE7SUFDRiwwREFBUSxDQUFBO0lBQ1Isb0VBQWEsQ0FBQTtJQUNiLGdEQUFHLENBQUE7SUFDSCxvREFBSyxDQUFBO0FBQ1AsQ0FBQyxFQWhCVyxhQUFhLEdBQWIscUJBQWEsS0FBYixxQkFBYSxRQWdCeEI7QUFFd0Isa0NBQVM7QUFDbEMsTUFBYSxhQUFjLFNBQVEsMkJBQXdCO0lBQ3pELENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ2hCLE9BQU8sSUFBSSxFQUFFO1lBQ1gsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1osSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ3JCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDNUIsSUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO2dCQUNoQixPQUFPO2FBQ1I7WUFDRCxRQUFRLElBQUksRUFBRTtnQkFDWixLQUFLLEdBQUcsQ0FBQztnQkFDVCxLQUFLLEdBQUcsQ0FBQztnQkFDVCxLQUFLLEdBQUcsQ0FBQztnQkFDVCxLQUFLLEdBQUcsQ0FBQztnQkFDVCxLQUFLLEdBQUcsQ0FBQztnQkFDVCxLQUFLLEdBQUc7b0JBQ04sSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO29CQUNmLE1B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RUFBRSxDQUFDO2FBQ2hCO1lBQ0QsSUFBSSxJQUFJLENBQUMsRUFBRSxFQUFFLElBQUksSUFBSSxFQUFFO2dCQUNyQixJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2FBQ2hDO1lBQ0QsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRyxDQUFDLEdBQUcsQ0FBQztZQUMzQixzREFBc0Q7WUFDdEQsT0FBTztnQkFDTCxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBTSxFQUFFLEdBQUcsQ0FBQztnQkFDbEMsS0FBSyxFQUFFLEtBQU07Z0JBQ2IsR0FBRzthQUNKLENBQUM7U0FDSDthQUFNO1lBQ0wsT0FBTztTQUNSO0lBQ0gsQ0FBQztDQUNGO0FBbklELHdDQW1JQyIsImZpbGUiOiJub2RlX21vZHVsZXMvQGRyLWNvcmUvbmctYXBwLWJ1aWxkZXIvZGlzdC91dGlscy9uZy1odG1sLXBhcnNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIHRzbGludDpkaXNhYmxlIG1heC1jbGFzc2VzLXBlci1maWxlIG1heC1saW5lLWxlbmd0aCBuby1jb25zb2xlIGpzZG9jLWZvcm1hdCAqL1xuaW1wb3J0IHtUb2tlbiwgQmFzZVBhcnNlciwgQmFzZUxleGVyfSBmcm9tICdkci1jb21wLXBhY2thZ2Uvd2ZoL2Rpc3QvYmFzZS1MTG4tcGFyc2VyJztcblxuZXhwb3J0IGVudW0gSHRtbFRva2VuVHlwZSB7XG4gIC8vIGNvbW1lbnRzLFxuICAnPCcsXG4gICc+JyxcbiAgJy8+JyxcbiAgJygnLFxuICAnKScsXG4gICdbJyxcbiAgJ10nLFxuICAnPC8nLFxuICAnPScsXG4gIHFtLCAvLyBxdW90YXRpb24gbWFya1xuICBpZGVudGl0eSxcbiAgc3RyaW5nTGl0ZXJhbCxcbiAgYW55LCAvLyAuKlxuICBzcGFjZVxufVxuXG5leHBvcnQge0h0bWxUb2tlblR5cGUgYXMgVG9rZW5UeXBlfTtcbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZUxleGVyIGV4dGVuZHMgQmFzZUxleGVyPEh0bWxUb2tlblR5cGU+IHtcbiAgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhdG9yPFRva2VuPEh0bWxUb2tlblR5cGU+PiB7XG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIHRoaXMuc2tpcCgpO1xuICAgICAgbGV0IGNoYXIgPSB0aGlzLmxhKCk7XG4gICAgICBjb25zdCBzdGFydCA9IHRoaXMucG9zaXRpb247XG4gICAgICBpZiAoY2hhciA9PSBudWxsKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHN3aXRjaCAoY2hhcikge1xuICAgICAgICBjYXNlICc+JzpcbiAgICAgICAgY2FzZSAnKCc6XG4gICAgICAgIGNhc2UgJyknOlxuICAgICAgICBjYXNlICdbJzpcbiAgICAgICAgY2FzZSAnXSc6XG4gICAgICAgIGNhc2UgJz0nOlxuICAgICAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgICAgIHlpZWxkIG5ldyBUb2tlbihIdG1sVG9rZW5UeXBlW2NoYXJdLCB0aGlzLCBzdGFydCk7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIGNhc2UgJ1wiJzpcbiAgICAgICAgY2FzZSAnXFwnJzpcbiAgICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgICAgICB5aWVsZCBuZXcgVG9rZW4oSHRtbFRva2VuVHlwZS5xbSwgdGhpcywgc3RhcnQpO1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgfVxuICAgICAgaWYgKGNoYXIgPT09ICc8JyAmJiB0aGlzLmlzSWRTdGFydCgyKSkge1xuICAgICAgICB5aWVsZCB0aGlzLm9wZW5UYWdTdGFydCgpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTmV4dCgnPC8nKSkge1xuICAgICAgICB5aWVsZCB0aGlzLmNsb3NlVGFnU3RhcnQoKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc05leHQoJy8+JykpIHtcbiAgICAgICAgdGhpcy5hZHZhbmNlKDIpO1xuICAgICAgICB5aWVsZCBuZXcgVG9rZW4oSHRtbFRva2VuVHlwZVsnLz4nXSwgdGhpcywgc3RhcnQpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmlzSWRTdGFydCgpKSB7XG4gICAgICAgIGRvIHtcbiAgICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgICAgICBjaGFyID0gdGhpcy5sYSgpO1xuICAgICAgICB9IHdoaWxlICh0aGlzLmlzSWRTdGFydCgpKTtcbiAgICAgICAgeWllbGQgbmV3IFRva2VuKEh0bWxUb2tlblR5cGUuaWRlbnRpdHksIHRoaXMsIHN0YXJ0KTtcbiAgICAgIC8vIH0gZWxzZSBpZiAoY2hhciA9PT0gJ1wiJykge1xuICAgICAgLy8gXHR5aWVsZCB0aGlzLnN0cmluZ0xpdCgnXCInKTtcbiAgICAgIC8vIH0gZWxzZSBpZiAoY2hhciA9PT0gJ1xcJycpIHtcbiAgICAgIC8vIFx0eWllbGQgdGhpcy5zdHJpbmdMaXQoJ1xcJycpO1xuICAgICAgLy8gfSBlbHNlIGlmIChjaGFyID09PSAnYCcpIHtcbiAgICAgIC8vIFx0eWllbGQgdGhpcy5zdHJpbmdMaXQoJ2AnKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc1doaXRlc3BhY2UoKSkge1xuICAgICAgICBkbyB7XG4gICAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICAgIH0gd2hpbGUgKHRoaXMuaXNXaGl0ZXNwYWNlKCkpO1xuICAgICAgICB5aWVsZCBuZXcgVG9rZW4oSHRtbFRva2VuVHlwZS5zcGFjZSwgdGhpcywgc3RhcnQpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHlpZWxkIG5ldyBUb2tlbihIdG1sVG9rZW5UeXBlLmFueSwgdGhpcywgc3RhcnQpO1xuICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgb3BlblRhZ1N0YXJ0KCkge1xuICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5wb3NpdGlvbjtcbiAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICBkbyB7XG4gICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICB9IHdoaWxlICh0aGlzLmlzSWRTdGFydCgpKTtcbiAgICByZXR1cm4gbmV3IFRva2VuKEh0bWxUb2tlblR5cGVbJzwnXSwgdGhpcywgc3RhcnQpO1xuICB9XG4gIGNsb3NlVGFnU3RhcnQoKSB7XG4gICAgY29uc3Qgc3RhcnQgPSB0aGlzLnBvc2l0aW9uO1xuICAgIHRoaXMuYWR2YW5jZSgyKTtcbiAgICB3aGlsZSAodGhpcy5sYSgpICE9PSAnPicpIHtcbiAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFRva2VuKEh0bWxUb2tlblR5cGVbJzwvJ10sIHRoaXMsIHN0YXJ0KTtcbiAgfVxuICBpc0lkU3RhcnQobGFJZHggPSAxKSB7XG4gICAgY29uc3QgY2hhciA9IHRoaXMubGEobGFJZHgpO1xuICAgIGlmICghY2hhcikge1xuICAgICAgdGhpcy50aHJvd0Vycm9yKCdFT0YnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgcmV0dXJuIC9bXjw+KClcXFtcXF1cIic9YC9dLy50ZXN0KGNoYXIpICYmIC9cXFMvLnRlc3QoY2hhcik7XG4gIH1cbiAgaXNXaGl0ZXNwYWNlKCkge1xuICAgIGNvbnN0IGNociA9IHRoaXMubGEoKTtcbiAgICByZXR1cm4gY2hyICYmIC9cXHMvLnRlc3QoY2hyKTtcbiAgfVxuXG4gIHN0cmluZ0xpdChxdW90ZTogc3RyaW5nKSB7XG4gICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgY29uc3Qgc3RhcnQgPSB0aGlzLnBvc2l0aW9uO1xuICAgIGNvbnN0IFtsaW5lLCBjb2xdID0gdGhpcy5nZXRMaW5lQ29sdW1uKHN0YXJ0KTtcbiAgICB3aGlsZSAodGhpcy5sYSgpICE9PSBxdW90ZSkge1xuICAgICAgaWYgKHRoaXMubGEoKSA9PSBudWxsKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdlbmRsZXNzIHN0cmluZyBsaXRlcmFsIGJlZ2luIHdpdGggbGluZSAlcywgY29sICVzJywgbGluZSwgY29sKTtcbiAgICAgICAgdGhpcy50aHJvd0Vycm9yKCk7XG4gICAgICB9XG4gICAgICAvLyBjb25zb2xlLmxvZygnOicsIHRoaXMubGEoKSk7XG4gICAgICBpZiAodGhpcy5sYSgpID09PSAnXFxcXCcpIHtcbiAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICB9XG4gICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICB9XG4gICAgY29uc3QgdGsgPSBuZXcgVG9rZW4oSHRtbFRva2VuVHlwZS5zdHJpbmdMaXRlcmFsLCB0aGlzLCBzdGFydCk7XG4gICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgcmV0dXJuIHRrO1xuICB9XG5cbiAgc2tpcCgpIHtcbiAgICBsZXQgY2hyID0gdGhpcy5sYSgpO1xuICAgIHdoaWxlKGNociAhPSBudWxsKSB7XG4gICAgICBpZiAodGhpcy5pc0NvbW1lbnQoKSkge1xuICAgICAgICB0aGlzLmNvbW1lbnQoKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc1N3aWdDb21tZW50KCkpIHtcbiAgICAgICAgdGhpcy5zd2lnQ29tbWVudCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjaHIgPSB0aGlzLmxhKCk7XG4gICAgIH1cbiAgICAgcmV0dXJuIHRoaXMubGEoKTtcbiAgfVxuXG4gIGlzQ29tbWVudCgpIHtcbiAgICByZXR1cm4gdGhpcy5pc05leHQoJzwhLS0nKTtcbiAgfVxuICBjb21tZW50KCkge1xuICAgIHRoaXMuYWR2YW5jZSg0KTtcbiAgICB3aGlsZSghdGhpcy5pc05leHQoJy0tPicpKSB7XG4gICAgICBpZiAodGhpcy5sYSgpID09IG51bGwpXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tbWVudCBpcyBub3QgY2xvc2VkLCAnICsgdGhpcy5nZXRDdXJyZW50UG9zSW5mbygpKTtcbiAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIH1cbiAgICB0aGlzLmFkdmFuY2UoMyk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgaXNTd2lnQ29tbWVudCgpIHtcbiAgICByZXR1cm4gdGhpcy5pc05leHQoJ3sjJyk7XG4gIH1cbiAgc3dpZ0NvbW1lbnQoKSB7XG4gICAgdGhpcy5hZHZhbmNlKDIpO1xuICAgIHdoaWxlICghdGhpcy5pc05leHQoJyN9JykpIHtcbiAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRhZ0FzdCB7XG4gIG5hbWU6IHN0cmluZztcbiAgYXR0cnM/OiB7W2tleTogc3RyaW5nXToge2lzTmc6IGJvb2xlYW4sIHZhbHVlPzogQXR0cmlidXRlVmFsdWVBc3R9fTtcbiAgc3RhcnQ6IG51bWJlcjtcbiAgZW5kOiBudW1iZXI7XG4gIFtrZXk6IHN0cmluZ106IGFueTtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgQXR0cmlidXRlVmFsdWVBc3Qge1xuICB0ZXh0OiBzdHJpbmc7IHN0YXJ0OiBudW1iZXI7IGVuZDogbnVtYmVyO1xufVxuZXhwb3J0IGNsYXNzIFRlbXBsYXRlUGFyc2VyIGV4dGVuZHMgQmFzZVBhcnNlcjxIdG1sVG9rZW5UeXBlPiB7XG4gIGxleGVyOiBUZW1wbGF0ZUxleGVyO1xuICB0ZXh0OiBzdHJpbmc7XG4gIGNvbnN0cnVjdG9yKGlucHV0OiBzdHJpbmcpIHtcbiAgICBjb25zdCBsZXhlciA9IG5ldyBUZW1wbGF0ZUxleGVyKGlucHV0KTtcbiAgICBzdXBlcihsZXhlcik7XG4gICAgdGhpcy5sZXhlciA9IGxleGVyO1xuICAgIHRoaXMudGV4dCA9IGlucHV0O1xuICB9XG5cbiAgZ2V0Q3VycmVudFBvc0luZm8oKTogc3RyaW5nIHtcbiAgICBjb25zdCBzdGFydCA9IHRoaXMubGEoKSA/IHRoaXMubGEoKSEuc3RhcnQgOiBudWxsO1xuICAgIGlmIChzdGFydCkge1xuICAgICAgY29uc3QgbGluZUNvbCA9IHRoaXMubGV4ZXIuZ2V0TGluZUNvbHVtbihzdGFydCk7XG4gICAgICByZXR1cm4gYExpbmUgJHtsaW5lQ29sWzBdICsgMX0gY29sdW1uICR7bGluZUNvbFsxXSArIDF9YDtcbiAgICB9XG4gICAgcmV0dXJuICc8ZW5kIG9mIGZpbGU+JztcbiAgfVxuICBza2lwKCkge1xuICAgIHdoaWxlICh0aGlzLmxhKCkgIT0gbnVsbCAmJiB0aGlzLmxhKCkhLnR5cGUgPT09IEh0bWxUb2tlblR5cGUuc3BhY2UpIHtcbiAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIH1cbiAgfVxuICBwYXJzZSgpOiBUYWdBc3RbXSB7XG4gICAgY29uc3QgYXN0OiBUYWdBc3RbXSA9IFtdO1xuICAgIHdoaWxlKHRoaXMubGEoKSAhPSBudWxsKSB7XG4gICAgICBpZiAodGhpcy5sYSgpIS50eXBlID09PSBIdG1sVG9rZW5UeXBlWyc8J10pIHtcbiAgICAgICAgYXN0LnB1c2godGhpcy50YWcoKSk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMubGEoKSEudHlwZSA9PT0gSHRtbFRva2VuVHlwZVsnPC8nXSkge1xuICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYXN0O1xuICB9XG4gIHRhZygpOiBUYWdBc3Qge1xuICAgIGNvbnN0IGZpcnN0ID0gdGhpcy5hZHZhbmNlKCkhO1xuICAgIGNvbnN0IG5hbWUgPSBmaXJzdC50ZXh0LnN1YnN0cmluZygxKTtcbiAgICBjb25zdCBhdHRycyA9IHRoaXMuYXR0cmlidXRlcygpO1xuICAgIGlmICh0aGlzLmxhKCkgPT1udWxsKSB7XG4gICAgICB0aGlzLnRocm93RXJyb3IoJ0VPRicpO1xuICAgIH1cbiAgICBjb25zdCBsYXN0ID0gdGhpcy5hZHZhbmNlKCk7IC8vID5cbiAgICByZXR1cm4ge25hbWUsIGF0dHJzLCBzdGFydDogZmlyc3Quc3RhcnQsIGVuZDogbGFzdCEuZW5kfTtcbiAgfVxuICBhdHRyaWJ1dGVzKCk6IHtba2V5OiBzdHJpbmddOiB7aXNOZzogYm9vbGVhbiwgdmFsdWU6IEF0dHJpYnV0ZVZhbHVlQXN0IHwgdW5kZWZpbmVkfX0ge1xuICAgIGNvbnN0IGF0dHJzOiB7W2tleTogc3RyaW5nXToge2lzTmc6IGJvb2xlYW4sIHZhbHVlOiBBdHRyaWJ1dGVWYWx1ZUFzdCB8IHVuZGVmaW5lZH19ID0ge307XG4gICAgd2hpbGUgKHRoaXMubGEoKSAmJiAhdGhpcy5pc05leHRUeXBlcyhIdG1sVG9rZW5UeXBlWyc+J10pICYmICF0aGlzLmlzTmV4dFR5cGVzKEh0bWxUb2tlblR5cGVbJy8+J10pKSB7XG4gICAgICBpZiAodGhpcy5pc05nQXR0ck5hbWUoKSkge1xuICAgICAgICBjb25zdCBrZXkgPSB0aGlzLm5nQXR0ck5hbWUoKTtcbiAgICAgICAgYXR0cnNba2V5XSA9IHtpc05nOiB0cnVlLCB2YWx1ZTogdGhpcy5hdHRyVmFsdWUoKX07XG4gICAgICB9IGVsc2UgaWYgKHRoaXMubGEoKSEudHlwZSA9PT0gSHRtbFRva2VuVHlwZS5pZGVudGl0eSkge1xuICAgICAgICBjb25zdCBrZXkgPSB0aGlzLmF0dHJOYW1lKCk7XG4gICAgICAgIGF0dHJzW2tleV0gPSB7aXNOZzogZmFsc2UsIHZhbHVlOiB0aGlzLmF0dHJWYWx1ZSgpfTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc05leHRUeXBlcyhIdG1sVG9rZW5UeXBlLnNwYWNlKSkge1xuICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdQcmV2aW91cyB0b2tlbnM6ICcsIHRoaXMubGIoKSEudGV4dCk7XG4gICAgICAgIHRoaXMudGhyb3dFcnJvcih0aGlzLmxhKCkhLnRleHQpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYXR0cnM7XG4gIH1cbiAgaXNOZ0F0dHJOYW1lKCkge1xuICAgIGlmICh0aGlzLmxhKCkgPT0gbnVsbClcbiAgICAgIHRoaXMudGhyb3dFcnJvcignRW5kIG9mIGZpbGUnKTtcbiAgICBjb25zdCB0eXBlID0gdGhpcy5sYSgpIS50eXBlO1xuICAgIHJldHVybiB0eXBlID09PSBIdG1sVG9rZW5UeXBlWydbJ10gfHwgdHlwZSA9PT0gSHRtbFRva2VuVHlwZVsnKCddO1xuICB9XG4gIG5nQXR0ck5hbWUoKSB7XG4gICAgaWYgKHRoaXMubGEoKSA9PSBudWxsKVxuICAgICAgdGhpcy50aHJvd0Vycm9yKCdFbmQgb2YgZmlsZScpO1xuICAgIGNvbnN0IGtpbmQgPSB0aGlzLmxhKCkhLnR5cGUgPT09IEh0bWxUb2tlblR5cGVbJ1snXSA/IEh0bWxUb2tlblR5cGVbJ10nXSA6IEh0bWxUb2tlblR5cGVbJyknXTtcbiAgICBsZXQgbmFtZTogc3RyaW5nO1xuICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIGlmICh0aGlzLmlzTmdBdHRyTmFtZSgpKVxuICAgICAgbmFtZSA9IHRoaXMubmdBdHRyTmFtZSgpO1xuICAgIGVsc2VcbiAgICAgIG5hbWUgPSB0aGlzLmF0dHJOYW1lKCk7XG4gICAgaWYgKHRoaXMubGEoKSEudHlwZSAhPT0ga2luZClcbiAgICAgIHRoaXMudGhyb3dFcnJvcih0aGlzLmxhKCkhLnRleHQpO1xuICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIHJldHVybiBuYW1lO1xuICB9XG4gIGF0dHJOYW1lKCkge1xuICAgIHJldHVybiB0aGlzLmFkdmFuY2UoKSEudGV4dDtcbiAgfVxuICBhdHRyVmFsdWUoKTogQXR0cmlidXRlVmFsdWVBc3QgfCB1bmRlZmluZWQge1xuICAgIGlmICh0aGlzLmxhKCkgJiYgdGhpcy5sYSgpIS50eXBlID09PSBIdG1sVG9rZW5UeXBlWyc9J10pIHtcbiAgICAgIC8vIGxldCB7dGV4dCwgc3RhcnQsIGVuZH0gPSB0aGlzLmFkdmFuY2UoMik7XG4gICAgICAvLyByZXR1cm4ge3RleHQsIHN0YXJ0LCBlbmR9O1xuICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICBsZXQgc3RhcnQgPSB0aGlzLmxhKCkgJiYgdGhpcy5sYSgpIS5zdGFydDtcbiAgICAgIGlmICh0aGlzLmlzTmV4dFR5cGVzKEh0bWxUb2tlblR5cGUucW0pKSB7XG4gICAgICAgIGNvbnN0IGVuZFRleHQgPSB0aGlzLmFkdmFuY2UoKSEudGV4dDtcbiAgICAgICAgc3RhcnQgPSB0aGlzLmxhKCkgJiYgdGhpcy5sYSgpIS5zdGFydDtcbiAgICAgICAgd2hpbGUgKHRoaXMubGEoKSAmJiAhdGhpcy5pc05leHRUb2tlblRleHQoZW5kVGV4dCkpIHtcbiAgICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5sYSgpID09IG51bGwpIHtcbiAgICAgICAgICB0aGlzLnRocm93RXJyb3IoJ2VuZCBvZiBmaWxlJyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZW5kID0gdGhpcy5sYigpIS5lbmQ7XG4gICAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgICAvLyBjb25zb2xlLmxvZygndmFsdWU6JywgdGhpcy50ZXh0LnNsaWNlKHN0YXJ0LCBlbmQpKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0ZXh0OiB0aGlzLnRleHQuc2xpY2Uoc3RhcnQhLCBlbmQpLFxuICAgICAgICAgIHN0YXJ0OiBzdGFydCEsXG4gICAgICAgICAgZW5kXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIHdoaWxlICh0aGlzLmxhKCkgJiYgIXRoaXMuaXNOZXh0VHlwZXMoSHRtbFRva2VuVHlwZS5zcGFjZSkgJiZcbiAgICAgICAgIXRoaXMuaXNOZXh0VHlwZXMoSHRtbFRva2VuVHlwZVsnPiddKSkge1xuICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmxhKCkgPT0gbnVsbCkge1xuICAgICAgICB0aGlzLnRocm93RXJyb3IoJ2VuZCBvZiBmaWxlJyk7XG4gICAgICB9XG4gICAgICBjb25zdCBlbmQgPSB0aGlzLmxiKCkhLmVuZDtcbiAgICAgIC8vIGNvbnNvbGUubG9nKCd2YWx1ZTonLCB0aGlzLnRleHQuc2xpY2Uoc3RhcnQsIGVuZCkpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdGV4dDogdGhpcy50ZXh0LnNsaWNlKHN0YXJ0ISwgZW5kKSxcbiAgICAgICAgc3RhcnQ6IHN0YXJ0ISxcbiAgICAgICAgZW5kXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG59XG4iXX0=
