"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/* tslint:disable max-classes-per-file max-line-length no-console jsdoc-format */
/**
 * TODO: Support parsing file with <script></script> tag contains special JS character like "<" and ">"
 */
const base_LLn_parser_1 = require("dr-comp-package/wfh/dist/base-LLn-parser");
var HtmlTokenType;
(function (HtmlTokenType) {
    // comments,
    HtmlTokenType[HtmlTokenType["<"] = 0] = "<";
    HtmlTokenType[HtmlTokenType[">"] = 1] = ">";
    HtmlTokenType[HtmlTokenType["/>"] = 2] = "/>";
    HtmlTokenType[HtmlTokenType["("] = 3] = "(";
    HtmlTokenType[HtmlTokenType[")"] = 4] = ")";
    HtmlTokenType[HtmlTokenType["["] = 5] = "[";
    HtmlTokenType[HtmlTokenType["]"] = 6] = "]";
    HtmlTokenType[HtmlTokenType["</"] = 7] = "</";
    HtmlTokenType[HtmlTokenType["="] = 8] = "=";
    HtmlTokenType[HtmlTokenType["qm"] = 9] = "qm";
    HtmlTokenType[HtmlTokenType["identity"] = 10] = "identity";
    HtmlTokenType[HtmlTokenType["stringLiteral"] = 11] = "stringLiteral";
    HtmlTokenType[HtmlTokenType["any"] = 12] = "any";
    HtmlTokenType[HtmlTokenType["space"] = 13] = "space";
})(HtmlTokenType = exports.HtmlTokenType || (exports.HtmlTokenType = {}));
exports.TokenType = HtmlTokenType;
class TemplateLexer extends base_LLn_parser_1.BaseLexer {
    *[Symbol.iterator]() {
        while (true) {
            this.skip();
            let char = this.la();
            const start = this.position;
            if (char == null) {
                return;
            }
            switch (char) {
                case '>':
                case '(':
                case ')':
                case '[':
                case ']':
                case '=':
                    this.advance();
                    yield new base_LLn_parser_1.Token(HtmlTokenType[char], this, start);
                    continue;
                case '"':
                case '\'':
                    this.advance();
                    yield new base_LLn_parser_1.Token(HtmlTokenType.qm, this, start);
                    continue;
                default:
            }
            if (char === '<' && this.isIdStart(2)) {
                yield this.openTagStart();
            }
            else if (this.isNext('</')) {
                yield this.closeTagStart();
            }
            else if (this.isNext('/>')) {
                this.advance(2);
                yield new base_LLn_parser_1.Token(HtmlTokenType['/>'], this, start);
            }
            else if (this.isIdStart()) {
                do {
                    this.advance();
                    char = this.la();
                } while (this.isIdStart());
                yield new base_LLn_parser_1.Token(HtmlTokenType.identity, this, start);
                // } else if (char === '"') {
                // 	yield this.stringLit('"');
                // } else if (char === '\'') {
                // 	yield this.stringLit('\'');
                // } else if (char === '`') {
                // 	yield this.stringLit('`');
            }
            else if (this.isWhitespace()) {
                do {
                    this.advance();
                } while (this.isWhitespace());
                yield new base_LLn_parser_1.Token(HtmlTokenType.space, this, start);
                continue;
            }
            else {
                yield new base_LLn_parser_1.Token(HtmlTokenType.any, this, start);
                this.advance();
            }
        }
    }
    openTagStart() {
        const start = this.position;
        this.advance();
        do {
            this.advance();
        } while (this.isIdStart());
        return new base_LLn_parser_1.Token(HtmlTokenType['<'], this, start);
    }
    closeTagStart() {
        const start = this.position;
        this.advance(2);
        while (this.la() !== '>') {
            this.advance();
        }
        return new base_LLn_parser_1.Token(HtmlTokenType['</'], this, start);
    }
    isIdStart(laIdx = 1) {
        const char = this.la(laIdx);
        if (!char) {
            this.throwError('EOF');
            return;
        }
        return /[^<>()\[\]"'=`/]/.test(char) && /\S/.test(char);
    }
    isWhitespace() {
        const chr = this.la();
        return chr && /\s/.test(chr);
    }
    stringLit(quote) {
        this.advance();
        const start = this.position;
        const [line, col] = this.getLineColumn(start);
        while (this.la() !== quote) {
            if (this.la() == null) {
                console.log('endless string literal begin with line %s, col %s', line, col);
                this.throwError();
            }
            // console.log(':', this.la());
            if (this.la() === '\\') {
                this.advance();
            }
            this.advance();
        }
        const tk = new base_LLn_parser_1.Token(HtmlTokenType.stringLiteral, this, start);
        this.advance();
        return tk;
    }
    skip() {
        let chr = this.la();
        while (chr != null) {
            if (this.isComment()) {
                this.comment();
            }
            else if (this.isSwigComment()) {
                this.swigComment();
            }
            else {
                break;
            }
            chr = this.la();
        }
        return this.la();
    }
    isComment() {
        return this.isNext('<!--');
    }
    comment() {
        this.advance(4);
        while (!this.isNext('-->')) {
            if (this.la() == null)
                throw new Error('Comment is not closed, ' + this.getCurrentPosInfo());
            this.advance();
        }
        this.advance(3);
        return true;
    }
    isSwigComment() {
        return this.isNext('{#');
    }
    swigComment() {
        this.advance(2);
        while (!this.isNext('#}')) {
            this.advance();
        }
    }
}
exports.TemplateLexer = TemplateLexer;
class TemplateParser extends base_LLn_parser_1.BaseParser {
    constructor(input) {
        const lexer = new TemplateLexer(input);
        super(lexer);
        this.lexer = lexer;
        this.text = input;
    }
    getCurrentPosInfo() {
        const start = this.la() ? this.la().start : null;
        if (start) {
            const lineCol = this.lexer.getLineColumn(start);
            return `Line ${lineCol[0] + 1} column ${lineCol[1] + 1}`;
        }
        return '<end of file>';
    }
    skip() {
        while (this.la() != null && this.la().type === HtmlTokenType.space) {
            this.advance();
        }
    }
    parse() {
        const ast = [];
        while (this.la() != null) {
            if (this.la().type === HtmlTokenType['<']) {
                ast.push(this.tag());
            }
            else if (this.la().type === HtmlTokenType['</']) {
                this.advance();
            }
            else {
                this.advance();
            }
        }
        return ast;
    }
    tag() {
        const first = this.advance();
        const name = first.text.substring(1);
        const attrs = this.attributes();
        if (this.la() == null) {
            this.throwError('EOF');
        }
        const last = this.advance(); // >
        return { name, attrs, start: first.start, end: last.end };
    }
    attributes() {
        const attrs = {};
        while (this.la() && !this.isNextTypes(HtmlTokenType['>']) && !this.isNextTypes(HtmlTokenType['/>'])) {
            if (this.isNgAttrName()) {
                const key = this.ngAttrName();
                attrs[key] = { isNg: true, value: this.attrValue() };
            }
            else if (this.la().type === HtmlTokenType.identity) {
                const key = this.attrName();
                attrs[key] = { isNg: false, value: this.attrValue() };
            }
            else if (this.isNextTypes(HtmlTokenType.space)) {
                this.advance();
            }
            else {
                console.log('Previous tokens: ', this.lb().text);
                this.throwError(this.la().text);
            }
        }
        return attrs;
    }
    isNgAttrName() {
        if (this.la() == null)
            this.throwError('End of file');
        const type = this.la().type;
        return type === HtmlTokenType['['] || type === HtmlTokenType['('];
    }
    ngAttrName() {
        if (this.la() == null)
            this.throwError('End of file');
        const kind = this.la().type === HtmlTokenType['['] ? HtmlTokenType[']'] : HtmlTokenType[')'];
        let name;
        this.advance();
        if (this.isNgAttrName())
            name = this.ngAttrName();
        else
            name = this.attrName();
        if (this.la().type !== kind)
            this.throwError(this.la().text);
        this.advance();
        return name;
    }
    attrName() {
        return this.advance().text;
    }
    attrValue() {
        if (this.la() && this.la().type === HtmlTokenType['=']) {
            // let {text, start, end} = this.advance(2);
            // return {text, start, end};
            this.advance();
            let start = this.la() && this.la().start;
            if (this.isNextTypes(HtmlTokenType.qm)) {
                const endText = this.advance().text;
                start = this.la() && this.la().start;
                while (this.la() && !this.isNextTokenText(endText)) {
                    this.advance();
                }
                if (this.la() == null) {
                    this.throwError('end of file');
                }
                const end = this.lb().end;
                this.advance();
                // console.log('value:', this.text.slice(start, end));
                return {
                    text: this.text.slice(start, end),
                    start: start,
                    end
                };
            }
            while (this.la() && !this.isNextTypes(HtmlTokenType.space) &&
                !this.isNextTypes(HtmlTokenType['>'])) {
                this.advance();
            }
            if (this.la() == null) {
                this.throwError('end of file');
            }
            const end = this.lb().end;
            // console.log('value:', this.text.slice(start, end));
            return {
                text: this.text.slice(start, end),
                start: start,
                end
            };
        }
        else {
            return;
        }
    }
}
exports.TemplateParser = TemplateParser;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AZHItY29yZS9uZy1hcHAtYnVpbGRlci90cy91dGlscy9uZy1odG1sLXBhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlGQUFpRjtBQUNqRjs7R0FFRztBQUNILDhFQUFzRjtBQUV0RixJQUFZLGFBZ0JYO0FBaEJELFdBQVksYUFBYTtJQUN2QixZQUFZO0lBQ1osMkNBQUcsQ0FBQTtJQUNILDJDQUFHLENBQUE7SUFDSCw2Q0FBSSxDQUFBO0lBQ0osMkNBQUcsQ0FBQTtJQUNILDJDQUFHLENBQUE7SUFDSCwyQ0FBRyxDQUFBO0lBQ0gsMkNBQUcsQ0FBQTtJQUNILDZDQUFJLENBQUE7SUFDSiwyQ0FBRyxDQUFBO0lBQ0gsNkNBQUUsQ0FBQTtJQUNGLDBEQUFRLENBQUE7SUFDUixvRUFBYSxDQUFBO0lBQ2IsZ0RBQUcsQ0FBQTtJQUNILG9EQUFLLENBQUE7QUFDUCxDQUFDLEVBaEJXLGFBQWEsR0FBYixxQkFBYSxLQUFiLHFCQUFhLFFBZ0J4QjtBQUV3QixrQ0FBUztBQUNsQyxNQUFhLGFBQWMsU0FBUSwyQkFBd0I7SUFDekQsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDaEIsT0FBTyxJQUFJLEVBQUU7WUFDWCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDWixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDckIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztZQUM1QixJQUFJLElBQUksSUFBSSxJQUFJLEVBQUU7Z0JBQ2hCLE9BQU87YUFDUjtZQUNELFFBQVEsSUFBSSxFQUFFO2dCQUNaLEtBQUssR0FBRyxDQUFDO2dCQUNULEtBQUssR0FBRyxDQUFDO2dCQUNULEtBQUssR0FBRyxDQUFDO2dCQUNULEtBQUssR0FBRyxDQUFDO2dCQUNULEtBQUssR0FBRyxDQUFDO2dCQUNULEtBQUssR0FBRztvQkFDTixJQUFJLENBQUMsT0FBTyxFQUFFLENB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LENBQUMsT0FBTyxFQUFFLENBQUM7YUFDaEI7WUFDRCxJQUFJLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxJQUFJLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUM7YUFDaEM7WUFDRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFHLENBQUMsR0FBRyxDQUFDO1lBQzNCLHNEQUFzRDtZQUN0RCxPQUFPO2dCQUNMLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFNLEVBQUUsR0FBRyxDQUFDO2dCQUNsQyxLQUFLLEVBQUUsS0FBTTtnQkFDYixHQUFHO2FBQ0osQ0FBQztTQUNIO2FBQU07WUFDTCxPQUFPO1NBQ1I7SUFDSCxDQUFDO0NBQ0Y7QUFuSUQsd0NBbUlDIiwiZmlsZSI6Im5vZGVfbW9kdWxlcy9AZHItY29yZS9uZy1hcHAtYnVpbGRlci9kaXN0L3V0aWxzL25nLWh0bWwtcGFyc2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogdHNsaW50OmRpc2FibGUgbWF4LWNsYXNzZXMtcGVyLWZpbGUgbWF4LWxpbmUtbGVuZ3RoIG5vLWNvbnNvbGUganNkb2MtZm9ybWF0ICovXG4vKipcbiAqIFRPRE86IFN1cHBvcnQgcGFyc2luZyBmaWxlIHdpdGggPHNjcmlwdD48L3NjcmlwdD4gdGFnIGNvbnRhaW5zIHNwZWNpYWwgSlMgY2hhcmFjdGVyIGxpa2UgXCI8XCIgYW5kIFwiPlwiXG4gKi9cbmltcG9ydCB7VG9rZW4sIEJhc2VQYXJzZXIsIEJhc2VMZXhlcn0gZnJvbSAnZHItY29tcC1wYWNrYWdlL3dmaC9kaXN0L2Jhc2UtTExuLXBhcnNlcic7XG5cbmV4cG9ydCBlbnVtIEh0bWxUb2tlblR5cGUge1xuICAvLyBjb21tZW50cyxcbiAgJzwnLFxuICAnPicsXG4gICcvPicsXG4gICcoJyxcbiAgJyknLFxuICAnWycsXG4gICddJyxcbiAgJzwvJyxcbiAgJz0nLFxuICBxbSwgLy8gcXVvdGF0aW9uIG1hcmtcbiAgaWRlbnRpdHksXG4gIHN0cmluZ0xpdGVyYWwsXG4gIGFueSwgLy8gLipcbiAgc3BhY2Vcbn1cblxuZXhwb3J0IHtIdG1sVG9rZW5UeXBlIGFzIFRva2VuVHlwZX07XG5leHBvcnQgY2xhc3MgVGVtcGxhdGVMZXhlciBleHRlbmRzIEJhc2VMZXhlcjxIdG1sVG9rZW5UeXBlPiB7XG4gICpbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYXRvcjxUb2tlbjxIdG1sVG9rZW5UeXBlPj4ge1xuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICB0aGlzLnNraXAoKTtcbiAgICAgIGxldCBjaGFyID0gdGhpcy5sYSgpO1xuICAgICAgY29uc3Qgc3RhcnQgPSB0aGlzLnBvc2l0aW9uO1xuICAgICAgaWYgKGNoYXIgPT0gbnVsbCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBzd2l0Y2ggKGNoYXIpIHtcbiAgICAgICAgY2FzZSAnPic6XG4gICAgICAgIGNhc2UgJygnOlxuICAgICAgICBjYXNlICcpJzpcbiAgICAgICAgY2FzZSAnWyc6XG4gICAgICAgIGNhc2UgJ10nOlxuICAgICAgICBjYXNlICc9JzpcbiAgICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgICAgICB5aWVsZCBuZXcgVG9rZW4oSHRtbFRva2VuVHlwZVtjaGFyXSwgdGhpcywgc3RhcnQpO1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICBjYXNlICdcIic6XG4gICAgICAgIGNhc2UgJ1xcJyc6XG4gICAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICAgICAgeWllbGQgbmV3IFRva2VuKEh0bWxUb2tlblR5cGUucW0sIHRoaXMsIHN0YXJ0KTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgIH1cbiAgICAgIGlmIChjaGFyID09PSAnPCcgJiYgdGhpcy5pc0lkU3RhcnQoMikpIHtcbiAgICAgICAgeWllbGQgdGhpcy5vcGVuVGFnU3RhcnQoKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc05leHQoJzwvJykpIHtcbiAgICAgICAgeWllbGQgdGhpcy5jbG9zZVRhZ1N0YXJ0KCk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuaXNOZXh0KCcvPicpKSB7XG4gICAgICAgIHRoaXMuYWR2YW5jZSgyKTtcbiAgICAgICAgeWllbGQgbmV3IFRva2VuKEh0bWxUb2tlblR5cGVbJy8+J10sIHRoaXMsIHN0YXJ0KTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0lkU3RhcnQoKSkge1xuICAgICAgICBkbyB7XG4gICAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICAgICAgY2hhciA9IHRoaXMubGEoKTtcbiAgICAgICAgfSB3aGlsZSAodGhpcy5pc0lkU3RhcnQoKSk7XG4gICAgICAgIHlpZWxkIG5ldyBUb2tlbihIdG1sVG9rZW5UeXBlLmlkZW50aXR5LCB0aGlzLCBzdGFydCk7XG4gICAgICAvLyB9IGVsc2UgaWYgKGNoYXIgPT09ICdcIicpIHtcbiAgICAgIC8vIFx0eWllbGQgdGhpcy5zdHJpbmdMaXQoJ1wiJyk7XG4gICAgICAvLyB9IGVsc2UgaWYgKGNoYXIgPT09ICdcXCcnKSB7XG4gICAgICAvLyBcdHlpZWxkIHRoaXMuc3RyaW5nTGl0KCdcXCcnKTtcbiAgICAgIC8vIH0gZWxzZSBpZiAoY2hhciA9PT0gJ2AnKSB7XG4gICAgICAvLyBcdHlpZWxkIHRoaXMuc3RyaW5nTGl0KCdgJyk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuaXNXaGl0ZXNwYWNlKCkpIHtcbiAgICAgICAgZG8ge1xuICAgICAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgICB9IHdoaWxlICh0aGlzLmlzV2hpdGVzcGFjZSgpKTtcbiAgICAgICAgeWllbGQgbmV3IFRva2VuKEh0bWxUb2tlblR5cGUuc3BhY2UsIHRoaXMsIHN0YXJ0KTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB5aWVsZCBuZXcgVG9rZW4oSHRtbFRva2VuVHlwZS5hbnksIHRoaXMsIHN0YXJ0KTtcbiAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIG9wZW5UYWdTdGFydCgpIHtcbiAgICBjb25zdCBzdGFydCA9IHRoaXMucG9zaXRpb247XG4gICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgZG8ge1xuICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgfSB3aGlsZSAodGhpcy5pc0lkU3RhcnQoKSk7XG4gICAgcmV0dXJuIG5ldyBUb2tlbihIdG1sVG9rZW5UeXBlWyc8J10sIHRoaXMsIHN0YXJ0KTtcbiAgfVxuICBjbG9zZVRhZ1N0YXJ0KCkge1xuICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5wb3NpdGlvbjtcbiAgICB0aGlzLmFkdmFuY2UoMik7XG4gICAgd2hpbGUgKHRoaXMubGEoKSAhPT0gJz4nKSB7XG4gICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBUb2tlbihIdG1sVG9rZW5UeXBlWyc8LyddLCB0aGlzLCBzdGFydCk7XG4gIH1cbiAgaXNJZFN0YXJ0KGxhSWR4ID0gMSkge1xuICAgIGNvbnN0IGNoYXIgPSB0aGlzLmxhKGxhSWR4KTtcbiAgICBpZiAoIWNoYXIpIHtcbiAgICAgIHRoaXMudGhyb3dFcnJvcignRU9GJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHJldHVybiAvW148PigpXFxbXFxdXCInPWAvXS8udGVzdChjaGFyKSAmJiAvXFxTLy50ZXN0KGNoYXIpO1xuICB9XG4gIGlzV2hpdGVzcGFjZSgpIHtcbiAgICBjb25zdCBjaHIgPSB0aGlzLmxhKCk7XG4gICAgcmV0dXJuIGNociAmJiAvXFxzLy50ZXN0KGNocik7XG4gIH1cblxuICBzdHJpbmdMaXQocXVvdGU6IHN0cmluZykge1xuICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5wb3NpdGlvbjtcbiAgICBjb25zdCBbbGluZSwgY29sXSA9IHRoaXMuZ2V0TGluZUNvbHVtbihzdGFydCk7XG4gICAgd2hpbGUgKHRoaXMubGEoKSAhPT0gcXVvdGUpIHtcbiAgICAgIGlmICh0aGlzLmxhKCkgPT0gbnVsbCkge1xuICAgICAgICBjb25zb2xlLmxvZygnZW5kbGVzcyBzdHJpbmcgbGl0ZXJhbCBiZWdpbiB3aXRoIGxpbmUgJXMsIGNvbCAlcycsIGxpbmUsIGNvbCk7XG4gICAgICAgIHRoaXMudGhyb3dFcnJvcigpO1xuICAgICAgfVxuICAgICAgLy8gY29uc29sZS5sb2coJzonLCB0aGlzLmxhKCkpO1xuICAgICAgaWYgKHRoaXMubGEoKSA9PT0gJ1xcXFwnKSB7XG4gICAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgfVxuICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgfVxuICAgIGNvbnN0IHRrID0gbmV3IFRva2VuKEh0bWxUb2tlblR5cGUuc3RyaW5nTGl0ZXJhbCwgdGhpcywgc3RhcnQpO1xuICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIHJldHVybiB0aztcbiAgfVxuXG4gIHNraXAoKSB7XG4gICAgbGV0IGNociA9IHRoaXMubGEoKTtcbiAgICB3aGlsZShjaHIgIT0gbnVsbCkge1xuICAgICAgaWYgKHRoaXMuaXNDb21tZW50KCkpIHtcbiAgICAgICAgdGhpcy5jb21tZW50KCk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuaXNTd2lnQ29tbWVudCgpKSB7XG4gICAgICAgIHRoaXMuc3dpZ0NvbW1lbnQoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2hyID0gdGhpcy5sYSgpO1xuICAgICB9XG4gICAgIHJldHVybiB0aGlzLmxhKCk7XG4gIH1cblxuICBpc0NvbW1lbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNOZXh0KCc8IS0tJyk7XG4gIH1cbiAgY29tbWVudCgpIHtcbiAgICB0aGlzLmFkdmFuY2UoNCk7XG4gICAgd2hpbGUoIXRoaXMuaXNOZXh0KCctLT4nKSkge1xuICAgICAgaWYgKHRoaXMubGEoKSA9PSBudWxsKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvbW1lbnQgaXMgbm90IGNsb3NlZCwgJyArIHRoaXMuZ2V0Q3VycmVudFBvc0luZm8oKSk7XG4gICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICB9XG4gICAgdGhpcy5hZHZhbmNlKDMpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIGlzU3dpZ0NvbW1lbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNOZXh0KCd7IycpO1xuICB9XG4gIHN3aWdDb21tZW50KCkge1xuICAgIHRoaXMuYWR2YW5jZSgyKTtcbiAgICB3aGlsZSAoIXRoaXMuaXNOZXh0KCcjfScpKSB7XG4gICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBUYWdBc3Qge1xuICBuYW1lOiBzdHJpbmc7XG4gIGF0dHJzPzoge1trZXk6IHN0cmluZ106IHtpc05nOiBib29sZWFuLCB2YWx1ZT86IEF0dHJpYnV0ZVZhbHVlQXN0fX07XG4gIHN0YXJ0OiBudW1iZXI7XG4gIGVuZDogbnVtYmVyO1xuICBba2V5OiBzdHJpbmddOiBhbnk7XG59XG5leHBvcnQgaW50ZXJmYWNlIEF0dHJpYnV0ZVZhbHVlQXN0IHtcbiAgdGV4dDogc3RyaW5nOyBzdGFydDogbnVtYmVyOyBlbmQ6IG51bWJlcjtcbn1cbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZVBhcnNlciBleHRlbmRzIEJhc2VQYXJzZXI8SHRtbFRva2VuVHlwZT4ge1xuICBsZXhlcjogVGVtcGxhdGVMZXhlcjtcbiAgdGV4dDogc3RyaW5nO1xuICBjb25zdHJ1Y3RvcihpbnB1dDogc3RyaW5nKSB7XG4gICAgY29uc3QgbGV4ZXIgPSBuZXcgVGVtcGxhdGVMZXhlcihpbnB1dCk7XG4gICAgc3VwZXIobGV4ZXIpO1xuICAgIHRoaXMubGV4ZXIgPSBsZXhlcjtcbiAgICB0aGlzLnRleHQgPSBpbnB1dDtcbiAgfVxuXG4gIGdldEN1cnJlbnRQb3NJbmZvKCk6IHN0cmluZyB7XG4gICAgY29uc3Qgc3RhcnQgPSB0aGlzLmxhKCkgPyB0aGlzLmxhKCkhLnN0YXJ0IDogbnVsbDtcbiAgICBpZiAoc3RhcnQpIHtcbiAgICAgIGNvbnN0IGxpbmVDb2wgPSB0aGlzLmxleGVyLmdldExpbmVDb2x1bW4oc3RhcnQpO1xuICAgICAgcmV0dXJuIGBMaW5lICR7bGluZUNvbFswXSArIDF9IGNvbHVtbiAke2xpbmVDb2xbMV0gKyAxfWA7XG4gICAgfVxuICAgIHJldHVybiAnPGVuZCBvZiBmaWxlPic7XG4gIH1cbiAgc2tpcCgpIHtcbiAgICB3aGlsZSAodGhpcy5sYSgpICE9IG51bGwgJiYgdGhpcy5sYSgpIS50eXBlID09PSBIdG1sVG9rZW5UeXBlLnNwYWNlKSB7XG4gICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICB9XG4gIH1cbiAgcGFyc2UoKTogVGFnQXN0W10ge1xuICAgIGNvbnN0IGFzdDogVGFnQXN0W10gPSBbXTtcbiAgICB3aGlsZSh0aGlzLmxhKCkgIT0gbnVsbCkge1xuICAgICAgaWYgKHRoaXMubGEoKSEudHlwZSA9PT0gSHRtbFRva2VuVHlwZVsnPCddKSB7XG4gICAgICAgIGFzdC5wdXNoKHRoaXMudGFnKCkpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmxhKCkhLnR5cGUgPT09IEh0bWxUb2tlblR5cGVbJzwvJ10pIHtcbiAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGFzdDtcbiAgfVxuICB0YWcoKTogVGFnQXN0IHtcbiAgICBjb25zdCBmaXJzdCA9IHRoaXMuYWR2YW5jZSgpITtcbiAgICBjb25zdCBuYW1lID0gZmlyc3QudGV4dC5zdWJzdHJpbmcoMSk7XG4gICAgY29uc3QgYXR0cnMgPSB0aGlzLmF0dHJpYnV0ZXMoKTtcbiAgICBpZiAodGhpcy5sYSgpID09bnVsbCkge1xuICAgICAgdGhpcy50aHJvd0Vycm9yKCdFT0YnKTtcbiAgICB9XG4gICAgY29uc3QgbGFzdCA9IHRoaXMuYWR2YW5jZSgpOyAvLyA+XG4gICAgcmV0dXJuIHtuYW1lLCBhdHRycywgc3RhcnQ6IGZpcnN0LnN0YXJ0LCBlbmQ6IGxhc3QhLmVuZH07XG4gIH1cbiAgYXR0cmlidXRlcygpOiB7W2tleTogc3RyaW5nXToge2lzTmc6IGJvb2xlYW4sIHZhbHVlOiBBdHRyaWJ1dGVWYWx1ZUFzdCB8IHVuZGVmaW5lZH19IHtcbiAgICBjb25zdCBhdHRyczoge1trZXk6IHN0cmluZ106IHtpc05nOiBib29sZWFuLCB2YWx1ZTogQXR0cmlidXRlVmFsdWVBc3QgfCB1bmRlZmluZWR9fSA9IHt9O1xuICAgIHdoaWxlICh0aGlzLmxhKCkgJiYgIXRoaXMuaXNOZXh0VHlwZXMoSHRtbFRva2VuVHlwZVsnPiddKSAmJiAhdGhpcy5pc05leHRUeXBlcyhIdG1sVG9rZW5UeXBlWycvPiddKSkge1xuICAgICAgaWYgKHRoaXMuaXNOZ0F0dHJOYW1lKCkpIHtcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5uZ0F0dHJOYW1lKCk7XG4gICAgICAgIGF0dHJzW2tleV0gPSB7aXNOZzogdHJ1ZSwgdmFsdWU6IHRoaXMuYXR0clZhbHVlKCl9O1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmxhKCkhLnR5cGUgPT09IEh0bWxUb2tlblR5cGUuaWRlbnRpdHkpIHtcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5hdHRyTmFtZSgpO1xuICAgICAgICBhdHRyc1trZXldID0ge2lzTmc6IGZhbHNlLCB2YWx1ZTogdGhpcy5hdHRyVmFsdWUoKX07XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuaXNOZXh0VHlwZXMoSHRtbFRva2VuVHlwZS5zcGFjZSkpIHtcbiAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygnUHJldmlvdXMgdG9rZW5zOiAnLCB0aGlzLmxiKCkhLnRleHQpO1xuICAgICAgICB0aGlzLnRocm93RXJyb3IodGhpcy5sYSgpIS50ZXh0KTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGF0dHJzO1xuICB9XG4gIGlzTmdBdHRyTmFtZSgpIHtcbiAgICBpZiAodGhpcy5sYSgpID09IG51bGwpXG4gICAgICB0aGlzLnRocm93RXJyb3IoJ0VuZCBvZiBmaWxlJyk7XG4gICAgY29uc3QgdHlwZSA9IHRoaXMubGEoKSEudHlwZTtcbiAgICByZXR1cm4gdHlwZSA9PT0gSHRtbFRva2VuVHlwZVsnWyddIHx8IHR5cGUgPT09IEh0bWxUb2tlblR5cGVbJygnXTtcbiAgfVxuICBuZ0F0dHJOYW1lKCkge1xuICAgIGlmICh0aGlzLmxhKCkgPT0gbnVsbClcbiAgICAgIHRoaXMudGhyb3dFcnJvcignRW5kIG9mIGZpbGUnKTtcbiAgICBjb25zdCBraW5kID0gdGhpcy5sYSgpIS50eXBlID09PSBIdG1sVG9rZW5UeXBlWydbJ10gPyBIdG1sVG9rZW5UeXBlWyddJ10gOiBIdG1sVG9rZW5UeXBlWycpJ107XG4gICAgbGV0IG5hbWU6IHN0cmluZztcbiAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICBpZiAodGhpcy5pc05nQXR0ck5hbWUoKSlcbiAgICAgIG5hbWUgPSB0aGlzLm5nQXR0ck5hbWUoKTtcbiAgICBlbHNlXG4gICAgICBuYW1lID0gdGhpcy5hdHRyTmFtZSgpO1xuICAgIGlmICh0aGlzLmxhKCkhLnR5cGUgIT09IGtpbmQpXG4gICAgICB0aGlzLnRocm93RXJyb3IodGhpcy5sYSgpIS50ZXh0KTtcbiAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICByZXR1cm4gbmFtZTtcbiAgfVxuICBhdHRyTmFtZSgpIHtcbiAgICByZXR1cm4gdGhpcy5hZHZhbmNlKCkhLnRleHQ7XG4gIH1cbiAgYXR0clZhbHVlKCk6IEF0dHJpYnV0ZVZhbHVlQXN0IHwgdW5kZWZpbmVkIHtcbiAgICBpZiAodGhpcy5sYSgpICYmIHRoaXMubGEoKSEudHlwZSA9PT0gSHRtbFRva2VuVHlwZVsnPSddKSB7XG4gICAgICAvLyBsZXQge3RleHQsIHN0YXJ0LCBlbmR9ID0gdGhpcy5hZHZhbmNlKDIpO1xuICAgICAgLy8gcmV0dXJuIHt0ZXh0LCBzdGFydCwgZW5kfTtcbiAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgbGV0IHN0YXJ0ID0gdGhpcy5sYSgpICYmIHRoaXMubGEoKSEuc3RhcnQ7XG4gICAgICBpZiAodGhpcy5pc05leHRUeXBlcyhIdG1sVG9rZW5UeXBlLnFtKSkge1xuICAgICAgICBjb25zdCBlbmRUZXh0ID0gdGhpcy5hZHZhbmNlKCkhLnRleHQ7XG4gICAgICAgIHN0YXJ0ID0gdGhpcy5sYSgpICYmIHRoaXMubGEoKSEuc3RhcnQ7XG4gICAgICAgIHdoaWxlICh0aGlzLmxhKCkgJiYgIXRoaXMuaXNOZXh0VG9rZW5UZXh0KGVuZFRleHQpKSB7XG4gICAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubGEoKSA9PSBudWxsKSB7XG4gICAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdlbmQgb2YgZmlsZScpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGVuZCA9IHRoaXMubGIoKSEuZW5kO1xuICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ3ZhbHVlOicsIHRoaXMudGV4dC5zbGljZShzdGFydCwgZW5kKSk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdGV4dDogdGhpcy50ZXh0LnNsaWNlKHN0YXJ0ISwgZW5kKSxcbiAgICAgICAgICBzdGFydDogc3RhcnQhLFxuICAgICAgICAgIGVuZFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICB3aGlsZSAodGhpcy5sYSgpICYmICF0aGlzLmlzTmV4dFR5cGVzKEh0bWxUb2tlblR5cGUuc3BhY2UpICYmXG4gICAgICAgICF0aGlzLmlzTmV4dFR5cGVzKEh0bWxUb2tlblR5cGVbJz4nXSkpIHtcbiAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5sYSgpID09IG51bGwpIHtcbiAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdlbmQgb2YgZmlsZScpO1xuICAgICAgfVxuICAgICAgY29uc3QgZW5kID0gdGhpcy5sYigpIS5lbmQ7XG4gICAgICAvLyBjb25zb2xlLmxvZygndmFsdWU6JywgdGhpcy50ZXh0LnNsaWNlKHN0YXJ0LCBlbmQpKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRleHQ6IHRoaXMudGV4dC5zbGljZShzdGFydCEsIGVuZCksXG4gICAgICAgIHN0YXJ0OiBzdGFydCEsXG4gICAgICAgIGVuZFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxufVxuIl19
