"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ScssParser = exports.ScssLexer = exports.TokenType = void 0;
// tslint:disable no-console
const base_LLn_parser_1 = require("@wfh/plink/wfh/dist/base-LLn-parser");
var TokenType;
(function (TokenType) {
    TokenType[TokenType["skip"] = 0] = "skip";
    TokenType[TokenType["id"] = 1] = "id";
    TokenType[TokenType["function"] = 2] = "function";
    TokenType[TokenType["stringLiteral"] = 3] = "stringLiteral";
    TokenType[TokenType["any"] = 4] = "any";
    TokenType[TokenType["space"] = 5] = "space";
    TokenType[TokenType["("] = 6] = "(";
    TokenType[TokenType[")"] = 7] = ")";
})(TokenType = exports.TokenType || (exports.TokenType = {}));
class ScssLexer extends base_LLn_parser_1.BaseLexer {
    constructor() {
        super(...arguments);
        this.inParentheses = false;
    }
    *[Symbol.iterator]() {
        while (true) {
            let char = this.la();
            const start = this.position;
            if (char == null) {
                return;
            }
            if (this.la() === '/' && (this.la(2) === '/' || this.la(2) === '*')) {
                if (this.comments())
                    continue;
            }
            char = this.la();
            if (char && /\s/.test(char)) {
                this.spaces();
                continue;
            }
            switch (char) {
                case '"':
                    yield this.stringLit('"');
                    break;
                case '\'':
                    yield this.stringLit('\'');
                    break;
                case '@':
                    yield this.identity();
                    break;
                case '(':
                    this.inParentheses = true;
                case ')':
                    this.advance();
                    yield new base_LLn_parser_1.Token(TokenType[char], this, start);
                    break;
                default:
                    if (char && /[a-zA-Z0-9_\-:\$]/.test(char)) {
                        yield this.identity(TokenType.id);
                        break;
                    }
                    this.advance();
                    yield new base_LLn_parser_1.Token(TokenType.any, this, start);
                    break;
            }
        }
    }
    identity(type = TokenType.function) {
        const start = this.position;
        this.advance();
        while (this.la() && /[a-zA-Z0-9_-]/.test(this.la())) {
            this.advance();
        }
        return new base_LLn_parser_1.Token(type, this, start);
    }
    stringLit(quote) {
        this.advance();
        const start = this.position;
        while (this.la() !== quote) {
            if (this.la() == null)
                this.throwError();
            // console.log(':', this.la());
            if (this.la() === '\\') {
                this.advance();
            }
            this.advance();
        }
        const tk = new base_LLn_parser_1.Token(TokenType.stringLiteral, this, start);
        this.advance();
        return tk;
    }
    spaces() {
        const start = this.position;
        while (this.la() != null && /\s/.test(this.la())) {
            this.advance();
        }
        return new base_LLn_parser_1.Token(TokenType.skip, this, start);
    }
    comments() {
        if (this.inParentheses && this.isNext('/', '/'))
            return null; // Do not consider '//' as comment in a parentheses like ulr(http://...)
        const start = this.position;
        this.advance();
        if (this.isNext('/')) {
            this.advance(2);
            while (this.la() !== '\n' && this.la() != null) {
                this.advance();
            }
            this.advance();
        }
        else if (this.isNext('*')) {
            this.advance(2);
            while (!this.isNext('*/') && this.la() != null) {
                this.advance();
            }
            this.advance(2);
        }
        return new base_LLn_parser_1.Token(TokenType.skip, this, start);
    }
}
exports.ScssLexer = ScssLexer;
class ScssParser extends base_LLn_parser_1.BaseParser {
    getResUrl(text) {
        const res = [];
        while (this.la() != null) {
            if (this.isNextTypes(TokenType.id, TokenType['(']) &&
                this.la().text === 'url' && this.lb().text !== '@import') {
                const start = this.la(2).end;
                this.advance(2); // jump over '('
                if (this.isNextTypes(TokenType.stringLiteral)) {
                    const stringLit = this.la();
                    if (stringLit == null)
                        this.throwError('End of file');
                    this.advance();
                    res.push(stringLit);
                }
                else {
                    while (this.la() != null && this.la().type !== TokenType[')']) {
                        this.advance();
                    }
                    if (this.la() == null)
                        this.throwError('End of file');
                    const end = this.la().start;
                    res.push({ start, end, text: text.slice(start, end) });
                }
            }
            else {
                this.advance();
            }
        }
        return res;
    }
    getAllImport(text) {
        const res = [];
        while (this.la() != null) {
            if (this.isNextTypes(TokenType.function, TokenType.stringLiteral) && this.la().text === '@import') {
                res.push(this.la(2));
                this.advance(2);
            }
            else if (this.isNextTypes(TokenType.function, TokenType.id, TokenType['(']) &&
                this.la().text === '@import' && this.la(2).text === 'url') {
                const start = this.la(3).end;
                this.advance(3);
                while (this.la() != null && this.la().type !== TokenType[')']) {
                    this.advance();
                }
                if (this.la() == null)
                    throw new Error('Unexpect end of file');
                const end = this.la().start;
                this.advance();
                res.push({ start, end, text: text.slice(start, end) });
            }
            else
                this.advance();
        }
        return res;
    }
}
exports.ScssParser = ScssParser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2ltcGxlLXNjc3MtcGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2ltcGxlLXNjc3MtcGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDRCQUE0QjtBQUM1Qix5RUFBaUY7QUFFakYsSUFBWSxTQVNYO0FBVEQsV0FBWSxTQUFTO0lBQ25CLHlDQUFJLENBQUE7SUFDSixxQ0FBRSxDQUFBO0lBQ0YsaURBQVEsQ0FBQTtJQUNSLDJEQUFhLENBQUE7SUFDYix1Q0FBRyxDQUFBO0lBQ0gsMkNBQUssQ0FBQTtJQUNMLG1DQUFHLENBQUE7SUFDSCxtQ0FBRyxDQUFBO0FBQ0wsQ0FBQyxFQVRXLFNBQVMsR0FBVCxpQkFBUyxLQUFULGlCQUFTLFFBU3BCO0FBRUQsTUFBYSxTQUFVLFNBQVEsMkJBQW9CO0lBQW5EOztRQUNFLGtCQUFhLEdBQUcsS0FBSyxDQUFDO0lBa0d4QixDQUFDO0lBakdDLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ2hCLE9BQU8sSUFBSSxFQUFFO1lBQ1gsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ3JCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDNUIsSUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO2dCQUNoQixPQUFPO2FBQ1I7WUFDRCxJQUFJLElBQUksQ0FBQyxFQUFFLEVBQUUsS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxFQUFFO2dCQUNuRSxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7b0JBQ2pCLFNBQVM7YUFDWjtZQUNELElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDakIsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENB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QUcsQ0FBQyxFQUFFO29CQUM3RCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7aUJBQ2hCO2dCQUNELElBQUksSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLElBQUk7b0JBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQztnQkFDMUMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRyxDQUFDLEtBQUssQ0FBQztnQkFDN0IsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNmLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsRUFBQyxDQUFDLENBQUM7YUFDeEQ7O2dCQUNDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUNsQjtRQUNELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztDQUNGO0FBckRELGdDQXFEQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlIG5vLWNvbnNvbGVcbmltcG9ydCB7VG9rZW4sIEJhc2VQYXJzZXIsIEJhc2VMZXhlcn0gZnJvbSAnQHdmaC9wbGluay93ZmgvZGlzdC9iYXNlLUxMbi1wYXJzZXInO1xuXG5leHBvcnQgZW51bSBUb2tlblR5cGUge1xuICBza2lwLFxuICBpZCxcbiAgZnVuY3Rpb24sXG4gIHN0cmluZ0xpdGVyYWwsXG4gIGFueSxcbiAgc3BhY2UsXG4gICcoJyxcbiAgJyknXG59XG5cbmV4cG9ydCBjbGFzcyBTY3NzTGV4ZXIgZXh0ZW5kcyBCYXNlTGV4ZXI8VG9rZW5UeXBlPiB7XG4gIGluUGFyZW50aGVzZXMgPSBmYWxzZTtcbiAgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhdG9yPFRva2VuPFRva2VuVHlwZT4+IHtcbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgbGV0IGNoYXIgPSB0aGlzLmxhKCk7XG4gICAgICBjb25zdCBzdGFydCA9IHRoaXMucG9zaXRpb247XG4gICAgICBpZiAoY2hhciA9PSBudWxsKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmxhKCkgPT09ICcvJyAmJiAodGhpcy5sYSgyKSA9PT0gJy8nIHx8IHRoaXMubGEoMikgPT09ICcqJykpIHtcbiAgICAgICAgaWYgKHRoaXMuY29tbWVudHMoKSlcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNoYXIgPSB0aGlzLmxhKCk7XG4gICAgICBpZiAoY2hhciAmJiAvXFxzLy50ZXN0KGNoYXIpKSB7XG4gICAgICAgIHRoaXMuc3BhY2VzKCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgc3dpdGNoIChjaGFyKSB7XG4gICAgICAgIGNhc2UgJ1wiJzpcbiAgICAgICAgICB5aWVsZCB0aGlzLnN0cmluZ0xpdCgnXCInKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnXFwnJzpcbiAgICAgICAgICB5aWVsZCB0aGlzLnN0cmluZ0xpdCgnXFwnJyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ0AnOlxuICAgICAgICAgIHlpZWxkIHRoaXMuaWRlbnRpdHkoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnKCc6XG4gICAgICAgICAgdGhpcy5pblBhcmVudGhlc2VzID0gdHJ1ZTtcbiAgICAgICAgY2FzZSAnKSc6XG4gICAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICAgICAgeWllbGQgbmV3IFRva2VuKFRva2VuVHlwZVtjaGFyXSwgdGhpcywgc3RhcnQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGlmIChjaGFyICYmIC9bYS16QS1aMC05X1xcLTpcXCRdLy50ZXN0KGNoYXIpKSB7XG4gICAgICAgICAgICB5aWVsZCB0aGlzLmlkZW50aXR5KFRva2VuVHlwZS5pZCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICAgICAgeWllbGQgbmV3IFRva2VuKFRva2VuVHlwZS5hbnksIHRoaXMsIHN0YXJ0KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpZGVudGl0eSh0eXBlID0gVG9rZW5UeXBlLmZ1bmN0aW9uKSB7XG4gICAgY29uc3Qgc3RhcnQgPSB0aGlzLnBvc2l0aW9uO1xuICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIHdoaWxlICh0aGlzLmxhKCkgJiYgL1thLXpBLVowLTlfLV0vLnRlc3QodGhpcy5sYSgpISkpIHtcbiAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFRva2VuKHR5cGUsIHRoaXMsIHN0YXJ0KTtcbiAgfVxuXG4gIHN0cmluZ0xpdChxdW90ZTogc3RyaW5nKSB7XG4gICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgY29uc3Qgc3RhcnQgPSB0aGlzLnBvc2l0aW9uO1xuICAgIHdoaWxlICh0aGlzLmxhKCkgIT09IHF1b3RlKSB7XG4gICAgICBpZiAodGhpcy5sYSgpID09IG51bGwpXG4gICAgICAgIHRoaXMudGhyb3dFcnJvcigpO1xuICAgICAgLy8gY29uc29sZS5sb2coJzonLCB0aGlzLmxhKCkpO1xuICAgICAgaWYgKHRoaXMubGEoKSA9PT0gJ1xcXFwnKSB7XG4gICAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgfVxuICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgfVxuICAgIGNvbnN0IHRrID0gbmV3IFRva2VuKFRva2VuVHlwZS5zdHJpbmdMaXRlcmFsLCB0aGlzLCBzdGFydCk7XG4gICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgcmV0dXJuIHRrO1xuICB9XG5cbiAgc3BhY2VzKCkge1xuICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5wb3NpdGlvbjtcbiAgICB3aGlsZSAodGhpcy5sYSgpICE9IG51bGwgJiYgL1xccy8udGVzdCh0aGlzLmxhKCkhKSkge1xuICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgVG9rZW4oVG9rZW5UeXBlLnNraXAsIHRoaXMsIHN0YXJ0KTtcbiAgfVxuICBjb21tZW50cygpIHtcbiAgICBpZiAodGhpcy5pblBhcmVudGhlc2VzICYmIHRoaXMuaXNOZXh0KCcvJywgJy8nKSlcbiAgICAgIHJldHVybiBudWxsOyAvLyBEbyBub3QgY29uc2lkZXIgJy8vJyBhcyBjb21tZW50IGluIGEgcGFyZW50aGVzZXMgbGlrZSB1bHIoaHR0cDovLy4uLilcbiAgICBjb25zdCBzdGFydCA9IHRoaXMucG9zaXRpb247XG4gICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgaWYgKHRoaXMuaXNOZXh0KCcvJykpIHtcbiAgICAgIHRoaXMuYWR2YW5jZSgyKTtcbiAgICAgIHdoaWxlICh0aGlzLmxhKCkgIT09ICdcXG4nICYmIHRoaXMubGEoKSAhPSBudWxsKSB7XG4gICAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgfVxuICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNOZXh0KCcqJykpIHtcbiAgICAgIHRoaXMuYWR2YW5jZSgyKTtcbiAgICAgIHdoaWxlICghdGhpcy5pc05leHQoJyovJykgJiYgdGhpcy5sYSgpICE9IG51bGwpIHtcbiAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICB9XG4gICAgICB0aGlzLmFkdmFuY2UoMik7XG4gICAgfVxuICAgIHJldHVybiBuZXcgVG9rZW4oVG9rZW5UeXBlLnNraXAsIHRoaXMsIHN0YXJ0KTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgU2Nzc1BhcnNlciBleHRlbmRzIEJhc2VQYXJzZXI8VG9rZW5UeXBlPiB7XG4gIGdldFJlc1VybCh0ZXh0OiBzdHJpbmcpOiBBcnJheTx7c3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIsIHRleHQ6IHN0cmluZ30+IHtcbiAgICBjb25zdCByZXM6IEFycmF5PHtzdGFydDogbnVtYmVyLCBlbmQ6IG51bWJlciwgdGV4dDogc3RyaW5nfT4gPSBbXTtcbiAgICB3aGlsZSh0aGlzLmxhKCkgIT0gbnVsbCkge1xuICAgICAgaWYgKHRoaXMuaXNOZXh0VHlwZXMoVG9rZW5UeXBlLmlkLCBUb2tlblR5cGVbJygnXSkgJiZcbiAgICAgICAgdGhpcy5sYSgpIS50ZXh0ID09PSAndXJsJyAmJiB0aGlzLmxiKCkhLnRleHQgIT09ICdAaW1wb3J0Jykge1xuICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5sYSgyKSEuZW5kO1xuICAgICAgICAgIHRoaXMuYWR2YW5jZSgyKTsgLy8ganVtcCBvdmVyICcoJ1xuICAgICAgICAgIGlmICh0aGlzLmlzTmV4dFR5cGVzKFRva2VuVHlwZS5zdHJpbmdMaXRlcmFsKSkge1xuICAgICAgICAgICAgY29uc3Qgc3RyaW5nTGl0ID0gdGhpcy5sYSgpO1xuICAgICAgICAgICAgaWYgKHN0cmluZ0xpdCA9PSBudWxsKVxuICAgICAgICAgICAgICB0aGlzLnRocm93RXJyb3IoJ0VuZCBvZiBmaWxlJyk7XG4gICAgICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgICAgICAgIHJlcy5wdXNoKHN0cmluZ0xpdCEpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB3aGlsZSh0aGlzLmxhKCkgIT0gbnVsbCAmJiB0aGlzLmxhKCkhLnR5cGUgIT09IFRva2VuVHlwZVsnKSddKSB7XG4gICAgICAgICAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMubGEoKSA9PSBudWxsKVxuICAgICAgICAgICAgICB0aGlzLnRocm93RXJyb3IoJ0VuZCBvZiBmaWxlJyk7XG4gICAgICAgICAgICBjb25zdCBlbmQgPSB0aGlzLmxhKCkhLnN0YXJ0O1xuICAgICAgICAgICAgcmVzLnB1c2goe3N0YXJ0LCBlbmQsIHRleHQ6IHRleHQuc2xpY2Uoc3RhcnQsIGVuZCl9KTtcbiAgICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIGdldEFsbEltcG9ydCh0ZXh0OiBzdHJpbmcpOiBBcnJheTx7c3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIsIHRleHQ6IHN0cmluZ30+IHtcbiAgICBjb25zdCByZXM6IEFycmF5PHtzdGFydDogbnVtYmVyLCBlbmQ6IG51bWJlciwgdGV4dDogc3RyaW5nfT4gPSBbXTtcbiAgICB3aGlsZSAodGhpcy5sYSgpICE9IG51bGwpIHtcbiAgICAgIGlmICh0aGlzLmlzTmV4dFR5cGVzKFRva2VuVHlwZS5mdW5jdGlvbiwgVG9rZW5UeXBlLnN0cmluZ0xpdGVyYWwpICYmIHRoaXMubGEoKSEudGV4dCA9PT0gJ0BpbXBvcnQnKSB7XG4gICAgICAgIHJlcy5wdXNoKHRoaXMubGEoMikhKTtcbiAgICAgICAgdGhpcy5hZHZhbmNlKDIpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTmV4dFR5cGVzKFRva2VuVHlwZS5mdW5jdGlvbiwgVG9rZW5UeXBlLmlkLCBUb2tlblR5cGVbJygnXSkgJiZcbiAgICAgICAgdGhpcy5sYSgpIS50ZXh0ID09PSAnQGltcG9ydCcgJiYgdGhpcy5sYSgyKSEudGV4dCA9PT0gJ3VybCcpIHtcbiAgICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMubGEoMykhLmVuZDtcbiAgICAgICAgICB0aGlzLmFkdmFuY2UoMyk7XG4gICAgICAgICAgd2hpbGUodGhpcy5sYSgpICE9IG51bGwgJiYgdGhpcy5sYSgpIS50eXBlICE9PSBUb2tlblR5cGVbJyknXSkge1xuICAgICAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh0aGlzLmxhKCkgPT0gbnVsbClcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3QgZW5kIG9mIGZpbGUnKTtcbiAgICAgICAgICBjb25zdCBlbmQgPSB0aGlzLmxhKCkhLnN0YXJ0O1xuICAgICAgICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgICAgIHJlcy5wdXNoKHtzdGFydCwgZW5kLCB0ZXh0OiB0ZXh0LnNsaWNlKHN0YXJ0LCBlbmQpfSk7XG4gICAgICB9IGVsc2VcbiAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgfVxuICAgIHJldHVybiByZXM7XG4gIH1cbn1cbiJdfQ==