"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
// tslint:disable max-line-length
const ts = tslib_1.__importStar(require("typescript"));
const typescript_1 = require("typescript");
const _ = tslib_1.__importStar(require("lodash"));
const patch_text_1 = tslib_1.__importDefault(require("./patch-text"));
const Path = tslib_1.__importStar(require("path"));
const fs = tslib_1.__importStar(require("fs"));
class EsImportStatement {
    constructor(from, start, end) {
        this.from = from;
        this.start = start;
        this.end = end;
        this.isDynamic = false;
    }
    asNameToRealName(asName) {
        const idxOfDot = asName.indexOf('.');
        if (idxOfDot > 0) {
            asName = asName.substring(0, idxOfDot);
        }
        if (this.defaultName === asName)
            return asName;
        else if (this.nameBinding && _.has(this.nameBinding, asName)) {
            return this.nameBinding[asName];
        }
        else if (asName === this.namespace) {
            return this.namespace;
        }
        throw new Error(`No "${asName}" found in import statement from "${this.from}"`);
    }
}
exports.EsImportStatement = EsImportStatement;
exports.findAppModuleFileFromMain = _.memoize(_findAppModuleFileFromMain);
function _findAppModuleFileFromMain(mainFile) {
    const lookupPath = ['AppModule', 'AppServerModule'];
    while (true) {
        const found = findFileByExportNames(mainFile, ...lookupPath);
        if (found == null || found.size === 0) {
            throw new Error('Can not found "AppModule" or "AppServerModule from ' + mainFile);
        }
        if (found.has(lookupPath[0])) {
            let target = Path.resolve(Path.dirname(mainFile), found.get(lookupPath[0]));
            if (!target.endsWith('.ts'))
                target = target + '.ts';
            return target;
        }
        if (found.has(lookupPath[1])) {
            mainFile = Path.resolve(Path.dirname(mainFile), found.get(lookupPath[1]));
            if (!mainFile.endsWith('.ts'))
                mainFile += '.ts';
        }
    }
}
function findFileByExportNames(file, ...importName) {
    const srcfile = ts.createSourceFile(file, fs.readFileSync(file, 'utf8'), ts.ScriptTarget.ESNext, true, ts.ScriptKind.TSX);
    const res = new Map();
    for (const stm of srcfile.statements) {
        if (stm.kind === typescript_1.SyntaxKind.ImportDeclaration && _.has(stm, 'importClause.namedBindings')) {
            const binding = stm.importClause.namedBindings;
            const found = _.intersection(binding.elements.map(el => el.name.text), importName);
            if (found && found.length > 0) {
                const appModuleFile = stm.moduleSpecifier.text;
                found.forEach(importName => res.set(importName, appModuleFile));
                break;
            }
        }
        else if (stm.kind === typescript_1.SyntaxKind.ExportDeclaration && stm.exportClause) {
            const binding = stm.exportClause;
            const found = _.intersection(binding.elements.map(el => el.name.text), importName);
            if (found && found.length > 0) {
                const appModuleFile = stm.moduleSpecifier.text;
                found.forEach(importName => res.set(importName, appModuleFile));
                break;
            }
        }
    }
    return res;
}
// tslint:disable max-classes-per-file
class AppModuleParser {
    constructor() {
        this.esImportsMap = new Map(); // key is imported name
        // modulesToAddSet: Set<string>; // in form of  <package name>#<export name>
        this.modulesToAdd = [];
    }
    /**
       *
       * @param file file path
       * @param fileContent file content
       * @param removableModules array of <ES module path>#<export name>, e.g. @foo/bar/src/module#DocRoute
       * @param modulesToAdd array of <ES module path>#<export name>, e.g. @foo/bar/src/module#DocRoute
       * @param importAppComponent e.g. @foo/bar/src/module#AppComponent
       */
    patchFile(file, fileContent, removableModules, modulesToAdd) {
        this.fileContent = fileContent;
        this.file = file;
        this.dynamicModuleSet = new Set(removableModules);
        for (const add of new Set(modulesToAdd).values()) {
            this.modulesToAdd.push(this.moduleInfoFromStr(add));
        }
        this.replacements = [];
        this.sourceFile = ts.createSourceFile(file, fileContent, ts.ScriptTarget.ESNext, true, ts.ScriptKind.TSX);
        for (const stm of this.sourceFile.statements) {
            this.traverseTsAst(stm);
        }
        return patch_text_1.default(fileContent, this.replacements);
    }
    findEsImportByName(name) {
        const lookup = name.indexOf('.') > 0 ? name.split('.')[0].trim() : name;
        return this.esImportsMap.get(lookup);
    }
    /**
       * 1. Remember those NgModule imports which are not removable
       *   (neither removable nor Typescript Identifier/CallExpression)
       * 2. Remove ES import statement which are removable
       * 3. Add new ES import statement
       * 4. Replace whole NgModule imports arrary with those not removables and newly added
       * @param ngImportArrayExp
       */
    checkAndPatch(ngImportArrayExp) {
        const keepImportEl = new Set(); // 1. Remember those NgModule imports which are not removable
        for (const el of ngImportArrayExp.elements) {
            let exp;
            if (el.kind === typescript_1.SyntaxKind.Identifier) {
                exp = el.text;
            }
            else if (el.kind === typescript_1.SyntaxKind.CallExpression) {
                exp = el.expression.getText(this.sourceFile);
            }
            else {
                keepImportEl.add(el.getText(this.sourceFile));
                continue;
            }
            const esImport = this.findEsImportByName(exp);
            const realName = esImport.asNameToRealName(exp);
            if (esImport.from.startsWith('@angular/')) {
                keepImportEl.add(el.getText(this.sourceFile));
                continue;
            }
            else if (this.dynamicModuleSet.has(esImport.from + '#' + realName)) {
                if (!esImport.isDynamic) {
                    // 2. Remove ES import statement which are removable
                    this.replacements.push({ start: esImport.start, end: esImport.end, text: '' });
                    esImport.isDynamic = true;
                }
            }
            else {
                keepImportEl.add(el.getText(this.sourceFile));
            }
        }
        // 3. Add new ES import statement
        this.appendNgImports();
        let i = 0;
        // 4. Replace whole NgModule imports arrary with those not removables and newly added
        const wholeNgImports = Array.from(keepImportEl.values());
        // wholeNgImports.unshift(...this.modulesToAdd.map(m => m.exportName + '_' + i++));
        const insertPos = wholeNgImports.findIndex(value => /^\s*RouterModule\s*\.\s*forRoot\(/.test(value));
        wholeNgImports.splice(insertPos, 0, ...this.modulesToAdd.map(m => m.exportName + '_' + i++));
        this.replacements.push({
            start: ngImportArrayExp.getStart(this.sourceFile),
            end: ngImportArrayExp.getEnd(),
            text: '[\n    ' + wholeNgImports.join(',\n    ') + '  ]'
        });
    }
    traverseTsAst(ast, level = 0) {
        if (ast.kind === typescript_1.SyntaxKind.ImportDeclaration) {
            const node = ast;
            const from = node.moduleSpecifier.text;
            const importInfo = new EsImportStatement(from, node.getStart(this.sourceFile, false), node.getEnd());
            this.esImportsMap.set(from, importInfo);
            if (_.get(node, 'importClause.name')) {
                importInfo.defaultName = node.importClause.name.text;
                this.esImportsMap.set(importInfo.defaultName, importInfo);
            }
            if (_.get(node, 'importClause.namedBindings')) {
                const nb = node.importClause.namedBindings;
                if (nb.kind === typescript_1.SyntaxKind.NamespaceImport) {
                    importInfo.namespace = nb.name.text;
                    this.esImportsMap.set(importInfo.namespace, importInfo);
                }
                else {
                    importInfo.nameBinding = {};
                    nb.elements.forEach(element => {
                        importInfo.nameBinding[element.name.text] = element.propertyName ? element.propertyName.text : element.name.text;
                        this.esImportsMap.set(element.name.text, importInfo);
                    });
                }
            }
            this.lastEsImportEndPos = ast.getEnd();
            // console.log(importInfo);
            return;
        }
        else if (ast.kind === typescript_1.SyntaxKind.Decorator && ast.expression.kind === typescript_1.SyntaxKind.CallExpression) {
            const exp = ast.expression;
            if (exp.expression.text === 'NgModule') {
                const notation = exp.arguments[0];
                const ngImports = notation.properties.find(el => el.name.text === 'imports');
                if (ngImports.kind !== typescript_1.SyntaxKind.PropertyAssignment) {
                    throw new Error('@NgModule\' property "imports" must be plain PropertyAssignment expression');
                }
                const importArrayExp = ngImports.initializer;
                this.checkAndPatch(importArrayExp);
                return;
            }
        }
        ast.forEachChild((sub) => {
            this.traverseTsAst(sub, level + 1);
        });
    }
    appendNgImports() {
        let i = 0;
        let newEsImport = '\n';
        const esImportMap = new Map();
        for (const add of this.modulesToAdd) {
            // this.replacements.push({start: pos, end: pos, text: `, ${add.exportName}_${i++}`});
            let fromModule = esImportMap.get(add.moduleName);
            if (fromModule == null) {
                fromModule = new Set();
                esImportMap.set(add.moduleName, fromModule);
            }
            fromModule.add(add.exportName);
        }
        i = 0;
        for (const fromModule of esImportMap.entries()) {
            // tslint:disable max-line-length
            newEsImport += `import {${Array.from(fromModule[1].values()).map((name) => `${name} as ${name}_${i++}`).join(', ')}} from '${fromModule[0]}';\n`;
        }
        this.replacements.push({ start: this.lastEsImportEndPos, end: this.lastEsImportEndPos, text: newEsImport });
    }
    moduleInfoFromStr(desc) {
        const idxHyph = desc.indexOf('#');
        const moduleName = desc.substring(0, idxHyph);
        const exportName = desc.substring(idxHyph + 1);
        if (!desc.startsWith('.')) {
            return { moduleName, exportName };
        }
        return {
            moduleName: Path.relative(Path.dirname(this.file), moduleName).replace(/\\/g, '/'),
            exportName
        };
    }
}
exports.default = AppModuleParser;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AZHItY29yZS9uZy1hcHAtYnVpbGRlci90cy91dGlscy9wYXJzZS1hcHAtbW9kdWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlDQUFpQztBQUNqQyx1REFBaUM7QUFDakMsMkNBQTRDO0FBQzVDLGtEQUE0QjtBQUM1QixzRUFBeUQ7QUFDekQsbURBQTZCO0FBQzdCLCtDQUF5QjtBQUV6QixNQUFhLGlCQUFpQjtJQU01QixZQUFtQixJQUFZLEVBQVMsS0FBYSxFQUFTLEdBQVc7UUFBdEQsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUFTLFVBQUssR0FBTCxLQUFLLENBQVE7UUFBUyxRQUFHLEdBQUgsR0FBRyxDQUFRO1FBRnpFLGNBQVMsR0FBRyxLQUFLLENBQUM7SUFFMEQsQ0FBQztJQUU3RSxnQkFBZ0IsQ0FBQyxNQUFjO1FBQzdCLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckMsSUFBSSxRQUFRLEdBQUcsQ0FBQyxFQUFFO1lBQ2hCLE1BQU0sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUN4QztRQUNELElBQUksSUFBSSxDQUFDLFdBQVcsS0FBSyxNQUFNO1lBQzdCLE9BQU8sTUFBTSxDQUFDO2FBQ1gsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsRUFBRTtZQUM1RCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDakM7YUFBTSxJQUFJLE1BQU0sS0FBSyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ3BDLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztTQUN2QjtRQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxNQUFNLHFDQUFxQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztJQUNs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QixFQUFFLElBQUksRUFBRSxXQUFXLEVBQUMsQ0FBQyxDQUFDO0lBQzVHLENBQUM7SUFFUyxpQkFBaUIsQ0FBQyxJQUFZO1FBQ3RDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDOUMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDekIsT0FBTyxFQUFDLFVBQVUsRUFBRSxVQUFVLEVBQUMsQ0FBQztTQUNqQztRQUNELE9BQU87WUFDTCxVQUFVLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQztZQUNsRixVQUFVO1NBQ1gsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQS9LRCxrQ0ErS0MiLCJmaWxlIjoibm9kZV9tb2R1bGVzL0Bkci1jb3JlL25nLWFwcC1idWlsZGVyL2Rpc3QvdXRpbHMvcGFyc2UtYXBwLW1vZHVsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlIG1heC1saW5lLWxlbmd0aFxuaW1wb3J0ICogYXMgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5pbXBvcnQge1N5bnRheEtpbmQgYXMgc2t9IGZyb20gJ3R5cGVzY3JpcHQnO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHJlcGxhY2VDb2RlLCB7UmVwbGFjZW1lbnRJbmZ9IGZyb20gJy4vcGF0Y2gtdGV4dCc7XG5pbXBvcnQgKiBhcyBQYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuXG5leHBvcnQgY2xhc3MgRXNJbXBvcnRTdGF0ZW1lbnQge1xuICBkZWZhdWx0TmFtZT86IHN0cmluZztcbiAgbmFtZXNwYWNlPzogc3RyaW5nO1xuICBuYW1lQmluZGluZz86IHtbYXM6IHN0cmluZ106IHN0cmluZ307IC8vIGtleSBpcyBcImFzXCIsIHZhbHVlIGlzIG9yaWdpbmFsIG5hbWVcbiAgaXNEeW5hbWljID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocHVibGljIGZyb206IHN0cmluZywgcHVibGljIHN0YXJ0OiBudW1iZXIsIHB1YmxpYyBlbmQ6IG51bWJlcikge31cblxuICBhc05hbWVUb1JlYWxOYW1lKGFzTmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3QgaWR4T2ZEb3QgPSBhc05hbWUuaW5kZXhPZignLicpO1xuICAgIGlmIChpZHhPZkRvdCA+IDApIHtcbiAgICAgIGFzTmFtZSA9IGFzTmFtZS5zdWJzdHJpbmcoMCwgaWR4T2ZEb3QpO1xuICAgIH1cbiAgICBpZiAodGhpcy5kZWZhdWx0TmFtZSA9PT0gYXNOYW1lKVxuICAgICAgcmV0dXJuIGFzTmFtZTtcbiAgICBlbHNlIGlmICh0aGlzLm5hbWVCaW5kaW5nICYmIF8uaGFzKHRoaXMubmFtZUJpbmRpbmcsIGFzTmFtZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLm5hbWVCaW5kaW5nW2FzTmFtZV07XG4gICAgfSBlbHNlIGlmIChhc05hbWUgPT09IHRoaXMubmFtZXNwYWNlKSB7XG4gICAgICByZXR1cm4gdGhpcy5uYW1lc3BhY2U7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihgTm8gXCIke2FzTmFtZX1cIiBmb3VuZCBpbiBpbXBvcnQgc3RhdGVtZW50IGZyb20gXCIke3RoaXMuZnJvbX1cImApO1xuICB9XG59XG5leHBvcnQgY29uc3QgZmluZEFwcE1vZHVsZUZpbGVGcm9tTWFpbiA9IF8ubWVtb2l6ZShfZmluZEFwcE1vZHVsZUZpbGVGcm9tTWFpbik7XG5cbmZ1bmN0aW9uIF9maW5kQXBwTW9kdWxlRmlsZUZyb21NYWluKG1haW5GaWxlOiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBsb29rdXBQYXRoID0gWydBcHBNb2R1bGUnLCAnQXBwU2VydmVyTW9kdWxlJ107XG4gIHdoaWxlICh0cnVlKSB7XG4gICAgY29uc3QgZm91bmQgPSBmaW5kRmlsZUJ5RXhwb3J0TmFtZXMobWFpbkZpbGUsIC4uLmxvb2t1cFBhdGgpO1xuICAgIGlmIChmb3VuZCA9PSBudWxsIHx8IGZvdW5kLnNpemUgPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2FuIG5vdCBmb3VuZCBcIkFwcE1vZHVsZVwiIG9yIFwiQXBwU2VydmVyTW9kdWxlIGZyb20gJyArIG1haW5GaWxlKTtcbiAgICB9XG4gICAgaWYgKGZvdW5kLmhhcyhsb29rdXBQYXRoWzBdKSkge1xuICAgICAgbGV0IHRhcmdldCA9IFBhdGgucmVzb2x2ZShQYXRoLmRpcm5hbWUobWFpbkZpbGUpLCBmb3VuZC5nZXQobG9va3VwUGF0aFswXSkpO1xuICAgICAgaWYgKCF0YXJnZXQuZW5kc1dpdGgoJy50cycpKVxuICAgICAgICB0YXJnZXQgPSB0YXJnZXQgKyAnLnRzJztcbiAgICAgIHJldHVybiB0YXJnZXQ7XG4gICAgfVxuICAgIGlmIChmb3VuZC5oYXMobG9va3VwUGF0aFsxXSkpIHtcbiAgICAgIG1haW5GaWxlID0gUGF0aC5yZXNvbHZlKFBhdGguZGlybmFtZShtYWluRmlsZSksIGZvdW5kLmdldChsb29rdXBQYXRoWzFdKSk7XG4gICAgICBpZiAoIW1haW5GaWxlLmVuZHNXaXRoKCcudHMnKSlcbiAgICAgICAgbWFpbkZpbGUgKz0gJy50cyc7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGZpbmRGaWxlQnlFeHBvcnROYW1lcyhmaWxlOiBzdHJpbmcsIC4uLmltcG9ydE5hbWU6IHN0cmluZ1tdKTogTWFwPHN0cmluZywgc3RyaW5nPiB7XG4gIGNvbnN0IHNyY2ZpbGUgPSB0cy5jcmVhdGVTb3VyY2VGaWxlKGZpbGUsIGZzLnJlYWRGaWxlU3luYyhmaWxlLCAndXRmOCcpLCB0cy5TY3JpcHRUYXJnZXQuRVNOZXh0LFxuICAgIHRydWUsIHRzLlNjcmlwdEtpbmQuVFNYKTtcbiAgY29uc3QgcmVzOiBNYXA8c3RyaW5nLCBzdHJpbmc+ID0gbmV3IE1hcCgpO1xuICBmb3IoY29uc3Qgc3RtIG9mIHNyY2ZpbGUuc3RhdGVtZW50cykge1xuICAgIGlmIChzdG0ua2luZCA9PT0gc2suSW1wb3J0RGVjbGFyYXRpb24gJiYgXy5oYXMoc3RtLCAnaW1wb3J0Q2xhdXNlLm5hbWVkQmluZGluZ3MnKSkge1xuICAgICAgY29uc3QgYmluZGluZyA9IChzdG0gYXMgdHMuSW1wb3J0RGVjbGFyYXRpb24pLmltcG9ydENsYXVzZS5uYW1lZEJpbmRpbmdzIGFzIHRzLk5hbWVkSW1wb3J0cztcbiAgICAgIGNvbnN0IGZvdW5kID0gXy5pbnRlcnNlY3Rpb24oYmluZGluZy5lbGVtZW50cy5tYXAoZWwgPT4gZWwubmFtZS50ZXh0KSwgaW1wb3J0TmFtZSk7XG4gICAgICBpZiAoZm91bmQgJiYgZm91bmQubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBhcHBNb2R1bGVGaWxlID0gKChzdG0gYXMgdHMuSW1wb3J0RGVjbGFyYXRpb24pLm1vZHVsZVNwZWNpZmllciBhcyB0cy5TdHJpbmdMaXRlcmFsKS50ZXh0O1xuICAgICAgICBmb3VuZC5mb3JFYWNoKGltcG9ydE5hbWUgPT4gcmVzLnNldChpbXBvcnROYW1lLCBhcHBNb2R1bGVGaWxlKSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoc3RtLmtpbmQgPT09IHNrLkV4cG9ydERlY2xhcmF0aW9uICYmIChzdG0gYXMgdHMuRXhwb3J0RGVjbGFyYXRpb24pLmV4cG9ydENsYXVzZSkge1xuICAgICAgY29uc3QgYmluZGluZyA9IChzdG0gYXMgdHMuRXhwb3J0RGVjbGFyYXRpb24pLmV4cG9ydENsYXVzZTtcbiAgICAgIGNvbnN0IGZvdW5kID0gXy5pbnRlcnNlY3Rpb24oYmluZGluZy5lbGVtZW50cy5tYXAoZWwgPT4gZWwubmFtZS50ZXh0KSwgaW1wb3J0TmFtZSk7XG4gICAgICBpZiAoZm91bmQgJiYgZm91bmQubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBhcHBNb2R1bGVGaWxlID0gKChzdG0gYXMgdHMuRXhwb3J0RGVjbGFyYXRpb24pLm1vZHVsZVNwZWNpZmllciBhcyB0cy5TdHJpbmdMaXRlcmFsKS50ZXh0O1xuICAgICAgICBmb3VuZC5mb3JFYWNoKGltcG9ydE5hbWUgPT4gcmVzLnNldChpbXBvcnROYW1lLCBhcHBNb2R1bGVGaWxlKSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gcmVzO1xufVxuLy8gdHNsaW50OmRpc2FibGUgbWF4LWNsYXNzZXMtcGVyLWZpbGVcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwcE1vZHVsZVBhcnNlciB7XG5cbiAgZmlsZTogc3RyaW5nO1xuICBlc0ltcG9ydHNNYXA6IE1hcDxzdHJpbmcsIEVzSW1wb3J0U3RhdGVtZW50PiA9IG5ldyBNYXAoKTsgLy8ga2V5IGlzIGltcG9ydGVkIG5hbWVcbiAgZHluYW1pY01vZHVsZVNldDogU2V0PHN0cmluZz47IC8vIGluIGZvcm0gb2YgIDxwYWNrYWdlIG5hbWU+IzxleHBvcnQgbmFtZT5cbiAgLy8gbW9kdWxlc1RvQWRkU2V0OiBTZXQ8c3RyaW5nPjsgLy8gaW4gZm9ybSBvZiAgPHBhY2thZ2UgbmFtZT4jPGV4cG9ydCBuYW1lPlxuICBtb2R1bGVzVG9BZGQ6IEFycmF5PHttb2R1bGVOYW1lOiBzdHJpbmcsIGV4cG9ydE5hbWU6IHN0cmluZ30+ID0gW107XG4gIHJlcGxhY2VtZW50czogUmVwbGFjZW1lbnRJbmZbXTtcbiAgbGFzdEVzSW1wb3J0RW5kUG9zOiBudW1iZXI7IC8vIFRoZSBlbmQgcG9zaXRpb24gb2YgbGFzdCBgaW1wb3J0YCBzdGF0ZW1lbnQsIHdlJ3JlIGdvaW5ndG8gaW5zZXJ0IG5ldyBhZnRlciBpdC5cblxuICBmaWxlQ29udGVudDogc3RyaW5nO1xuICBzb3VyY2VGaWxlOiB0cy5Tb3VyY2VGaWxlO1xuXG4gIC8qKlxuXHQgKiBcblx0ICogQHBhcmFtIGZpbGUgZmlsZSBwYXRoXG5cdCAqIEBwYXJhbSBmaWxlQ29udGVudCBmaWxlIGNvbnRlbnRcblx0ICogQHBhcmFtIHJlbW92YWJsZU1vZHVsZXMgYXJyYXkgb2YgPEVTIG1vZHVsZSBwYXRoPiM8ZXhwb3J0IG5hbWU+LCBlLmcuIEBmb28vYmFyL3NyYy9tb2R1bGUjRG9jUm91dGVcblx0ICogQHBhcmFtIG1vZHVsZXNUb0FkZCBhcnJheSBvZiA8RVMgbW9kdWxlIHBhdGg+IzxleHBvcnQgbmFtZT4sIGUuZy4gQGZvby9iYXIvc3JjL21vZHVsZSNEb2NSb3V0ZVxuXHQgKiBAcGFyYW0gaW1wb3J0QXBwQ29tcG9uZW50IGUuZy4gQGZvby9iYXIvc3JjL21vZHVsZSNBcHBDb21wb25lbnRcblx0ICovXG4gIHBhdGNoRmlsZShmaWxlOiBzdHJpbmcsIGZpbGVDb250ZW50OiBzdHJpbmcsIHJlbW92YWJsZU1vZHVsZXM6IHN0cmluZ1tdLCBtb2R1bGVzVG9BZGQ6IHN0cmluZ1tdKSB7XG4gICAgdGhpcy5maWxlQ29udGVudCA9IGZpbGVDb250ZW50O1xuICAgIHRoaXMuZmlsZSA9IGZpbGU7XG5cbiAgICB0aGlzLmR5bmFtaWNNb2R1bGVTZXQgPSBuZXcgU2V0KHJlbW92YWJsZU1vZHVsZXMpO1xuICAgIGZvciAoY29uc3QgYWRkIG9mIG5ldyBTZXQobW9kdWxlc1RvQWRkKS52YWx1ZXMoKSkge1xuICAgICAgdGhpcy5tb2R1bGVzVG9BZGQucHVzaCh0aGlzLm1vZHVsZUluZm9Gcm9tU3RyKGFkZCkpO1xuICAgIH1cbiAgICB0aGlzLnJlcGxhY2VtZW50cyA9IFtdO1xuXG4gICAgdGhpcy5zb3VyY2VGaWxlID0gdHMuY3JlYXRlU291cmNlRmlsZShmaWxlLCBmaWxlQ29udGVudCwgdHMuU2NyaXB0VGFyZ2V0LkVTTmV4dCxcbiAgICAgIHRydWUsIHRzLlNjcmlwdEtpbmQuVFNYKTtcbiAgICBmb3IoY29uc3Qgc3RtIG9mIHRoaXMuc291cmNlRmlsZS5zdGF0ZW1lbnRzKSB7XG4gICAgICB0aGlzLnRyYXZlcnNlVHNBc3Qoc3RtKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVwbGFjZUNvZGUoZmlsZUNvbnRlbnQsIHRoaXMucmVwbGFjZW1lbnRzKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBmaW5kRXNJbXBvcnRCeU5hbWUobmFtZTogc3RyaW5nKTogRXNJbXBvcnRTdGF0ZW1lbnQge1xuICAgIGNvbnN0IGxvb2t1cCA9IG5hbWUuaW5kZXhPZignLicpID4gMCA/IG5hbWUuc3BsaXQoJy4nKVswXS50cmltKCkgOiBuYW1lO1xuICAgIHJldHVybiB0aGlzLmVzSW1wb3J0c01hcC5nZXQobG9va3VwKTtcbiAgfVxuXG4gIC8qKlxuXHQgKiAxLiBSZW1lbWJlciB0aG9zZSBOZ01vZHVsZSBpbXBvcnRzIHdoaWNoIGFyZSBub3QgcmVtb3ZhYmxlXG5cdCAqICAgKG5laXRoZXIgcmVtb3ZhYmxlIG5vciBUeXBlc2NyaXB0IElkZW50aWZpZXIvQ2FsbEV4cHJlc3Npb24pXG5cdCAqIDIuIFJlbW92ZSBFUyBpbXBvcnQgc3RhdGVtZW50IHdoaWNoIGFyZSByZW1vdmFibGVcblx0ICogMy4gQWRkIG5ldyBFUyBpbXBvcnQgc3RhdGVtZW50XG5cdCAqIDQuIFJlcGxhY2Ugd2hvbGUgTmdNb2R1bGUgaW1wb3J0cyBhcnJhcnkgd2l0aCB0aG9zZSBub3QgcmVtb3ZhYmxlcyBhbmQgbmV3bHkgYWRkZWRcblx0ICogQHBhcmFtIG5nSW1wb3J0QXJyYXlFeHBcblx0ICovXG4gIHByb3RlY3RlZCBjaGVja0FuZFBhdGNoKG5nSW1wb3J0QXJyYXlFeHA6IHRzLkFycmF5TGl0ZXJhbEV4cHJlc3Npb24pIHtcbiAgICBjb25zdCBrZWVwSW1wb3J0RWw6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpOyAvLyAxLiBSZW1lbWJlciB0aG9zZSBOZ01vZHVsZSBpbXBvcnRzIHdoaWNoIGFyZSBub3QgcmVtb3ZhYmxlXG4gICAgZm9yIChjb25zdCBlbCBvZiBuZ0ltcG9ydEFycmF5RXhwLmVsZW1lbnRzKSB7XG4gICAgICBsZXQgZXhwOiBzdHJpbmc7XG4gICAgICBpZiAoZWwua2luZCA9PT0gc2suSWRlbnRpZmllcikge1xuICAgICAgICBleHAgPSAoZWwgYXMgdHMuSWRlbnRpZmllcikudGV4dDtcbiAgICAgIH0gZWxzZSBpZiAoZWwua2luZCA9PT0gc2suQ2FsbEV4cHJlc3Npb24pIHtcbiAgICAgICAgZXhwID0gKGVsIGFzIHRzLkNhbGxFeHByZXNzaW9uKS5leHByZXNzaW9uLmdldFRleHQodGhpcy5zb3VyY2VGaWxlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGtlZXBJbXBvcnRFbC5hZGQoZWwuZ2V0VGV4dCh0aGlzLnNvdXJjZUZpbGUpKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBjb25zdCBlc0ltcG9ydCA9IHRoaXMuZmluZEVzSW1wb3J0QnlOYW1lKGV4cCk7XG4gICAgICBjb25zdCByZWFsTmFtZSA9IGVzSW1wb3J0LmFzTmFtZVRvUmVhbE5hbWUoZXhwKTtcbiAgICAgIGlmIChlc0ltcG9ydC5mcm9tLnN0YXJ0c1dpdGgoJ0Bhbmd1bGFyLycpKSB7XG4gICAgICAgIGtlZXBJbXBvcnRFbC5hZGQoZWwuZ2V0VGV4dCh0aGlzLnNvdXJjZUZpbGUpKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuZHluYW1pY01vZHVsZVNldC5oYXMoZXNJbXBvcnQuZnJvbSArICcjJyArIHJlYWxOYW1lKSkge1xuICAgICAgICBpZiAoIWVzSW1wb3J0LmlzRHluYW1pYykge1xuICAgICAgICAgIC8vIDIuIFJlbW92ZSBFUyBpbXBvcnQgc3RhdGVtZW50IHdoaWNoIGFyZSByZW1vdmFibGVcbiAgICAgICAgICB0aGlzLnJlcGxhY2VtZW50cy5wdXNoKHtzdGFydDogZXNJbXBvcnQuc3RhcnQsIGVuZDogZXNJbXBvcnQuZW5kLCB0ZXh0OiAnJ30pO1xuICAgICAgICAgIGVzSW1wb3J0LmlzRHluYW1pYyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGtlZXBJbXBvcnRFbC5hZGQoZWwuZ2V0VGV4dCh0aGlzLnNvdXJjZUZpbGUpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gMy4gQWRkIG5ldyBFUyBpbXBvcnQgc3RhdGVtZW50XG4gICAgdGhpcy5hcHBlbmROZ0ltcG9ydHMoKTtcbiAgICBsZXQgaSA9IDA7XG4gICAgLy8gNC4gUmVwbGFjZSB3aG9sZSBOZ01vZHVsZSBpbXBvcnRzIGFycmFyeSB3aXRoIHRob3NlIG5vdCByZW1vdmFibGVzIGFuZCBuZXdseSBhZGRlZFxuICAgIGNvbnN0IHdob2xlTmdJbXBvcnRzID0gQXJyYXkuZnJvbShrZWVwSW1wb3J0RWwudmFsdWVzKCkpO1xuICAgIC8vIHdob2xlTmdJbXBvcnRzLnVuc2hpZnQoLi4udGhpcy5tb2R1bGVzVG9BZGQubWFwKG0gPT4gbS5leHBvcnROYW1lICsgJ18nICsgaSsrKSk7XG4gICAgY29uc3QgaW5zZXJ0UG9zID0gd2hvbGVOZ0ltcG9ydHMuZmluZEluZGV4KHZhbHVlID0+IC9eXFxzKlJvdXRlck1vZHVsZVxccypcXC5cXHMqZm9yUm9vdFxcKC8udGVzdCh2YWx1ZSkpO1xuICAgIHdob2xlTmdJbXBvcnRzLnNwbGljZShpbnNlcnRQb3MsIDAsIC4uLnRoaXMubW9kdWxlc1RvQWRkLm1hcChtID0+IG0uZXhwb3J0TmFtZSArICdfJyArIGkrKykpO1xuICAgIHRoaXMucmVwbGFjZW1lbnRzLnB1c2goe1xuICAgICAgc3RhcnQ6IG5nSW1wb3J0QXJyYXlFeHAuZ2V0U3RhcnQodGhpcy5zb3VyY2VGaWxlKSxcbiAgICAgIGVuZDogbmdJbXBvcnRBcnJheUV4cC5nZXRFbmQoKSxcbiAgICAgIHRleHQ6ICdbXFxuICAgICcgKyB3aG9sZU5nSW1wb3J0cy5qb2luKCcsXFxuICAgICcpICsgJyAgXSdcbiAgICB9KTtcbiAgfVxuXG4gIHByb3RlY3RlZCB0cmF2ZXJzZVRzQXN0KGFzdDogdHMuTm9kZSwgbGV2ZWwgPSAwKSB7XG4gICAgaWYgKGFzdC5raW5kID09PSBzay5JbXBvcnREZWNsYXJhdGlvbikge1xuICAgICAgY29uc3Qgbm9kZSA9IGFzdCBhcyB0cy5JbXBvcnREZWNsYXJhdGlvbjtcbiAgICAgIGNvbnN0IGZyb20gPSAobm9kZS5tb2R1bGVTcGVjaWZpZXIgYXMgdHMuU3RyaW5nTGl0ZXJhbCkudGV4dDtcbiAgICAgIGNvbnN0IGltcG9ydEluZm86IEVzSW1wb3J0U3RhdGVtZW50ID0gbmV3IEVzSW1wb3J0U3RhdGVtZW50KFxuICAgICAgICBmcm9tLCBub2RlLmdldFN0YXJ0KHRoaXMuc291cmNlRmlsZSwgZmFsc2UpLG5vZGUuZ2V0RW5kKCkpO1xuICAgICAgdGhpcy5lc0ltcG9ydHNNYXAuc2V0KGZyb20sIGltcG9ydEluZm8pO1xuXG4gICAgICBpZiAoXy5nZXQobm9kZSwgJ2ltcG9ydENsYXVzZS5uYW1lJykpIHtcbiAgICAgICAgaW1wb3J0SW5mby5kZWZhdWx0TmFtZSA9IG5vZGUuaW1wb3J0Q2xhdXNlLm5hbWUudGV4dDtcbiAgICAgICAgdGhpcy5lc0ltcG9ydHNNYXAuc2V0KGltcG9ydEluZm8uZGVmYXVsdE5hbWUsIGltcG9ydEluZm8pO1xuICAgICAgfVxuICAgICAgaWYgKF8uZ2V0KG5vZGUsICdpbXBvcnRDbGF1c2UubmFtZWRCaW5kaW5ncycpKSB7XG4gICAgICAgIGNvbnN0IG5iID0gbm9kZS5pbXBvcnRDbGF1c2UubmFtZWRCaW5kaW5ncztcbiAgICAgICAgaWYgKG5iLmtpbmQgPT09IHNrLk5hbWVzcGFjZUltcG9ydCkge1xuICAgICAgICAgIGltcG9ydEluZm8ubmFtZXNwYWNlID0gbmIubmFtZS50ZXh0O1xuICAgICAgICAgIHRoaXMuZXNJbXBvcnRzTWFwLnNldChpbXBvcnRJbmZvLm5hbWVzcGFjZSwgaW1wb3J0SW5mbyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaW1wb3J0SW5mby5uYW1lQmluZGluZyA9IHt9O1xuICAgICAgICAgIG5iLmVsZW1lbnRzLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICAgICAgICBpbXBvcnRJbmZvLm5hbWVCaW5kaW5nW2VsZW1lbnQubmFtZS50ZXh0XSA9IGVsZW1lbnQucHJvcGVydHlOYW1lID8gZWxlbWVudC5wcm9wZXJ0eU5hbWUudGV4dCA6IGVsZW1lbnQubmFtZS50ZXh0O1xuICAgICAgICAgICAgdGhpcy5lc0ltcG9ydHNNYXAuc2V0KGVsZW1lbnQubmFtZS50ZXh0LCBpbXBvcnRJbmZvKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5sYXN0RXNJbXBvcnRFbmRQb3MgPSBhc3QuZ2V0RW5kKCk7XG4gICAgICAvLyBjb25zb2xlLmxvZyhpbXBvcnRJbmZvKTtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKGFzdC5raW5kID09PSBzay5EZWNvcmF0b3IgJiYgKGFzdCBhcyB0cy5EZWNvcmF0b3IpLmV4cHJlc3Npb24ua2luZCA9PT0gc2suQ2FsbEV4cHJlc3Npb24pIHtcbiAgICAgIGNvbnN0IGV4cCA9IChhc3QgYXMgdHMuRGVjb3JhdG9yKS5leHByZXNzaW9uIGFzIHRzLkNhbGxFeHByZXNzaW9uO1xuICAgICAgaWYgKChleHAuZXhwcmVzc2lvbiBhcyB0cy5JZGVudGlmaWVyKS50ZXh0ID09PSAnTmdNb2R1bGUnKSB7XG4gICAgICAgIGNvbnN0IG5vdGF0aW9uID0gZXhwLmFyZ3VtZW50c1swXSBhcyB0cy5PYmplY3RMaXRlcmFsRXhwcmVzc2lvbjtcbiAgICAgICAgY29uc3QgbmdJbXBvcnRzID0gbm90YXRpb24ucHJvcGVydGllcy5maW5kKFxuICAgICAgICAgIGVsID0+IChlbC5uYW1lIGFzIHRzLklkZW50aWZpZXIpLnRleHQgPT09ICdpbXBvcnRzJyk7XG4gICAgICAgIGlmIChuZ0ltcG9ydHMua2luZCAhPT0gc2suUHJvcGVydHlBc3NpZ25tZW50KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdATmdNb2R1bGVcXCcgcHJvcGVydHkgXCJpbXBvcnRzXCIgbXVzdCBiZSBwbGFpbiBQcm9wZXJ0eUFzc2lnbm1lbnQgZXhwcmVzc2lvbicpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGltcG9ydEFycmF5RXhwID0gKChuZ0ltcG9ydHMgYXMgdHMuUHJvcGVydHlBc3NpZ25tZW50KS5pbml0aWFsaXplciBhcyB0cy5BcnJheUxpdGVyYWxFeHByZXNzaW9uKTtcbiAgICAgICAgdGhpcy5jaGVja0FuZFBhdGNoKGltcG9ydEFycmF5RXhwKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICBhc3QuZm9yRWFjaENoaWxkKChzdWI6IHRzLk5vZGUpID0+IHtcbiAgICAgIHRoaXMudHJhdmVyc2VUc0FzdChzdWIsIGxldmVsICsgMSk7XG4gICAgfSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYXBwZW5kTmdJbXBvcnRzKCkge1xuICAgIGxldCBpID0gMDtcbiAgICBsZXQgbmV3RXNJbXBvcnQgPSAnXFxuJztcbiAgICBjb25zdCBlc0ltcG9ydE1hcDogTWFwPHN0cmluZywgU2V0PHN0cmluZz4+ID0gbmV3IE1hcCgpO1xuICAgIGZvciAoY29uc3QgYWRkIG9mIHRoaXMubW9kdWxlc1RvQWRkKSB7XG4gICAgICAvLyB0aGlzLnJlcGxhY2VtZW50cy5wdXNoKHtzdGFydDogcG9zLCBlbmQ6IHBvcywgdGV4dDogYCwgJHthZGQuZXhwb3J0TmFtZX1fJHtpKyt9YH0pO1xuICAgICAgbGV0IGZyb21Nb2R1bGUgPSBlc0ltcG9ydE1hcC5nZXQoYWRkLm1vZHVsZU5hbWUpO1xuICAgICAgaWYgKGZyb21Nb2R1bGUgPT0gbnVsbCkge1xuICAgICAgICBmcm9tTW9kdWxlID0gbmV3IFNldCgpO1xuICAgICAgICBlc0ltcG9ydE1hcC5zZXQoYWRkLm1vZHVsZU5hbWUsIGZyb21Nb2R1bGUpO1xuICAgICAgfVxuICAgICAgZnJvbU1vZHVsZS5hZGQoYWRkLmV4cG9ydE5hbWUpO1xuICAgIH1cbiAgICBpID0gMDtcbiAgICBmb3IgKGNvbnN0IGZyb21Nb2R1bGUgb2YgZXNJbXBvcnRNYXAuZW50cmllcygpKSB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZSBtYXgtbGluZS1sZW5ndGhcbiAgICAgIG5ld0VzSW1wb3J0ICs9IGBpbXBvcnQgeyR7QXJyYXkuZnJvbShmcm9tTW9kdWxlWzFdLnZhbHVlcygpKS5tYXAoKG5hbWUpID0+IGAke25hbWV9IGFzICR7bmFtZX1fJHtpKyt9YCkuam9pbignLCAnKX19IGZyb20gJyR7ZnJvbU1vZHVsZVswXX0nO1xcbmA7XG4gICAgfVxuICAgIHRoaXMucmVwbGFjZW1lbnRzLnB1c2goe3N0YXJ0OiB0aGlzLmxhc3RFc0ltcG9ydEVuZFBvcywgZW5kOiB0aGlzLmxhc3RFc0ltcG9ydEVuZFBvcywgdGV4dDogbmV3RXNJbXBvcnR9KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBtb2R1bGVJbmZvRnJvbVN0cihkZXNjOiBzdHJpbmcpOiB7bW9kdWxlTmFtZTogc3RyaW5nLCBleHBvcnROYW1lOiBzdHJpbmd9IHtcbiAgICBjb25zdCBpZHhIeXBoID0gZGVzYy5pbmRleE9mKCcjJyk7XG4gICAgY29uc3QgbW9kdWxlTmFtZSA9IGRlc2Muc3Vic3RyaW5nKDAsIGlkeEh5cGgpO1xuICAgIGNvbnN0IGV4cG9ydE5hbWUgPSBkZXNjLnN1YnN0cmluZyhpZHhIeXBoICsgMSk7XG4gICAgaWYgKCFkZXNjLnN0YXJ0c1dpdGgoJy4nKSkge1xuICAgICAgcmV0dXJuIHttb2R1bGVOYW1lLCBleHBvcnROYW1lfTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIG1vZHVsZU5hbWU6IFBhdGgucmVsYXRpdmUoUGF0aC5kaXJuYW1lKHRoaXMuZmlsZSksIG1vZHVsZU5hbWUpLnJlcGxhY2UoL1xcXFwvZywgJy8nKSxcbiAgICAgIGV4cG9ydE5hbWVcbiAgICB9O1xuICB9XG59XG4iXX0=
