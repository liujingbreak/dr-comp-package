"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const ng_html_parser_1 = require("../utils/ng-html-parser");
const patch_text_1 = tslib_1.__importStar(require("../utils/patch-text"));
const __api_1 = tslib_1.__importDefault(require("__api"));
const url_1 = tslib_1.__importDefault(require("url"));
const _ = tslib_1.__importStar(require("lodash"));
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const chalk = require('chalk');
const log = require('log4js').getLogger('ng-app-builder.html-assets-resolver');
// export enum ReplaceType {
// 	resolveUrl, loadRes
// }
const toCheckNames = ['href', 'src', 'ng-src', 'ng-href', 'srcset', 'routerLink'];
function replaceForHtml(content, resourcePath, callback) {
    let ast;
    try {
        ast = new ng_html_parser_1.TemplateParser(content).parse();
    }
    catch (e) {
        log.error(content);
        throw e;
    }
    // const proms: Array<PromiseLike<any>> = [];
    const dones = [];
    const resolver = new AttrAssetsUrlResolver(resourcePath, callback);
    for (const el of ast) {
        // if (el.name === 'script')
        // 	continue;
        for (const name of toCheckNames) {
            if (_.has(el.attrs, name)) {
                const value = el.attrs[name].value;
                if (el.attrs[name].isNg || value == null || value.text.indexOf('{{') >= 0)
                    continue;
                const resolved$ = resolver.resolve(name, value, el);
                if (resolved$)
                    dones.push(resolved$);
            }
        }
    }
    if (dones.length > 0)
        return rxjs_1.forkJoin(dones).pipe(operators_1.map(replacements => patch_text_1.default(content, replacements)));
    else
        return rxjs_1.of(content);
}
exports.replaceForHtml = replaceForHtml;
class AttrAssetsUrlResolver {
    constructor(resourcePath, callback) {
        this.resourcePath = resourcePath;
        this.callback = callback;
    }
    resolve(attrName, valueToken, el) {
        if (!valueToken)
            return null;
        if (attrName === 'srcset') {
            // img srcset
            const value = this.doSrcSet(valueToken.text);
            return value.pipe(operators_1.map(value => new patch_text_1.Replacement(valueToken.start, valueToken.end, value)));
            // replacements.push(new Rep(valueToken.start, valueToken.end, value));
        }
        else if (attrName === 'src') {
            // img src
            const url = this.doLoadAssets(valueToken.text);
            return url.pipe(operators_1.map(url => new patch_text_1.Replacement(valueToken.start, valueToken.end, url)));
        }
        else if (attrName === 'routerLink') {
            const url = this.resolveUrl(valueToken.text);
            const parsedUrl = url_1.default.parse(url);
            return rxjs_1.of(new patch_text_1.Replacement(valueToken.start, valueToken.end, parsedUrl.path + (parsedUrl.hash ? parsedUrl.hash : '')));
        }
        else { // href, ng-src, routerLink
            const url = this.resolveUrl(valueToken.text);
            return rxjs_1.of(new patch_text_1.Replacement(valueToken.start, valueToken.end, url));
        }
    }
    doSrcSet(value) {
        const urlSets$s = value.split(/\s*,\s*/).map(urlSet => {
            urlSet = _.trim(urlSet);
            const factors = urlSet.split(/\s+/);
            const image = factors[0];
            return this.doLoadAssets(image)
                .pipe(operators_1.map(url => url + factors[1]));
        });
        return rxjs_1.forkJoin(urlSets$s).pipe(operators_1.map(urlSets => urlSets.join(', ')));
    }
    resolveUrl(href) {
        if (href === '')
            return href;
        var normalUrlObj = __api_1.default.normalizeAssetsUrl(href, this.resourcePath);
        if (_.isObject(normalUrlObj)) {
            const res = normalUrlObj;
            const resolved = res.isPage ?
                __api_1.default.entryPageUrl(res.packageName, res.path, res.locale) :
                __api_1.default.assetsUrl(res.packageName, res.path);
            log.info(`resolve URL/routePath ${chalk.yellow(href)} to ${chalk.cyan(resolved)},\n` +
                chalk.grey(this.resourcePath));
            return resolved;
        }
        return href;
    }
    doLoadAssets(src) {
        if (src.startsWith('assets://') || src.startsWith('page://')) {
            const normalUrlObj = __api_1.default.normalizeAssetsUrl(src, this.resourcePath);
            if (_.isObject(normalUrlObj)) {
                const res = normalUrlObj;
                return rxjs_1.of(res.isPage ?
                    __api_1.default.entryPageUrl(res.packageName, res.path, res.locale) :
                    __api_1.default.assetsUrl(res.packageName, res.path));
            }
        }
        if (/^(?:https?:|\/\/|data:)/.test(src))
            return rxjs_1.of(src);
        if (src.charAt(0) === '/')
            return rxjs_1.of(src);
        if (src.charAt(0) === '~') {
            src = src.substring(1);
        }
        else if (src.startsWith('npm://')) {
            src = src.substring('npm://'.length);
        }
        else if (src.charAt(0) !== '.' && src.trim().length > 0 && src.indexOf('{') < 0)
            src = './' + src;
        return this.callback(src);
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AZHItY29yZS9uZy1hcHAtYnVpbGRlci90cy9uZy1hb3QtYXNzZXRzL2h0bWwtYXNzZXRzLXJlc29sdmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDREQUFrRjtBQUNsRiwwRUFBa0U7QUFDbEUsMERBQXdCO0FBQ3hCLHNEQUFzQjtBQUN0QixrREFBNEI7QUFDNUIsK0JBQThDO0FBQzlDLDhDQUFtQztBQUNuQyxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDL0IsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO0FBRS9FLDRCQUE0QjtBQUM1Qix1QkFBdUI7QUFDdkIsSUFBSTtBQUNKLE1BQU0sWUFBWSxHQUFHLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxZQUFZLENBQUMsQ0FBQztBQUVsRixTQUFnQixjQUFjLENBQUMsT0FBZSxFQUFFLFlBQW9CLEVBQ2xFLFFBQThDO0lBQzlDLElBQUksR0FBYSxDQUFDO0lBQ2xCLElBQUk7UUFDRixHQUFHLEdBQUcsSUFBSSwrQkFBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO0tBQzNDO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ25CLE1BQU0sQ0FBQyxDQUFDO0tBQ1Q7SUFDRCw2Q0FBNkM7SUFDN0MsTUFBTSxLQUFLLEdBQXNCLEVBQUUsQ0FBQztJQUNwQyxNQUFNLFFBQVEsR0FBRyxJQUFJLHFCQUFxQixDQUFDLFlBQVksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNuRSxLQUFLLE1BQU0sRUFBRSxJQUFJLEdBQUcsRUFBRTtRQUNwQiw0QkFBNEI7UUFDNUIsYUFBYTtRQUNiLEtBQUssTUFBTSxJQUFJLElBQUksWUFBWSxF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QUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztZQUNyQyxPQUFPLFNBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQixJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRztZQUN2QixPQUFPLFNBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQixJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQ3pCLEdBQUcsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3hCO2FBQU0sSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ25DLEdBQUcsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN0QzthQUFNLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO1lBQy9FLEdBQUcsR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFDO1FBRW5CLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM1QixDQUFDO0NBQ0YiLCJmaWxlIjoibm9kZV9tb2R1bGVzL0Bkci1jb3JlL25nLWFwcC1idWlsZGVyL2Rpc3QvbmctYW90LWFzc2V0cy9odG1sLWFzc2V0cy1yZXNvbHZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHtUZW1wbGF0ZVBhcnNlciwgQXR0cmlidXRlVmFsdWVBc3QsIFRhZ0FzdH0gZnJvbSAnLi4vdXRpbHMvbmctaHRtbC1wYXJzZXInO1xuaW1wb3J0IHBhdGNoVGV4dCwge1JlcGxhY2VtZW50IGFzIFJlcH0gZnJvbSAnLi4vdXRpbHMvcGF0Y2gtdGV4dCc7XG5pbXBvcnQgYXBpIGZyb20gJ19fYXBpJztcbmltcG9ydCBVcmwgZnJvbSAndXJsJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgb2YsIGZvcmtKb2lufSBmcm9tICdyeGpzJztcbmltcG9ydCB7bWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5jb25zdCBjaGFsayA9IHJlcXVpcmUoJ2NoYWxrJyk7XG5jb25zdCBsb2cgPSByZXF1aXJlKCdsb2c0anMnKS5nZXRMb2dnZXIoJ25nLWFwcC1idWlsZGVyLmh0bWwtYXNzZXRzLXJlc29sdmVyJyk7XG5cbi8vIGV4cG9ydCBlbnVtIFJlcGxhY2VUeXBlIHtcbi8vIFx0cmVzb2x2ZVVybCwgbG9hZFJlc1xuLy8gfVxuY29uc3QgdG9DaGVja05hbWVzID0gWydocmVmJywgJ3NyYycsICduZy1zcmMnLCAnbmctaHJlZicsICdzcmNzZXQnLCAncm91dGVyTGluayddO1xuXG5leHBvcnQgZnVuY3Rpb24gcmVwbGFjZUZvckh0bWwoY29udGVudDogc3RyaW5nLCByZXNvdXJjZVBhdGg6IHN0cmluZyxcbiAgY2FsbGJhY2s6ICh0ZXh0OiBzdHJpbmcpID0+IE9ic2VydmFibGU8c3RyaW5nPik6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gIGxldCBhc3Q6IFRhZ0FzdFtdO1xuICB0cnkge1xuICAgIGFzdCA9IG5ldyBUZW1wbGF0ZVBhcnNlcihjb250ZW50KS5wYXJzZSgpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yKGNvbnRlbnQpO1xuICAgIHRocm93IGU7XG4gIH1cbiAgLy8gY29uc3QgcHJvbXM6IEFycmF5PFByb21pc2VMaWtlPGFueT4+ID0gW107XG4gIGNvbnN0IGRvbmVzOiBPYnNlcnZhYmxlPFJlcD5bXSA9IFtdO1xuICBjb25zdCByZXNvbHZlciA9IG5ldyBBdHRyQXNzZXRzVXJsUmVzb2x2ZXIocmVzb3VyY2VQYXRoLCBjYWxsYmFjayk7XG4gIGZvciAoY29uc3QgZWwgb2YgYXN0KSB7XG4gICAgLy8gaWYgKGVsLm5hbWUgPT09ICdzY3JpcHQnKVxuICAgIC8vIFx0Y29udGludWU7XG4gICAgZm9yIChjb25zdCBuYW1lIG9mIHRvQ2hlY2tOYW1lcykge1xuICAgICAgaWYgKF8uaGFzKGVsLmF0dHJzLCBuYW1lKSkge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IGVsLmF0dHJzIVtuYW1lXS52YWx1ZTtcbiAgICAgICAgaWYgKGVsLmF0dHJzIVtuYW1lXS5pc05nIHx8IHZhbHVlID09IG51bGwgfHwgdmFsdWUudGV4dC5pbmRleE9mKCd7eycpID49IDAgKVxuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICBjb25zdCByZXNvbHZlZCQgPSByZXNvbHZlci5yZXNvbHZlKG5hbWUsIHZhbHVlLCBlbCk7XG4gICAgICAgIGlmIChyZXNvbHZlZCQpXG4gICAgICAgICAgZG9uZXMucHVzaChyZXNvbHZlZCQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBpZiAoZG9uZXMubGVuZ3RoID4gMClcbiAgICByZXR1cm4gZm9ya0pvaW4oZG9uZXMpLnBpcGUobWFwKHJlcGxhY2VtZW50cyA9PiBwYXRjaFRleHQoY29udGVudCwgcmVwbGFjZW1lbnRzKSkpO1xuICBlbHNlXG4gICAgcmV0dXJuIG9mKGNvbnRlbnQpO1xufVxuXG5jbGFzcyBBdHRyQXNzZXRzVXJsUmVzb2x2ZXIge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlc291cmNlUGF0aDogc3RyaW5nLCBwcml2YXRlIGNhbGxiYWNrOiAodGV4dDogc3RyaW5nKSA9PiBPYnNlcnZhYmxlPHN0cmluZz4pIHtcbiAgfVxuICByZXNvbHZlKGF0dHJOYW1lOiBzdHJpbmcsIHZhbHVlVG9rZW46IEF0dHJpYnV0ZVZhbHVlQXN0LFxuICAgIGVsOiBUYWdBc3QpOiBPYnNlcnZhYmxlPFJlcD4gfCBudWxsIHtcbiAgICBpZiAoIXZhbHVlVG9rZW4pXG4gICAgICByZXR1cm4gbnVsbDtcbiAgICBpZiAoYXR0ck5hbWUgPT09ICdzcmNzZXQnKSB7XG4gICAgICAvLyBpbWcgc3Jjc2V0XG4gICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZG9TcmNTZXQodmFsdWVUb2tlbi50ZXh0KTtcbiAgICAgIHJldHVybiB2YWx1ZS5waXBlKG1hcCh2YWx1ZSA9PiBuZXcgUmVwKHZhbHVlVG9rZW4uc3RhcnQsIHZhbHVlVG9rZW4uZW5kLCB2YWx1ZSkpKTtcbiAgICAgIC8vIHJlcGxhY2VtZW50cy5wdXNoKG5ldyBSZXAodmFsdWVUb2tlbi5zdGFydCwgdmFsdWVUb2tlbi5lbmQsIHZhbHVlKSk7XG4gICAgfSBlbHNlIGlmIChhdHRyTmFtZSA9PT0gJ3NyYycpIHtcbiAgICAgIC8vIGltZyBzcmNcbiAgICAgIGNvbnN0IHVybCA9IHRoaXMuZG9Mb2FkQXNzZXRzKHZhbHVlVG9rZW4udGV4dCk7XG4gICAgICByZXR1cm4gdXJsLnBpcGUobWFwKHVybCA9PiBuZXcgUmVwKHZhbHVlVG9rZW4uc3RhcnQsIHZhbHVlVG9rZW4uZW5kLCB1cmwpKSk7XG4gICAgfSBlbHNlIGlmIChhdHRyTmFtZSA9PT0gJ3JvdXRlckxpbmsnKSB7XG4gICAgICBjb25zdCB1cmwgPSB0aGlzLnJlc29sdmVVcmwodmFsdWVUb2tlbi50ZXh0KTtcbiAgICAgIGNvbnN0IHBhcnNlZFVybCA9IFVybC5wYXJzZSh1cmwpO1xuICAgICAgcmV0dXJuIG9mKG5ldyBSZXAodmFsdWVUb2tlbi5zdGFydCwgdmFsdWVUb2tlbi5lbmQsIHBhcnNlZFVybC5wYXRoICsgKHBhcnNlZFVybC5oYXNoID8gcGFyc2VkVXJsLmhhc2ggOiAnJykpKTtcbiAgICB9IGVsc2UgeyAvLyBocmVmLCBuZy1zcmMsIHJvdXRlckxpbmtcbiAgICAgIGNvbnN0IHVybCA9IHRoaXMucmVzb2x2ZVVybCh2YWx1ZVRva2VuLnRleHQpO1xuICAgICAgcmV0dXJuIG9mKG5ldyBSZXAodmFsdWVUb2tlbi5zdGFydCwgdmFsdWVUb2tlbi5lbmQsIHVybCkpO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIGRvU3JjU2V0KHZhbHVlOiBzdHJpbmcpIHtcbiAgICBjb25zdCB1cmxTZXRzJHMgPSB2YWx1ZS5zcGxpdCgvXFxzKixcXHMqLykubWFwKHVybFNldCA9PiB7XG4gICAgICB1cmxTZXQgPSBfLnRyaW0odXJsU2V0KTtcbiAgICAgIGNvbnN0IGZhY3RvcnMgPSB1cmxTZXQuc3BsaXQoL1xccysvKTtcbiAgICAgIGNvbnN0IGltYWdlID0gZmFjdG9yc1swXTtcbiAgICAgIHJldHVybiB0aGlzLmRvTG9hZEFzc2V0cyhpbWFnZSlcbiAgICAgIC5waXBlKG1hcCh1cmwgPT4gdXJsICsgZmFjdG9yc1sxXSkpO1xuICAgIH0pO1xuICAgIHJldHVybiBmb3JrSm9pbih1cmxTZXRzJHMpLnBpcGUobWFwKHVybFNldHMgPT4gdXJsU2V0cy5qb2luKCcsICcpKSk7XG4gIH1cblxuICBwcml2YXRlIHJlc29sdmVVcmwoaHJlZjogc3RyaW5nKSB7XG4gICAgaWYgKGhyZWYgPT09ICcnKVxuICAgICAgcmV0dXJuIGhyZWY7XG4gICAgdmFyIG5vcm1hbFVybE9iaiA9IGFwaS5ub3JtYWxpemVBc3NldHNVcmwoaHJlZiwgdGhpcy5yZXNvdXJjZVBhdGgpO1xuICAgIGlmIChfLmlzT2JqZWN0KG5vcm1hbFVybE9iaikpIHtcbiAgICAgIGNvbnN0IHJlcyA9IG5vcm1hbFVybE9iaiBhcyBhbnk7XG4gICAgICBjb25zdCByZXNvbHZlZCA9IHJlcy5pc1BhZ2UgP1xuICAgICAgICBhcGkuZW50cnlQYWdlVXJsKHJlcy5wYWNrYWdlTmFtZSwgcmVzLnBhdGgsIHJlcy5sb2NhbGUpIDpcbiAgICAgICAgYXBpLmFzc2V0c1VybChyZXMucGFja2FnZU5hbWUsIHJlcy5wYXRoKTtcbiAgICAgIGxvZy5pbmZvKGByZXNvbHZlIFVSTC9yb3V0ZVBhdGggJHtjaGFsay55ZWxsb3coaHJlZil9IHRvICR7Y2hhbGsuY3lhbihyZXNvbHZlZCl9LFxcbmAgK1xuICAgICAgICBjaGFsay5ncmV5KHRoaXMucmVzb3VyY2VQYXRoKSk7XG4gICAgICByZXR1cm4gcmVzb2x2ZWQ7XG4gICAgfVxuICAgIHJldHVybiBocmVmO1xuICB9XG5cbiAgcHJpdmF0ZSBkb0xvYWRBc3NldHMoc3JjOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIGlmIChzcmMuc3RhcnRzV2l0aCgnYXNzZXRzOi8vJykgfHwgc3JjLnN0YXJ0c1dpdGgoJ3BhZ2U6Ly8nKSkge1xuICAgICAgY29uc3Qgbm9ybWFsVXJsT2JqID0gYXBpLm5vcm1hbGl6ZUFzc2V0c1VybChzcmMsIHRoaXMucmVzb3VyY2VQYXRoKTtcbiAgICAgIGlmIChfLmlzT2JqZWN0KG5vcm1hbFVybE9iaikpIHtcbiAgICAgICAgY29uc3QgcmVzID0gbm9ybWFsVXJsT2JqIGFzIGFueTtcbiAgICAgICAgcmV0dXJuIG9mKHJlcy5pc1BhZ2UgP1xuICAgICAgICAgIGFwaS5lbnRyeVBhZ2VVcmwocmVzLnBhY2thZ2VOYW1lLCByZXMucGF0aCwgcmVzLmxvY2FsZSkgOlxuICAgICAgICAgIGFwaS5hc3NldHNVcmwocmVzLnBhY2thZ2VOYW1lLCByZXMucGF0aCkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICgvXig/Omh0dHBzPzp8XFwvXFwvfGRhdGE6KS8udGVzdChzcmMpKVxuICAgICAgcmV0dXJuIG9mKHNyYyk7XG4gICAgaWYgKHNyYy5jaGFyQXQoMCkgPT09ICcvJylcbiAgICAgIHJldHVybiBvZihzcmMpO1xuICAgIGlmIChzcmMuY2hhckF0KDApID09PSAnficpIHtcbiAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcoMSk7XG4gICAgfSBlbHNlIGlmIChzcmMuc3RhcnRzV2l0aCgnbnBtOi8vJykpIHtcbiAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcoJ25wbTovLycubGVuZ3RoKTtcbiAgICB9IGVsc2UgaWYgKHNyYy5jaGFyQXQoMCkgIT09ICcuJyAmJiBzcmMudHJpbSgpLmxlbmd0aCA+IDAgJiYgc3JjLmluZGV4T2YoJ3snKSA8IDApXG4gICAgICBzcmMgPSAnLi8nICsgc3JjO1xuXG4gICAgcmV0dXJuIHRoaXMuY2FsbGJhY2soc3JjKTtcbiAgfVxufVxuIl19
