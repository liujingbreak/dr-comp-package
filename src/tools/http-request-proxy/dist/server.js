"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const __api_1 = tslib_1.__importDefault(require("__api"));
const _ = tslib_1.__importStar(require("lodash"));
const log4js = tslib_1.__importStar(require("log4js"));
var log = log4js.getLogger(__api_1.default.packageName);
const proxy_handler_1 = tslib_1.__importDefault(require("./proxy-handler"));
function activate() {
    // api.router().use('/', api.cors());
    testRouter();
    var multiProxies = __api_1.default.config.get([__api_1.default.packageName, 'proxies']);
    if (multiProxies) {
        _.each(multiProxies, (target, name) => useProxy(__api_1.default.router(), target, name));
    }
    else {
        var proxyTo = __api_1.default.config.get(__api_1.default.packageName + '.proxyTo');
        if (proxyTo == null) {
            log.warn('No proxy configuration "%s" found', __api_1.default.packageName + '.proxies');
            return;
        }
        useProxy(__api_1.default.router(), proxyTo, '');
    }
}
exports.activate = activate;
var proxyInstances = {};
function forName(name, opts) {
    if (proxyInstances[name])
        return proxyInstances[name];
    var p = new ProxyInstance(name, opts);
    proxyInstances[name] = p;
    return p;
}
exports.forName = forName;
function forEach(callback) {
    var multiProxies = __api_1.default.config.get([__api_1.default.packageName, 'proxies']);
    if (multiProxies) {
        _.each(multiProxies, (target, name) => callback(forName(name)));
    }
    else {
        callback(forName(''));
    }
}
exports.forEach = forEach;
class ProxyInstance {
    constructor(name, options = {}) {
        this.options = options;
        this.resHandlers = {};
        this.reqHandlers = {};
        this.mockHandlers = {};
        this.resHeaderHandlers = {};
        this.name = name;
    }
    get isRemoveCookieDomain() {
        return !!this.options.removeCookieDomain;
    }
    addOptions(opt) {
        _.assign(this.options, opt);
        return this;
    }
    useProxy(router, target) {
        useProxy(router, target, this.name);
    }
    /**
     * @param {*} path sub path after '/http-request-proxy'
     * @param {*} handler (url: string, method:string,
     * 	responseHeaders: {[name: string]:string}, responseBody: string | Buffer) => null | Promise<string>
     */
    interceptResponse(path, handler) {
        this.addHandler(path, handler, this.resHandlers);
    }
    interceptRequest(path, handler) {
        this.addHandler(path, handler, this.reqHandlers);
    }
    mockResponse(path, handler) {
        this.addHandler(path, handler, this.mockHandlers);
    }
    interceptResHeader(path, handler) {
        this.addHandler(path, handler, this.resHeaderHandlers);
    }
    addHandler(path, handler, to) {
        if (path !== '*' && !_.startsWith(path, '/'))
            path = '/' + path;
        var list = _.get(to, path);
        if (list == null) {
            list = new Set();
            to[path] = list;
        }
        list.add(handler);
    }
}
exports.ProxyInstance = ProxyInstance;
/**
 * Add proxy middlewares to a specific router path
    * @param {Route} router Express router instance, could be `api.router()`
    * @param {string} target a full http URL, e.g. https://www-demo.foobar.com
    * @param {string} proxyPath sub path the proxy middleware will be handling on
 */
function useProxy(router, target, proxyPath) {
    if (proxyPath == null)
        proxyPath = '/';
    if (!proxyPath.startsWith('/'))
        proxyPath = '/' + proxyPath;
    target = _.trimEnd(target, '/');
    var proxyName = _.trimStart(proxyPath, '/');
    router.use(proxyPath, __api_1.default.cors());
    router.use(proxyPath, (req, res) => {
        proxy_handler_1.default(target, req, res, forName(proxyName), proxyName);
    });
    log.info('Proxy %s to %s', proxyPath, target);
}
exports.useProxy = useProxy;
function testRouter() {
    __api_1.default.router().use('/_test', (req, res) => {
        var s = '<pre>';
        s += JSON.stringify(req.headers, null, '\t') + '</pre>';
        _.forIn(req, (v, k) => {
            if (k.startsWith('_') || _.isFunction(v) || k === 'headers')
                return;
            try {
                log.info(k + ': ' + v);
                s += '<b>' + k + '</b>: ' + v + '<br/>';
            }
            catch (e) {
                log.error('cant resolve property %s', k);
            }
        });
        res.send(s);
    });
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AZHIvaHR0cC1yZXF1ZXN0LXByb3h5L3RzL3NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFBd0I7QUFDeEIsa0RBQTRCO0FBQzVCLHVEQUFpQztBQUVqQyxJQUFJLEdBQUcsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLGVBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUM1Qyw0RUFBc0M7QUFFdEMsU0FBZ0IsUUFBUTtJQUN2QixxQ0FBcUM7SUFDckMsVUFBVSxFQUFFLENBQUM7SUFDYixJQUFJLFlBQVksR0FBRyxlQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLGVBQUcsQ0FBQyxXQUFXLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUNoRSxJQUFJLFlBQVksRUFBRTtRQUNqQixDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxlQUFHLENBQUMsTUFBTSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7S0FDN0U7U0FBTTtRQUNOLElBQUksT0FBTyxHQUFHLGVBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGVBQUcsQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDLENBQUM7UUFDM0QsSUFBSSxPQUFPLElBQUksSUFBSSxFQUFFO1lBQ3BCLEdBQUcsQ0FBQyxJQUFJLENBQUMsbUNBQW1DLEVBQUUsZUFBRyxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUMsQ0FBQztZQUM1RSxPQUFPO1NBQ1A7UUFDRCxRQUFRLENBQUMsZUFBRyxDQUFDLE1BQU0sRUFBRSxFQUFFLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztLQUNwQztBQUNGLENBQUM7QUFkRCw0QkFjQztBQUVELElBQUksY0FBYyxHQUFpQyxFQUFFLENBQUM7QUFDdEQsU0FBZ0IsT0FBTyxDQUFDLElBQVksRUFBRSxJQUF5QjtJ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QUFFLEVBQUU7UUFDMUUsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDO1FBQ2hCLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQztRQUN4RCxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNyQixJQUFJLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssU0FBUztnQkFDMUQsT0FBTztZQUNSLElBQUk7Z0JBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUN2QixDQUFDLElBQUksS0FBSyxHQUFHLENBQUMsR0FBRyxRQUFRLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQzthQUN4QztZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNYLEdBQUcsQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDekM7UUFDRixDQUFDLENBQUMsQ0FBQztRQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDYixDQUFDLENBQUMsQ0FBQztBQUNKLENBQUMiLCJmaWxlIjoibm9kZV9tb2R1bGVzL0Bkci9odHRwLXJlcXVlc3QtcHJveHkvZGlzdC9zZXJ2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXBpIGZyb20gJ19fYXBpJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGxvZzRqcyBmcm9tICdsb2c0anMnO1xuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbnZhciBsb2cgPSBsb2c0anMuZ2V0TG9nZ2VyKGFwaS5wYWNrYWdlTmFtZSk7XG5pbXBvcnQgZG9Qcm94eSBmcm9tICcuL3Byb3h5LWhhbmRsZXInO1xuXG5leHBvcnQgZnVuY3Rpb24gYWN0aXZhdGUoKSB7XG5cdC8vIGFwaS5yb3V0ZXIoKS51c2UoJy8nLCBhcGkuY29ycygpKTtcblx0dGVzdFJvdXRlcigpO1xuXHR2YXIgbXVsdGlQcm94aWVzID0gYXBpLmNvbmZpZy5nZXQoW2FwaS5wYWNrYWdlTmFtZSwgJ3Byb3hpZXMnXSk7XG5cdGlmIChtdWx0aVByb3hpZXMpIHtcblx0XHRfLmVhY2gobXVsdGlQcm94aWVzLCAodGFyZ2V0LCBuYW1lKSA9PiB1c2VQcm94eShhcGkucm91dGVyKCksIHRhcmdldCwgbmFtZSkpO1xuXHR9IGVsc2Uge1xuXHRcdHZhciBwcm94eVRvID0gYXBpLmNvbmZpZy5nZXQoYXBpLnBhY2thZ2VOYW1lICsgJy5wcm94eVRvJyk7XG5cdFx0aWYgKHByb3h5VG8gPT0gbnVsbCkge1xuXHRcdFx0bG9nLndhcm4oJ05vIHByb3h5IGNvbmZpZ3VyYXRpb24gXCIlc1wiIGZvdW5kJywgYXBpLnBhY2thZ2VOYW1lICsgJy5wcm94aWVzJyk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdHVzZVByb3h5KGFwaS5yb3V0ZXIoKSwgcHJveHlUbywgJycpO1xuXHR9XG59XG5cbnZhciBwcm94eUluc3RhbmNlczoge1trOiBzdHJpbmddOiBQcm94eUluc3RhbmNlfSA9IHt9O1xuZXhwb3J0IGZ1bmN0aW9uIGZvck5hbWUobmFtZTogc3RyaW5nLCBvcHRzPzoge1trOiBzdHJpbmddOiBhbnl9KTogUHJveHlJbnN0YW5jZSB7XG5cdGlmIChwcm94eUluc3RhbmNlc1tuYW1lXSlcblx0XHRyZXR1cm4gcHJveHlJbnN0YW5jZXNbbmFtZV07XG5cdHZhciBwID0gbmV3IFByb3h5SW5zdGFuY2UobmFtZSwgb3B0cyk7XG5cdHByb3h5SW5zdGFuY2VzW25hbWVdID0gcDtcblx0cmV0dXJuIHA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmb3JFYWNoKGNhbGxiYWNrOiAocHJveHlJbnN0YW5jZTogUHJveHlJbnN0YW5jZSkgPT4gdm9pZCk6IHZvaWQge1xuXHR2YXIgbXVsdGlQcm94aWVzID0gYXBpLmNvbmZpZy5nZXQoW2FwaS5wYWNrYWdlTmFtZSwgJ3Byb3hpZXMnXSk7XG5cdGlmIChtdWx0aVByb3hpZXMpIHtcblx0XHRfLmVhY2gobXVsdGlQcm94aWVzLCAodGFyZ2V0LCBuYW1lKSA9PiBjYWxsYmFjayhmb3JOYW1lKG5hbWUpKSk7XG5cdH0gZWxzZSB7XG5cdFx0Y2FsbGJhY2soZm9yTmFtZSgnJykpO1xuXHR9XG59XG5leHBvcnQgdHlwZSBCb2R5SGFuZGxlciA9IChyZXE6IGV4cHJlc3MuUmVxdWVzdCxcblx0aGFja2VkUmVxSGVhZGVyczoge1tuYW1lOiBzdHJpbmddOiBzdHJpbmd9LFxuXHRyZXF1ZXN0Qm9keTogYW55LFxuXHRsYXN0UmVzdWx0OiBhbnkpID0+IGFueTtcblxuZXhwb3J0IHR5cGUgSGVhZGVySGFuZGxlciA9IChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgaGVhZGVyOiB7W25hbWU6IHN0cmluZ106IGFueX0pID0+IHZvaWQ7XG5leHBvcnQgY2xhc3MgUHJveHlJbnN0YW5jZSB7XG5cdG5hbWU6IHN0cmluZztcblx0cmVzSGFuZGxlcnM6IHtbcGF0aDogc3RyaW5nXTogU2V0PEJvZHlIYW5kbGVyIHwgSGVhZGVySGFuZGxlcj59ID0ge307XG5cdHJlcUhhbmRsZXJzOiB7W3BhdGg6IHN0cmluZ106IFNldDxCb2R5SGFuZGxlciB8IEhlYWRlckhhbmRsZXI+fSA9IHt9O1xuXHRtb2NrSGFuZGxlcnM6IHtbcGF0aDogc3RyaW5nXTogU2V0PEJvZHlIYW5kbGVyIHwgSGVhZGVySGFuZGxlcj59ID0ge307XG5cdHJlc0hlYWRlckhhbmRsZXJzOiB7W3BhdGg6IHN0cmluZ106IFNldDxIZWFkZXJIYW5kbGVyPn0gPSB7fTtcblx0Y29uc3RydWN0b3IobmFtZTogc3RyaW5nLCBwcml2YXRlIG9wdGlvbnM6IHtbazogc3RyaW5nXTogYW55fSA9IHt9KSB7XG5cdFx0dGhpcy5uYW1lID0gbmFtZTtcblx0fVxuXG5cdGdldCBpc1JlbW92ZUNvb2tpZURvbWFpbigpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gISF0aGlzLm9wdGlvbnMucmVtb3ZlQ29va2llRG9tYWluO1xuXHR9XG5cblx0YWRkT3B0aW9ucyhvcHQ6IHtbazogc3RyaW5nXTogYW55fSk6IFByb3h5SW5zdGFuY2Uge1xuXHRcdF8uYXNzaWduKHRoaXMub3B0aW9ucywgb3B0KTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHVzZVByb3h5KHJvdXRlcjogYW55LCB0YXJnZXQ6IHN0cmluZykge1xuXHRcdHVzZVByb3h5KHJvdXRlciwgdGFyZ2V0LCB0aGlzLm5hbWUpO1xuXHR9XG5cdC8qKlxuXHQgKiBAcGFyYW0geyp9IHBhdGggc3ViIHBhdGggYWZ0ZXIgJy9odHRwLXJlcXVlc3QtcHJveHknXG5cdCAqIEBwYXJhbSB7Kn0gaGFuZGxlciAodXJsOiBzdHJpbmcsIG1ldGhvZDpzdHJpbmcsXG5cdCAqIFx0cmVzcG9uc2VIZWFkZXJzOiB7W25hbWU6IHN0cmluZ106c3RyaW5nfSwgcmVzcG9uc2VCb2R5OiBzdHJpbmcgfCBCdWZmZXIpID0+IG51bGwgfCBQcm9taXNlPHN0cmluZz5cblx0ICovXG5cdGludGVyY2VwdFJlc3BvbnNlKHBhdGg6IHN0cmluZywgaGFuZGxlcjogQm9keUhhbmRsZXIpIHtcblx0XHR0aGlzLmFkZEhhbmRsZXIocGF0aCwgaGFuZGxlciwgdGhpcy5yZXNIYW5kbGVycyk7XG5cdH1cblx0aW50ZXJjZXB0UmVxdWVzdChwYXRoOiBzdHJpbmcsIGhhbmRsZXI6IEJvZHlIYW5kbGVyKSB7XG5cdFx0dGhpcy5hZGRIYW5kbGVyKHBhdGgsIGhhbmRsZXIsIHRoaXMucmVxSGFuZGxlcnMpO1xuXHR9XG5cdG1vY2tSZXNwb25zZShwYXRoOiBzdHJpbmcsIGhhbmRsZXI6IEJvZHlIYW5kbGVyKSB7XG5cdFx0dGhpcy5hZGRIYW5kbGVyKHBhdGgsIGhhbmRsZXIsIHRoaXMubW9ja0hhbmRsZXJzKTtcblx0fVxuXHRpbnRlcmNlcHRSZXNIZWFkZXIocGF0aDogc3RyaW5nLCBoYW5kbGVyOiBIZWFkZXJIYW5kbGVyKSB7XG5cdFx0dGhpcy5hZGRIYW5kbGVyKHBhdGgsIGhhbmRsZXIsIHRoaXMucmVzSGVhZGVySGFuZGxlcnMpO1xuXHR9XG5cdHByaXZhdGUgYWRkSGFuZGxlcihwYXRoOiBzdHJpbmcsIGhhbmRsZXI6IEJvZHlIYW5kbGVyIHwgSGVhZGVySGFuZGxlcixcblx0XHR0bzoge1twYXRoOiBzdHJpbmddOiBTZXQ8Qm9keUhhbmRsZXIgfCBIZWFkZXJIYW5kbGVyPn0pIHtcblx0XHRpZiAocGF0aCAhPT0gJyonICYmICFfLnN0YXJ0c1dpdGgocGF0aCwgJy8nKSlcblx0XHRcdHBhdGggPSAnLycgKyBwYXRoO1xuXHRcdHZhciBsaXN0OiBTZXQ8Qm9keUhhbmRsZXIgfCBIZWFkZXJIYW5kbGVyPiA9IF8uZ2V0KHRvLCBwYXRoKTtcblx0XHRpZiAobGlzdCA9PSBudWxsKSB7XG5cdFx0XHRsaXN0ID0gbmV3IFNldDxCb2R5SGFuZGxlciB8IEhlYWRlckhhbmRsZXI+KCk7XG5cdFx0XHR0b1twYXRoXSA9IGxpc3Q7XG5cdFx0fVxuXHRcdGxpc3QuYWRkKGhhbmRsZXIpO1xuXHR9XG59XG5cbi8qKlxuICogQWRkIHByb3h5IG1pZGRsZXdhcmVzIHRvIGEgc3BlY2lmaWMgcm91dGVyIHBhdGhcblx0KiBAcGFyYW0ge1JvdXRlfSByb3V0ZXIgRXhwcmVzcyByb3V0ZXIgaW5zdGFuY2UsIGNvdWxkIGJlIGBhcGkucm91dGVyKClgXG5cdCogQHBhcmFtIHtzdHJpbmd9IHRhcmdldCBhIGZ1bGwgaHR0cCBVUkwsIGUuZy4gaHR0cHM6Ly93d3ctZGVtby5mb29iYXIuY29tXG5cdCogQHBhcmFtIHtzdHJpbmd9IHByb3h5UGF0aCBzdWIgcGF0aCB0aGUgcHJveHkgbWlkZGxld2FyZSB3aWxsIGJlIGhhbmRsaW5nIG9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB1c2VQcm94eShyb3V0ZXI6IGV4cHJlc3MuUm91dGVyLCB0YXJnZXQ6IHN0cmluZywgcHJveHlQYXRoOiBzdHJpbmcpOiB2b2lkIHtcblx0aWYgKHByb3h5UGF0aCA9PSBudWxsKVxuXHRcdHByb3h5UGF0aCA9ICcvJztcblx0aWYgKCFwcm94eVBhdGguc3RhcnRzV2l0aCgnLycpKVxuXHRcdHByb3h5UGF0aCA9ICcvJyArIHByb3h5UGF0aDtcblx0dGFyZ2V0ID0gXy50cmltRW5kKHRhcmdldCwgJy8nKTtcblx0dmFyIHByb3h5TmFtZSA9IF8udHJpbVN0YXJ0KHByb3h5UGF0aCwgJy8nKTtcblxuXHRyb3V0ZXIudXNlKHByb3h5UGF0aCwgYXBpLmNvcnMoKSk7XG5cdHJvdXRlci51c2UocHJveHlQYXRoLCAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRcdGRvUHJveHkodGFyZ2V0LCByZXEsIHJlcywgZm9yTmFtZShwcm94eU5hbWUpLCBwcm94eU5hbWUpO1xuXHR9KTtcblx0bG9nLmluZm8oJ1Byb3h5ICVzIHRvICVzJywgcHJveHlQYXRoLCB0YXJnZXQpO1xufVxuXG5mdW5jdGlvbiB0ZXN0Um91dGVyKCk6IHZvaWQge1xuXHRhcGkucm91dGVyKCkudXNlKCcvX3Rlc3QnLCAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRcdHZhciBzID0gJzxwcmU+Jztcblx0XHRzICs9IEpTT04uc3RyaW5naWZ5KHJlcS5oZWFkZXJzLCBudWxsLCAnXFx0JykgKyAnPC9wcmU+Jztcblx0XHRfLmZvckluKHJlcSwgKHYsIGspID0+IHtcblx0XHRcdGlmIChrLnN0YXJ0c1dpdGgoJ18nKSB8fCBfLmlzRnVuY3Rpb24odikgfHwgayA9PT0gJ2hlYWRlcnMnKVxuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRsb2cuaW5mbyhrICsgJzogJyArIHYpO1xuXHRcdFx0XHRzICs9ICc8Yj4nICsgayArICc8L2I+OiAnICsgdiArICc8YnIvPic7XG5cdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdGxvZy5lcnJvcignY2FudCByZXNvbHZlIHByb3BlcnR5ICVzJywgayk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdFx0cmVzLnNlbmQocyk7XG5cdH0pO1xufVxuIl19
