"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
var request = require('request');
const __api_1 = tslib_1.__importDefault(require("__api"));
const _ = tslib_1.__importStar(require("lodash"));
// import {BodyHandler, HeaderHandler} from './server';
const proxy_instance_1 = require("../isom/proxy-instance");
const url_1 = tslib_1.__importDefault(require("url"));
const fs = tslib_1.__importStar(require("fs"));
var log = require('log4js').getLogger(__api_1.default.packageName + '.msg');
var logBody = require('log4js').getLogger(__api_1.default.packageName + '.body');
var chalk = require('chalk');
var trackRequestStream = __api_1.default.config.get(__api_1.default.packageName + '.trackRequestStream');
var countRequest = 0;
var SKIP_RES_HEADERS = [
    'transfer-encoding',
    'content-encoding',
    'cache-control',
    'access-control-allow-origin'
];
var SKIP_RES_HEADERS_SET = SKIP_RES_HEADERS.reduce((set, name) => {
    set[name.toLowerCase()] = true;
    return set;
}, {});
/**
 * @param {*} target {string} URL of proxying target
 * @param {*} req {request}
 * @param {*} res {response}
 * @param {*} proxyInstance
 * @param {*} proxyName {string} proxy sub path which should not starts with '/'
 * @return undefined
 */
function doProxy(target, req, res, proxyInstance, proxyName) {
    var requestNum = ++countRequest;
    var toUrl = target + req.url.replace(/\/\//g, '/');
    if (req.method === 'GET')
        toUrl += (req.url.indexOf('?') >= 0 ? '#' : '?') + 'random=' + Math.random();
    // ------------hack begins ------
    var toHeaders = hackHeaders(target, req);
    // ----------- hack ends ----------
    let requestDebugInfo = `\n[#${requestNum}] REQUEST ${chalk.yellow(req.method)} ${chalk.cyan(toUrl)}\n` +
        `OriginalUrl: ${req.originalUrl}\n` +
        // `Host: ${req.headers.host}\n` +
        // `request headers: ${JSON.stringify(req.headers, null, 2)}\n` +
        `Hacked header: ${JSON.stringify(toHeaders, null, 2)}\n`;
    // log.info('hacked request headers: \n%s', JSON.stringify(toHeaders, null, 2));
    var opts = {
        url: toUrl,
        method: req.method,
        headers: toHeaders,
        strictSSL: false,
        time: false,
        timeout: __api_1.default.config.get(__api_1.default.packageName + '.timeout', 20000),
        // "request" will not automatically do gzip decoding on incomingMessage,
        // must explicitly set `gzip` to true
        gzip: toHeaders['accept-encoding'] && toHeaders['accept-encoding'].indexOf('gzip') >= 0
    };
    return proxy_instance_1.intercept(req, toHeaders, req.body, proxyInstance.mockHandlers, proxyName)
        .then((mockBody) => {
        if (mockBody != null) {
            log.info(requestDebugInfo);
            return Promise.resolve(doBodyAsync(requestNum, req, req.body, opts))
                .then(msg => {
                log.info(msg);
                log.info('Mock response:\n' + chalk.blue(_.isString(mockBody) ? mockBody : JSON.stringify(mockBody)));
                res.status(200).send(mockBody);
            });
        }
        else {
            return proxy_instance_1.intercept(req, toHeaders, req.body, proxyInstance.reqHandlers, proxyName)
                .then((result) => {
                const reqBody = result == null ? req.body : result;
                return Promise.resolve(doBodyAsync(requestNum, req, reqBody, opts));
            })
                .then(msg => {
                requestDebugInfo += msg;
                return send(req, opts, requestDebugInfo, requestNum, res, proxyInstance);
            })
                .then((data) => {
                return proxy_instance_1.intercept(req, data.headers, data.body, proxyInstance.resHandlers, proxyName)
                    .then((body) => {
                    if (body)
                        logBody.info(`Hacked Response body:\n${chalk.green(_.isString(body) ? body :
                            (Buffer.isBuffer(body) ? 'buffer' : JSON.stringify(body)))}`);
                    res.status(data.res.statusCode).send(body == null ? data.body : body);
                });
            });
        }
    })
        .catch((err) => {
        log.error(err);
        res.status(500).send(err.message);
    });
}
exports.default = doProxy;
function send(req, opts, requestDebugInfo, requestNum, res, proxyInstance) {
    return new Promise((resolve, reject) => {
        var bufArray = [];
        request(opts, (err, msg, body) => {
            log.info(requestDebugInfo);
            var responseDebugInfo = `[#${requestNum}] RESPONSE:`;
            if (err) {
                log.error(`Request error ${err}`);
                reject(err);
                return;
            }
            if (msg.statusCode > 299 || msg.statusCode < 200)
                log.warn('Status: %d %s', msg.statusCode, msg.statusMessage);
            else
                responseDebugInfo += `Status: ${msg.statusCode} ${msg.statusMessage}\n`;
            responseDebugInfo += 'Response headers:\n' + JSON.stringify(msg.headers, null, 2);
            hackResponseHeaders(req, msg.headers, res, proxyInstance);
            log.info(responseDebugInfo);
            var contentType = _.get(msg.headers, 'content-type');
            if (contentType && (contentType.indexOf('xml') >= 0 || contentType.indexOf('text') >= 0 ||
                contentType.indexOf('json') >= 0)) {
                logBody.info(`Response body:\n${chalk.blue(body)}`);
                return resolve({ headers: msg.headers, body, res: msg });
            }
            var buf = Buffer.concat(bufArray);
            return resolve({ headers: msg.headers, body: buf, res: msg });
        })
            .on('data', (b) => bufArray.push(b))
            .on('end', () => { });
    });
}
/**
 * Transport request from express to a request options.form/body for Request
 * @param {object} reqHeaders expresss request.headers
 * @param {object | string} reqBody expresss request.body
 * @param {object} opts Request options
 * @return debug string
 */
function doBodyAsync(requestNum, req, reqBody, opts) {
    var reqHeaders = req.headers;
    if (Buffer.isBuffer(reqBody) || _.isString(reqBody)) {
        // 
        opts.body = reqBody;
        return 'Body as Buffer or string: ' + reqBody.length;
    }
    else if (_.isObject(reqBody)) {
        // Request body is object (JSON, form or stream)
        const reqContentType = reqHeaders['content-type'];
        if (reqContentType && reqContentType.indexOf('json') >= 0) {
            opts.body = JSON.stringify(reqBody);
            return 'Body as JSON: ' + opts.body;
        }
        else if (reqContentType && reqContentType.indexOf('application/x-www-form-urlencoded') >= 0) {
            opts.form = reqBody;
            return 'Body as form: ' + JSON.stringify(opts.form);
        }
    }
    // Request body is stream
    if (trackRequestStream) {
        const tempFile = __api_1.default.config.resolve('destDir', 'request-body-' + requestNum);
        var out = fs.createWriteStream(tempFile);
        return new Promise((resolve, reject) => {
            req.pipe(out).on('finish', () => {
                log.info('Finished writing request body to temp file ', tempFile);
                opts.body = fs.createReadStream(tempFile);
                resolve('Body as Readable Stream');
            });
        });
    }
    else {
        opts.body = req;
        return 'Body as Readable Stream';
    }
}
function hackHeaders(target, req) {
    var toHeaders = _.assign({}, req.headers, {
        'x-real-ip': req.ip,
        'x-forwarded_for': req.ip,
        'x-forwarded-for': req.ip
    });
    var parsedTarget = url_1.default.parse(target);
    toHeaders.host = parsedTarget.host;
    delete toHeaders.origin;
    if (toHeaders.referer) {
        // tslint:disable-next-line:max-line-length
        toHeaders.referer = `${parsedTarget.protocol}//${parsedTarget.host}${url_1.default.parse(toHeaders.referer).pathname}`;
    }
    return toHeaders;
}
function hackResponseHeaders(req, originHeaders, response, proxyInstance) {
    _.each(originHeaders, (v, n) => {
        if (!_.get(SKIP_RES_HEADERS_SET, n.toLowerCase())) {
            if (n === 'set-cookie' && proxyInstance.isRemoveCookieDomain) {
                v = v.map((cookie) => {
                    var attrs = cookie.split(';');
                    return attrs.filter((value) => !value.startsWith('domain')).join(';');
                });
                log.info('Domain attribute is removed from set-cookie header: ', v);
            }
            response.set(n, v);
        }
        else
            log.debug('skip response header: %s', n);
    });
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AZHIvaHR0cC1yZXF1ZXN0LXByb3h5L3RzL3Byb3h5LWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2pDLDBEQUF3QjtBQUN4QixrREFBNEI7QUFHNUIsdURBQXVEO0FBQ3ZELDJEQUFpRDtBQUNqRCxzREFBc0I7QUFFdEIsK0NBQXlCO0FBQ3pCLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsZUFBRyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsQ0FBQztBQUNoRSxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsU0FBUyxDQUFDLGVBQUcsQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLENBQUM7QUFFckUsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzdCLElBQUksa0JBQWtCLEdBQUcsZUFBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsZUFBRyxDQUFDLFdBQVcsR0FBRyxxQkFBcUIsQ0FBQyxDQUFDO0FBRWpGLElBQUksWUFBWSxHQUFHLENBQUMsQ0FBQztBQUVyQixJQUFJLGdCQUFnQixHQUFHO0lBQ3RCLG1CQUFtQjtJQUNuQixrQkFBa0I7SUFDbEIsZUFBZTtJQUNmLDZCQUE2QjtDQUM3QixDQUFDO0FBQ0YsSUFBSSxvQkFBb0IsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUEyQixFQUFFLElBQUksRUFBRSxFQUFFO0lBQ3hGLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDL0IsT0FBTyxHQUFHLENBQUM7QUFDWixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFFUDs7Ozs7OztHQU9HO0FBQ0gsU0FBd0IsT0FBTyxDQUFDLE1BQWMsRUFBRSxHQUFvQixF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Q25COztZQUNBLEdBQUcsQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDM0MsQ0FBQyxDQUFDLENBQUM7QUFDSixDQUFDIiwiZmlsZSI6Im5vZGVfbW9kdWxlcy9AZHIvaHR0cC1yZXF1ZXN0LXByb3h5L2Rpc3QvcHJveHktaGFuZGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciByZXF1ZXN0ID0gcmVxdWlyZSgncmVxdWVzdCcpO1xuaW1wb3J0IGFwaSBmcm9tICdfX2FwaSc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgUHJveHlJbnN0YW5jZSB9IGZyb20gJy4vc2VydmVyJztcbi8vIGltcG9ydCB7Qm9keUhhbmRsZXIsIEhlYWRlckhhbmRsZXJ9IGZyb20gJy4vc2VydmVyJztcbmltcG9ydCB7aW50ZXJjZXB0fSBmcm9tICcuLi9pc29tL3Byb3h5LWluc3RhbmNlJztcbmltcG9ydCBVcmwgZnJvbSAndXJsJztcbmltcG9ydCB7SW5jb21pbmdNZXNzYWdlfSBmcm9tICdodHRwJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbnZhciBsb2cgPSByZXF1aXJlKCdsb2c0anMnKS5nZXRMb2dnZXIoYXBpLnBhY2thZ2VOYW1lICsgJy5tc2cnKTtcbnZhciBsb2dCb2R5ID0gcmVxdWlyZSgnbG9nNGpzJykuZ2V0TG9nZ2VyKGFwaS5wYWNrYWdlTmFtZSArICcuYm9keScpO1xuXG52YXIgY2hhbGsgPSByZXF1aXJlKCdjaGFsaycpO1xudmFyIHRyYWNrUmVxdWVzdFN0cmVhbSA9IGFwaS5jb25maWcuZ2V0KGFwaS5wYWNrYWdlTmFtZSArICcudHJhY2tSZXF1ZXN0U3RyZWFtJyk7XG5cbnZhciBjb3VudFJlcXVlc3QgPSAwO1xuXG52YXIgU0tJUF9SRVNfSEVBREVSUyA9IFtcblx0J3RyYW5zZmVyLWVuY29kaW5nJyxcblx0J2NvbnRlbnQtZW5jb2RpbmcnLFxuXHQnY2FjaGUtY29udHJvbCcsXG5cdCdhY2Nlc3MtY29udHJvbC1hbGxvdy1vcmlnaW4nXG5dO1xudmFyIFNLSVBfUkVTX0hFQURFUlNfU0VUID0gU0tJUF9SRVNfSEVBREVSUy5yZWR1Y2UoKHNldDoge1trOiBzdHJpbmddOiBib29sZWFufSwgbmFtZSkgPT4ge1xuXHRzZXRbbmFtZS50b0xvd2VyQ2FzZSgpXSA9IHRydWU7XG5cdHJldHVybiBzZXQ7XG59LCB7fSk7XG5cbi8qKlxuICogQHBhcmFtIHsqfSB0YXJnZXQge3N0cmluZ30gVVJMIG9mIHByb3h5aW5nIHRhcmdldFxuICogQHBhcmFtIHsqfSByZXEge3JlcXVlc3R9XG4gKiBAcGFyYW0geyp9IHJlcyB7cmVzcG9uc2V9XG4gKiBAcGFyYW0geyp9IHByb3h5SW5zdGFuY2VcbiAqIEBwYXJhbSB7Kn0gcHJveHlOYW1lIHtzdHJpbmd9IHByb3h5IHN1YiBwYXRoIHdoaWNoIHNob3VsZCBub3Qgc3RhcnRzIHdpdGggJy8nXG4gKiBAcmV0dXJuIHVuZGVmaW5lZFxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBkb1Byb3h5KHRhcmdldDogc3RyaW5nLCByZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlLFxuXHRwcm94eUluc3RhbmNlOiBQcm94eUluc3RhbmNlLCBwcm94eU5hbWU6IHN0cmluZykge1xuXHR2YXIgcmVxdWVzdE51bSA9ICsrY291bnRSZXF1ZXN0O1xuXG5cdHZhciB0b1VybCA9IHRhcmdldCArIHJlcS51cmwucmVwbGFjZSgvXFwvXFwvL2csICcvJyk7XG5cdGlmIChyZXEubWV0aG9kID09PSAnR0VUJylcblx0XHR0b1VybCArPSAocmVxLnVybC5pbmRleE9mKCc/JykgPj0gMCA/ICcjJyA6ICc/JykgKyAncmFuZG9tPScgKyBNYXRoLnJhbmRvbSgpO1xuXHQvLyAtLS0tLS0tLS0tLS1oYWNrIGJlZ2lucyAtLS0tLS1cblx0dmFyIHRvSGVhZGVycyA9IGhhY2tIZWFkZXJzKHRhcmdldCwgcmVxKTtcblx0Ly8gLS0tLS0tLS0tLS0gaGFjayBlbmRzIC0tLS0tLS0tLS1cblx0bGV0IHJlcXVlc3REZWJ1Z0luZm8gPSBgXFxuWyMke3JlcXVlc3ROdW19XSBSRVFVRVNUICR7Y2hhbGsueWVsbG93KHJlcS5tZXRob2QpfSAke2NoYWxrLmN5YW4odG9VcmwpfVxcbmAgK1xuXHRgT3JpZ2luYWxVcmw6ICR7cmVxLm9yaWdpbmFsVXJsfVxcbmAgK1xuXHQvLyBgSG9zdDogJHtyZXEuaGVhZGVycy5ob3N0fVxcbmAgK1xuXHQvLyBgcmVxdWVzdCBoZWFkZXJzOiAke0pTT04uc3RyaW5naWZ5KHJlcS5oZWFkZXJzLCBudWxsLCAyKX1cXG5gICtcblx0YEhhY2tlZCBoZWFkZXI6ICR7SlNPTi5zdHJpbmdpZnkodG9IZWFkZXJzLCBudWxsLCAyKX1cXG5gO1xuXHQvLyBsb2cuaW5mbygnaGFja2VkIHJlcXVlc3QgaGVhZGVyczogXFxuJXMnLCBKU09OLnN0cmluZ2lmeSh0b0hlYWRlcnMsIG51bGwsIDIpKTtcblx0dmFyIG9wdHMgPSB7XG5cdFx0dXJsOiB0b1VybCxcblx0XHRtZXRob2Q6IHJlcS5tZXRob2QsXG5cdFx0aGVhZGVyczogdG9IZWFkZXJzLFxuXHRcdHN0cmljdFNTTDogZmFsc2UsXG5cdFx0dGltZTogZmFsc2UsXG5cdFx0dGltZW91dDogYXBpLmNvbmZpZy5nZXQoYXBpLnBhY2thZ2VOYW1lICsgJy50aW1lb3V0JywgMjAwMDApLFxuXHRcdC8vIFwicmVxdWVzdFwiIHdpbGwgbm90IGF1dG9tYXRpY2FsbHkgZG8gZ3ppcCBkZWNvZGluZyBvbiBpbmNvbWluZ01lc3NhZ2UsXG5cdFx0Ly8gbXVzdCBleHBsaWNpdGx5IHNldCBgZ3ppcGAgdG8gdHJ1ZVxuXHRcdGd6aXA6IHRvSGVhZGVyc1snYWNjZXB0LWVuY29kaW5nJ10gJiYgdG9IZWFkZXJzWydhY2NlcHQtZW5jb2RpbmcnXS5pbmRleE9mKCdnemlwJykgPj0gMFxuXHR9O1xuXG5cdHJldHVybiBpbnRlcmNlcHQocmVxLCB0b0hlYWRlcnMsIHJlcS5ib2R5LCBwcm94eUluc3RhbmNlLm1vY2tIYW5kbGVycywgcHJveHlOYW1lKVxuXHQudGhlbigobW9ja0JvZHk6IGFueSkgPT4ge1xuXHRcdGlmIChtb2NrQm9keSAhPSBudWxsKSB7XG5cdFx0XHRsb2cuaW5mbyhyZXF1ZXN0RGVidWdJbmZvKTtcblx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUoZG9Cb2R5QXN5bmMocmVxdWVzdE51bSwgcmVxLCByZXEuYm9keSwgb3B0cykpXG5cdFx0XHQudGhlbihtc2cgPT4ge1xuXHRcdFx0XHRsb2cuaW5mbyhtc2cpO1xuXHRcdFx0XHRsb2cuaW5mbygnTW9jayByZXNwb25zZTpcXG4nICsgY2hhbGsuYmx1ZShfLmlzU3RyaW5nKG1vY2tCb2R5KSA/IG1vY2tCb2R5IDogSlNPTi5zdHJpbmdpZnkobW9ja0JvZHkpKSk7XG5cdFx0XHRcdHJlcy5zdGF0dXMoMjAwKS5zZW5kKG1vY2tCb2R5KTtcblx0XHRcdH0pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXR1cm4gaW50ZXJjZXB0KHJlcSwgdG9IZWFkZXJzLCByZXEuYm9keSwgcHJveHlJbnN0YW5jZS5yZXFIYW5kbGVycywgcHJveHlOYW1lKVxuXHRcdFx0LnRoZW4oKHJlc3VsdDogYW55KSA9PiB7XG5cdFx0XHRcdGNvbnN0IHJlcUJvZHkgPSByZXN1bHQgPT0gbnVsbCA/IHJlcS5ib2R5IDogcmVzdWx0O1xuXHRcdFx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRvQm9keUFzeW5jKHJlcXVlc3ROdW0sIHJlcSwgcmVxQm9keSwgb3B0cykpO1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKG1zZyA9PiB7XG5cdFx0XHRcdHJlcXVlc3REZWJ1Z0luZm8gKz0gbXNnO1xuXHRcdFx0XHRyZXR1cm4gc2VuZChyZXEsIG9wdHMsIHJlcXVlc3REZWJ1Z0luZm8sIHJlcXVlc3ROdW0sIHJlcywgcHJveHlJbnN0YW5jZSk7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oKGRhdGE6IGFueSkgPT4ge1xuXHRcdFx0XHRyZXR1cm4gaW50ZXJjZXB0KHJlcSwgZGF0YS5oZWFkZXJzLCBkYXRhLmJvZHksIHByb3h5SW5zdGFuY2UucmVzSGFuZGxlcnMsIHByb3h5TmFtZSlcblx0XHRcdFx0LnRoZW4oKGJvZHk6IGFueSkgPT4ge1xuXHRcdFx0XHRcdGlmIChib2R5KVxuXHRcdFx0XHRcdFx0bG9nQm9keS5pbmZvKGBIYWNrZWQgUmVzcG9uc2UgYm9keTpcXG4ke2NoYWxrLmdyZWVuKF8uaXNTdHJpbmcoYm9keSkgPyBib2R5IDpcblx0XHRcdFx0XHRcdFx0KEJ1ZmZlci5pc0J1ZmZlcihib2R5KSA/ICdidWZmZXInIDogSlNPTi5zdHJpbmdpZnkoYm9keSkpKX1gKTtcblx0XHRcdFx0XHRyZXMuc3RhdHVzKGRhdGEucmVzLnN0YXR1c0NvZGUpLnNlbmQoYm9keSA9PSBudWxsID8gZGF0YS5ib2R5IDogYm9keSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSk7XG5cdFx0fVxuXHR9KVxuXHQuY2F0Y2goKGVycjogRXJyb3IpID0+IHtcblx0XHRsb2cuZXJyb3IoZXJyKTtcblx0XHRyZXMuc3RhdHVzKDUwMCkuc2VuZChlcnIubWVzc2FnZSk7XG5cdH0pO1xufVxuXG5mdW5jdGlvbiBzZW5kKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCBvcHRzOiBhbnksIHJlcXVlc3REZWJ1Z0luZm86IGFueSwgcmVxdWVzdE51bTogbnVtYmVyLCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsXG5cdHByb3h5SW5zdGFuY2U6IFByb3h5SW5zdGFuY2UpOlxuXHRQcm9taXNlPHtoZWFkZXJzOiB7W2s6IHN0cmluZ106IGFueX0sIGJvZHk6IGFueSwgcmVzOiBJbmNvbWluZ01lc3NhZ2V9PiB7XG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0dmFyIGJ1ZkFycmF5OiBCdWZmZXJbXSA9IFtdO1xuXHRcdHJlcXVlc3Qob3B0cywgKGVycjogRXJyb3IsIG1zZzogSW5jb21pbmdNZXNzYWdlLCBib2R5OiBzdHJpbmd8QnVmZmVyKSA9PiB7XG5cdFx0XHRsb2cuaW5mbyhyZXF1ZXN0RGVidWdJbmZvKTtcblx0XHRcdHZhciByZXNwb25zZURlYnVnSW5mbyA9IGBbIyR7cmVxdWVzdE51bX1dIFJFU1BPTlNFOmA7XG5cdFx0XHRpZiAoZXJyKSB7XG5cdFx0XHRcdGxvZy5lcnJvcihgUmVxdWVzdCBlcnJvciAke2Vycn1gKTtcblx0XHRcdFx0cmVqZWN0KGVycik7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblx0XHRcdGlmIChtc2cuc3RhdHVzQ29kZSA+IDI5OSB8fCBtc2cuc3RhdHVzQ29kZSA8IDIwMClcblx0XHRcdFx0bG9nLndhcm4oJ1N0YXR1czogJWQgJXMnLCBtc2cuc3RhdHVzQ29kZSwgbXNnLnN0YXR1c01lc3NhZ2UpO1xuXHRcdFx0ZWxzZVxuXHRcdFx0XHRyZXNwb25zZURlYnVnSW5mbyArPSBgU3RhdHVzOiAke21zZy5zdGF0dXNDb2RlfSAke21zZy5zdGF0dXNNZXNzYWdlfVxcbmA7XG5cdFx0XHRyZXNwb25zZURlYnVnSW5mbyArPSAnUmVzcG9uc2UgaGVhZGVyczpcXG4nICsgSlNPTi5zdHJpbmdpZnkobXNnLmhlYWRlcnMsIG51bGwsIDIpO1xuXHRcdFx0aGFja1Jlc3BvbnNlSGVhZGVycyhyZXEsIG1zZy5oZWFkZXJzLCByZXMsIHByb3h5SW5zdGFuY2UpO1xuXHRcdFx0bG9nLmluZm8ocmVzcG9uc2VEZWJ1Z0luZm8pO1xuXG5cdFx0XHR2YXIgY29udGVudFR5cGUgPSBfLmdldChtc2cuaGVhZGVycywgJ2NvbnRlbnQtdHlwZScpO1xuXHRcdFx0aWYgKGNvbnRlbnRUeXBlICYmIChjb250ZW50VHlwZS5pbmRleE9mKCd4bWwnKSA+PSAwIHx8IGNvbnRlbnRUeXBlLmluZGV4T2YoJ3RleHQnKSA+PSAwIHx8XG5cdFx0XHRcdGNvbnRlbnRUeXBlLmluZGV4T2YoJ2pzb24nKSA+PSAwICkpIHtcblx0XHRcdFx0bG9nQm9keS5pbmZvKGBSZXNwb25zZSBib2R5OlxcbiR7Y2hhbGsuYmx1ZShib2R5KX1gKTtcblx0XHRcdFx0cmV0dXJuIHJlc29sdmUoe2hlYWRlcnM6IG1zZy5oZWFkZXJzLCBib2R5LCByZXM6IG1zZ30pO1xuXHRcdFx0fVxuXHRcdFx0dmFyIGJ1ZiA9IEJ1ZmZlci5jb25jYXQoYnVmQXJyYXkpO1xuXHRcdFx0cmV0dXJuIHJlc29sdmUoe2hlYWRlcnM6IG1zZy5oZWFkZXJzLCBib2R5OiBidWYsIHJlczogbXNnfSk7XG5cdFx0fSlcblx0XHQub24oJ2RhdGEnLCAoYjogQnVmZmVyKSA9PiBidWZBcnJheS5wdXNoKGIpKVxuXHRcdC5vbignZW5kJywgKCkgPT4ge30pO1xuXHR9KTtcbn1cblxuLyoqXG4gKiBUcmFuc3BvcnQgcmVxdWVzdCBmcm9tIGV4cHJlc3MgdG8gYSByZXF1ZXN0IG9wdGlvbnMuZm9ybS9ib2R5IGZvciBSZXF1ZXN0XG4gKiBAcGFyYW0ge29iamVjdH0gcmVxSGVhZGVycyBleHByZXNzcyByZXF1ZXN0LmhlYWRlcnNcbiAqIEBwYXJhbSB7b2JqZWN0IHwgc3RyaW5nfSByZXFCb2R5IGV4cHJlc3NzIHJlcXVlc3QuYm9keVxuICogQHBhcmFtIHtvYmplY3R9IG9wdHMgUmVxdWVzdCBvcHRpb25zXG4gKiBAcmV0dXJuIGRlYnVnIHN0cmluZ1xuICovXG5mdW5jdGlvbiBkb0JvZHlBc3luYyhyZXF1ZXN0TnVtOiBudW1iZXIsIHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXFCb2R5OiBhbnksIG9wdHM6IHtbazogc3RyaW5nXTogYW55fSk6XG5cdHN0cmluZyB8IFByb21pc2VMaWtlPHN0cmluZz4ge1xuXHR2YXIgcmVxSGVhZGVyczoge1trOiBzdHJpbmddOiBhbnl9ID0gcmVxLmhlYWRlcnM7XG5cdGlmIChCdWZmZXIuaXNCdWZmZXIocmVxQm9keSkgfHwgXy5pc1N0cmluZyhyZXFCb2R5KSkge1xuXHRcdC8vIFxuXHRcdG9wdHMuYm9keSA9IHJlcUJvZHk7XG5cdFx0cmV0dXJuICdCb2R5IGFzIEJ1ZmZlciBvciBzdHJpbmc6ICcgKyByZXFCb2R5Lmxlbmd0aDtcblx0fSBlbHNlIGlmIChfLmlzT2JqZWN0KHJlcUJvZHkpKSB7XG5cdFx0Ly8gUmVxdWVzdCBib2R5IGlzIG9iamVjdCAoSlNPTiwgZm9ybSBvciBzdHJlYW0pXG5cdFx0Y29uc3QgcmVxQ29udGVudFR5cGUgPSByZXFIZWFkZXJzWydjb250ZW50LXR5cGUnXTtcblx0XHRpZiAocmVxQ29udGVudFR5cGUgJiYgcmVxQ29udGVudFR5cGUuaW5kZXhPZignanNvbicpID49IDApIHtcblx0XHRcdG9wdHMuYm9keSA9IEpTT04uc3RyaW5naWZ5KHJlcUJvZHkpO1xuXHRcdFx0cmV0dXJuICdCb2R5IGFzIEpTT046ICcgKyBvcHRzLmJvZHk7XG5cdFx0fSBlbHNlIGlmIChyZXFDb250ZW50VHlwZSAmJiByZXFDb250ZW50VHlwZS5pbmRleE9mKCdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnKSA+PSAwKSB7XG5cdFx0XHRvcHRzLmZvcm0gPSByZXFCb2R5O1xuXHRcdFx0cmV0dXJuICdCb2R5IGFzIGZvcm06ICcgKyBKU09OLnN0cmluZ2lmeShvcHRzLmZvcm0pO1xuXHRcdH1cblx0fVxuXG5cdC8vIFJlcXVlc3QgYm9keSBpcyBzdHJlYW1cblx0aWYgKHRyYWNrUmVxdWVzdFN0cmVhbSkge1xuXHRcdGNvbnN0IHRlbXBGaWxlOiBzdHJpbmcgPSBhcGkuY29uZmlnLnJlc29sdmUoJ2Rlc3REaXInLCAncmVxdWVzdC1ib2R5LScgKyByZXF1ZXN0TnVtKTtcblx0XHR2YXIgb3V0ID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0odGVtcEZpbGUpO1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHRyZXEucGlwZShvdXQpLm9uKCdmaW5pc2gnLCAoKSA9PiB7XG5cdFx0XHRcdGxvZy5pbmZvKCdGaW5pc2hlZCB3cml0aW5nIHJlcXVlc3QgYm9keSB0byB0ZW1wIGZpbGUgJywgdGVtcEZpbGUpO1xuXHRcdFx0XHRvcHRzLmJvZHkgPSBmcy5jcmVhdGVSZWFkU3RyZWFtKHRlbXBGaWxlKTtcblx0XHRcdFx0cmVzb2x2ZSgnQm9keSBhcyBSZWFkYWJsZSBTdHJlYW0nKTtcblx0XHRcdH0pO1xuXHRcdH0pO1xuXHR9IGVsc2Uge1xuXHRcdG9wdHMuYm9keSA9IHJlcTtcblx0XHRyZXR1cm4gJ0JvZHkgYXMgUmVhZGFibGUgU3RyZWFtJztcblx0fVxufVxuXG5mdW5jdGlvbiBoYWNrSGVhZGVycyh0YXJnZXQ6IHN0cmluZywgcmVxOiBleHByZXNzLlJlcXVlc3QpOiB7W2s6IHN0cmluZ106IGFueX0ge1xuXHR2YXIgdG9IZWFkZXJzID0gXy5hc3NpZ24oe30sIHJlcS5oZWFkZXJzLCB7XG5cdFx0J3gtcmVhbC1pcCc6IHJlcS5pcCxcblx0XHQneC1mb3J3YXJkZWRfZm9yJzogcmVxLmlwLFxuXHRcdCd4LWZvcndhcmRlZC1mb3InOiByZXEuaXBcblx0fSk7XG5cdHZhciBwYXJzZWRUYXJnZXQgPSBVcmwucGFyc2UodGFyZ2V0KTtcblx0dG9IZWFkZXJzLmhvc3QgPSBwYXJzZWRUYXJnZXQuaG9zdDtcblx0ZGVsZXRlIHRvSGVhZGVycy5vcmlnaW47XG5cdGlmICh0b0hlYWRlcnMucmVmZXJlcikge1xuXHRcdC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcblx0XHR0b0hlYWRlcnMucmVmZXJlciA9IGAke3BhcnNlZFRhcmdldC5wcm90b2NvbH0vLyR7cGFyc2VkVGFyZ2V0Lmhvc3R9JHtVcmwucGFyc2UodG9IZWFkZXJzLnJlZmVyZXIgYXMgc3RyaW5nKS5wYXRobmFtZX1gO1xuXHR9XG5cdHJldHVybiB0b0hlYWRlcnM7XG59XG5cbmZ1bmN0aW9uIGhhY2tSZXNwb25zZUhlYWRlcnMocmVxOiBleHByZXNzLlJlcXVlc3QsIG9yaWdpbkhlYWRlcnM6IHtbazogc3RyaW5nXTogYW55fSwgcmVzcG9uc2U6IGV4cHJlc3MuUmVzcG9uc2UsXG5cdHByb3h5SW5zdGFuY2U6IFByb3h5SW5zdGFuY2UpIHtcblx0Xy5lYWNoKG9yaWdpbkhlYWRlcnMsICh2LCBuKSA9PiB7XG5cdFx0aWYgKCFfLmdldChTS0lQX1JFU19IRUFERVJTX1NFVCwgbi50b0xvd2VyQ2FzZSgpKSkge1xuXHRcdFx0aWYgKG4gPT09ICdzZXQtY29va2llJyAmJiBwcm94eUluc3RhbmNlLmlzUmVtb3ZlQ29va2llRG9tYWluKSB7XG5cdFx0XHRcdHYgPSB2Lm1hcCgoY29va2llOiBhbnkpID0+IHtcblx0XHRcdFx0XHR2YXIgYXR0cnM6IHN0cmluZ1tdID0gY29va2llLnNwbGl0KCc7Jyk7XG5cdFx0XHRcdFx0cmV0dXJuIGF0dHJzLmZpbHRlcigodmFsdWUpID0+ICF2YWx1ZS5zdGFydHNXaXRoKCdkb21haW4nKSkuam9pbignOycpO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0bG9nLmluZm8oJ0RvbWFpbiBhdHRyaWJ1dGUgaXMgcmVtb3ZlZCBmcm9tIHNldC1jb29raWUgaGVhZGVyOiAnLCB2KTtcblx0XHRcdH1cblx0XHRcdHJlc3BvbnNlLnNldChuLCB2KTtcblx0XHR9IGVsc2Vcblx0XHRcdGxvZy5kZWJ1Zygnc2tpcCByZXNwb25zZSBoZWFkZXI6ICVzJywgbik7XG5cdH0pO1xufVxuIl19
