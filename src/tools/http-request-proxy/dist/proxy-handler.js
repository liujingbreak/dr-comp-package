"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
var request = require('request');
const __api_1 = tslib_1.__importDefault(require("__api"));
const _ = tslib_1.__importStar(require("lodash"));
const fs = tslib_1.__importStar(require("fs"));
var log = require('log4js').getLogger(__api_1.default.packageName + '.msg');
var logBody = require('log4js').getLogger(__api_1.default.packageName + '.body');
var Url = require('url');
var chalk = require('chalk');
var trackRequestStream = __api_1.default.config.get(__api_1.default.packageName + '.trackRequestStream');
var countRequest = 0;
var SKIP_RES_HEADERS = [
    'transfer-encoding',
    'content-encoding',
    'cache-control',
    'access-control-allow-origin'
];
var SKIP_RES_HEADERS_SET = SKIP_RES_HEADERS.reduce((set, name) => {
    set[name.toLowerCase()] = true;
    return set;
}, {});
/**
 * @param {*} target {string} URL of proxying target
 * @param {*} req {request}
 * @param {*} res {response}
 * @param {*} proxyInstance
 * @param {*} proxyName {string} proxy sub path which should not starts with '/'
 * @return undefined
 */
function doProxy(target, req, res, proxyInstance, proxyName) {
    var requestNum = ++countRequest;
    var toUrl = target + req.url.replace(/\/\//g, '/');
    if (req.method === 'GET')
        toUrl += (req.url.indexOf('?') >= 0 ? '#' : '?') + 'random=' + Math.random();
    // ------------hack begins ------
    var toHeaders = hackHeaders(target, req);
    // ----------- hack ends ----------
    let requestDebugInfo = `\n[#${requestNum}] REQUEST ${chalk.yellow(req.method)} ${chalk.cyan(toUrl)}\n` +
        `OriginalUrl: ${req.originalUrl}\n` +
        // `Host: ${req.headers.host}\n` +
        // `request headers: ${JSON.stringify(req.headers, null, 2)}\n` +
        `Hacked header: ${JSON.stringify(toHeaders, null, 2)}\n`;
    // log.info('hacked request headers: \n%s', JSON.stringify(toHeaders, null, 2));
    var opts = {
        url: toUrl,
        method: req.method,
        headers: toHeaders,
        strictSSL: false,
        time: false,
        timeout: __api_1.default.config.get(__api_1.default.packageName + '.timeout', 20000),
        // "request" will not automatically do gzip decoding on incomingMessage,
        // must explicitly set `gzip` to true
        gzip: toHeaders['accept-encoding'] && toHeaders['accept-encoding'].indexOf('gzip') >= 0
    };
    return intercept(req, toHeaders, req.body, proxyInstance.mockHandlers, proxyName)
        .then((mockBody) => {
        if (mockBody != null) {
            log.info(requestDebugInfo);
            return Promise.resolve(doBodyAsync(requestNum, req, req.body, opts))
                .then(msg => {
                log.info(msg);
                log.info('Mock response:\n' + chalk.blue(_.isString(mockBody) ? mockBody : JSON.stringify(mockBody)));
                res.status(200).send(mockBody);
            });
        }
        else {
            return intercept(req, toHeaders, req.body, proxyInstance.reqHandlers, proxyName)
                .then((result) => {
                const reqBody = result == null ? req.body : result;
                return Promise.resolve(doBodyAsync(requestNum, req, reqBody, opts));
            })
                .then(msg => {
                requestDebugInfo += msg;
                return send(req, opts, requestDebugInfo, requestNum, res, proxyInstance);
            })
                .then((data) => {
                return intercept(req, data.headers, data.body, proxyInstance.resHandlers, proxyName)
                    .then((body) => {
                    if (body)
                        logBody.info(`Hacked Response body:\n${chalk.green(_.isString(body) ? body :
                            (Buffer.isBuffer(body) ? 'buffer' : JSON.stringify(body)))}`);
                    res.status(data.res.statusCode).send(body == null ? data.body : body);
                });
            });
        }
    })
        .catch((err) => {
        log.error(err);
        res.status(500).send(err.message);
    });
}
exports.default = doProxy;
function send(req, opts, requestDebugInfo, requestNum, res, proxyInstance) {
    return new Promise((resolve, reject) => {
        var bufArray = [];
        request(opts, (err, msg, body) => {
            log.info(requestDebugInfo);
            var responseDebugInfo = `[#${requestNum}] RESPONSE:`;
            if (err) {
                log.error(`Request error ${err}`);
                reject(err);
                return;
            }
            if (msg.statusCode > 299 || msg.statusCode < 200)
                log.warn('Status: %d %s', msg.statusCode, msg.statusMessage);
            else
                responseDebugInfo += `Status: ${msg.statusCode} ${msg.statusMessage}\n`;
            responseDebugInfo += 'Response headers:\n' + JSON.stringify(msg.headers, null, 2);
            hackResponseHeaders(req, msg.headers, res, proxyInstance);
            log.info(responseDebugInfo);
            var contentType = _.get(msg.headers, 'content-type');
            if (contentType && (contentType.indexOf('xml') >= 0 || contentType.indexOf('text') >= 0 ||
                contentType.indexOf('json') >= 0)) {
                logBody.info(`Response body:\n${chalk.blue(body)}`);
                return resolve({ headers: msg.headers, body, res: msg });
            }
            var buf = Buffer.concat(bufArray);
            return resolve({ headers: msg.headers, body: buf, res: msg });
        })
            .on('data', (b) => bufArray.push(b))
            .on('end', () => { });
    });
}
/**
 * Transport request from express to a request options.form/body for Request
 * @param {object} reqHeaders expresss request.headers
 * @param {object | string} reqBody expresss request.body
 * @param {object} opts Request options
 * @return debug string
 */
function doBodyAsync(requestNum, req, reqBody, opts) {
    var reqHeaders = req.headers;
    if (Buffer.isBuffer(reqBody) || _.isString(reqBody)) {
        // 
        opts.body = reqBody;
        return 'Body as Buffer or string: ' + reqBody.length;
    }
    else if (_.isObject(reqBody)) {
        // Request body is object (JSON, form or stream)
        const reqContentType = reqHeaders['content-type'];
        if (reqContentType && reqContentType.indexOf('json') >= 0) {
            opts.body = JSON.stringify(reqBody);
            return 'Body as JSON: ' + opts.body;
        }
        else if (reqContentType && reqContentType.indexOf('application/x-www-form-urlencoded') >= 0) {
            opts.form = reqBody;
            return 'Body as form: ' + JSON.stringify(opts.form);
        }
    }
    // Request body is stream
    if (trackRequestStream) {
        const tempFile = __api_1.default.config.resolve('destDir', 'request-body-' + requestNum);
        var out = fs.createWriteStream(tempFile);
        return new Promise((resolve, reject) => {
            req.pipe(out).on('finish', () => {
                log.info('Finished writing request body to temp file ', tempFile);
                opts.body = fs.createReadStream(tempFile);
                resolve('Body as Readable Stream');
            });
        });
    }
    else {
        opts.body = req;
        return 'Body as Readable Stream';
    }
}
function intercept(req, headers, body, resHandlers, name) {
    var bodyHandlerProm;
    var handlers = _filterHandlers(req, resHandlers);
    if (handlers.length > 0) {
        bodyHandlerProm = Promise.resolve({ req, headers, body });
        handlers.forEach(func => {
            bodyHandlerProm = bodyHandlerProm.then(data => {
                const resolvedRes = func(data.req, data.headers, data.body, data.result);
                if (resolvedRes != null) {
                    return Promise.resolve(resolvedRes)
                        .then(result => {
                        return Object.assign(data, { result });
                    });
                }
                return Promise.resolve(data);
            });
        });
        bodyHandlerProm = bodyHandlerProm.then(data => data.result);
    }
    else {
        bodyHandlerProm = Promise.resolve(null);
    }
    return bodyHandlerProm;
}
function _filterHandlers(req, resHandlers) {
    var handlers = [];
    var handlerSet = _.get(resHandlers, Url.parse(req.url).pathname);
    if (handlerSet)
        handlers.push(...handlerSet.values());
    var defaultHandlerSet = resHandlers['*'];
    if (defaultHandlerSet)
        handlers.push(...defaultHandlerSet.values());
    return handlers;
}
function hackHeaders(target, req) {
    var toHeaders = _.assign({}, req.headers, {
        'x-real-ip': req.ip,
        'x-forwarded_for': req.ip,
        'x-forwarded-for': req.ip
    });
    var parsedTarget = Url.parse(target);
    toHeaders.host = parsedTarget.host;
    delete toHeaders.origin;
    if (toHeaders.referer) {
        toHeaders.referer = `${parsedTarget.protocol}//${parsedTarget.host}${Url.parse(toHeaders.referer).pathname}`;
    }
    return toHeaders;
}
function hackResponseHeaders(req, originHeaders, response, proxyInstance) {
    _.each(originHeaders, (v, n) => {
        if (!_.get(SKIP_RES_HEADERS_SET, n.toLowerCase())) {
            if (n === 'set-cookie' && proxyInstance.isRemoveCookieDomain) {
                v = v.map((cookie) => {
                    var attrs = cookie.split(';');
                    return attrs.filter((value) => !value.startsWith('domain')).join(';');
                });
                log.info('Domain attribute is removed from set-cookie header: ', v);
            }
            response.set(n, v);
        }
        else
            log.debug('skip response header: %s', n);
    });
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AZHIvaHR0cC1yZXF1ZXN0LXByb3h5L3RzL3Byb3h5LWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2pDLDBEQUF3QjtBQUN4QixrREFBNEI7QUFLNUIsK0NBQXlCO0FBQ3pCLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsZUFBRyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsQ0FBQztBQUNoRSxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsU0FBUyxDQUFDLGVBQUcsQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLENBQUM7QUFDckUsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3pCLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUM3QixJQUFJLGtCQUFrQixHQUFHLGVBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGVBQUcsQ0FBQyxXQUFXLEdBQUcscUJBQXFCLENBQUMsQ0FBQztBQUVqRixJQUFJLFlBQVksR0FBRyxDQUFDLENBQUM7QUFFckIsSUFBSSxnQkFBZ0IsR0FBRztJQUN0QixtQkFBbUI7SUFDbkIsa0JBQWtCO0lBQ2xCLGVBQWU7SUFDZiw2QkFBNkI7Q0FDN0IsQ0FBQztBQUNGLElBQUksb0JBQW9CLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBMkIsRUFBRSxJQUFJLEVBQUUsRUFBRTtJQUN4RixHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQy9CLE9BQU8sR0FBRyxDQUFDO0FBQ1osQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBRVA7Ozs7Ozs7R0FPRztBQUNILFNBQXdCLE9BQU8sQ0FBQyxNQUFjLEVBQUUsR0FBb0IsRUFBRSxHQUFxQixFQUMxRixhQUE0QixFQUFFLFNBQWlCO0lBQy9DLElBQUksVUFBVSxHQUFHLEVBQUUsWUFBWSxDQUFDO0lBRWhDLElBQUksS0FBSyxHQUFHLE1BQU0sR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDbkQsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLEtBQUs7UUFDdkIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDOUUsaUNBQWlDO0lBQ2pDLElBQUksU0FBUyxHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDekMsbUNBQW1DO0lBQ25DLElBQUksZ0JBQWdCLEdBQUcsT0FBTyxVQUFVLGFBQWEsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSTtRQUN0RyxnQkFBZ0IsR0FBRyxDQUFDLFdBQVcsSUFBSTtRQUNuQyxrQ0FBa0M7UUFDbEMsaUVBQWlFO1FBQ2pFLGtCQUFrQixJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUN6RCxnRkFBZ0Y7SUFDaEYsSUFBSSxJQUFJLEdBQUc7UUFDVixHQUFHLEVBQUUsS0FBSztRQUNWLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTtRQUNsQixPQUFPLEVBQUUsU0FBUztRQUNsQixTQUFTLEVBQUUsS0FBSztRQUNoQixJQUFJLEVBQUUsS0FBSztRQUNYLE9BQU8sRUFBRSxlQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxlQUFHLENBQUMsV0FBVyxHQUFHLFVBQVUsRUFBRSxLQUFLLENBQUM7UUFDNUQsd0VBQXdFO1FBQ3hFLHFDQUFxQztRQUNyQyxJQUFJLEVBQUUsU0FBUyxDQUFDLGlCQUFpQixDQUFDLElBQUksU0FBUyxDQUFDLGlCQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7S0FDdkYsQ0FBQztJQUVGLE9BQU8sU0FBUyxDQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsWUFBWSxFQUFFLFNBQVMsQ0FBQztTQUNoRixJQUFJLENBQUMsQ0FBQyxRQUFhLEVBQUUsRUFBRTtRQUN2QixJQUFJLFFBQVEsSUFBSSxJQUFJLEVBQUU7WUFDckIsR0FBRyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQzNCLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2lCQUNuRSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQ1gsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDZCxHQUFHLENBQUMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDaEMsQ0FBQyxDQUFDLENBQUM7U0FDSDthQUFNO1lBQ04sT0FBTyxTQUFTLENBQUMsR0FBRyxFQUFFLFNBQVMsRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxXQUFXLEVBQUUsU0FBUyxDQUFDO2lCQUMvRSxJQUFJLENBQUMsQ0FBQyxNQUFXLEVBQUUsRUFBRTtnQkFDckIsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO2dCQUNuRCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDckUsQ0FBQyxDQUFDO2lCQUNELElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDWCxnQkFBZ0IsSUFBSSxHQUFHLENBQUM7Z0JBQ3hCLE9BQU8sSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxhQUFhLENBQUMsQ0FBQztZQUMxRSxDQUFDLENBQUM7aUJBQ0QsSUFBSSxDQUFDLENBQUMsSUFBUyxFQUFFLEVBQUU7Z0JBQ25CLE9BQU8sU0FBUyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUM7cUJBQ25GLElBQUksQ0FBQyxDQUFDLElBQVMsRUFBRSxFQUFFO29CQUNuQixJQUFJLElBQUk7d0JBQ1AsT0FBTyxDQUFDLElBQUksQ0FBQywwQkFBMEIsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQzs0QkFDM0UsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztvQkFDaEUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDdkUsQ0FBQyxDQUFDLENBQUM7WUFDSixDQUFDLENBQUMsQ0FBQztTQUNIO0lBQ0YsQ0FBQyxDQUFDO1NBQ0QsS0FBSyxDQUFDLENBQUMsR0FBVSxFQUFFLEVBQUU7UUFDckIsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNmLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNuQyxDQUFDLENBQUMsQ0FBQztBQUNKLENBQUM7QUEvREQsMEJBK0RDO0FBRUQsU0FBUyxJQUFJLENBQUMsR0FBb0IsRUFBRSxJQUFTLEVBQUUsZ0JBQXFCLEVBQUUsVUFBa0IsRUFBRSxHQUFxQixFQUM5RyxhQUE0QjtJQUU1QixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQ3RDLElBQUksUUFBUSxHQUFhLEVBQUUsQ0FBQztRQUM1QixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBVSxFQUFFLEdBQW9CLEVBQUUsSUFBbUIsRUFBRSxFQUFFO1lBQ3ZFLEdBQUcsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUMzQixJQUFJLGlCQUFpQixHQUFHLEtBQUssVUFBVSxhQUFhLENBQUM7WUFDckQsSUFBSSxHQUFHLEVBQUU7Z0JBQ1IsR0FBRyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDbEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNaLE9BQU87YUFDUDtZQUNELElBQUksR0FBRyxDQUFDLFVBQVUsR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLFVBQVUsR0FBRyxHQUFHO2dCQUMvQyxHQUFHLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxHQUFHLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQzs7Z0JBRTdELGlCQUFpQixJQUFJLFdBQVcsR0FBRyxDQUFDLFVBQVUsSUFBSSxHQUFHLENBQUMsYUFBYSxJQUFJLENBQUM7WUFDekUsaUJBQWlCLElBQUkscUJBQXFCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNsRixtQkFBbUIsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsYUFBYSxDQUFDLENBQUM7WUFDMUQsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1lBRTVCLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxjQUFjLENBQUMsQ0FBQztZQUNyRCxJQUFJLFdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFDdEYsV0FBVyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUUsRUFBRTtnQkFDcEMsT0FBTyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3BELE9BQU8sT0FBTyxDQUFDLEVBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDO2FBQ3ZEO1lBQ0QsSUFBSSxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNsQyxPQUFPLE9BQU8sQ0FBQyxFQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBQyxDQUFDLENBQUM7UUFDN0QsQ0FBQyxDQUFDO2FBQ0QsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQVMsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMzQyxFQUFFLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3RCLENBQUMsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVEOzs7Ozs7R0FNRztBQUNILFNBQVMsV0FBVyxDQUFDLFVBQWtCLEVBQUUsR0FBb0IsRUFBRSxPQUFZLEVBQUUsSUFBd0I7SUFFcEcsSUFBSSxVQUFVLEdBQXVCLEdBQUcsQ0FBQyxPQUFPLENBQUM7SUFDakQsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDcEQsR0FBRztRQUNILElBQUksQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDO1FBQ3BCLE9BQU8sNEJBQTRCLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztLQUNyRDtTQUFNLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUMvQixnREFBZ0Q7UUFDaEQsTUFBTSxjQUFjLEdBQUcsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ2xELElBQUksY0FBYyxJQUFJLGNBQWMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzFELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNwQyxPQUFPLGdCQUFnQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7U0FDcEM7YUFBTSxJQUFJLGNBQWMsSUFBSSxjQUFjLENBQUMsT0FBTyxDQUFDLG1DQUFtQyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzlGLElBQUksQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDO1lBQ3BCLE9BQU8sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDcEQ7S0FDRDtJQUVELHlCQUF5QjtJQUN6QixJQUFJLGtCQUFrQixFQUFFO1FBQ3ZCLE1BQU0sUUFBUSxHQUFXLGVBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxlQUFlLEdBQUcsVUFBVSxDQUFDLENBQUM7UUFDckYsSUFBSSxHQUFHLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDdEMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRTtnQkFDL0IsR0FBRyxDQUFDLElBQUksQ0FBQyw2Q0FBNkMsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDbEUsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzFDLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1lBQ3BDLENBQUMsQ0FBQyxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7S0FDSDtTQUFNO1FBQ04sSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUM7UUFDaEIsT0FBTyx5QkFBeUIsQ0FBQztLQUNqQztBQUNGLENBQUM7QUFRRCxTQUFTLFNBQVMsQ0FBQyxHQUFvQixFQUFFLE9BQTJCLEVBQUUsSUFBUyxFQUM5RSxXQUErQyxFQUFFLElBQVk7SUFDN0QsSUFBSSxlQUF1QyxDQUFDO0lBQzVDLElBQUksUUFBUSxHQUFrQixlQUFlLENBQUMsR0FBRyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ2hFLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7UUFDeEIsZUFBZSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7UUFDeEQsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN2QixlQUFlLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDN0MsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDekUsSUFBSSxXQUFXLElBQUksSUFBSSxFQUFFO29CQUN4QixPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDO3lCQUNsQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7d0JBQ2QsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxFQUFDLE1BQU0sRUFBQyxDQUFDLENBQUM7b0JBQ3RDLENBQUMsQ0FBQyxDQUFDO2lCQUNIO2dCQUNELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM5QixDQUFDLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBQ0gsZUFBZSxHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7S0FDNUQ7U0FBTTtRQUNOLGVBQWUsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3hDO0lBQ0QsT0FBTyxlQUFlLENBQUM7QUFDeEIsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLEdBQW9CLEVBQUUsV0FBNkQ7SUFDM0csSUFBSSxRQUFRLEdBQXFDLEVBQUUsQ0FBQztJQUNwRCxJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNqRSxJQUFJLFVBQVU7UUFDYixRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDdkMsSUFBSSxpQkFBaUIsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekMsSUFBSSxpQkFBaUI7UUFDcEIsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDOUMsT0FBTyxRQUFRLENBQUM7QUFDakIsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLE1BQWMsRUFBRSxHQUFvQjtJQUN4RCxJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsT0FBTyxFQUFFO1FBQ3pDLFdBQVcsRUFBRSxHQUFHLENBQUMsRUFBRTtRQUNuQixpQkFBaUIsRUFBRSxHQUFHLENBQUMsRUFBRTtRQUN6QixpQkFBaUIsRUFBRSxHQUFHLENBQUMsRUFBRTtLQUN6QixDQUFDLENBQUM7SUFDSCxJQUFJLFlBQVksR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3JDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQztJQUNuQyxPQUFPLFNBQVMsQ0FBQyxNQUFNLENBQUM7SUFDeEIsSUFBSSxTQUFTLENBQUMsT0FBTyxFQUFFO1FBQ3RCLFNBQVMsQ0FBQyxPQUFPLEdBQUcsR0FBRyxZQUFZLENBQUMsUUFBUSxLQUFLLFlBQVksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7S0FDN0c7SUFDRCxPQUFPLFNBQVMsQ0FBQztBQUNsQixDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxHQUFvQixFQUFFLGFBQWlDLEVBQUUsUUFBMEIsRUFDL0csYUFBNEI7SUFDNUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDOUIsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLEVBQUU7WUFDbEQsSUFBSSxDQUFDLEtBQUssWUFBWSxJQUFJLGFBQWEsQ0FBQyxvQkFBb0IsRUFBRTtnQkFDN0QsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFXLEVBQUUsRUFBRTtvQkFDekIsSUFBSSxLQUFLLEdBQWEsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDeEMsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3ZFLENBQUMsQ0FBQyxDQUFDO2dCQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsc0RBQXNELEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDcEU7WUFDRCxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUNuQjs7WUFDQSxHQUFHLENBQUMsS0FBSyxDQUFDLDBCQUEwQixFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzNDLENBQUMsQ0FBQyxDQUFDO0FBQ0osQ0FBQyIsImZpbGUiOiJub2RlX21vZHVsZXMvQGRyL2h0dHAtcmVxdWVzdC1wcm94eS9kaXN0L3Byb3h5LWhhbmRsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QnKTtcbmltcG9ydCBhcGkgZnJvbSAnX19hcGknO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFByb3h5SW5zdGFuY2UgfSBmcm9tICcuL3NlcnZlcic7XG5pbXBvcnQge0JvZHlIYW5kbGVyLCBIZWFkZXJIYW5kbGVyfSBmcm9tICcuL3NlcnZlcic7XG5pbXBvcnQge0luY29taW5nTWVzc2FnZX0gZnJvbSAnaHR0cCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG52YXIgbG9nID0gcmVxdWlyZSgnbG9nNGpzJykuZ2V0TG9nZ2VyKGFwaS5wYWNrYWdlTmFtZSArICcubXNnJyk7XG52YXIgbG9nQm9keSA9IHJlcXVpcmUoJ2xvZzRqcycpLmdldExvZ2dlcihhcGkucGFja2FnZU5hbWUgKyAnLmJvZHknKTtcbnZhciBVcmwgPSByZXF1aXJlKCd1cmwnKTtcbnZhciBjaGFsayA9IHJlcXVpcmUoJ2NoYWxrJyk7XG52YXIgdHJhY2tSZXF1ZXN0U3RyZWFtID0gYXBpLmNvbmZpZy5nZXQoYXBpLnBhY2thZ2VOYW1lICsgJy50cmFja1JlcXVlc3RTdHJlYW0nKTtcblxudmFyIGNvdW50UmVxdWVzdCA9IDA7XG5cbnZhciBTS0lQX1JFU19IRUFERVJTID0gW1xuXHQndHJhbnNmZXItZW5jb2RpbmcnLFxuXHQnY29udGVudC1lbmNvZGluZycsXG5cdCdjYWNoZS1jb250cm9sJyxcblx0J2FjY2Vzcy1jb250cm9sLWFsbG93LW9yaWdpbidcbl07XG52YXIgU0tJUF9SRVNfSEVBREVSU19TRVQgPSBTS0lQX1JFU19IRUFERVJTLnJlZHVjZSgoc2V0OiB7W2s6IHN0cmluZ106IGJvb2xlYW59LCBuYW1lKSA9PiB7XG5cdHNldFtuYW1lLnRvTG93ZXJDYXNlKCldID0gdHJ1ZTtcblx0cmV0dXJuIHNldDtcbn0sIHt9KTtcblxuLyoqXG4gKiBAcGFyYW0geyp9IHRhcmdldCB7c3RyaW5nfSBVUkwgb2YgcHJveHlpbmcgdGFyZ2V0XG4gKiBAcGFyYW0geyp9IHJlcSB7cmVxdWVzdH1cbiAqIEBwYXJhbSB7Kn0gcmVzIHtyZXNwb25zZX1cbiAqIEBwYXJhbSB7Kn0gcHJveHlJbnN0YW5jZVxuICogQHBhcmFtIHsqfSBwcm94eU5hbWUge3N0cmluZ30gcHJveHkgc3ViIHBhdGggd2hpY2ggc2hvdWxkIG5vdCBzdGFydHMgd2l0aCAnLydcbiAqIEByZXR1cm4gdW5kZWZpbmVkXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGRvUHJveHkodGFyZ2V0OiBzdHJpbmcsIHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsXG5cdHByb3h5SW5zdGFuY2U6IFByb3h5SW5zdGFuY2UsIHByb3h5TmFtZTogc3RyaW5nKSB7XG5cdHZhciByZXF1ZXN0TnVtID0gKytjb3VudFJlcXVlc3Q7XG5cblx0dmFyIHRvVXJsID0gdGFyZ2V0ICsgcmVxLnVybC5yZXBsYWNlKC9cXC9cXC8vZywgJy8nKTtcblx0aWYgKHJlcS5tZXRob2QgPT09ICdHRVQnKVxuXHRcdHRvVXJsICs9IChyZXEudXJsLmluZGV4T2YoJz8nKSA+PSAwID8gJyMnIDogJz8nKSArICdyYW5kb209JyArIE1hdGgucmFuZG9tKCk7XG5cdC8vIC0tLS0tLS0tLS0tLWhhY2sgYmVnaW5zIC0tLS0tLVxuXHR2YXIgdG9IZWFkZXJzID0gaGFja0hlYWRlcnModGFyZ2V0LCByZXEpO1xuXHQvLyAtLS0tLS0tLS0tLSBoYWNrIGVuZHMgLS0tLS0tLS0tLVxuXHRsZXQgcmVxdWVzdERlYnVnSW5mbyA9IGBcXG5bIyR7cmVxdWVzdE51bX1dIFJFUVVFU1QgJHtjaGFsay55ZWxsb3cocmVxLm1ldGhvZCl9ICR7Y2hhbGsuY3lhbih0b1VybCl9XFxuYCArXG5cdGBPcmlnaW5hbFVybDogJHtyZXEub3JpZ2luYWxVcmx9XFxuYCArXG5cdC8vIGBIb3N0OiAke3JlcS5oZWFkZXJzLmhvc3R9XFxuYCArXG5cdC8vIGByZXF1ZXN0IGhlYWRlcnM6ICR7SlNPTi5zdHJpbmdpZnkocmVxLmhlYWRlcnMsIG51bGwsIDIpfVxcbmAgK1xuXHRgSGFja2VkIGhlYWRlcjogJHtKU09OLnN0cmluZ2lmeSh0b0hlYWRlcnMsIG51bGwsIDIpfVxcbmA7XG5cdC8vIGxvZy5pbmZvKCdoYWNrZWQgcmVxdWVzdCBoZWFkZXJzOiBcXG4lcycsIEpTT04uc3RyaW5naWZ5KHRvSGVhZGVycywgbnVsbCwgMikpO1xuXHR2YXIgb3B0cyA9IHtcblx0XHR1cmw6IHRvVXJsLFxuXHRcdG1ldGhvZDogcmVxLm1ldGhvZCxcblx0XHRoZWFkZXJzOiB0b0hlYWRlcnMsXG5cdFx0c3RyaWN0U1NMOiBmYWxzZSxcblx0XHR0aW1lOiBmYWxzZSxcblx0XHR0aW1lb3V0OiBhcGkuY29uZmlnLmdldChhcGkucGFja2FnZU5hbWUgKyAnLnRpbWVvdXQnLCAyMDAwMCksXG5cdFx0Ly8gXCJyZXF1ZXN0XCIgd2lsbCBub3QgYXV0b21hdGljYWxseSBkbyBnemlwIGRlY29kaW5nIG9uIGluY29taW5nTWVzc2FnZSxcblx0XHQvLyBtdXN0IGV4cGxpY2l0bHkgc2V0IGBnemlwYCB0byB0cnVlXG5cdFx0Z3ppcDogdG9IZWFkZXJzWydhY2NlcHQtZW5jb2RpbmcnXSAmJiB0b0hlYWRlcnNbJ2FjY2VwdC1lbmNvZGluZyddLmluZGV4T2YoJ2d6aXAnKSA+PSAwXG5cdH07XG5cblx0cmV0dXJuIGludGVyY2VwdChyZXEsIHRvSGVhZGVycywgcmVxLmJvZHksIHByb3h5SW5zdGFuY2UubW9ja0hhbmRsZXJzLCBwcm94eU5hbWUpXG5cdC50aGVuKChtb2NrQm9keTogYW55KSA9PiB7XG5cdFx0aWYgKG1vY2tCb2R5ICE9IG51bGwpIHtcblx0XHRcdGxvZy5pbmZvKHJlcXVlc3REZWJ1Z0luZm8pO1xuXHRcdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShkb0JvZHlBc3luYyhyZXF1ZXN0TnVtLCByZXEsIHJlcS5ib2R5LCBvcHRzKSlcblx0XHRcdC50aGVuKG1zZyA9PiB7XG5cdFx0XHRcdGxvZy5pbmZvKG1zZyk7XG5cdFx0XHRcdGxvZy5pbmZvKCdNb2NrIHJlc3BvbnNlOlxcbicgKyBjaGFsay5ibHVlKF8uaXNTdHJpbmcobW9ja0JvZHkpID8gbW9ja0JvZHkgOiBKU09OLnN0cmluZ2lmeShtb2NrQm9keSkpKTtcblx0XHRcdFx0cmVzLnN0YXR1cygyMDApLnNlbmQobW9ja0JvZHkpO1xuXHRcdFx0fSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJldHVybiBpbnRlcmNlcHQocmVxLCB0b0hlYWRlcnMsIHJlcS5ib2R5LCBwcm94eUluc3RhbmNlLnJlcUhhbmRsZXJzLCBwcm94eU5hbWUpXG5cdFx0XHQudGhlbigocmVzdWx0OiBhbnkpID0+IHtcblx0XHRcdFx0Y29uc3QgcmVxQm9keSA9IHJlc3VsdCA9PSBudWxsID8gcmVxLmJvZHkgOiByZXN1bHQ7XG5cdFx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUoZG9Cb2R5QXN5bmMocmVxdWVzdE51bSwgcmVxLCByZXFCb2R5LCBvcHRzKSk7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4obXNnID0+IHtcblx0XHRcdFx0cmVxdWVzdERlYnVnSW5mbyArPSBtc2c7XG5cdFx0XHRcdHJldHVybiBzZW5kKHJlcSwgb3B0cywgcmVxdWVzdERlYnVnSW5mbywgcmVxdWVzdE51bSwgcmVzLCBwcm94eUluc3RhbmNlKTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbigoZGF0YTogYW55KSA9PiB7XG5cdFx0XHRcdHJldHVybiBpbnRlcmNlcHQocmVxLCBkYXRhLmhlYWRlcnMsIGRhdGEuYm9keSwgcHJveHlJbnN0YW5jZS5yZXNIYW5kbGVycywgcHJveHlOYW1lKVxuXHRcdFx0XHQudGhlbigoYm9keTogYW55KSA9PiB7XG5cdFx0XHRcdFx0aWYgKGJvZHkpXG5cdFx0XHRcdFx0XHRsb2dCb2R5LmluZm8oYEhhY2tlZCBSZXNwb25zZSBib2R5OlxcbiR7Y2hhbGsuZ3JlZW4oXy5pc1N0cmluZyhib2R5KSA/IGJvZHkgOlxuXHRcdFx0XHRcdFx0XHQoQnVmZmVyLmlzQnVmZmVyKGJvZHkpID8gJ2J1ZmZlcicgOiBKU09OLnN0cmluZ2lmeShib2R5KSkpfWApO1xuXHRcdFx0XHRcdHJlcy5zdGF0dXMoZGF0YS5yZXMuc3RhdHVzQ29kZSkuc2VuZChib2R5ID09IG51bGwgPyBkYXRhLmJvZHkgOiBib2R5KTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9KTtcblx0XHR9XG5cdH0pXG5cdC5jYXRjaCgoZXJyOiBFcnJvcikgPT4ge1xuXHRcdGxvZy5lcnJvcihlcnIpO1xuXHRcdHJlcy5zdGF0dXMoNTAwKS5zZW5kKGVyci5tZXNzYWdlKTtcblx0fSk7XG59XG5cbmZ1bmN0aW9uIHNlbmQocmVxOiBleHByZXNzLlJlcXVlc3QsIG9wdHM6IGFueSwgcmVxdWVzdERlYnVnSW5mbzogYW55LCByZXF1ZXN0TnVtOiBudW1iZXIsIHJlczogZXhwcmVzcy5SZXNwb25zZSxcblx0cHJveHlJbnN0YW5jZTogUHJveHlJbnN0YW5jZSk6XG5cdFByb21pc2U8e2hlYWRlcnM6IHtbazogc3RyaW5nXTogYW55fSwgYm9keTogYW55LCByZXM6IEluY29taW5nTWVzc2FnZX0+IHtcblx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHR2YXIgYnVmQXJyYXk6IEJ1ZmZlcltdID0gW107XG5cdFx0cmVxdWVzdChvcHRzLCAoZXJyOiBFcnJvciwgbXNnOiBJbmNvbWluZ01lc3NhZ2UsIGJvZHk6IHN0cmluZ3xCdWZmZXIpID0+IHtcblx0XHRcdGxvZy5pbmZvKHJlcXVlc3REZWJ1Z0luZm8pO1xuXHRcdFx0dmFyIHJlc3BvbnNlRGVidWdJbmZvID0gYFsjJHtyZXF1ZXN0TnVtfV0gUkVTUE9OU0U6YDtcblx0XHRcdGlmIChlcnIpIHtcblx0XHRcdFx0bG9nLmVycm9yKGBSZXF1ZXN0IGVycm9yICR7ZXJyfWApO1xuXHRcdFx0XHRyZWplY3QoZXJyKTtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXHRcdFx0aWYgKG1zZy5zdGF0dXNDb2RlID4gMjk5IHx8IG1zZy5zdGF0dXNDb2RlIDwgMjAwKVxuXHRcdFx0XHRsb2cud2FybignU3RhdHVzOiAlZCAlcycsIG1zZy5zdGF0dXNDb2RlLCBtc2cuc3RhdHVzTWVzc2FnZSk7XG5cdFx0XHRlbHNlXG5cdFx0XHRcdHJlc3BvbnNlRGVidWdJbmZvICs9IGBTdGF0dXM6ICR7bXNnLnN0YXR1c0NvZGV9ICR7bXNnLnN0YXR1c01lc3NhZ2V9XFxuYDtcblx0XHRcdHJlc3BvbnNlRGVidWdJbmZvICs9ICdSZXNwb25zZSBoZWFkZXJzOlxcbicgKyBKU09OLnN0cmluZ2lmeShtc2cuaGVhZGVycywgbnVsbCwgMik7XG5cdFx0XHRoYWNrUmVzcG9uc2VIZWFkZXJzKHJlcSwgbXNnLmhlYWRlcnMsIHJlcywgcHJveHlJbnN0YW5jZSk7XG5cdFx0XHRsb2cuaW5mbyhyZXNwb25zZURlYnVnSW5mbyk7XG5cblx0XHRcdHZhciBjb250ZW50VHlwZSA9IF8uZ2V0KG1zZy5oZWFkZXJzLCAnY29udGVudC10eXBlJyk7XG5cdFx0XHRpZiAoY29udGVudFR5cGUgJiYgKGNvbnRlbnRUeXBlLmluZGV4T2YoJ3htbCcpID49IDAgfHwgY29udGVudFR5cGUuaW5kZXhPZigndGV4dCcpID49IDAgfHxcblx0XHRcdFx0Y29udGVudFR5cGUuaW5kZXhPZignanNvbicpID49IDAgKSkge1xuXHRcdFx0XHRsb2dCb2R5LmluZm8oYFJlc3BvbnNlIGJvZHk6XFxuJHtjaGFsay5ibHVlKGJvZHkpfWApO1xuXHRcdFx0XHRyZXR1cm4gcmVzb2x2ZSh7aGVhZGVyczogbXNnLmhlYWRlcnMsIGJvZHksIHJlczogbXNnfSk7XG5cdFx0XHR9XG5cdFx0XHR2YXIgYnVmID0gQnVmZmVyLmNvbmNhdChidWZBcnJheSk7XG5cdFx0XHRyZXR1cm4gcmVzb2x2ZSh7aGVhZGVyczogbXNnLmhlYWRlcnMsIGJvZHk6IGJ1ZiwgcmVzOiBtc2d9KTtcblx0XHR9KVxuXHRcdC5vbignZGF0YScsIChiOiBCdWZmZXIpID0+IGJ1ZkFycmF5LnB1c2goYikpXG5cdFx0Lm9uKCdlbmQnLCAoKSA9PiB7fSk7XG5cdH0pO1xufVxuXG4vKipcbiAqIFRyYW5zcG9ydCByZXF1ZXN0IGZyb20gZXhwcmVzcyB0byBhIHJlcXVlc3Qgb3B0aW9ucy5mb3JtL2JvZHkgZm9yIFJlcXVlc3RcbiAqIEBwYXJhbSB7b2JqZWN0fSByZXFIZWFkZXJzIGV4cHJlc3NzIHJlcXVlc3QuaGVhZGVyc1xuICogQHBhcmFtIHtvYmplY3QgfCBzdHJpbmd9IHJlcUJvZHkgZXhwcmVzc3MgcmVxdWVzdC5ib2R5XG4gKiBAcGFyYW0ge29iamVjdH0gb3B0cyBSZXF1ZXN0IG9wdGlvbnNcbiAqIEByZXR1cm4gZGVidWcgc3RyaW5nXG4gKi9cbmZ1bmN0aW9uIGRvQm9keUFzeW5jKHJlcXVlc3ROdW06IG51bWJlciwgcmVxOiBleHByZXNzLlJlcXVlc3QsIHJlcUJvZHk6IGFueSwgb3B0czoge1trOiBzdHJpbmddOiBhbnl9KTpcblx0c3RyaW5nIHwgUHJvbWlzZUxpa2U8c3RyaW5nPiB7XG5cdHZhciByZXFIZWFkZXJzOiB7W2s6IHN0cmluZ106IGFueX0gPSByZXEuaGVhZGVycztcblx0aWYgKEJ1ZmZlci5pc0J1ZmZlcihyZXFCb2R5KSB8fCBfLmlzU3RyaW5nKHJlcUJvZHkpKSB7XG5cdFx0Ly8gXG5cdFx0b3B0cy5ib2R5ID0gcmVxQm9keTtcblx0XHRyZXR1cm4gJ0JvZHkgYXMgQnVmZmVyIG9yIHN0cmluZzogJyArIHJlcUJvZHkubGVuZ3RoO1xuXHR9IGVsc2UgaWYgKF8uaXNPYmplY3QocmVxQm9keSkpIHtcblx0XHQvLyBSZXF1ZXN0IGJvZHkgaXMgb2JqZWN0IChKU09OLCBmb3JtIG9yIHN0cmVhbSlcblx0XHRjb25zdCByZXFDb250ZW50VHlwZSA9IHJlcUhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddO1xuXHRcdGlmIChyZXFDb250ZW50VHlwZSAmJiByZXFDb250ZW50VHlwZS5pbmRleE9mKCdqc29uJykgPj0gMCkge1xuXHRcdFx0b3B0cy5ib2R5ID0gSlNPTi5zdHJpbmdpZnkocmVxQm9keSk7XG5cdFx0XHRyZXR1cm4gJ0JvZHkgYXMgSlNPTjogJyArIG9wdHMuYm9keTtcblx0XHR9IGVsc2UgaWYgKHJlcUNvbnRlbnRUeXBlICYmIHJlcUNvbnRlbnRUeXBlLmluZGV4T2YoJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpID49IDApIHtcblx0XHRcdG9wdHMuZm9ybSA9IHJlcUJvZHk7XG5cdFx0XHRyZXR1cm4gJ0JvZHkgYXMgZm9ybTogJyArIEpTT04uc3RyaW5naWZ5KG9wdHMuZm9ybSk7XG5cdFx0fVxuXHR9XG5cblx0Ly8gUmVxdWVzdCBib2R5IGlzIHN0cmVhbVxuXHRpZiAodHJhY2tSZXF1ZXN0U3RyZWFtKSB7XG5cdFx0Y29uc3QgdGVtcEZpbGU6IHN0cmluZyA9IGFwaS5jb25maWcucmVzb2x2ZSgnZGVzdERpcicsICdyZXF1ZXN0LWJvZHktJyArIHJlcXVlc3ROdW0pO1xuXHRcdHZhciBvdXQgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbSh0ZW1wRmlsZSk7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdHJlcS5waXBlKG91dCkub24oJ2ZpbmlzaCcsICgpID0+IHtcblx0XHRcdFx0bG9nLmluZm8oJ0ZpbmlzaGVkIHdyaXRpbmcgcmVxdWVzdCBib2R5IHRvIHRlbXAgZmlsZSAnLCB0ZW1wRmlsZSk7XG5cdFx0XHRcdG9wdHMuYm9keSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0odGVtcEZpbGUpO1xuXHRcdFx0XHRyZXNvbHZlKCdCb2R5IGFzIFJlYWRhYmxlIFN0cmVhbScpO1xuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdH0gZWxzZSB7XG5cdFx0b3B0cy5ib2R5ID0gcmVxO1xuXHRcdHJldHVybiAnQm9keSBhcyBSZWFkYWJsZSBTdHJlYW0nO1xuXHR9XG59XG5cbmludGVyZmFjZSBIYW5kbGVyUGFyYW1zIHtcblx0cmVxOiBleHByZXNzLlJlcXVlc3Q7XG5cdGhlYWRlcnM6IHtbazogc3RyaW5nXTogYW55fTtcblx0Ym9keTogYW55O1xuXHRyZXN1bHQ/OiBhbnk7XG59XG5mdW5jdGlvbiBpbnRlcmNlcHQocmVxOiBleHByZXNzLlJlcXVlc3QsIGhlYWRlcnM6IHtbazogc3RyaW5nXTogYW55fSwgYm9keTogYW55LFxuXHRyZXNIYW5kbGVyczoge1twYXRoOiBzdHJpbmddOiBTZXQ8Qm9keUhhbmRsZXI+fSwgbmFtZTogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcblx0dmFyIGJvZHlIYW5kbGVyUHJvbTogUHJvbWlzZTxIYW5kbGVyUGFyYW1zPjtcblx0dmFyIGhhbmRsZXJzOiBCb2R5SGFuZGxlcltdID0gX2ZpbHRlckhhbmRsZXJzKHJlcSwgcmVzSGFuZGxlcnMpO1xuXHRpZiAoaGFuZGxlcnMubGVuZ3RoID4gMCkge1xuXHRcdGJvZHlIYW5kbGVyUHJvbSA9IFByb21pc2UucmVzb2x2ZSh7cmVxLCBoZWFkZXJzLCBib2R5fSk7XG5cdFx0aGFuZGxlcnMuZm9yRWFjaChmdW5jID0+IHtcblx0XHRcdGJvZHlIYW5kbGVyUHJvbSA9IGJvZHlIYW5kbGVyUHJvbS50aGVuKGRhdGEgPT4ge1xuXHRcdFx0XHRjb25zdCByZXNvbHZlZFJlcyA9IGZ1bmMoZGF0YS5yZXEsIGRhdGEuaGVhZGVycywgZGF0YS5ib2R5LCBkYXRhLnJlc3VsdCk7XG5cdFx0XHRcdGlmIChyZXNvbHZlZFJlcyAhPSBudWxsKSB7XG5cdFx0XHRcdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXNvbHZlZFJlcylcblx0XHRcdFx0XHQudGhlbihyZXN1bHQgPT4ge1xuXHRcdFx0XHRcdFx0cmV0dXJuIE9iamVjdC5hc3NpZ24oZGF0YSwge3Jlc3VsdH0pO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUoZGF0YSk7XG5cdFx0XHR9KTtcblx0XHR9KTtcblx0XHRib2R5SGFuZGxlclByb20gPSBib2R5SGFuZGxlclByb20udGhlbihkYXRhID0+IGRhdGEucmVzdWx0KTtcblx0fSBlbHNlIHtcblx0XHRib2R5SGFuZGxlclByb20gPSBQcm9taXNlLnJlc29sdmUobnVsbCk7XG5cdH1cblx0cmV0dXJuIGJvZHlIYW5kbGVyUHJvbTtcbn1cblxuZnVuY3Rpb24gX2ZpbHRlckhhbmRsZXJzKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXNIYW5kbGVyczoge1twYXRoOiBzdHJpbmddOiBTZXQ8Qm9keUhhbmRsZXJ8SGVhZGVySGFuZGxlcj59KSB7XG5cdHZhciBoYW5kbGVyczogQXJyYXk8Qm9keUhhbmRsZXJ8SGVhZGVySGFuZGxlcj4gPSBbXTtcblx0dmFyIGhhbmRsZXJTZXQgPSBfLmdldChyZXNIYW5kbGVycywgVXJsLnBhcnNlKHJlcS51cmwpLnBhdGhuYW1lKTtcblx0aWYgKGhhbmRsZXJTZXQpXG5cdFx0aGFuZGxlcnMucHVzaCguLi5oYW5kbGVyU2V0LnZhbHVlcygpKTtcblx0dmFyIGRlZmF1bHRIYW5kbGVyU2V0ID0gcmVzSGFuZGxlcnNbJyonXTtcblx0aWYgKGRlZmF1bHRIYW5kbGVyU2V0KVxuXHRcdGhhbmRsZXJzLnB1c2goLi4uZGVmYXVsdEhhbmRsZXJTZXQudmFsdWVzKCkpO1xuXHRyZXR1cm4gaGFuZGxlcnM7XG59XG5cbmZ1bmN0aW9uIGhhY2tIZWFkZXJzKHRhcmdldDogc3RyaW5nLCByZXE6IGV4cHJlc3MuUmVxdWVzdCk6IHtbazogc3RyaW5nXTogYW55fSB7XG5cdHZhciB0b0hlYWRlcnMgPSBfLmFzc2lnbih7fSwgcmVxLmhlYWRlcnMsIHtcblx0XHQneC1yZWFsLWlwJzogcmVxLmlwLFxuXHRcdCd4LWZvcndhcmRlZF9mb3InOiByZXEuaXAsXG5cdFx0J3gtZm9yd2FyZGVkLWZvcic6IHJlcS5pcFxuXHR9KTtcblx0dmFyIHBhcnNlZFRhcmdldCA9IFVybC5wYXJzZSh0YXJnZXQpO1xuXHR0b0hlYWRlcnMuaG9zdCA9IHBhcnNlZFRhcmdldC5ob3N0O1xuXHRkZWxldGUgdG9IZWFkZXJzLm9yaWdpbjtcblx0aWYgKHRvSGVhZGVycy5yZWZlcmVyKSB7XG5cdFx0dG9IZWFkZXJzLnJlZmVyZXIgPSBgJHtwYXJzZWRUYXJnZXQucHJvdG9jb2x9Ly8ke3BhcnNlZFRhcmdldC5ob3N0fSR7VXJsLnBhcnNlKHRvSGVhZGVycy5yZWZlcmVyKS5wYXRobmFtZX1gO1xuXHR9XG5cdHJldHVybiB0b0hlYWRlcnM7XG59XG5cbmZ1bmN0aW9uIGhhY2tSZXNwb25zZUhlYWRlcnMocmVxOiBleHByZXNzLlJlcXVlc3QsIG9yaWdpbkhlYWRlcnM6IHtbazogc3RyaW5nXTogYW55fSwgcmVzcG9uc2U6IGV4cHJlc3MuUmVzcG9uc2UsXG5cdHByb3h5SW5zdGFuY2U6IFByb3h5SW5zdGFuY2UpIHtcblx0Xy5lYWNoKG9yaWdpbkhlYWRlcnMsICh2LCBuKSA9PiB7XG5cdFx0aWYgKCFfLmdldChTS0lQX1JFU19IRUFERVJTX1NFVCwgbi50b0xvd2VyQ2FzZSgpKSkge1xuXHRcdFx0aWYgKG4gPT09ICdzZXQtY29va2llJyAmJiBwcm94eUluc3RhbmNlLmlzUmVtb3ZlQ29va2llRG9tYWluKSB7XG5cdFx0XHRcdHYgPSB2Lm1hcCgoY29va2llOiBhbnkpID0+IHtcblx0XHRcdFx0XHR2YXIgYXR0cnM6IHN0cmluZ1tdID0gY29va2llLnNwbGl0KCc7Jyk7XG5cdFx0XHRcdFx0cmV0dXJuIGF0dHJzLmZpbHRlcigodmFsdWUpID0+ICF2YWx1ZS5zdGFydHNXaXRoKCdkb21haW4nKSkuam9pbignOycpO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0bG9nLmluZm8oJ0RvbWFpbiBhdHRyaWJ1dGUgaXMgcmVtb3ZlZCBmcm9tIHNldC1jb29raWUgaGVhZGVyOiAnLCB2KTtcblx0XHRcdH1cblx0XHRcdHJlc3BvbnNlLnNldChuLCB2KTtcblx0XHR9IGVsc2Vcblx0XHRcdGxvZy5kZWJ1Zygnc2tpcCByZXNwb25zZSBoZWFkZXI6ICVzJywgbik7XG5cdH0pO1xufVxuIl19
