"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const _ = tslib_1.__importStar(require("lodash"));
const url_1 = tslib_1.__importDefault(require("url"));
function intercept(req, headers, body, resHandlers, name) {
    var bodyHandlerProm;
    var handlers = _filterHandlers(req, resHandlers);
    if (handlers.length > 0) {
        bodyHandlerProm = Promise.resolve({ req, headers, body });
        handlers.forEach(func => {
            bodyHandlerProm = bodyHandlerProm.then(data => {
                const resolvedRes = func(data.req, data.headers, data.body, data.result);
                if (resolvedRes != null) {
                    return Promise.resolve(resolvedRes)
                        .then(result => {
                        return Object.assign(data, { result });
                    });
                }
                return Promise.resolve(data);
            });
        });
        bodyHandlerProm = bodyHandlerProm.then(data => data.result);
    }
    else {
        bodyHandlerProm = Promise.resolve(null);
    }
    return bodyHandlerProm;
}
exports.intercept = intercept;
function _filterHandlers(req, resHandlers) {
    var handlers = [];
    var handlerSet = _.get(resHandlers, url_1.default.parse(req.url).pathname);
    if (handlerSet)
        handlers.push(...handlerSet.values());
    var defaultHandlerSet = resHandlers['*'];
    if (defaultHandlerSet)
        handlers.push(...defaultHandlerSet.values());
    return handlers;
}
class ProxyInstanceForBrowser {
    constructor(name, options = {}) {
        this.options = options;
        this.resHandlers = {};
        this.reqHandlers = {};
        this.mockHandlers = {};
        this.resHeaderHandlers = {};
        this.name = name;
    }
    get isRemoveCookieDomain() {
        return !!this.options.removeCookieDomain;
    }
    addOptions(opt) {
        _.assign(this.options, opt);
        return this;
    }
    /**
     * @param {*} path sub path after '/http-request-proxy'
     * @param {*} handler (url: string, method:string,
     * 	responseHeaders: {[name: string]:string}, responseBody: string | Buffer) => null | Promise<string>
     */
    interceptResponse(path, handler) {
        this.addHandler(path, handler, this.resHandlers);
    }
    interceptRequest(path, handler) {
        this.addHandler(path, handler, this.reqHandlers);
    }
    mockResponse(path, handler) {
        this.addHandler(path, handler, this.mockHandlers);
    }
    interceptResHeader(path, handler) {
        this.addHandler(path, handler, this.resHeaderHandlers);
    }
    addHandler(path, handler, to) {
        if (path !== '*' && !_.startsWith(path, '/'))
            path = '/' + path;
        var list = _.get(to, path);
        if (list == null) {
            list = new Set();
            to[path] = list;
        }
        list.add(handler);
    }
}
exports.ProxyInstanceForBrowser = ProxyInstanceForBrowser;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AZHIvaHR0cC1yZXF1ZXN0LXByb3h5L2lzb20vcHJveHktaW5zdGFuY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsa0RBQTRCO0FBRTVCLHNEQUFzQjtBQTJCdEIsU0FBZ0IsU0FBUyxDQUFDLEdBQW9CLEVBQUUsT0FBMkIsRUFBRSxJQUFTLEVBQ3JGLFdBQXFCLEVBQUUsSUFBWTtJQUNuQyxJQUFJLGVBQXVDLENBQUM7SUFDNUMsSUFBSSxRQUFRLEdBQWtCLGVBQWUsQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDaEUsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtRQUN4QixlQUFlLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUN4RCxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3ZCLGVBQWUsR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUM3QyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN6RSxJQUFJLFdBQVcsSUFBSSxJQUFJLEVBQUU7b0JBQ3hCLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUM7eUJBQ2xDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTt3QkFDZCxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUMsTUFBTSxFQUFDLENBQUMsQ0FBQztvQkFDdEMsQ0FBQyxDQUFDLENBQUM7aUJBQ0g7Z0JBQ0QsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlCLENBQUMsQ0FBQyxDQUFDO1FBQ0osQ0FBQyxDQUFD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QUFDO1lBQzlDLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7U0FDaEI7UUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ25CLENBQUM7Q0FDRDtBQTlDRCwwREE4Q0MiLCJmaWxlIjoibm9kZV9tb2R1bGVzL0Bkci9odHRwLXJlcXVlc3QtcHJveHkvaXNvbS9wcm94eS1pbnN0YW5jZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgVXJsIGZyb20gJ3VybCc7XG4vLyBpbXBvcnQge0luY29taW5nSHR0cEhlYWRlcnN9IGZyb20gJ2h0dHAnO1xuXG5leHBvcnQgdHlwZSBIZWFkZXJIYW5kbGVyID0gKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCBoZWFkZXI6IHtbbmFtZTogc3RyaW5nXTogYW55fSkgPT4gdm9pZDtcblxuLy8gZXhwb3J0IGludGVyZmFjZSBJc29tUmVxdWVzdCB7XG4vLyBcdG1ldGhvZDogc3RyaW5nO1xuLy8gXHR1cmw6IHN0cmluZztcbi8vIFx0aGVhZGVyczogSW5jb21pbmdIdHRwSGVhZGVycztcbi8vIFx0Ym9keTogYW55O1xuLy8gXHRxdWVyeTogYW55O1xuLy8gXHRyZXNwb25zZVR5cGU6ICdhcnJheWJ1ZmZlcicgfCAnYmxvYicgfCAnanNvbicgfCAndGV4dCc7XG4vLyB9XG5leHBvcnQgdHlwZSBCb2R5SGFuZGxlciA9IChyZXE6IGV4cHJlc3MuUmVxdWVzdCxcblx0aGFja2VkUmVxSGVhZGVyczoge1tuYW1lOiBzdHJpbmddOiBzdHJpbmd9LFxuXHRyZXF1ZXN0Qm9keTogYW55LFxuXHRsYXN0UmVzdWx0OiBhbnkpID0+IGFueTtcblxuZXhwb3J0IGludGVyZmFjZSBIYW5kbGVycyB7XG5cdFtwYXRoOiBzdHJpbmddOiBTZXQ8Qm9keUhhbmRsZXIgfCBIZWFkZXJIYW5kbGVyPjtcbn1cbmludGVyZmFjZSBIYW5kbGVyUGFyYW1zIHtcblx0cmVxOiBleHByZXNzLlJlcXVlc3Q7XG5cdGhlYWRlcnM6IHtbazogc3RyaW5nXTogYW55fTtcblx0Ym9keTogYW55O1xuXHRyZXN1bHQ/OiBhbnk7XG59XG5leHBvcnQgZnVuY3Rpb24gaW50ZXJjZXB0KHJlcTogZXhwcmVzcy5SZXF1ZXN0LCBoZWFkZXJzOiB7W2s6IHN0cmluZ106IGFueX0sIGJvZHk6IGFueSxcblx0cmVzSGFuZGxlcnM6IEhhbmRsZXJzLCBuYW1lOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuXHR2YXIgYm9keUhhbmRsZXJQcm9tOiBQcm9taXNlPEhhbmRsZXJQYXJhbXM+O1xuXHR2YXIgaGFuZGxlcnM6IEJvZHlIYW5kbGVyW10gPSBfZmlsdGVySGFuZGxlcnMocmVxLCByZXNIYW5kbGVycyk7XG5cdGlmIChoYW5kbGVycy5sZW5ndGggPiAwKSB7XG5cdFx0Ym9keUhhbmRsZXJQcm9tID0gUHJvbWlzZS5yZXNvbHZlKHtyZXEsIGhlYWRlcnMsIGJvZHl9KTtcblx0XHRoYW5kbGVycy5mb3JFYWNoKGZ1bmMgPT4ge1xuXHRcdFx0Ym9keUhhbmRsZXJQcm9tID0gYm9keUhhbmRsZXJQcm9tLnRoZW4oZGF0YSA9PiB7XG5cdFx0XHRcdGNvbnN0IHJlc29sdmVkUmVzID0gZnVuYyhkYXRhLnJlcSwgZGF0YS5oZWFkZXJzLCBkYXRhLmJvZHksIGRhdGEucmVzdWx0KTtcblx0XHRcdFx0aWYgKHJlc29sdmVkUmVzICE9IG51bGwpIHtcblx0XHRcdFx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc29sdmVkUmVzKVxuXHRcdFx0XHRcdC50aGVuKHJlc3VsdCA9PiB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gT2JqZWN0LmFzc2lnbihkYXRhLCB7cmVzdWx0fSk7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblx0XHRcdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShkYXRhKTtcblx0XHRcdH0pO1xuXHRcdH0pO1xuXHRcdGJvZHlIYW5kbGVyUHJvbSA9IGJvZHlIYW5kbGVyUHJvbS50aGVuKGRhdGEgPT4gZGF0YS5yZXN1bHQpO1xuXHR9IGVsc2Uge1xuXHRcdGJvZHlIYW5kbGVyUHJvbSA9IFByb21pc2UucmVzb2x2ZShudWxsKTtcblx0fVxuXHRyZXR1cm4gYm9keUhhbmRsZXJQcm9tO1xufVxuZnVuY3Rpb24gX2ZpbHRlckhhbmRsZXJzKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXNIYW5kbGVyczoge1twYXRoOiBzdHJpbmddOiBTZXQ8Qm9keUhhbmRsZXJ8SGVhZGVySGFuZGxlcj59KSB7XG5cdHZhciBoYW5kbGVyczogQXJyYXk8Qm9keUhhbmRsZXJ8SGVhZGVySGFuZGxlcj4gPSBbXTtcblx0dmFyIGhhbmRsZXJTZXQgPSBfLmdldChyZXNIYW5kbGVycywgVXJsLnBhcnNlKHJlcS51cmwpLnBhdGhuYW1lKTtcblx0aWYgKGhhbmRsZXJTZXQpXG5cdFx0aGFuZGxlcnMucHVzaCguLi5oYW5kbGVyU2V0LnZhbHVlcygpKTtcblx0dmFyIGRlZmF1bHRIYW5kbGVyU2V0ID0gcmVzSGFuZGxlcnNbJyonXTtcblx0aWYgKGRlZmF1bHRIYW5kbGVyU2V0KVxuXHRcdGhhbmRsZXJzLnB1c2goLi4uZGVmYXVsdEhhbmRsZXJTZXQudmFsdWVzKCkpO1xuXHRyZXR1cm4gaGFuZGxlcnM7XG59XG5leHBvcnQgY2xhc3MgUHJveHlJbnN0YW5jZUZvckJyb3dzZXIge1xuXHRuYW1lOiBzdHJpbmc7XG5cdHJlc0hhbmRsZXJzOiBIYW5kbGVycyA9IHt9O1xuXHRyZXFIYW5kbGVyczogSGFuZGxlcnMgPSB7fTtcblx0bW9ja0hhbmRsZXJzOiBIYW5kbGVycyA9IHt9O1xuXHRyZXNIZWFkZXJIYW5kbGVyczoge1twYXRoOiBzdHJpbmddOiBTZXQ8SGVhZGVySGFuZGxlcj59ID0ge307XG5cdGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZywgcHJvdGVjdGVkIG9wdGlvbnM6IHtbazogc3RyaW5nXTogYW55fSA9IHt9KSB7XG5cdFx0dGhpcy5uYW1lID0gbmFtZTtcblx0fVxuXG5cdGdldCBpc1JlbW92ZUNvb2tpZURvbWFpbigpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gISF0aGlzLm9wdGlvbnMucmVtb3ZlQ29va2llRG9tYWluO1xuXHR9XG5cblx0YWRkT3B0aW9ucyhvcHQ6IHtbazogc3RyaW5nXTogYW55fSk6IFByb3h5SW5zdGFuY2VGb3JCcm93c2VyIHtcblx0XHRfLmFzc2lnbih0aGlzLm9wdGlvbnMsIG9wdCk7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblx0LyoqXG5cdCAqIEBwYXJhbSB7Kn0gcGF0aCBzdWIgcGF0aCBhZnRlciAnL2h0dHAtcmVxdWVzdC1wcm94eSdcblx0ICogQHBhcmFtIHsqfSBoYW5kbGVyICh1cmw6IHN0cmluZywgbWV0aG9kOnN0cmluZyxcblx0ICogXHRyZXNwb25zZUhlYWRlcnM6IHtbbmFtZTogc3RyaW5nXTpzdHJpbmd9LCByZXNwb25zZUJvZHk6IHN0cmluZyB8IEJ1ZmZlcikgPT4gbnVsbCB8IFByb21pc2U8c3RyaW5nPlxuXHQgKi9cblx0aW50ZXJjZXB0UmVzcG9uc2UocGF0aDogc3RyaW5nLCBoYW5kbGVyOiBCb2R5SGFuZGxlcikge1xuXHRcdHRoaXMuYWRkSGFuZGxlcihwYXRoLCBoYW5kbGVyLCB0aGlzLnJlc0hhbmRsZXJzKTtcblx0fVxuXHRpbnRlcmNlcHRSZXF1ZXN0KHBhdGg6IHN0cmluZywgaGFuZGxlcjogQm9keUhhbmRsZXIpIHtcblx0XHR0aGlzLmFkZEhhbmRsZXIocGF0aCwgaGFuZGxlciwgdGhpcy5yZXFIYW5kbGVycyk7XG5cdH1cblx0bW9ja1Jlc3BvbnNlKHBhdGg6IHN0cmluZywgaGFuZGxlcjogQm9keUhhbmRsZXIpIHtcblx0XHR0aGlzLmFkZEhhbmRsZXIocGF0aCwgaGFuZGxlciwgdGhpcy5tb2NrSGFuZGxlcnMpO1xuXHR9XG5cdGludGVyY2VwdFJlc0hlYWRlcihwYXRoOiBzdHJpbmcsIGhhbmRsZXI6IEhlYWRlckhhbmRsZXIpIHtcblx0XHR0aGlzLmFkZEhhbmRsZXIocGF0aCwgaGFuZGxlciwgdGhpcy5yZXNIZWFkZXJIYW5kbGVycyk7XG5cdH1cblx0cHJpdmF0ZSBhZGRIYW5kbGVyKHBhdGg6IHN0cmluZywgaGFuZGxlcjogQm9keUhhbmRsZXIgfCBIZWFkZXJIYW5kbGVyLFxuXHRcdHRvOiB7W3BhdGg6IHN0cmluZ106IFNldDxCb2R5SGFuZGxlciB8IEhlYWRlckhhbmRsZXI+fSkge1xuXHRcdGlmIChwYXRoICE9PSAnKicgJiYgIV8uc3RhcnRzV2l0aChwYXRoLCAnLycpKVxuXHRcdFx0cGF0aCA9ICcvJyArIHBhdGg7XG5cdFx0dmFyIGxpc3Q6IFNldDxCb2R5SGFuZGxlciB8IEhlYWRlckhhbmRsZXI+ID0gXy5nZXQodG8sIHBhdGgpO1xuXHRcdGlmIChsaXN0ID09IG51bGwpIHtcblx0XHRcdGxpc3QgPSBuZXcgU2V0PEJvZHlIYW5kbGVyIHwgSGVhZGVySGFuZGxlcj4oKTtcblx0XHRcdHRvW3BhdGhdID0gbGlzdDtcblx0XHR9XG5cdFx0bGlzdC5hZGQoaGFuZGxlcik7XG5cdH1cbn1cblxuZXhwb3J0IHR5cGUgTW9ja1NldHVwRnVuYyA9IChwcm94eTogUHJveHlJbnN0YW5jZUZvckJyb3dzZXIsIGZvck5hbWU/OiAobmFtZTogc3RyaW5nKSA9PlxuXHRQcm94eUluc3RhbmNlRm9yQnJvd3NlcikgPT4gdm9pZDtcbiJdfQ==
