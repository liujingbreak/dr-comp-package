#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
require('source-map-support/register');
const commander_1 = require("commander");
const package_json_1 = tslib_1.__importDefault(require("../package.json"));
const path_1 = tslib_1.__importDefault(require("path"));
const cfg = require('dr-comp-package/wfh/lib/config.js');
const logConfig = require('dr-comp-package/wfh/lib/logConfig.js');
const package_runner_1 = require("dr-comp-package/wfh/dist/package-runner");
const chalk_1 = tslib_1.__importDefault(require("chalk"));
const fs_extra_1 = tslib_1.__importDefault(require("fs-extra"));
const log4js_1 = tslib_1.__importDefault(require("log4js"));
const program = new commander_1.Command().name('prebuild');
program.version(package_json_1.default.version);
program.option('-c, --config <config-file>', 'Read config files, if there are multiple files, the latter one overrides previous one', (curr, prev) => prev.concat(curr), []);
program.option('--prop <property-path=value as JSON | literal>', '<property-path>=<value as JSON | literal> ... directly set configuration properties, property name is lodash.set() path-like string\n e.g.\n', (curr, prev) => prev.concat(curr), []);
program.option('--secret <credential code>', 'credential code for deploy to "prod" environment');
// ----------- deploy ----------
const deployCmd = program.command('deploy <app> [ts-scripts#function-or-shell]')
    .option('--static', 'as an static resource build', false)
    .option('--no-push-branch', 'push to release branch', false)
    // .option('--secret <secret>', 'credential word')
    .action((app, scriptsFile) => tslib_1.__awaiter(this, void 0, void 0, function* () {
    const opt = deployCmd.opts();
    yield cfg.init({
        c: program.opts().config.length === 0 ? undefined : program.opts().config,
        prop: program.opts().prop
    });
    logConfig(cfg());
    package_runner_1.prepareLazyNodeInjector({});
    const cliDeploy = require('./cli-deploy').default;
    yield cliDeploy(opt.static, opt.env, app, deployCmd.opts().pushBranch, program.opts().secret || null, scriptsFile);
}));
createEnvOption(deployCmd);
// -------- githash ----------
const githashCmd = createEnvOption(program.command('githash'), false)
    .action(() => tslib_1.__awaiter(this, void 0, void 0, function* () {
    const Artifacts = require('./artifacts');
    if (githashCmd.opts().env) {
        // tslint:disable-next-line: no-console
        console.log(yield Artifacts.stringifyListVersions(githashCmd.opts().env));
    }
    else {
        // tslint:disable-next-line: no-console
        console.log(yield Artifacts.stringifyListAllVersions());
    }
}));
// ------ send --------
const sendCmd = createEnvOption(program.command('send <app-name> <zip-file>'))
    .description('Send static resource to remote server')
    .action((appName, zip) => tslib_1.__awaiter(this, void 0, void 0, function* () {
    yield cfg.init({
        c: program.opts().config.length === 0 ? undefined : program.opts().config,
        prop: program.opts().prop
    });
    logConfig(cfg());
    package_runner_1.prepareLazyNodeInjector({});
    yield require('./_send-patch').send(sendCmd.opts().env, appName, zip, program.opts().secret);
}));
// ------ mockzip --------
const mockzipCmd = program.command('mockzip');
mockzipCmd.option('-d,--dir <dir>', 'create a mock zip file in specific directory');
mockzipCmd.action(() => tslib_1.__awaiter(this, void 0, void 0, function* () {
    yield cfg.init({
        c: program.opts().config.length === 0 ? undefined : program.opts().config,
        prop: program.opts().prop
    });
    logConfig(cfg());
    const Artifacts = require('./artifacts');
    const fileContent = '' + new Date().toUTCString();
    const file = mockzipCmd.opts().dir ? path_1.default.resolve(mockzipCmd.opts().dir, 'prebuild-mock.zip') : cfg.resolve('destDir', 'prebuild-mock.zip');
    fs_extra_1.default.mkdirpSync(path_1.default.dirname(file));
    yield Artifacts.writeMockZip(file, fileContent);
    const log = log4js_1.default.getLogger('prebuild');
    // tslint:disable-next-line: no-console
    log.info('Mock zip:', file);
}));
// ---------- keypair ------------
const keypairCmd = program.command('keypair [file-name]')
    .description('Generate a new asymmetric key pair')
    .action((fileName) => tslib_1.__awaiter(this, void 0, void 0, function* () {
    const genKeypair = require('./cli-keypair').default;
    yield genKeypair(fileName, keypairCmd.opts());
}));
const tsAstCmd = program.command('ts-ast <ts-file>')
    .option('--no-type', 'do not print AST type', false)
    .option('-q|--query <selector>', 'query selector', undefined)
    .description('Print Typescript AST structure')
    .action((filename) => tslib_1.__awaiter(this, void 0, void 0, function* () {
    const printFile = require('./ts-ast-query').printFile;
    printFile(filename, tsAstCmd.opts().query, tsAstCmd.opts().type);
}));
program.command('functions <file>')
    .description('List exported functions for *.ts, *.d.ts, *.js file')
    .action((file) => tslib_1.__awaiter(this, void 0, void 0, function* () {
    const { listExportedFunction } = require('./cli-ts-ast-util');
    listExportedFunction(file);
}));
// -------- listzip --------
program.command('listzip <file>')
    .description('List zip file content and size')
    .action((file) => tslib_1.__awaiter(this, void 0, void 0, function* () {
    const { listZip } = require('./cli-unzip');
    yield listZip(file);
}));
program.description(chalk_1.default.cyanBright('Prebuild and deploy static resource to file server and compile node server side TS files'));
program.parseAsync(process.argv)
    .catch(e => {
    console.error(e);
    process.exit(1);
});
function createEnvOption(cmd, required = true) {
    const func = required ? cmd.requiredOption : cmd.option;
    return func.call(cmd, '--env <local | dev | test | stage | prod>', 'target environment, e.g. "local", "dev", "test", "stage", "prod", default as all environment');
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AYmsvcHJlYnVpbGQvdHMvY2xpLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSxPQUFPLENBQUMsNkJBQTZCLENBQUMsQ0FBQztBQUN2Qyx5Q0FBNkM7QUFDN0MsMkVBQWlDO0FBQ2pDLHdEQUF3QjtBQUV4QixNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsbUNBQW1DLENBQXNCLENBQUM7QUFDOUUsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7QUFDbEUsNEVBQWdGO0FBR2hGLDBEQUEwQjtBQUMxQixnRUFBMEI7QUFJMUIsNERBQTRCO0FBTTVCLE1BQU0sT0FBTyxHQUFHLElBQUksbUJBQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUUvQyxPQUFPLENBQUMsT0FBTyxDQUFDLHNCQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDNUIsT0FBTyxDQUFDLE1BQU0sQ0FBQyw0QkFBNEIsRUFDekMsdUZBQXVGLEVBQ3ZGLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFjLENBQUMsQ0FBQztBQUNyRCxPQUFPLENBQUMsTUFBTSxDQUFDLGdEQUFnRCxFQUM3RCw4SUFBOEksRUFDOUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQWMsQ0FBQyxDQUFDO0FBQ3JELE9BQU8sQ0FBQyxNQUFNLENBQUMsNEJBQTRCLEVBQUUsa0RBQWtELENBQUMsQ0FBQztBQUVqRyxnQ0FBZ0M7QUFDaEMsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQztLQUMvRSxNQUFNLENBQUMsVUFBVSxFQUFFLDZCQUE2QixFQUFFLEtBQUssQ0FBQztLQUN4RCxNQUFNLENBQUMsa0JBQWtCLEVBQUUs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SUFBSSxDQUFDLENBQUM7QUFDN0IsQ0FBQyxDQUFBLENBQUMsQ0FBQztBQUVILDRCQUE0QjtBQUM1QixPQUFPLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDO0tBQ2hDLFdBQVcsQ0FBQyxnQ0FBZ0MsQ0FBQztLQUM3QyxNQUFNLENBQUMsQ0FBTSxJQUFJLEVBQUMsRUFBRTtJQUNuQixNQUFNLEVBQUMsT0FBTyxFQUFDLEdBQWtCLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUN4RCxNQUFNLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN0QixDQUFDLENBQUEsQ0FBQyxDQUFDO0FBRUgsT0FBTyxDQUFDLFdBQVcsQ0FBQyxlQUFLLENBQUMsVUFBVSxDQUNsQywwRkFBMEYsQ0FBQyxDQUFDLENBQUM7QUFDL0YsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO0tBQy9CLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtJQUNULE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQztBQUlILFNBQVMsZUFBZSxDQUFDLEdBQXNCLEVBQUUsUUFBUSxHQUFHLElBQUk7SUFDOUQsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDO0lBRXhELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsMkNBQTJDLEVBQUUsOEZBQThGLENBQUMsQ0FBQztBQUNySyxDQUFDIiwiZmlsZSI6Im5vZGVfbW9kdWxlcy9AYmsvcHJlYnVpbGQvZGlzdC9jbGkuanMiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXG5yZXF1aXJlKCdzb3VyY2UtbWFwLXN1cHBvcnQvcmVnaXN0ZXInKTtcbmltcG9ydCBjb21tYW5kZXIsIHtDb21tYW5kfSBmcm9tICdjb21tYW5kZXInO1xuaW1wb3J0IHBrIGZyb20gJy4uL3BhY2thZ2UuanNvbic7XG5pbXBvcnQgUGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBhcGkgZnJvbSAnX19hcGknO1xuY29uc3QgY2ZnID0gcmVxdWlyZSgnZHItY29tcC1wYWNrYWdlL3dmaC9saWIvY29uZmlnLmpzJykgYXMgdHlwZW9mIGFwaS5jb25maWc7XG5jb25zdCBsb2dDb25maWcgPSByZXF1aXJlKCdkci1jb21wLXBhY2thZ2Uvd2ZoL2xpYi9sb2dDb25maWcuanMnKTtcbmltcG9ydCB7cHJlcGFyZUxhenlOb2RlSW5qZWN0b3J9IGZyb20gJ2RyLWNvbXAtcGFja2FnZS93ZmgvZGlzdC9wYWNrYWdlLXJ1bm5lcic7XG5pbXBvcnQgKiBhcyBfQXJ0aWZhY3RzIGZyb20gJy4vYXJ0aWZhY3RzJztcbmltcG9ydCAqIGFzIHNwIGZyb20gJy4vX3NlbmQtcGF0Y2gnO1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgKiBhcyBfcHJlYnVpbGRQb3N0IGZyb20gJy4vcHJlYnVpbGQtcG9zdCc7XG4vLyBpbXBvcnQge3NwYXdufSBmcm9tICdkci1jb21wLXBhY2thZ2Uvd2ZoL2Rpc3QvcHJvY2Vzcy11dGlscyc7XG5pbXBvcnQgX2NsaURlcGxveSBmcm9tICcuL2NsaS1kZXBsb3knO1xuaW1wb3J0IGxvZzRqcyBmcm9tICdsb2c0anMnO1xuaW1wb3J0IF9nZW5LZXlwYWlyIGZyb20gJy4vY2xpLWtleXBhaXInO1xuaW1wb3J0ICogYXMgdHNBc3RRdWVyeSBmcm9tICcuL3RzLWFzdC1xdWVyeSc7XG5pbXBvcnQgKiBhcyBfdW56aXAgZnJvbSAnLi9jbGktdW56aXAnO1xuaW1wb3J0ICogYXMgYXN0VXRpbCBmcm9tICcuL2NsaS10cy1hc3QtdXRpbCc7XG5cbmNvbnN0IHByb2dyYW0gPSBuZXcgQ29tbWFuZCgpLm5hbWUoJ3ByZWJ1aWxkJyk7XG5cbnByb2dyYW0udmVyc2lvbihway52ZXJzaW9uKTtcbnByb2dyYW0ub3B0aW9uKCctYywgLS1jb25maWcgPGNvbmZpZy1maWxlPicsXG4gICdSZWFkIGNvbmZpZyBmaWxlcywgaWYgdGhlcmUgYXJlIG11bHRpcGxlIGZpbGVzLCB0aGUgbGF0dGVyIG9uZSBvdmVycmlkZXMgcHJldmlvdXMgb25lJyxcbiAgKGN1cnIsIHByZXYpID0+IHByZXYuY29uY2F0KGN1cnIpLCBbXSBhcyBzdHJpbmdbXSk7XG5wcm9ncmFtLm9wdGlvbignLS1wcm9wIDxwcm9wZXJ0eS1wYXRoPXZhbHVlIGFzIEpTT04gfCBsaXRlcmFsPicsXG4gICc8cHJvcGVydHktcGF0aD49PHZhbHVlIGFzIEpTT04gfCBsaXRlcmFsPiAuLi4gZGlyZWN0bHkgc2V0IGNvbmZpZ3VyYXRpb24gcHJvcGVydGllcywgcHJvcGVydHkgbmFtZSBpcyBsb2Rhc2guc2V0KCkgcGF0aC1saWtlIHN0cmluZ1xcbiBlLmcuXFxuJyxcbiAgKGN1cnIsIHByZXYpID0+IHByZXYuY29uY2F0KGN1cnIpLCBbXSBhcyBzdHJpbmdbXSk7XG5wcm9ncmFtLm9wdGlvbignLS1zZWNyZXQgPGNyZWRlbnRpYWwgY29kZT4nLCAnY3JlZGVudGlhbCBjb2RlIGZvciBkZXBsb3kgdG8gXCJwcm9kXCIgZW52aXJvbm1lbnQnKTtcblxuLy8gLS0tLS0tLS0tLS0gZGVwbG95IC0tLS0tLS0tLS1cbmNvbnN0IGRlcGxveUNtZCA9IHByb2dyYW0uY29tbWFuZCgnZGVwbG95IDxhcHA+IFt0cy1zY3JpcHRzI2Z1bmN0aW9uLW9yLXNoZWxsXScpXG4ub3B0aW9uKCctLXN0YXRpYycsICdhcyBhbiBzdGF0aWMgcmVzb3VyY2UgYnVpbGQnLCBmYWxzZSlcbi5vcHRpb24oJy0tbm8tcHVzaC1icmFuY2gnLCAncHVzaCB0byByZWxlYXNlIGJyYW5jaCcsIGZhbHNlKVxuLy8gLm9wdGlvbignLS1zZWNyZXQgPHNlY3JldD4nLCAnY3JlZGVudGlhbCB3b3JkJylcbi5hY3Rpb24oYXN5bmMgKGFwcDogc3RyaW5nLCBzY3JpcHRzRmlsZT86IHN0cmluZykgPT4ge1xuICBjb25zdCBvcHQgPSBkZXBsb3lDbWQub3B0cygpO1xuICBhd2FpdCBjZmcuaW5pdCh7XG4gICAgYzogKHByb2dyYW0ub3B0cygpLmNvbmZpZyBhcyBzdHJpbmdbXSkubGVuZ3RoID09PSAwID8gdW5kZWZpbmVkIDogcHJvZ3JhbS5vcHRzKCkuY29uZmlnLFxuICAgIHByb3A6IChwcm9ncmFtLm9wdHMoKS5wcm9wIGFzIHN0cmluZ1tdKVxuICB9KTtcbiAgbG9nQ29uZmlnKGNmZygpKTtcbiAgcHJlcGFyZUxhenlOb2RlSW5qZWN0b3Ioe30pO1xuXG4gIGNvbnN0IGNsaURlcGxveSA9IChyZXF1aXJlKCcuL2NsaS1kZXBsb3knKS5kZWZhdWx0IGFzIHR5cGVvZiBfY2xpRGVwbG95KTtcbiAgYXdhaXQgY2xpRGVwbG95KG9wdC5zdGF0aWMsIG9wdC5lbnYsIGFwcCwgZGVwbG95Q21kLm9wdHMoKS5wdXNoQnJhbmNoLCBwcm9ncmFtLm9wdHMoKS5zZWNyZXQgfHwgbnVsbCwgc2NyaXB0c0ZpbGUpO1xufSk7XG5jcmVhdGVFbnZPcHRpb24oZGVwbG95Q21kKTtcblxuXG4vLyAtLS0tLS0tLSBnaXRoYXNoIC0tLS0tLS0tLS1cbmNvbnN0IGdpdGhhc2hDbWQgPSBjcmVhdGVFbnZPcHRpb24ocHJvZ3JhbS5jb21tYW5kKCdnaXRoYXNoJyksIGZhbHNlKVxuLmFjdGlvbihhc3luYyAoKSA9PiB7XG4gIGNvbnN0IEFydGlmYWN0czogdHlwZW9mIF9BcnRpZmFjdHMgPSByZXF1aXJlKCcuL2FydGlmYWN0cycpO1xuICBpZiAoZ2l0aGFzaENtZC5vcHRzKCkuZW52KSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1jb25zb2xlXG4gICAgY29uc29sZS5sb2coYXdhaXQgQXJ0aWZhY3RzLnN0cmluZ2lmeUxpc3RWZXJzaW9ucyhnaXRoYXNoQ21kLm9wdHMoKS5lbnYpKTtcbiAgfSBlbHNlIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWNvbnNvbGVcbiAgICBjb25zb2xlLmxvZyhhd2FpdCBBcnRpZmFjdHMuc3RyaW5naWZ5TGlzdEFsbFZlcnNpb25zKCkpO1xuICB9XG59KTtcblxuLy8gLS0tLS0tIHNlbmQgLS0tLS0tLS1cbmNvbnN0IHNlbmRDbWQgPSBjcmVhdGVFbnZPcHRpb24ocHJvZ3JhbS5jb21tYW5kKCdzZW5kIDxhcHAtbmFtZT4gPHppcC1maWxlPicpKVxuLmRlc2NyaXB0aW9uKCdTZW5kIHN0YXRpYyByZXNvdXJjZSB0byByZW1vdGUgc2VydmVyJylcbi5hY3Rpb24oYXN5bmMgKGFwcE5hbWUsIHppcCkgPT4ge1xuICBhd2FpdCBjZmcuaW5pdCh7XG4gICAgYzogKHByb2dyYW0ub3B0cygpLmNvbmZpZyBhcyBzdHJpbmdbXSkubGVuZ3RoID09PSAwID8gdW5kZWZpbmVkIDogcHJvZ3JhbS5vcHRzKCkuY29uZmlnLFxuICAgIHByb3A6IChwcm9ncmFtLm9wdHMoKS5wcm9wIGFzIHN0cmluZ1tdKVxuICB9KTtcbiAgbG9nQ29uZmlnKGNmZygpKTtcbiAgcHJlcGFyZUxhenlOb2RlSW5qZWN0b3Ioe30pO1xuXG4gIGF3YWl0IChyZXF1aXJlKCcuL19zZW5kLXBhdGNoJykgYXMgdHlwZW9mIHNwKS5zZW5kKHNlbmRDbWQub3B0cygpLmVudiwgYXBwTmFtZSwgemlwLCBwcm9ncmFtLm9wdHMoKS5zZWNyZXQpO1xufSk7XG5cblxuLy8gLS0tLS0tIG1vY2t6aXAgLS0tLS0tLS1cbmNvbnN0IG1vY2t6aXBDbWQgPSBwcm9ncmFtLmNvbW1hbmQoJ21vY2t6aXAnKTtcbm1vY2t6aXBDbWQub3B0aW9uKCctZCwtLWRpciA8ZGlyPicsICdjcmVhdGUgYSBtb2NrIHppcCBmaWxlIGluIHNwZWNpZmljIGRpcmVjdG9yeScpO1xubW9ja3ppcENtZC5hY3Rpb24oYXN5bmMgKCkgPT4ge1xuICBhd2FpdCBjZmcuaW5pdCh7XG4gICAgYzogKHByb2dyYW0ub3B0cygpLmNvbmZpZyBhcyBzdHJpbmdbXSkubGVuZ3RoID09PSAwID8gdW5kZWZpbmVkIDogcHJvZ3JhbS5vcHRzKCkuY29uZmlnLFxuICAgIHByb3A6IChwcm9ncmFtLm9wdHMoKS5wcm9wIGFzIHN0cmluZ1tdKVxuICB9KTtcbiAgbG9nQ29uZmlnKGNmZygpKTtcblxuICBjb25zdCBBcnRpZmFjdHM6IHR5cGVvZiBfQXJ0aWZhY3RzID0gcmVxdWlyZSgnLi9hcnRpZmFjdHMnKTtcblxuICBjb25zdCBmaWxlQ29udGVudCA9ICcnICsgbmV3IERhdGUoKS50b1VUQ1N0cmluZygpO1xuXG4gIGNvbnN0IGZpbGUgPSBtb2NremlwQ21kLm9wdHMoKS5kaXIgPyBQYXRoLnJlc29sdmUobW9ja3ppcENtZC5vcHRzKCkuZGlyLCAncHJlYnVpbGQtbW9jay56aXAnKSA6IGNmZy5yZXNvbHZlKCdkZXN0RGlyJywgJ3ByZWJ1aWxkLW1vY2suemlwJyk7XG4gIGZzLm1rZGlycFN5bmMoUGF0aC5kaXJuYW1lKGZpbGUpKTtcblxuICBhd2FpdCBBcnRpZmFjdHMud3JpdGVNb2NrWmlwKGZpbGUsIGZpbGVDb250ZW50KTtcbiAgY29uc3QgbG9nID0gbG9nNGpzLmdldExvZ2dlcigncHJlYnVpbGQnKTtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1jb25zb2xlXG4gIGxvZy5pbmZvKCdNb2NrIHppcDonLCBmaWxlKTtcbn0pO1xuXG4vLyAtLS0tLS0tLS0tIGtleXBhaXIgLS0tLS0tLS0tLS0tXG5jb25zdCBrZXlwYWlyQ21kID0gcHJvZ3JhbS5jb21tYW5kKCdrZXlwYWlyIFtmaWxlLW5hbWVdJylcbi5kZXNjcmlwdGlvbignR2VuZXJhdGUgYSBuZXcgYXN5bW1ldHJpYyBrZXkgcGFpcicpXG4uYWN0aW9uKGFzeW5jIChmaWxlTmFtZSkgPT4ge1xuICBjb25zdCBnZW5LZXlwYWlyID0gcmVxdWlyZSgnLi9jbGkta2V5cGFpcicpLmRlZmF1bHQgYXMgdHlwZW9mIF9nZW5LZXlwYWlyO1xuICBhd2FpdCBnZW5LZXlwYWlyKGZpbGVOYW1lLCBrZXlwYWlyQ21kLm9wdHMoKSk7XG59KTtcblxuY29uc3QgdHNBc3RDbWQgPSBwcm9ncmFtLmNvbW1hbmQoJ3RzLWFzdCA8dHMtZmlsZT4nKVxuLm9wdGlvbignLS1uby10eXBlJywgJ2RvIG5vdCBwcmludCBBU1QgdHlwZScsIGZhbHNlKVxuLm9wdGlvbignLXF8LS1xdWVyeSA8c2VsZWN0b3I+JywgJ3F1ZXJ5IHNlbGVjdG9yJywgdW5kZWZpbmVkKVxuLmRlc2NyaXB0aW9uKCdQcmludCBUeXBlc2NyaXB0IEFTVCBzdHJ1Y3R1cmUnKVxuLmFjdGlvbihhc3luYyBmaWxlbmFtZSA9PiB7XG4gIGNvbnN0IHByaW50RmlsZTogKHR5cGVvZiB0c0FzdFF1ZXJ5KVsncHJpbnRGaWxlJ10gPSByZXF1aXJlKCcuL3RzLWFzdC1xdWVyeScpLnByaW50RmlsZTtcbiAgcHJpbnRGaWxlKGZpbGVuYW1lLCB0c0FzdENtZC5vcHRzKCkucXVlcnksIHRzQXN0Q21kLm9wdHMoKS50eXBlIGFzIGJvb2xlYW4pO1xufSk7XG5cbnByb2dyYW0uY29tbWFuZCgnZnVuY3Rpb25zIDxmaWxlPicpXG4uZGVzY3JpcHRpb24oJ0xpc3QgZXhwb3J0ZWQgZnVuY3Rpb25zIGZvciAqLnRzLCAqLmQudHMsICouanMgZmlsZScpXG4uYWN0aW9uKGFzeW5jIGZpbGUgPT4ge1xuICBjb25zdCB7bGlzdEV4cG9ydGVkRnVuY3Rpb259ID0gcmVxdWlyZSgnLi9jbGktdHMtYXN0LXV0aWwnKSBhcyB0eXBlb2YgYXN0VXRpbDtcbiAgbGlzdEV4cG9ydGVkRnVuY3Rpb24oZmlsZSk7XG59KTtcblxuLy8gLS0tLS0tLS0gbGlzdHppcCAtLS0tLS0tLVxucHJvZ3JhbS5jb21tYW5kKCdsaXN0emlwIDxmaWxlPicpXG4uZGVzY3JpcHRpb24oJ0xpc3QgemlwIGZpbGUgY29udGVudCBhbmQgc2l6ZScpXG4uYWN0aW9uKGFzeW5jIGZpbGUgPT4ge1xuICBjb25zdCB7bGlzdFppcH06IHR5cGVvZiBfdW56aXAgPSByZXF1aXJlKCcuL2NsaS11bnppcCcpO1xuICBhd2FpdCBsaXN0WmlwKGZpbGUpO1xufSk7XG5cbnByb2dyYW0uZGVzY3JpcHRpb24oY2hhbGsuY3lhbkJyaWdodChcbiAgJ1ByZWJ1aWxkIGFuZCBkZXBsb3kgc3RhdGljIHJlc291cmNlIHRvIGZpbGUgc2VydmVyIGFuZCBjb21waWxlIG5vZGUgc2VydmVyIHNpZGUgVFMgZmlsZXMnKSk7XG5wcm9ncmFtLnBhcnNlQXN5bmMocHJvY2Vzcy5hcmd2KVxuLmNhdGNoKGUgPT4ge1xuICBjb25zb2xlLmVycm9yKGUpO1xuICBwcm9jZXNzLmV4aXQoMSk7XG59KTtcblxuXG5cbmZ1bmN0aW9uIGNyZWF0ZUVudk9wdGlvbihjbWQ6IGNvbW1hbmRlci5Db21tYW5kLCByZXF1aXJlZCA9IHRydWUpOiBSZXR1cm5UeXBlPGNvbW1hbmRlci5Db21tYW5kWydyZXF1aXJlZE9wdGlvbiddPiB7XG4gIGNvbnN0IGZ1bmMgPSByZXF1aXJlZCA/IGNtZC5yZXF1aXJlZE9wdGlvbiA6IGNtZC5vcHRpb247XG5cbiAgcmV0dXJuIGZ1bmMuY2FsbChjbWQsICctLWVudiA8bG9jYWwgfCBkZXYgfCB0ZXN0IHwgc3RhZ2UgfCBwcm9kPicsICd0YXJnZXQgZW52aXJvbm1lbnQsIGUuZy4gXCJsb2NhbFwiLCBcImRldlwiLCBcInRlc3RcIiwgXCJzdGFnZVwiLCBcInByb2RcIiwgZGVmYXVsdCBhcyBhbGwgZW52aXJvbm1lbnQnKTtcbn1cblxuIl19
