"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
/* tslint:disable max-classes-per-file */
const _ = __importStar(require("lodash"));
class PackageBrowserInstance {
    constructor(attrs) {
        if (!(this instanceof PackageBrowserInstance)) {
            return new PackageBrowserInstance(attrs);
        }
        if (attrs) {
            this.init(attrs);
        }
    }
    init(attrs) {
        _.assign(this, attrs);
        const parsedName = this.parsedName;
        if (parsedName) {
            this.shortName = parsedName.name;
            this.scopeName = parsedName.scope;
        }
    }
    toString() {
        return 'Package: ' + this.longName;
    }
}
exports.default = PackageBrowserInstance;
const Path = __importStar(require("path"));
const fs = __importStar(require("fs"));
const dir_tree_1 = require("require-injector/dist/dir-tree");
const packageUtils = require('dr-comp-package/wfh/lib/packageMgr/packageUtils');
class LazyPackageFactory {
    constructor() {
        this.packagePathMap = new dir_tree_1.DirTree();
    }
    getPackageByPath(file) {
        let currPath = file;
        let found;
        found = this.packagePathMap.getAllData(file);
        if (found.length > 0)
            return found[found.length - 1];
        while (true) {
            const dir = Path.dirname(currPath);
            if (dir === currPath)
                break; // Has reached root
            if (fs.existsSync(Path.join(dir, 'package.json'))) {
                const pkjson = require(Path.join(dir, 'package.json'));
                const pk = createPackage(dir, pkjson);
                this.packagePathMap.putData(dir, pk);
                return pk;
            }
            currPath = dir;
        }
        return null;
    }
}
exports.LazyPackageFactory = LazyPackageFactory;
function createPackage(packagePath, pkJson) {
    const name = pkJson.name;
    const instance = new PackageBrowserInstance({
        isVendor: false,
        bundle: null,
        longName: pkJson.name,
        shortName: packageUtils.parseName(pkJson.name).name,
        packagePath,
        realPackagePath: fs.realpathSync(packagePath)
    });
    let entryViews, entryPages;
    let isEntryServerTemplate = true;
    let noParseFiles;
    if (pkJson.dr) {
        if (pkJson.dr.entryPage) {
            isEntryServerTemplate = false;
            entryPages = [].concat(pkJson.dr.entryPage);
        }
        else if (pkJson.dr.entryView) {
            isEntryServerTemplate = true;
            entryViews = [].concat(pkJson.dr.entryView);
        }
        if (pkJson.dr.noParse) {
            noParseFiles = [].concat(pkJson.dr.noParse).map(trimNoParseSetting);
        }
        if (pkJson.dr.browserifyNoParse) {
            noParseFiles = [].concat(pkJson.dr.browserifyNoParse).map(trimNoParseSetting);
        }
    }
    const mainFile = pkJson.browser || pkJson.main;
    instance.init({
        file: mainFile ? fs.realpathSync(Path.resolve(packagePath, mainFile)) : undefined,
        main: pkJson.main,
        // style: pkJson.style ? resolveStyle(name, nodePaths) : null,
        parsedName: packageUtils.parseName(name),
        entryPages,
        entryViews,
        browserifyNoParse: noParseFiles,
        isEntryServerTemplate,
        translatable: !_.has(pkJson, 'dr.translatable') || _.get(pkJson, 'dr.translatable'),
        dr: pkJson.dr,
        json: pkJson,
        compiler: _.get(pkJson, 'dr.compiler'),
        browser: pkJson.browser,
        i18n: pkJson.dr && pkJson.dr.i18n ? pkJson.dr.i18n : null,
        appType: _.get(pkJson, 'dr.appType')
    });
    return instance;
}
function trimNoParseSetting(p) {
    p = p.replace(/\\/g, '/');
    if (p.startsWith('./')) {
        p = p.substring(2);
    }
    return p;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFja2FnZS1pbnN0YW5jZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3RzL2J1aWxkLXV0aWwvdHMvcGFja2FnZS1pbnN0YW5jZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSx5Q0FBeUM7QUFDekMsMENBQTRCO0FBRTVCLE1BQXFCLHNCQUFzQjtJQXdCekMsWUFBWSxLQUFVO1FBQ3BCLElBQUksQ0FBQyxDQUFDLElBQUksWUFBWSxzQkFBc0IsQ0FBQyxFQUFFO1lBQzdDLE9BQU8sSUFBSSxzQkFBc0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMxQztRQUNELElBQUksS0FBSyxFQUFFO1lBQ1QsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNsQjtJQUNILENBQUM7SUFDRCxJQUFJLENBQUMsS0FBNEU7UUFDL0UsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdEIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztRQUNuQyxJQUFJLFVBQVUsRUFBRTtZQUNkLElBQUksQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQztZQUNqQyxJQUFJLENBQUMsU0FBUyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUM7U0FDbkM7SUFDSCxDQUFDO0lBQ0QsUUFBUTtRQUNOLE9BQU8sV0FBVyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDckMsQ0FBQztDQUNGO0FBM0NELHlDQTJDQztBQUNELDJDQUE2QjtBQUM3Qix1Q0FBeUI7QUFDekIsNkRBQXVEO0FBQ3ZELE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxpREFBaUQsQ0FBQyxDQUFDO0FBQ2hGLE1BQWEsa0JBQWtCO0lBQS9CO1FBQ0UsbUJBQWMsR0FBRyxJQUFJLGtCQUFPLEVBQTBCLENBQUM7SUFzQnpELENBQUM7SUFwQkMsZ0JBQWdCLENBQUMsSUFBWTtRQUMzQixJQUFJ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QixDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNwQjtJQUNELE9BQU8sQ0FBQyxDQUFDO0FBQ1gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIHRzbGludDpkaXNhYmxlIG1heC1jbGFzc2VzLXBlci1maWxlICovXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBhY2thZ2VCcm93c2VySW5zdGFuY2Uge1xuICBidW5kbGU6IHN0cmluZztcbiAgbG9uZ05hbWU6IHN0cmluZztcbiAgc2hvcnROYW1lOiBzdHJpbmc7XG4gIGZpbGU/OiBzdHJpbmc7XG4gIHBhcnNlZE5hbWU6IHtzY29wZTogc3RyaW5nLCBuYW1lOiBzdHJpbmd9O1xuICBzY29wZU5hbWU6IHN0cmluZztcbiAgZW50cnlQYWdlcz86IHN0cmluZ1tdO1xuICBpMThuOiBzdHJpbmc7XG4gIHBhY2thZ2VQYXRoOiBzdHJpbmc7XG4gIHJlYWxQYWNrYWdlUGF0aDogc3RyaW5nO1xuICBtYWluOiBzdHJpbmc7XG4gIHN0eWxlPzogc3RyaW5nIHwgbnVsbDtcbiAgZW50cnlWaWV3cz86IHN0cmluZ1tdO1xuICBicm93c2VyaWZ5Tm9QYXJzZT86IGFueVtdO1xuICBpc0VudHJ5U2VydmVyVGVtcGxhdGU6IGJvb2xlYW47XG4gIHRyYW5zbGF0YWJsZTogc3RyaW5nO1xuICBkcjogYW55O1xuICBqc29uOiBhbnk7XG4gIGJyb3dzZXI6IHN0cmluZztcbiAgaXNWZW5kb3I6IGJvb2xlYW47XG4gIGFwcFR5cGU6IHN0cmluZztcbiAgY29tcGlsZXI/OiBhbnk7XG5cbiAgY29uc3RydWN0b3IoYXR0cnM6IGFueSkge1xuICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBQYWNrYWdlQnJvd3Nlckluc3RhbmNlKSkge1xuICAgICAgcmV0dXJuIG5ldyBQYWNrYWdlQnJvd3Nlckluc3RhbmNlKGF0dHJzKTtcbiAgICB9XG4gICAgaWYgKGF0dHJzKSB7XG4gICAgICB0aGlzLmluaXQoYXR0cnMpO1xuICAgIH1cbiAgfVxuICBpbml0KGF0dHJzOiB7W2tleSBpbiBrZXlvZiBQYWNrYWdlQnJvd3Nlckluc3RhbmNlXT86IFBhY2thZ2VCcm93c2VySW5zdGFuY2Vba2V5XX0pIHtcbiAgICBfLmFzc2lnbih0aGlzLCBhdHRycyk7XG4gICAgY29uc3QgcGFyc2VkTmFtZSA9IHRoaXMucGFyc2VkTmFtZTtcbiAgICBpZiAocGFyc2VkTmFtZSkge1xuICAgICAgdGhpcy5zaG9ydE5hbWUgPSBwYXJzZWROYW1lLm5hbWU7XG4gICAgICB0aGlzLnNjb3BlTmFtZSA9IHBhcnNlZE5hbWUuc2NvcGU7XG4gICAgfVxuICB9XG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnUGFja2FnZTogJyArIHRoaXMubG9uZ05hbWU7XG4gIH1cbn1cbmltcG9ydCAqIGFzIFBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQge0RpclRyZWV9IGZyb20gJ3JlcXVpcmUtaW5qZWN0b3IvZGlzdC9kaXItdHJlZSc7XG5jb25zdCBwYWNrYWdlVXRpbHMgPSByZXF1aXJlKCdkci1jb21wLXBhY2thZ2Uvd2ZoL2xpYi9wYWNrYWdlTWdyL3BhY2thZ2VVdGlscycpO1xuZXhwb3J0IGNsYXNzIExhenlQYWNrYWdlRmFjdG9yeSB7XG4gIHBhY2thZ2VQYXRoTWFwID0gbmV3IERpclRyZWU8UGFja2FnZUJyb3dzZXJJbnN0YW5jZT4oKTtcblxuICBnZXRQYWNrYWdlQnlQYXRoKGZpbGU6IHN0cmluZyk6IFBhY2thZ2VCcm93c2VySW5zdGFuY2UgfCBudWxsIHtcbiAgICBsZXQgY3VyclBhdGggPSBmaWxlO1xuICAgIGxldCBmb3VuZDogUGFja2FnZUJyb3dzZXJJbnN0YW5jZVtdO1xuICAgIGZvdW5kID0gdGhpcy5wYWNrYWdlUGF0aE1hcC5nZXRBbGxEYXRhKGZpbGUpO1xuICAgIGlmIChmb3VuZC5sZW5ndGggPiAwKVxuICAgICAgcmV0dXJuIGZvdW5kW2ZvdW5kLmxlbmd0aCAtIDFdO1xuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICBjb25zdCBkaXIgPSBQYXRoLmRpcm5hbWUoY3VyclBhdGgpO1xuICAgICAgaWYgKGRpciA9PT0gY3VyclBhdGgpXG4gICAgICAgIGJyZWFrOyAvLyBIYXMgcmVhY2hlZCByb290XG4gICAgICBpZiAoZnMuZXhpc3RzU3luYyhQYXRoLmpvaW4oZGlyLCAncGFja2FnZS5qc29uJykpKSB7XG4gICAgICAgIGNvbnN0IHBranNvbiA9IHJlcXVpcmUoUGF0aC5qb2luKGRpciwgJ3BhY2thZ2UuanNvbicpKTtcbiAgICAgICAgY29uc3QgcGsgPSBjcmVhdGVQYWNrYWdlKGRpciwgcGtqc29uKTtcbiAgICAgICAgdGhpcy5wYWNrYWdlUGF0aE1hcC5wdXREYXRhKGRpciwgcGspO1xuICAgICAgICByZXR1cm4gcGs7XG4gICAgICB9XG4gICAgICBjdXJyUGF0aCA9IGRpcjtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuZnVuY3Rpb24gY3JlYXRlUGFja2FnZShwYWNrYWdlUGF0aDogc3RyaW5nLCBwa0pzb246IGFueSkge1xuICBjb25zdCBuYW1lOiBzdHJpbmcgPSBwa0pzb24ubmFtZTtcbiAgY29uc3QgaW5zdGFuY2UgPSBuZXcgUGFja2FnZUJyb3dzZXJJbnN0YW5jZSh7XG4gICAgaXNWZW5kb3I6IGZhbHNlLFxuICAgIGJ1bmRsZTogbnVsbCxcbiAgICBsb25nTmFtZTogcGtKc29uLm5hbWUsXG4gICAgc2hvcnROYW1lOiBwYWNrYWdlVXRpbHMucGFyc2VOYW1lKHBrSnNvbi5uYW1lKS5uYW1lLFxuICAgIHBhY2thZ2VQYXRoLFxuICAgIHJlYWxQYWNrYWdlUGF0aDogZnMucmVhbHBhdGhTeW5jKHBhY2thZ2VQYXRoKVxuICB9KTtcbiAgbGV0IGVudHJ5Vmlld3M6IHN0cmluZ1tdIHwgdW5kZWZpbmVkLCBlbnRyeVBhZ2VzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgbGV0IGlzRW50cnlTZXJ2ZXJUZW1wbGF0ZSA9IHRydWU7XG4gIGxldCBub1BhcnNlRmlsZXM6IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xuICBpZiAocGtKc29uLmRyKSB7XG4gICAgaWYgKHBrSnNvbi5kci5lbnRyeVBhZ2UpIHtcbiAgICAgIGlzRW50cnlTZXJ2ZXJUZW1wbGF0ZSA9IGZhbHNlO1xuICAgICAgZW50cnlQYWdlcyA9IFtdLmNvbmNhdChwa0pzb24uZHIuZW50cnlQYWdlKTtcbiAgICB9IGVsc2UgaWYgKHBrSnNvbi5kci5lbnRyeVZpZXcpIHtcbiAgICAgIGlzRW50cnlTZXJ2ZXJUZW1wbGF0ZSA9IHRydWU7XG4gICAgICBlbnRyeVZpZXdzID0gW10uY29uY2F0KHBrSnNvbi5kci5lbnRyeVZpZXcpO1xuICAgIH1cbiAgICBpZiAocGtKc29uLmRyLm5vUGFyc2UpIHtcbiAgICAgIG5vUGFyc2VGaWxlcyA9IFtdLmNvbmNhdChwa0pzb24uZHIubm9QYXJzZSkubWFwKHRyaW1Ob1BhcnNlU2V0dGluZyk7XG4gICAgfVxuICAgIGlmIChwa0pzb24uZHIuYnJvd3NlcmlmeU5vUGFyc2UpIHtcbiAgICAgIG5vUGFyc2VGaWxlcyA9IFtdLmNvbmNhdChwa0pzb24uZHIuYnJvd3NlcmlmeU5vUGFyc2UpLm1hcCh0cmltTm9QYXJzZVNldHRpbmcpO1xuICAgIH1cbiAgfVxuICBjb25zdCBtYWluRmlsZTogc3RyaW5nID0gcGtKc29uLmJyb3dzZXIgfHwgcGtKc29uLm1haW47XG4gIGluc3RhbmNlLmluaXQoe1xuICAgIGZpbGU6IG1haW5GaWxlID8gZnMucmVhbHBhdGhTeW5jKFBhdGgucmVzb2x2ZShwYWNrYWdlUGF0aCwgbWFpbkZpbGUpKSA6IHVuZGVmaW5lZCwgLy8gcGFja2FnZS5qc29uIFwiYnJvd3NlclwiXG4gICAgbWFpbjogcGtKc29uLm1haW4sIC8vIHBhY2thZ2UuanNvbiBcIm1haW5cIlxuICAgIC8vIHN0eWxlOiBwa0pzb24uc3R5bGUgPyByZXNvbHZlU3R5bGUobmFtZSwgbm9kZVBhdGhzKSA6IG51bGwsXG4gICAgcGFyc2VkTmFtZTogcGFja2FnZVV0aWxzLnBhcnNlTmFtZShuYW1lKSxcbiAgICBlbnRyeVBhZ2VzLFxuICAgIGVudHJ5Vmlld3MsXG4gICAgYnJvd3NlcmlmeU5vUGFyc2U6IG5vUGFyc2VGaWxlcyxcbiAgICBpc0VudHJ5U2VydmVyVGVtcGxhdGUsXG4gICAgdHJhbnNsYXRhYmxlOiAhXy5oYXMocGtKc29uLCAnZHIudHJhbnNsYXRhYmxlJykgfHwgXy5nZXQocGtKc29uLCAnZHIudHJhbnNsYXRhYmxlJyksXG4gICAgZHI6IHBrSnNvbi5kcixcbiAgICBqc29uOiBwa0pzb24sXG4gICAgY29tcGlsZXI6IF8uZ2V0KHBrSnNvbiwgJ2RyLmNvbXBpbGVyJyksXG4gICAgYnJvd3NlcjogcGtKc29uLmJyb3dzZXIsXG4gICAgaTE4bjogcGtKc29uLmRyICYmIHBrSnNvbi5kci5pMThuID8gcGtKc29uLmRyLmkxOG4gOiBudWxsLFxuICAgIGFwcFR5cGU6IF8uZ2V0KHBrSnNvbiwgJ2RyLmFwcFR5cGUnKVxuICB9KTtcbiAgcmV0dXJuIGluc3RhbmNlO1xufVxuXG5mdW5jdGlvbiB0cmltTm9QYXJzZVNldHRpbmcocDogc3RyaW5nKSB7XG4gIHAgPSBwLnJlcGxhY2UoL1xcXFwvZywgJy8nKTtcbiAgaWYgKHAuc3RhcnRzV2l0aCgnLi8nKSkge1xuICAgIHAgPSBwLnN1YnN0cmluZygyKTtcbiAgfVxuICByZXR1cm4gcDtcbn1cbiJdfQ==