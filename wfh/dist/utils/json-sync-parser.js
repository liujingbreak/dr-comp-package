"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const LLn_parser_1 = require("../LLn-parser");
const lexer = function (strLookAhead, emitter) {
    let char = strLookAhead.la();
    if (char == null) {
        emitter.end();
        return;
    }
    if (/[{}\[\],:]/.test(char)) {
        strLookAhead.startChunk(char);
        strLookAhead.advance();
        emitter.emit();
    }
    else if (/\s/.test(char)) {
        do {
            strLookAhead.advance();
            char = strLookAhead.la();
        } while (char && /\s/.test(char));
    }
    else if (/["']/.test(char)) {
        strLookAhead.startChunk('stringLiteral');
        const openChar = strLookAhead.advance();
        while (true) {
            const la = strLookAhead.la();
            if (la == null) {
                return strLookAhead.throwError();
            }
            if (la === '\\') {
                strLookAhead.advance(2);
            }
            else if (la === openChar) {
                strLookAhead.advance();
                emitter.emit();
                return;
            }
            else {
                strLookAhead.advance();
            }
        }
    }
    else {
        strLookAhead.startChunk('other');
        let next;
        do {
            strLookAhead.advance();
            next = strLookAhead.la();
        } while (next != null && !/[{}\[\],:\s'"]/.test(next));
        emitter.emit();
    }
    char = strLookAhead.la();
};
var AstType;
(function (AstType) {
    AstType[AstType["object"] = 0] = "object";
    AstType[AstType["array"] = 1] = "array";
    AstType[AstType["property"] = 2] = "property";
    AstType[AstType["value"] = 3] = "value";
})(AstType || (AstType = {}));
const grammar = function (tokenLa) {
    return doObject(tokenLa);
};
function doObject(lexer) {
    const ast = {
        type: AstType.object,
        properties: []
    };
    const lp = lexer.advance();
    ast.start = lp.pos;
    let next = lexer.la();
    while (next != null && next.type !== '}') {
        const propToken = lexer.advance();
        const colon = lexer.advance();
        if (colon.type !== ':') {
            throw new Error(`Expect ':' but recieve '${colon.text}' at ${colon.line}:${colon.col}`);
        }
        ast.properties.push({ name: propToken, value: doValue(lexer) });
        next = lexer.la();
        if (next && next.type === ',')
            lexer.advance();
        next = lexer.la();
    }
    const rp = lexer.advance(); // }
    ast.end = rp.end;
    return ast;
}
function doArray(lexer) {
    const ast = {
        type: AstType.array,
        items: []
    };
    lexer.advance();
    let next = lexer.la();
    while (next != null && next.type !== ']') {
        if (next.type !== ',') {
            ast.items.push(doValue(lexer));
        }
        else {
            lexer.advance();
        }
        next = lexer.la();
    }
    if (next && next.type === ']')
        lexer.advance(); // ]
    else if (next == null)
        throw new Error('Unexpect EOF after ' + lexer.lastConsumed.text);
    else
        throw new Error(`Unexpect ${next.text} at ${next.line}:${next.col}`);
    return ast;
}
function doValue(lexer) {
    const next = lexer.la();
    if (next === null) {
        throw new Error('Unexpect EOF');
    }
    if (next.type === '{') {
        return doObject(lexer);
    }
    else if (next.type === '[') {
        return doArray(lexer);
    }
    else if (next.type === 'stringLiteral' || next.type === 'other') {
        return lexer.advance();
    }
    else {
        throw new Error(`Unexpect '${next.text}' at ${next.line}:${next.col}`);
    }
}
function parse(content) {
    const jsonParser = LLn_parser_1.parser('JSON', lexer, grammar);
    jsonParser.write(content);
    jsonParser.end();
    return jsonParser.getResult();
}
exports.default = parse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbi1zeW5jLXBhcnNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3RzL3V0aWxzL2pzb24tc3luYy1wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSw4Q0FBOEQ7QUFJOUQsTUFBTSxLQUFLLEdBQWlDLFVBQzFDLFlBQVksRUFBRSxPQUFPO0lBQ3JCLElBQUksSUFBSSxHQUFHLFlBQVksQ0FBQyxFQUFFLEVBQUUsQ0FBQztJQUM3QixJQUFJLElBQUksSUFBSSxJQUFJLEVBQUU7UUFDaEIsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2QsT0FBTztLQUNSO0lBQ0QsSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQzNCLFlBQVksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUIsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3ZCLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztLQUNoQjtTQUFNLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUMxQixHQUFHO1lBQ0QsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3ZCLElBQUksR0FBRyxZQUFZLENBQUMsRUFBRSxFQUFFLENBQUM7U0FDMUIsUUFBUSxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtLQUNuQztTQUFNLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUM1QixZQUFZLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN4QyxPQUFPLElBQUksRUFBRTtZQUNYLE1BQU0sRUFBRSxHQUFHLFlBQVksQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUM3QixJQUFJLEVBQUUsSUFBSSxJQUFJLEVBQUU7Z0JBQ2QsT0FBTyxZQUFZLENB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Q3JCLE9BQU8sUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3hCO1NBQU0sSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLEdBQUcsRUFBRTtRQUM1QixPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztLQUN2QjtTQUFNLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxlQUFlLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUU7UUFDakUsT0FBTyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7S0FDeEI7U0FBTTtRQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsYUFBYSxJQUFJLENBQUMsSUFBSSxRQUFRLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7S0FDeEU7QUFDSCxDQUFDO0FBRUQsU0FBd0IsS0FBSyxDQUFDLE9BQWU7SUFDM0MsTUFBTSxVQUFVLEdBQUcsbUJBQU0sQ0FDdkIsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMxQixVQUFVLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzFCLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUNqQixPQUFPLFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztBQUNoQyxDQUFDO0FBTkQsd0JBTUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IENodW5rLCBHcmFtbWFyLCBMZXhlciwgcGFyc2VyIH0gZnJvbSAnLi4vTExuLXBhcnNlcic7XG5cbmV4cG9ydCB0eXBlIFRva2VuID0gQ2h1bms8c3RyaW5nLCBzdHJpbmc+ICYge3RleHQ6IHN0cmluZ307XG5cbmNvbnN0IGxleGVyOiBMZXhlcjxzdHJpbmcsIHN0cmluZywgVG9rZW4+ID0gZnVuY3Rpb24oXG4gIHN0ckxvb2tBaGVhZCwgZW1pdHRlcikge1xuICBsZXQgY2hhciA9IHN0ckxvb2tBaGVhZC5sYSgpO1xuICBpZiAoY2hhciA9PSBudWxsKSB7XG4gICAgZW1pdHRlci5lbmQoKTtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKC9be31cXFtcXF0sOl0vLnRlc3QoY2hhcikpIHtcbiAgICBzdHJMb29rQWhlYWQuc3RhcnRDaHVuayhjaGFyKTtcbiAgICBzdHJMb29rQWhlYWQuYWR2YW5jZSgpO1xuICAgIGVtaXR0ZXIuZW1pdCgpO1xuICB9IGVsc2UgaWYgKC9cXHMvLnRlc3QoY2hhcikpIHtcbiAgICBkbyB7XG4gICAgICBzdHJMb29rQWhlYWQuYWR2YW5jZSgpO1xuICAgICAgY2hhciA9IHN0ckxvb2tBaGVhZC5sYSgpO1xuICAgIH0gd2hpbGUgKGNoYXIgJiYgL1xccy8udGVzdChjaGFyKSk7XG4gIH0gZWxzZSBpZiAoL1tcIiddLy50ZXN0KGNoYXIpKSB7XG4gICAgc3RyTG9va0FoZWFkLnN0YXJ0Q2h1bmsoJ3N0cmluZ0xpdGVyYWwnKTtcbiAgICBjb25zdCBvcGVuQ2hhciA9IHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIGNvbnN0IGxhID0gc3RyTG9va0FoZWFkLmxhKCk7XG4gICAgICBpZiAobGEgPT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gc3RyTG9va0FoZWFkLnRocm93RXJyb3IoKTtcbiAgICAgIH1cbiAgICAgIGlmIChsYSA9PT0gJ1xcXFwnKSB7XG4gICAgICAgIHN0ckxvb2tBaGVhZC5hZHZhbmNlKDIpO1xuICAgICAgfSBlbHNlIGlmIChsYSA9PT0gb3BlbkNoYXIpIHtcbiAgICAgICAgc3RyTG9va0FoZWFkLmFkdmFuY2UoKTtcbiAgICAgICAgZW1pdHRlci5lbWl0KCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHN0ckxvb2tBaGVhZC5zdGFydENodW5rKCdvdGhlcicpO1xuICAgIGxldCBuZXh0OiBzdHJpbmcgfCBudWxsO1xuICAgIGRvIHtcbiAgICAgIHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgICBuZXh0ID0gc3RyTG9va0FoZWFkLmxhKCk7XG4gICAgfSB3aGlsZSAobmV4dCAhPSBudWxsICYmICEvW3t9XFxbXFxdLDpcXHMnXCJdLy50ZXN0KG5leHQpKTtcbiAgICBlbWl0dGVyLmVtaXQoKTtcbiAgfVxuICBjaGFyID0gc3RyTG9va0FoZWFkLmxhKCk7XG59O1xuXG5lbnVtIEFzdFR5cGUge1xuICBvYmplY3QgPSAwLFxuICBhcnJheSxcbiAgcHJvcGVydHksXG4gIHZhbHVlXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXN0IHtcbiAgdHlwZTogQXN0VHlwZTtcbiAgc3RhcnQ/OiBudW1iZXI7XG4gIGVuZD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBPYmplY3RBc3QgZXh0ZW5kcyBBc3Qge1xuICBwcm9wZXJ0aWVzOiB7bmFtZTogVG9rZW4sIHZhbHVlOiBBc3R8VG9rZW59W107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXJyYXlBc3QgZXh0ZW5kcyBBc3Qge1xuICBpdGVtczogQXJyYXk8QXN0IHwgVG9rZW4+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFZhbHVlQXN0IGV4dGVuZHMgQXN0IHtcbiAgdmFsdWU6IFRva2VuO1xufVxuXG5jb25zdCBncmFtbWFyOiBHcmFtbWFyPFRva2VuLCBPYmplY3RBc3Q+ID0gZnVuY3Rpb24odG9rZW5MYSkge1xuICByZXR1cm4gZG9PYmplY3QodG9rZW5MYSk7XG59O1xuXG5mdW5jdGlvbiBkb09iamVjdChsZXhlcjogUGFyYW1ldGVyczxHcmFtbWFyPFRva2VuLCBPYmplY3RBc3Q+PlswXSk6IE9iamVjdEFzdCB7XG4gIGNvbnN0IGFzdDogT2JqZWN0QXN0ID0ge1xuICAgIHR5cGU6IEFzdFR5cGUub2JqZWN0LFxuICAgIHByb3BlcnRpZXM6IFtdXG4gIH07XG4gIGNvbnN0IGxwID0gbGV4ZXIuYWR2YW5jZSgpO1xuICBhc3Quc3RhcnQgPSBscC5wb3M7XG4gIGxldCBuZXh0ID0gbGV4ZXIubGEoKTtcbiAgd2hpbGUgKG5leHQgIT0gbnVsbCAmJiBuZXh0LnR5cGUgIT09ICd9Jykge1xuICAgIGNvbnN0IHByb3BUb2tlbiA9IGxleGVyLmFkdmFuY2UoKTtcbiAgICBjb25zdCBjb2xvbiA9IGxleGVyLmFkdmFuY2UoKTtcbiAgICBpZiAoY29sb24udHlwZSAhPT0gJzonKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdCAnOicgYnV0IHJlY2lldmUgJyR7Y29sb24udGV4dH0nIGF0ICR7Y29sb24ubGluZX06JHtjb2xvbi5jb2x9YCk7XG4gICAgfVxuXG4gICAgYXN0LnByb3BlcnRpZXMucHVzaCh7bmFtZTogcHJvcFRva2VuLCB2YWx1ZTogZG9WYWx1ZShsZXhlcil9KTtcbiAgICBuZXh0ID0gbGV4ZXIubGEoKTtcbiAgICBpZiAobmV4dCAmJiBuZXh0LnR5cGUgPT09ICcsJylcbiAgICAgIGxleGVyLmFkdmFuY2UoKTtcbiAgICBuZXh0ID0gbGV4ZXIubGEoKTtcbiAgfVxuICBjb25zdCBycCA9IGxleGVyLmFkdmFuY2UoKTsgLy8gfVxuICBhc3QuZW5kID0gcnAuZW5kO1xuICByZXR1cm4gYXN0O1xufVxuXG5mdW5jdGlvbiBkb0FycmF5KGxleGVyOiBQYXJhbWV0ZXJzPEdyYW1tYXI8VG9rZW4sIE9iamVjdEFzdD4+WzBdKTogQXJyYXlBc3Qge1xuICBjb25zdCBhc3Q6IEFycmF5QXN0ID0ge1xuICAgIHR5cGU6IEFzdFR5cGUuYXJyYXksXG4gICAgaXRlbXM6IFtdXG4gIH07XG4gIGxleGVyLmFkdmFuY2UoKTtcbiAgbGV0IG5leHQgPSBsZXhlci5sYSgpO1xuICB3aGlsZSAobmV4dCAhPSBudWxsICYmIG5leHQudHlwZSAhPT0gJ10nKSB7XG5cbiAgICBpZiAobmV4dC50eXBlICE9PSAnLCcpIHtcbiAgICAgIGFzdC5pdGVtcy5wdXNoKGRvVmFsdWUobGV4ZXIpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV4ZXIuYWR2YW5jZSgpO1xuICAgIH1cbiAgICBuZXh0ID0gbGV4ZXIubGEoKTtcbiAgfVxuICBpZiAobmV4dCAmJiBuZXh0LnR5cGUgPT09ICddJylcbiAgICBsZXhlci5hZHZhbmNlKCk7IC8vIF1cbiAgZWxzZSBpZiAobmV4dCA9PSBudWxsKVxuICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3QgRU9GIGFmdGVyICcgKyBsZXhlci5sYXN0Q29uc3VtZWQhLnRleHQpO1xuICBlbHNlXG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdCAke25leHQudGV4dH0gYXQgJHtuZXh0LmxpbmV9OiR7bmV4dC5jb2x9YCk7XG4gIHJldHVybiBhc3Q7XG59XG5cbmZ1bmN0aW9uIGRvVmFsdWUobGV4ZXI6IFBhcmFtZXRlcnM8R3JhbW1hcjxUb2tlbiwgT2JqZWN0QXN0Pj5bMF0pIHtcbiAgY29uc3QgbmV4dCA9IGxleGVyLmxhKCk7XG4gIGlmIChuZXh0ID09PSBudWxsKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdVbmV4cGVjdCBFT0YnKTtcbiAgfVxuICBpZiAobmV4dC50eXBlID09PSAneycpIHtcbiAgICByZXR1cm4gZG9PYmplY3QobGV4ZXIpO1xuICB9IGVsc2UgaWYgKG5leHQudHlwZSA9PT0gJ1snKSB7XG4gICAgcmV0dXJuIGRvQXJyYXkobGV4ZXIpO1xuICB9IGVsc2UgaWYgKG5leHQudHlwZSA9PT0gJ3N0cmluZ0xpdGVyYWwnIHx8IG5leHQudHlwZSA9PT0gJ290aGVyJykge1xuICAgIHJldHVybiBsZXhlci5hZHZhbmNlKCk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdCAnJHtuZXh0LnRleHR9JyBhdCAke25leHQubGluZX06JHtuZXh0LmNvbH1gKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBwYXJzZShjb250ZW50OiBzdHJpbmcpIHtcbiAgY29uc3QganNvblBhcnNlciA9IHBhcnNlcjxzdHJpbmcsIHN0cmluZywgVG9rZW4sIE9iamVjdEFzdD4oXG4gICAgJ0pTT04nLCBsZXhlciwgZ3JhbW1hcik7XG4gIGpzb25QYXJzZXIud3JpdGUoY29udGVudCk7XG4gIGpzb25QYXJzZXIuZW5kKCk7XG4gIHJldHVybiBqc29uUGFyc2VyLmdldFJlc3VsdCgpO1xufVxuIl19