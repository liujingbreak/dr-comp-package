"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const LLn_parser_1 = require("../LLn-parser");
exports.Token = LLn_parser_1.Token;
function parse(content, onToken) {
    const operators = onToken ? [operators_1.tap(onToken)] : null;
    // from([content.split('')]).pipe(observeOn(queueScheduler)).subscribe(s => console.log(s));
    return LLn_parser_1.parser('JSON', rxjs_1.from([content.split('')]), parseLex, operators, parseGrammar);
}
exports.default = parse;
function parseLex(strLookAhead) {
    let char = strLookAhead.la();
    while (char != null) {
        if (/[{}\[\],:]/.test(char)) {
            strLookAhead.startToken(char);
            strLookAhead.advance();
            strLookAhead.emitToken();
        }
        else if (/\s/.test(char)) {
            do {
                strLookAhead.advance();
                char = strLookAhead.la();
            } while (char && /\s/.test(char));
        }
        else if (/["']/.test(char)) {
            strLookAhead.startToken('stringLiteral');
            const openChar = strLookAhead.advance();
            while (true) {
                const la = strLookAhead.la();
                if (la == null) {
                    return strLookAhead.throwError();
                }
                if (la === '\\') {
                    strLookAhead.advance(2);
                }
                else if (la === openChar) {
                    strLookAhead.advance();
                    strLookAhead.emitToken();
                    break;
                }
                else {
                    strLookAhead.advance();
                }
            }
        }
        else {
            strLookAhead.startToken('other');
            let next;
            do {
                strLookAhead.advance();
                next = strLookAhead.la();
            } while (next != null && !/[{}\[\],:\s'"]/.test(next));
            strLookAhead.emitToken();
        }
        char = strLookAhead.la();
    }
}
var AstType;
(function (AstType) {
    AstType[AstType["object"] = 0] = "object";
    AstType[AstType["array"] = 1] = "array";
    AstType[AstType["property"] = 2] = "property";
    AstType[AstType["value"] = 3] = "value";
})(AstType || (AstType = {}));
function parseGrammar(tokenLa) {
    return doObject(tokenLa);
}
function doObject(lexer) {
    const ast = {
        type: AstType.object,
        properties: []
    };
    lexer.advance();
    let next = lexer.la();
    while (next != null && next.type !== '}') {
        const propToken = lexer.advance();
        const colon = lexer.advance();
        if (colon.type !== ':') {
            throw new Error(`Expect ':' but recieve '${colon.text}' at ${colon.line}:${colon.col}`);
        }
        ast.properties.push({ name: propToken, value: doValue(lexer) });
        next = lexer.la();
        if (next && next.type === ',')
            lexer.advance();
        next = lexer.la();
    }
    lexer.advance(); // }
    return ast;
}
function doArray(lexer) {
    const ast = {
        type: AstType.array,
        items: []
    };
    lexer.advance();
    let next = lexer.la();
    while (next != null && next.type !== ']') {
        if (next.type !== ',') {
            ast.items.push(doValue(lexer));
        }
        next = lexer.la();
    }
    if (next && next.type === ']')
        lexer.advance(); // ]
    else if (next == null)
        throw new Error('Unexpect EOF after ' + lexer.lastConsumed.text);
    else
        throw new Error(`Unexpect ${next.text} at ${next.line}:${next.col}`);
    return ast;
}
function doValue(lexer) {
    const next = lexer.la();
    if (next === null) {
        throw new Error('Unexpect EOF');
    }
    if (next.type === '{') {
        return doObject(lexer);
    }
    else if (next.type === '[') {
        return doArray(lexer);
    }
    else if (next.type === 'stringLiteral' || next.type === 'other') {
        return lexer.advance();
    }
    else {
        throw new Error(`Unexpect '${next.text}' at ${next.line}:${next.col}`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbi1zeW5jLXBhcnNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3RzL3V0aWxzL2pzb24tc3luYy1wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSwrQkFBNEI7QUFDNUIsOENBQXFDO0FBQ3JDLDhDQUE4RTtBQVNyRSxnQkFUd0Msa0JBQUssQ0FTeEM7QUFQZCxTQUF3QixLQUFLLENBQUMsT0FBZSxFQUFFLE9BQXdDO0lBQ3JGLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxlQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBRWxELDRGQUE0RjtJQUM1RixPQUFPLG1CQUFNLENBQUMsTUFBTSxFQUFFLFdBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7QUFDdEYsQ0FBQztBQUxELHdCQUtDO0FBSUQsU0FBUyxRQUFRLENBQ2YsWUFBaUQ7SUFDakQsSUFBSSxJQUFJLEdBQUcsWUFBWSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQzdCLE9BQU8sSUFBSSxJQUFJLElBQUksRUFBRTtRQUNuQixJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDM0IsWUFBWSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM5QixZQUFZLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDdkIsWUFBWSxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQzFCO2FBQU0sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzFCLEdBQUc7Z0JBQ0QsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUN2QixJQUFJLEdBQUcsWUFBWSxDQUFDLEVBQUUsRUFBRSxDQUFDO2FBQzFCLFFBQVEsSUFBSSxJQUFJLElB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QUN4QixJQUFJLElBQUksS0FBSyxJQUFJLEVBQUU7UUFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQztLQUNqQztJQUNELElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxHQUFHLEVBQUU7UUFDckIsT0FBTyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7S0FDeEI7U0FBTSxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssR0FBRyxFQUFFO1FBQzVCLE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3ZCO1NBQU0sSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLGVBQWUsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRTtRQUNqRSxPQUFPLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztLQUN4QjtTQUFNO1FBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLElBQUksQ0FBQyxJQUFJLFFBQVEsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztLQUN4RTtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IGZyb20gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IExvb2tBaGVhZCwgTG9va0FoZWFkT2JzZXJ2YWJsZSwgcGFyc2VyLCBUb2tlbiB9IGZyb20gJy4uL0xMbi1wYXJzZXInO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBwYXJzZShjb250ZW50OiBzdHJpbmcsIG9uVG9rZW4/OiAodG9rZW46IFRva2VuPHN0cmluZz4pID0+IHZvaWQpIHtcbiAgY29uc3Qgb3BlcmF0b3JzID0gb25Ub2tlbiA/IFt0YXAob25Ub2tlbildIDogbnVsbDtcblxuICAvLyBmcm9tKFtjb250ZW50LnNwbGl0KCcnKV0pLnBpcGUob2JzZXJ2ZU9uKHF1ZXVlU2NoZWR1bGVyKSkuc3Vic2NyaWJlKHMgPT4gY29uc29sZS5sb2cocykpO1xuICByZXR1cm4gcGFyc2VyKCdKU09OJywgZnJvbShbY29udGVudC5zcGxpdCgnJyldKSwgcGFyc2VMZXgsIG9wZXJhdG9ycywgcGFyc2VHcmFtbWFyKTtcbn1cblxuZXhwb3J0IHsgVG9rZW4gfTtcblxuZnVuY3Rpb24gcGFyc2VMZXgoXG4gIHN0ckxvb2tBaGVhZDogTG9va0FoZWFkT2JzZXJ2YWJsZTxzdHJpbmcsIHN0cmluZz4pIHtcbiAgbGV0IGNoYXIgPSBzdHJMb29rQWhlYWQubGEoKTtcbiAgd2hpbGUgKGNoYXIgIT0gbnVsbCkge1xuICAgIGlmICgvW3t9XFxbXFxdLDpdLy50ZXN0KGNoYXIpKSB7XG4gICAgICBzdHJMb29rQWhlYWQuc3RhcnRUb2tlbihjaGFyKTtcbiAgICAgIHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgICBzdHJMb29rQWhlYWQuZW1pdFRva2VuKCk7XG4gICAgfSBlbHNlIGlmICgvXFxzLy50ZXN0KGNoYXIpKSB7XG4gICAgICBkbyB7XG4gICAgICAgIHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgICAgIGNoYXIgPSBzdHJMb29rQWhlYWQubGEoKTtcbiAgICAgIH0gd2hpbGUgKGNoYXIgJiYgL1xccy8udGVzdChjaGFyKSk7XG4gICAgfSBlbHNlIGlmICgvW1wiJ10vLnRlc3QoY2hhcikpIHtcbiAgICAgIHN0ckxvb2tBaGVhZC5zdGFydFRva2VuKCdzdHJpbmdMaXRlcmFsJyk7XG4gICAgICBjb25zdCBvcGVuQ2hhciA9IHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICBjb25zdCBsYSA9IHN0ckxvb2tBaGVhZC5sYSgpO1xuICAgICAgICBpZiAobGEgPT0gbnVsbCkge1xuICAgICAgICAgIHJldHVybiBzdHJMb29rQWhlYWQudGhyb3dFcnJvcigpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChsYSA9PT0gJ1xcXFwnKSB7XG4gICAgICAgICAgc3RyTG9va0FoZWFkLmFkdmFuY2UoMik7XG4gICAgICAgIH0gZWxzZSBpZiAobGEgPT09IG9wZW5DaGFyKSB7XG4gICAgICAgICAgc3RyTG9va0FoZWFkLmFkdmFuY2UoKTtcbiAgICAgICAgICBzdHJMb29rQWhlYWQuZW1pdFRva2VuKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc3RyTG9va0FoZWFkLmFkdmFuY2UoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBzdHJMb29rQWhlYWQuc3RhcnRUb2tlbignb3RoZXInKTtcbiAgICAgIGxldCBuZXh0OiBzdHJpbmcgfCBudWxsO1xuICAgICAgZG8ge1xuICAgICAgICBzdHJMb29rQWhlYWQuYWR2YW5jZSgpO1xuICAgICAgICBuZXh0ID0gc3RyTG9va0FoZWFkLmxhKCk7XG4gICAgICB9IHdoaWxlIChuZXh0ICE9IG51bGwgJiYgIS9be31cXFtcXF0sOlxccydcIl0vLnRlc3QobmV4dCkpO1xuICAgICAgc3RyTG9va0FoZWFkLmVtaXRUb2tlbigpO1xuICAgIH1cbiAgICBjaGFyID0gc3RyTG9va0FoZWFkLmxhKCk7XG4gIH1cbn1cblxudHlwZSBMZXhlciA9IExvb2tBaGVhZDxUb2tlbjxzdHJpbmc+LCBzdHJpbmc+O1xuXG5lbnVtIEFzdFR5cGUge1xuICBvYmplY3QgPSAwLFxuICBhcnJheSxcbiAgcHJvcGVydHksXG4gIHZhbHVlXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXN0IHtcbiAgdHlwZTogQXN0VHlwZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBPYmplY3RBc3QgZXh0ZW5kcyBBc3Qge1xuICBwcm9wZXJ0aWVzOiB7bmFtZTogVG9rZW48c3RyaW5nPiwgdmFsdWU6IEFzdHxUb2tlbjxzdHJpbmc+fVtdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFycmF5QXN0IGV4dGVuZHMgQXN0IHtcbiAgaXRlbXM6IEFycmF5PEFzdCB8IFRva2VuPHN0cmluZz4+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFZhbHVlQXN0IGV4dGVuZHMgQXN0IHtcbiAgdmFsdWU6IFRva2VuPHN0cmluZz47XG59XG5cbmZ1bmN0aW9uIHBhcnNlR3JhbW1hcih0b2tlbkxhOiBMZXhlcikge1xuICByZXR1cm4gZG9PYmplY3QodG9rZW5MYSk7XG59XG5cbmZ1bmN0aW9uIGRvT2JqZWN0KGxleGVyOiBMZXhlcik6IE9iamVjdEFzdCB7XG4gIGNvbnN0IGFzdDogT2JqZWN0QXN0ID0ge1xuICAgIHR5cGU6IEFzdFR5cGUub2JqZWN0LFxuICAgIHByb3BlcnRpZXM6IFtdXG4gIH07XG4gIGxleGVyLmFkdmFuY2UoKTtcbiAgbGV0IG5leHQgPSBsZXhlci5sYSgpO1xuICB3aGlsZSAobmV4dCAhPSBudWxsICYmIG5leHQudHlwZSAhPT0gJ30nKSB7XG4gICAgY29uc3QgcHJvcFRva2VuID0gbGV4ZXIuYWR2YW5jZSgpO1xuICAgIGNvbnN0IGNvbG9uID0gbGV4ZXIuYWR2YW5jZSgpO1xuICAgIGlmIChjb2xvbi50eXBlICE9PSAnOicpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ICc6JyBidXQgcmVjaWV2ZSAnJHtjb2xvbi50ZXh0fScgYXQgJHtjb2xvbi5saW5lfToke2NvbG9uLmNvbH1gKTtcbiAgICB9XG5cbiAgICBhc3QucHJvcGVydGllcy5wdXNoKHtuYW1lOiBwcm9wVG9rZW4sIHZhbHVlOiBkb1ZhbHVlKGxleGVyKX0pO1xuICAgIG5leHQgPSBsZXhlci5sYSgpO1xuICAgIGlmIChuZXh0ICYmIG5leHQudHlwZSA9PT0gJywnKVxuICAgICAgbGV4ZXIuYWR2YW5jZSgpO1xuICAgIG5leHQgPSBsZXhlci5sYSgpO1xuICB9XG4gIGxleGVyLmFkdmFuY2UoKTsgLy8gfVxuICByZXR1cm4gYXN0O1xufVxuXG5mdW5jdGlvbiBkb0FycmF5KGxleGVyOiBMZXhlcik6IEFycmF5QXN0IHtcbiAgY29uc3QgYXN0OiBBcnJheUFzdCA9IHtcbiAgICB0eXBlOiBBc3RUeXBlLmFycmF5LFxuICAgIGl0ZW1zOiBbXVxuICB9O1xuICBsZXhlci5hZHZhbmNlKCk7XG4gIGxldCBuZXh0ID0gbGV4ZXIubGEoKTtcbiAgd2hpbGUgKG5leHQgIT0gbnVsbCAmJiBuZXh0LnR5cGUgIT09ICddJykge1xuICAgIGlmIChuZXh0LnR5cGUgIT09ICcsJykge1xuICAgICAgYXN0Lml0ZW1zLnB1c2goZG9WYWx1ZShsZXhlcikpO1xuICAgIH1cbiAgICBuZXh0ID0gbGV4ZXIubGEoKTtcbiAgfVxuICBpZiAobmV4dCAmJiBuZXh0LnR5cGUgPT09ICddJylcbiAgICBsZXhlci5hZHZhbmNlKCk7IC8vIF1cbiAgZWxzZSBpZiAobmV4dCA9PSBudWxsKVxuICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3QgRU9GIGFmdGVyICcgKyBsZXhlci5sYXN0Q29uc3VtZWQhLnRleHQpO1xuICBlbHNlXG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdCAke25leHQudGV4dH0gYXQgJHtuZXh0LmxpbmV9OiR7bmV4dC5jb2x9YCk7XG4gIHJldHVybiBhc3Q7XG59XG5cbmZ1bmN0aW9uIGRvVmFsdWUobGV4ZXI6IExleGVyKSB7XG4gIGNvbnN0IG5leHQgPSBsZXhlci5sYSgpO1xuICBpZiAobmV4dCA9PT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3QgRU9GJyk7XG4gIH1cbiAgaWYgKG5leHQudHlwZSA9PT0gJ3snKSB7XG4gICAgcmV0dXJuIGRvT2JqZWN0KGxleGVyKTtcbiAgfSBlbHNlIGlmIChuZXh0LnR5cGUgPT09ICdbJykge1xuICAgIHJldHVybiBkb0FycmF5KGxleGVyKTtcbiAgfSBlbHNlIGlmIChuZXh0LnR5cGUgPT09ICdzdHJpbmdMaXRlcmFsJyB8fCBuZXh0LnR5cGUgPT09ICdvdGhlcicpIHtcbiAgICByZXR1cm4gbGV4ZXIuYWR2YW5jZSgpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3QgJyR7bmV4dC50ZXh0fScgYXQgJHtuZXh0LmxpbmV9OiR7bmV4dC5jb2x9YCk7XG4gIH1cbn1cbiJdfQ==