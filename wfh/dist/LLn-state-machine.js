"use strict";
// export type StateHandler<V> = (machine: LLStateMachine<V>) => void;
Object.defineProperty(exports, "__esModule", { value: true });
class LLStateMachine {
    constructor(firstHandler) {
        this.debugOn = false;
        this.stack = [];
        this.cache = [];
        this.position = 0;
        this.line = 1;
        this.column = 1;
        this.switchDone = Promise.resolve();
        this.cacheReadIdx = 0;
        this.stack.push(firstHandler);
    }
    consume() {
        this.cache.splice(0, this.cacheReadIdx + 1); // Only keep the last one
        this.cacheReadIdx = -1;
    }
    /**
     * Reset to the position after last consumed
     */
    reset() {
        if (this.currChunk && !this.currChunk.isClosed) {
            const resetCnt = this.cacheReadIdx + 1;
            this.currChunk.values.splice(this.currChunk.values.length - resetCnt, resetCnt);
        }
        this.cacheReadIdx = -1;
    }
    push(handler) {
        this.stack.push(handler);
    }
    /**
     * popup current machine from stack, next time it will go to last machine.
     */
    pop() {
        this.stack.pop();
    }
    startChunk(type) {
        if (this.currChunk)
            this.currChunk.close();
        this.currChunk = new Chunk(type, this).open();
        return this.currChunk;
    }
    closeChunk() {
        return this.currChunk.close();
    }
    onNext(values) {
        this.cache.push(...values);
        const switchState = () => {
            this.switchDone = this.switchDone
                .then(() => {
                if (this.cacheReadIdx < this.cache.length) {
                    const value = this.cache[this.cacheReadIdx];
                    if (this.currChunk)
                        this.currChunk.values.push(value);
                    return this.callHandler(value)
                        .then(() => {
                        this.cacheReadIdx++;
                        this.position++;
                        this.column++;
                        if (value === '\n') {
                            this.line++;
                            this.column = 1;
                        }
                        switchState();
                    });
                }
            });
        };
        switchState();
    }
    done() {
        return this.switchDone;
    }
    callHandler(value) {
        const currHandler = this.stack[this.stack.length - 1];
        return Promise.resolve(currHandler.handle(this, value));
    }
}
exports.LLStateMachine = LLStateMachine;
class Chunk {
    constructor(type, machine) {
        this.type = type;
        this.machine = machine;
        this.values = [];
        this.isClosed = false;
    }
    open() {
        this.start = {
            pos: this.machine.position,
            line: this.machine.line,
            column: this.machine.column
        };
        return this;
    }
    close() {
        this.isClosed = true;
        this.end = this.machine.position + 1;
        return this;
    }
    toString() {
        return JSON.stringify({ start: this.start, end: this.end, value: this.values });
    }
}
exports.Chunk = Chunk;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTExuLXN0YXRlLW1hY2hpbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi90cy9MTG4tc3RhdGUtbWFjaGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0Esc0VBQXNFOztBQVF0RSxNQUFhLGNBQWM7SUFZekIsWUFBWSxZQUE2QjtRQVh6QyxZQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ2hCLFVBQUssR0FBc0IsRUFBRSxDQUFDO1FBQzlCLFVBQUssR0FBUSxFQUFFLENBQUM7UUFFaEIsYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLFNBQUksR0FBRyxDQUFDLENBQUM7UUFDVCxXQUFNLEdBQUcsQ0FBQyxDQUFDO1FBRUgsZUFBVSxHQUFHLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUMvQixpQkFBWSxHQUFHLENBQUMsQ0FBQztRQUd2QixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRUQsT0FBTztRQUNMLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMseUJBQXlCO1FBQ3RFLElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSztRQUNILElBQUksSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFO1lBQzlDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQ2pGO1FBQ0QsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRUQsSUFBSSxDQUFDLE9BQXdCO1FBQzNCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFRDs7T0FFRztJQUNILEdBQUc7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFFRCxVQUFVLENBQUksSUFBTztRQUNuQixJQUFJLElBQUksQ0FBQyxTQUFTO1lBQ2hCLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDekIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEtBQUssQ0FBTyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDcEQsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxVQUFVO1FBQ1IsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2hDLENBQUM7SUFFRCxNQUFNLENBQUMsTUFBVztRQUNoQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO1FBRTNCLE1BQU0sV0FBVyxHQUFHLEdBQUcsRUFBRTtZQUN2QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVO2lCQUNoQyxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUNULElBQUksSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRTtvQkFDekMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBQzVDLElBQUksSUFBSSxDQUFDLFNBQVM7d0JBQ2hCLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDcEMsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQzt5QkFDM0IsSUFBSSxDQUFDLEdBQUcsRUFBRTt3QkFDVCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7d0JBQ3BCLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQzt3QkFDaEIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO3dCQUNkLElBQUssS0FBYSxLQUFLLElBQUksRUFBRTs0QkFDM0IsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDOzRCQUNaLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO3lCQUNqQjt3QkFDRCxXQUFXLEVBQUUsQ0FBQztvQkFDaEIsQ0FBQyxDQUFDLENBQUM7aUJBQ047WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQztRQUNGLFdBQVcsRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxJQUFJO1FBQ0YsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQ3pCLENBQUM7SUFFTyxXQUFXLENBQUMsS0FBUTtRQUMxQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3RELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQzFELENBQUM7Q0FDRjtBQXpGRCx3Q0F5RkM7QUFFRCxNQUFhLEtBQUs7SUFNaEIsWUFBbUIsSUFBTyxFQUFVLE9BQTBCO1FBQTNDLFNBQUksR0FBSixJQUFJLENBQUc7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFtQjtRQUw5RCxXQUFNLEdBQVEsRUFBRSxDQUFDO1FBR2pCLGFBQVEsR0FBRyxLQUFLLENBQUM7SUFFZ0QsQ0FBQztJQUVsRSxJQUFJO1FBQ0YsSUFBSSxDQUFDLEtBQUssR0FBRztZQUNYLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVE7WUFDMUIsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSTtZQUN2QixNQUFNLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNO1NBQzVCLENBQUM7UUFDRixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxLQUFLO1FBQ0gsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDckMsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFDLENBQUMsQ0FBQztJQUNoRixDQUFDO0NBQ0Y7QUExQkQsc0JBMEJDIiwic291cmNlc0NvbnRlbnQiOlsiXG4vLyBleHBvcnQgdHlwZSBTdGF0ZUhhbmRsZXI8Vj4gPSAobWFjaGluZTogTExTdGF0ZU1hY2hpbmU8Vj4pID0+IHZvaWQ7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RhdGVIYW5kbGVyPFY+IHtcbiAgbmFtZT86IHN0cmluZztcbiAgaGFuZGxlKG1hY2hpbmU6IExMU3RhdGVNYWNoaW5lPFY+LCB2YWx1ZTogVik6IFByb21pc2U8YW55PiB8IGFueTtcbiAgW3N0YXRlTmFtZTogc3RyaW5nXTogYW55O1xufVxuXG5leHBvcnQgY2xhc3MgTExTdGF0ZU1hY2hpbmU8Vj4ge1xuICBkZWJ1Z09uID0gZmFsc2U7XG4gIHN0YWNrOiBTdGF0ZUhhbmRsZXI8Vj5bXSA9IFtdO1xuICBjYWNoZTogVltdID0gW107XG4gIGN1cnJWYWx1ZTogVjtcbiAgcG9zaXRpb24gPSAwO1xuICBsaW5lID0gMTtcbiAgY29sdW1uID0gMTtcbiAgcHJpdmF0ZSBjdXJyQ2h1bms6IENodW5rPFYsIGFueT47XG4gIHByaXZhdGUgc3dpdGNoRG9uZSA9IFByb21pc2UucmVzb2x2ZSgpO1xuICBwcml2YXRlIGNhY2hlUmVhZElkeCA9IDA7XG5cbiAgY29uc3RydWN0b3IoZmlyc3RIYW5kbGVyOiBTdGF0ZUhhbmRsZXI8Vj4pIHtcbiAgICB0aGlzLnN0YWNrLnB1c2goZmlyc3RIYW5kbGVyKTtcbiAgfVxuXG4gIGNvbnN1bWUoKSB7XG4gICAgdGhpcy5jYWNoZS5zcGxpY2UoMCwgdGhpcy5jYWNoZVJlYWRJZHggKyAxKTsgLy8gT25seSBrZWVwIHRoZSBsYXN0IG9uZVxuICAgIHRoaXMuY2FjaGVSZWFkSWR4ID0gLTE7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXQgdG8gdGhlIHBvc2l0aW9uIGFmdGVyIGxhc3QgY29uc3VtZWRcbiAgICovXG4gIHJlc2V0KCkge1xuICAgIGlmICh0aGlzLmN1cnJDaHVuayAmJiAhdGhpcy5jdXJyQ2h1bmsuaXNDbG9zZWQpIHtcbiAgICAgIGNvbnN0IHJlc2V0Q250ID0gdGhpcy5jYWNoZVJlYWRJZHggKyAxO1xuICAgICAgdGhpcy5jdXJyQ2h1bmsudmFsdWVzLnNwbGljZSh0aGlzLmN1cnJDaHVuay52YWx1ZXMubGVuZ3RoIC0gcmVzZXRDbnQsIHJlc2V0Q250KTtcbiAgICB9XG4gICAgdGhpcy5jYWNoZVJlYWRJZHggPSAtMTtcbiAgfVxuXG4gIHB1c2goaGFuZGxlcjogU3RhdGVIYW5kbGVyPFY+KSB7XG4gICAgdGhpcy5zdGFjay5wdXNoKGhhbmRsZXIpO1xuICB9XG5cbiAgLyoqXG4gICAqIHBvcHVwIGN1cnJlbnQgbWFjaGluZSBmcm9tIHN0YWNrLCBuZXh0IHRpbWUgaXQgd2lsbCBnbyB0byBsYXN0IG1hY2hpbmUuXG4gICAqL1xuICBwb3AoKSB7XG4gICAgdGhpcy5zdGFjay5wb3AoKTtcbiAgfVxuXG4gIHN0YXJ0Q2h1bms8VD4odHlwZTogVCk6IENodW5rPFYsIFQ+IHtcbiAgICBpZiAodGhpcy5jdXJyQ2h1bmspXG4gICAgICB0aGlzLmN1cnJDaHVuay5jbG9zZSgpO1xuICAgIHRoaXMuY3VyckNodW5rID0gbmV3IENodW5rPFYsIFQ+KHR5cGUsIHRoaXMpLm9wZW4oKTtcbiAgICByZXR1cm4gdGhpcy5jdXJyQ2h1bms7XG4gIH1cblxuICBjbG9zZUNodW5rKCkge1xuICAgIHJldHVybiB0aGlzLmN1cnJDaHVuay5jbG9zZSgpO1xuICB9XG5cbiAgb25OZXh0KHZhbHVlczogVltdKSB7XG4gICAgdGhpcy5jYWNoZS5wdXNoKC4uLnZhbHVlcyk7XG5cbiAgICBjb25zdCBzd2l0Y2hTdGF0ZSA9ICgpID0+IHtcbiAgICAgIHRoaXMuc3dpdGNoRG9uZSA9IHRoaXMuc3dpdGNoRG9uZVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5jYWNoZVJlYWRJZHggPCB0aGlzLmNhY2hlLmxlbmd0aCkge1xuICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5jYWNoZVt0aGlzLmNhY2hlUmVhZElkeF07XG4gICAgICAgICAgaWYgKHRoaXMuY3VyckNodW5rKVxuICAgICAgICAgICAgdGhpcy5jdXJyQ2h1bmsudmFsdWVzLnB1c2godmFsdWUpO1xuICAgICAgICAgIHJldHVybiB0aGlzLmNhbGxIYW5kbGVyKHZhbHVlKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICB0aGlzLmNhY2hlUmVhZElkeCsrO1xuICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uKys7XG4gICAgICAgICAgICAgIHRoaXMuY29sdW1uKys7XG4gICAgICAgICAgICAgIGlmICgodmFsdWUgYXMgYW55KSA9PT0gJ1xcbicpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxpbmUrKztcbiAgICAgICAgICAgICAgICB0aGlzLmNvbHVtbiA9IDE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgc3dpdGNoU3RhdGUoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9O1xuICAgIHN3aXRjaFN0YXRlKCk7XG4gIH1cblxuICBkb25lKCkge1xuICAgIHJldHVybiB0aGlzLnN3aXRjaERvbmU7XG4gIH1cblxuICBwcml2YXRlIGNhbGxIYW5kbGVyKHZhbHVlOiBWKTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCBjdXJySGFuZGxlciA9IHRoaXMuc3RhY2tbdGhpcy5zdGFjay5sZW5ndGggLSAxXTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGN1cnJIYW5kbGVyLmhhbmRsZSh0aGlzLCB2YWx1ZSkpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDaHVuazxWLCBUPiB7XG4gIHZhbHVlczogVltdID0gW107XG4gIHN0YXJ0OiBQb3N0aW9uO1xuICBlbmQ/OiBudW1iZXI7XG4gIGlzQ2xvc2VkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocHVibGljIHR5cGU6IFQsIHByaXZhdGUgbWFjaGluZTogTExTdGF0ZU1hY2hpbmU8Vj4pIHt9XG5cbiAgb3BlbigpIHtcbiAgICB0aGlzLnN0YXJ0ID0ge1xuICAgICAgcG9zOiB0aGlzLm1hY2hpbmUucG9zaXRpb24sXG4gICAgICBsaW5lOiB0aGlzLm1hY2hpbmUubGluZSxcbiAgICAgIGNvbHVtbjogdGhpcy5tYWNoaW5lLmNvbHVtblxuICAgIH07XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBjbG9zZSgpIHtcbiAgICB0aGlzLmlzQ2xvc2VkID0gdHJ1ZTtcbiAgICB0aGlzLmVuZCA9IHRoaXMubWFjaGluZS5wb3NpdGlvbiArIDE7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoe3N0YXJ0OiB0aGlzLnN0YXJ0LCBlbmQ6IHRoaXMuZW5kLCB2YWx1ZTogdGhpcy52YWx1ZXN9KTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBvc3Rpb24ge1xuICBwb3M6IG51bWJlcjtcbiAgbGluZTogbnVtYmVyO1xuICBjb2x1bW46IG51bWJlcjtcbn1cbiJdfQ==